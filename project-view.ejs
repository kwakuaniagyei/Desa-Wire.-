<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Cache Buster: <%= Date.now() %> -->
    <title>Project Management Interface</title>
    <link rel="icon" type="image/png" href="/img/icon.png">
    <link rel="shortcut icon" type="image/png" href="/img/icon.png">
    <script src="/js/notifications.js?v=<%= Date.now() %>"></script>
    <script src="/js/chat-widget.js?v=<%= Date.now() %>"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif;
            background-color: #F5F7FA;
            height: 100vh;
            overflow: hidden;
            font-size: 17px;
        }

        /* Header */
        .header {
            background-color: #282C34;
            height: 60px;
            display: flex;
            align-items: center;
            padding: 0 20px;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .hamburger-menu {
            background: none;
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 40px;
        }

        .hamburger-menu:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .hamburger-menu:focus {
            outline: none;
            background-color: rgba(255, 255, 255, 0.1);
        }

        .desa-logo {
            width: 32px;
            height: 32px;
            border-radius: 4px;
        }

        .logo {
            color: white;
            font-size: 18px;
            font-weight: 600;
        }

        .header-center {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            max-width: 400px;
            margin: 0 auto;
        }

        .search-bar {
            background-color: #F5F7FA;
            border: none;
            border-radius: 6px;
            padding: 8px 40px 8px 12px;
            width: 100%;
            font-size: 14px;
            color: #333;
        }

        .search-bar::placeholder {
            color: #999;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .header-icon {
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        /* Project Dropdown */
        .project-dropdown {
            position: relative;
        }

        .project-dropdown-content {
            display: none;
            position: absolute;
            left: 0;
            top: calc(100% + 10px);
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            min-width: 280px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 999999999;
        }

        .project-dropdown-content.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        .project-dropdown-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e2e8f0;
            font-weight: 600;
            color: #2d3748;
            font-size: 14px;
        }

        .project-search-container {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .project-search-input {
            width: 100%;
            padding: 8px 12px 8px 36px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 13px;
            outline: none;
            background: white;
            transition: border-color 0.2s;
        }

        .project-search-input:focus {
            border-color: #3F80EA;
        }

        .project-search-wrapper {
            position: relative;
        }

        .project-search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #a0aec0;
            font-size: 13px;
        }

        .project-list {
            max-height: 320px;
            overflow-y: auto;
        }

        .project-actions-container {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            background: #f8fafc;
        }

        .project-action-item {
            flex: 1;
            padding: 12px 20px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            border-right: 1px solid #e2e8f0;
        }

        .project-action-item:last-child {
            border-right: none;
        }

        .project-action-item:hover {
            background: #e2e8f0;
        }

        .project-action-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #3F80EA 0%, #2563eb 100%);
            color: white;
        }

        .project-action-icon.new-project {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .project-action-text {
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            color: #2d3748;
        }

        .project-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
        }

        .project-item:hover {
            background: #f7fafc;
        }

        .project-item.active {
            background: #ebf8ff;
            border-left: 3px solid #3F80EA;
        }

        .project-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }

        .project-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 600;
        }

        .project-item-info {
            flex: 1;
            min-width: 0;
        }

        .project-item-name {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-item-type {
            font-size: 12px;
            color: #718096;
            margin-top: 2px;
        }

        .project-item-members {
            font-size: 12px;
            color: #a0aec0;
            white-space: nowrap;
        }

        .header-text {
            color: white;
            font-size: 14px;
            cursor: pointer;
        }

        /* User Dropdown & Notifications */
        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }

        .user-dropdown {
            position: relative;
            cursor: pointer;
        }

        .user-dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
            margin-top: 5px;
        }

        .user-dropdown-content.show {
            display: block;
        }

        .user-dropdown-header {
            padding: 15px;
            border-bottom: 1px solid #f1f5f9;
        }

        .user-full-name {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .user-email {
            color: #718096;
            font-size: 13px;
        }

        .user-dropdown-menu {
            padding: 8px 0;
        }

        .user-dropdown-item {
            padding: 8px 15px;
            color: #4a5568;
            text-decoration: none;
            display: block;
            transition: background 0.2s;
        }

        .user-dropdown-item:hover {
            background: #f7fafc;
        }

        .notification-icon {
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background 0.2s;
            color: white;
            font-size: 16px;
        }

        .notification-icon:hover {
            background: rgba(255,255,255,0.1);
        }

        .notification-panel, .help-panel {
            position: absolute;
            top: calc(100% + 10px);
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            width: 350px;
            max-height: 500px;
            overflow-y: auto;
            z-index: 999999999;
            display: none;
        }

        .notification-panel.show, .help-panel.show {
            display: block;
            animation: slideDown 0.2s ease-out;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .panel-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 700;
            color: #2d3748;
        }

        .help-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .help-item:hover {
            background: #f7fafc;
        }

        .help-item-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .help-item-desc {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        .notification-filters {
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            background: #f8fafc;
        }

        .filter-btn {
            padding: 6px 14px;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f1f5f9;
            border-color: #cbd5e0;
        }

        .filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
        }

        .notification-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .notification-type-badge.People {
            background: #e6f7ff;
            color: #1890ff;
        }

        .notification-type-badge.Project {
            background: #f0f5ff;
            color: #6366f1;
        }

        .notification-type-badge.Account {
            background: #fff7e6;
            color: #fa8c16;
        }

        .notification-type-badge.Alerts {
            background: #fff1f0;
            color: #f5222d;
        }

        .notification-type-badge.Tasks {
            background: #f6ffed;
            color: #52c41a;
        }

        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f7fafc;
        }

        .notification-item.unread {
            background: #ebf8ff;
        }

        .notification-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 5px;
        }

        .notification-icon-circle {
            width: 8px;
            height: 8px;
            background: #3182ce;
            border-radius: 50%;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .mark-all-read {
            font-size: 12px;
            color: #3182ce;
            cursor: pointer;
            font-weight: 500;
        }

        .mark-all-read:hover {
            text-decoration: underline;
        }

        /* Sidebar */
        .sidebar {
            background-color: #282C34;
            width: 250px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 60px;
            padding: 20px 0;
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        .sidebar-section {
            margin-bottom: 30px;
        }

        .section-title {
            color: #8B949E;
            font-size: 15px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            padding: 0 20px 12px;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px 20px;
            color: white;
            text-decoration: none;
            font-size: 18px;
            font-weight: 500;
            transition: background-color 0.2s;
            cursor: pointer;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif;
        }

        .nav-item:hover {
            background-color: #3C4043;
        }

        .nav-item.active {
            background-color: #3F80EA;
            color: white;
        }

        .nav-item i {
            width: 22px;
            font-size: 20px;
            text-align: center;
        }

        .sidebar-bottom {
            position: absolute;
            bottom: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
        }

        .sidebar-bottom i {
            color: white;
            font-size: 16px;
            cursor: pointer;
        }

        /* Sidebar Collapsed State */
        .sidebar.collapsed {
            width: 60px;
        }

        .sidebar.collapsed .section-title,
        .sidebar.collapsed .nav-label {
            display: none !important;
        }

        .sidebar .section-title,
        .sidebar .nav-label {
            display: inline;
            transition: opacity 0.3s ease;
        }

        .sidebar.collapsed .nav-item {
            justify-content: center;
            padding: 12px 0;
        }

        .sidebar.collapsed .nav-item i {
            margin-right: 0;
        }

        /* Main Content */
        .main-content {
            margin-left: 250px;
            margin-top: 60px;
            height: calc(100vh - 60px);
            padding: 20px;
            overflow-y: auto;
            transition: margin-left 0.3s ease;
        }

        .main-content.sidebar-collapsed {
            margin-left: 60px;
        }

        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
        }

        .action-left {
            display: flex;
            gap: 12px;
        }

        .action-right {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 10px 18px;
            border: none;
            border-radius: 6px;
            font-size: 15px !important;
            font-weight: 600 !important;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            letter-spacing: 0.3px !important;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            text-transform: uppercase !important;
        }

        .btn-primary {
            background-color: #3F80EA;
            color: white;
        }

        .btn-secondary {
            background-color: #F5F7FA;
            color: #333;
            border: 1px solid #E1E5E9;
        }

        .btn-secondary:hover {
            background-color: #E1E5E9;
        }

        .btn:hover {
            transform: translateY(-1px);
        }

        .btn-primary:hover {
            background-color: #357ABD;
        }

        /* Modern Action Bar Styles - React Design */
        .modern-action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #e5e7eb;
            background: white;
            margin: -20px -20px 24px -20px;
        }

        .modern-action-left,
        .modern-action-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modern-btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            border: 1px solid transparent;
            text-transform: none;
        }

        .modern-btn i {
            font-size: 14px;
        }

        .modern-btn-primary {
            background-color: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .modern-btn-primary:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }

        .modern-btn-secondary {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .modern-btn-secondary:hover {
            background-color: #f9fafb;
        }

        .modern-btn-icon-primary {
            background-color: #2563eb;
            color: white;
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        .modern-btn-icon-primary:hover {
            background-color: #1d4ed8;
        }

        .modern-btn-icon-secondary {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 8px;
            min-width: 36px;
            justify-content: center;
        }

        .modern-btn-icon-secondary:hover {
            background-color: #f9fafb;
        }

        .modern-dropdown-wrapper {
            position: relative;
        }

        /* Empty State */
        /* Plans Grid */
        /* Main Layout - Second Screenshot Style */
        .main-layout {
            display: flex;
            gap: 20px;
            min-height: 400px;
        }

        .folders-sidebar {
            width: 300px;
            background: transparent;
            border-radius: 0;
            padding: 0;
            box-shadow: none;
            min-height: auto;
        }

        .documents-main {
            flex: 1;
            background: transparent;
            border-radius: 8px;
            padding: 0;
            min-height: auto;
        }

        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .folder-item,
        .plan-item {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .folder-item:hover,
        .plan-item:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1);
            transform: translateY(-2px);
        }

        .folder-item {
            background: white;
            color: #1e293b;
            min-height: 50px;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            position: relative;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .folder-item:hover {
            background: #f8f9fa;
            border-color: #3b82f6;
        }

        .folder-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .folder-icon {
            font-size: 18px;
            color: #64748b;
        }

        .folder-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .folder-name {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .folder-count {
            font-size: 12px;
            color: #64748b;
        }

        .folder-dropdown {
            position: relative;
        }

        .folder-dropdown-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            padding: 2px;
            border-radius: 2px;
            transition: all 0.2s;
            font-size: 12px;
        }

        .folder-dropdown-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .folder-dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 160px;
            display: none;
        }

        .folder-dropdown-menu.show {
            display: block;
        }

        .folder-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #1e293b;
        }

        .folder-dropdown-item:hover {
            background: #f8f9fa;
        }

        .folder-dropdown-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .folder-dropdown-item:last-child {
            border-radius: 0 0 8px 8px;
        }

        .folder-dropdown-item.delete {
            color: #dc2626;
        }

        .folder-dropdown-item.delete:hover {
            background: #fef2f2;
        }

        /* Folders and Documents Layout */
        .folders-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 20px;
        }

        .documents-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .plan-item {
            display: flex;
            flex-direction: row;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
            position: relative;
            padding: 12px;
            gap: 12px;
            align-items: flex-start;
            transition: all 0.2s;
        }

        .plan-item.selected {
            border-color: #3B82F6;
            background: #EFF6FF;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        .plan-checkbox {
            flex-shrink: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 8px;
        }

        .plan-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #3B82F6;
        }

        .plan-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            cursor: pointer;
        }

        .plan-preview {
            width: 100%;
            height: 180px;
            background: white;
            border-radius: 8px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            border: 1px solid #f1f5f9;
        }

        .plan-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .plan-preview-icon {
            font-size: 32px;
            color: #cbd5e1;
        }

        /* Professional PDF Document Preview */
        .plan-preview-icon .pdf-document-preview {
            width: 100% !important;
            height: 100% !important;
            background: white !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 4px !important;
            padding: 8px !important;
            font-family: 'Arial', sans-serif !important;
            font-size: 8px !important;
            line-height: 1.2 !important;
            overflow: hidden !important;
            position: relative !important;
            display: block !important;
        }

        .plan-preview-icon .pdf-doc-header {
            border-bottom: 1px solid #d1d5db !important;
            padding-bottom: 4px !important;
            margin-bottom: 6px !important;
        }

        .plan-preview-icon .pdf-doc-title {
            font-weight: bold !important;
            font-size: 9px !important;
            color: #1f2937 !important;
            text-transform: uppercase !important;
            letter-spacing: 0.5px !important;
        }

        .plan-preview-icon .pdf-doc-subtitle {
            font-size: 7px !important;
            color: #6b7280 !important;
            margin-top: 1px !important;
        }

        .plan-preview-icon .pdf-doc-content {
            flex: 1 !important;
        }

        .plan-preview-icon .pdf-doc-section {
            margin-bottom: 4px !important;
        }

        .plan-preview-icon .pdf-doc-field {
            display: flex !important;
            margin-bottom: 2px !important;
        }

        .plan-preview-icon .pdf-label {
            font-weight: bold !important;
            color: #374151 !important;
            min-width: 25px !important;
            font-size: 7px !important;
        }

        .plan-preview-icon .pdf-value {
            color: #1f2937 !important;
            font-size: 7px !important;
            margin-left: 4px !important;
        }

        .plan-preview-icon .pdf-doc-table {
            border: 1px solid #d1d5db !important;
            border-radius: 2px !important;
            margin-top: 4px !important;
        }

        .plan-preview-icon .pdf-table-header {
            background: #f9fafb !important;
            border-bottom: 1px solid #d1d5db !important;
            display: flex !important;
            font-weight: bold !important;
            font-size: 6px !important;
        }

        .plan-preview-icon .pdf-table-row {
            display: flex !important;
            border-bottom: 1px solid #f3f4f6 !important;
        }

        .plan-preview-icon .pdf-table-row:last-child {
            border-bottom: none !important;
        }

        .plan-preview-icon .pdf-table-cell {
            padding: 2px 4px !important;
            font-size: 6px !important;
            color: #374151 !important;
            flex: 1 !important;
            border-right: 1px solid #f3f4f6 !important;
        }

        .plan-preview-icon .pdf-table-cell:last-child {
            border-right: none !important;
        }

        .plan-preview-icon .pdf-doc-footer {
            position: absolute !important;
            bottom: 4px !important;
            right: 8px !important;
        }

        .plan-preview-icon .pdf-doc-number {
            font-size: 8px !important;
            color: #6b7280 !important;
            font-weight: bold !important;
        }

        .plan-name {
            font-size: 13px;
            font-weight: 500;
            color: #1e293b;
            margin-bottom: 4px;
        }

        .plan-meta {
            font-size: 11px;
            color: #64748b;
        }

        /* Actions Dropdown */
        .actions-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 200px;
            z-index: 1000;
        }

        .actions-dropdown.show {
            display: block;
        }

        .actions-dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            color: #2d3748;
        }

        .actions-dropdown-item:first-child {
            border-top-left-radius: 6px;
            border-top-right-radius: 6px;
        }

        .actions-dropdown-item:last-child {
            border-bottom-left-radius: 6px;
            border-bottom-right-radius: 6px;
        }

        .actions-dropdown-item:hover {
            background: #f7fafc;
        }

        .actions-dropdown-item i {
            width: 16px;
            text-align: center;
        }

        .actions-dropdown-item.delete-action {
            color: #e53e3e;
        }

        .actions-dropdown-item.delete-action:hover {
            background: #fed7d7;
        }

        .action-badge {
            background: #3182ce;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 8px;
        }

        .tag {
            display: inline-block;
            padding: 4px 8px;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            margin: 2px;
        }

        .tag:hover {
            background: #e2e8f0;
        }

        .tag.selected {
            background: #3182ce;
            color: white;
            border-color: #3182ce;
        }

        .selected-tag {
            background: #3182ce;
            color: white;
            border-color: #3182ce;
        }

        /* Filter Dropdown */
        .filter-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            right: 0;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            width: 320px;
            z-index: 1000;
            padding: 16px;
        }

        .filter-dropdown.show {
            display: block;
        }

        .filter-section {
            margin-bottom: 20px;
        }

        .filter-section:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            display: block;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-weight: 600 !important;
            font-size: 15px !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            color: #2D3748;
            margin-bottom: 10px;
        }

        .filter-search {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            transition: all 0.2s;
        }

        .filter-search:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 8px 0;
            cursor: pointer;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            color: #4A5568;
        }

        .filter-option input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #3B82F6;
        }

        .filter-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #3B82F6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid #E2E8F0;
        }

        .btn-filter-clear {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid #E2E8F0;
            border-radius: 8px;
            background: white;
            color: #6B7280;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-filter-clear:hover {
            background: #F9FAFB;
            border-color: #D1D5DB;
        }

        .btn-filter-apply {
            flex: 1;
            padding: 10px 16px;
            border: none;
            border-radius: 8px;
            background: #3B82F6;
            color: white;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            font-size: 15px !important;
            font-weight: 600 !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-filter-apply:hover {
            background: #2563EB;
        }

        /* List View */
        .plans-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .plans-list .plan-item {
            flex-direction: row;
            padding: 16px;
        }

        .plans-list .plan-content {
            flex-direction: row;
            align-items: center;
            gap: 16px;
        }

        .plans-list .plan-preview {
            width: 80px;
            height: 80px;
            flex-shrink: 0;
            margin-bottom: 0;
        }

        .plans-list .plan-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .plans-list .plan-name {
            font-size: 15px;
            margin-bottom: 0;
        }

        .plans-list .plan-meta {
            font-size: 13px;
        }

        .plans-list .folder-item {
            padding: 20px;
        }

        .view-toggle.active {
            background: #3B82F6;
            color: white;
        }

        /* Selected Files List */
        .selected-files-list {
            margin-top: 20px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .selected-files-list:empty {
            display: none;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: white;
            border-radius: 6px;
            margin-bottom: 8px;
            border: 1px solid #e2e8f0;
        }

        .file-item:last-child {
            margin-bottom: 0;
        }

        .file-item-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 0;
        }

        .file-item-icon {
            font-size: 20px;
            flex-shrink: 0;
        }

        .file-item-details {
            flex: 1;
            min-width: 0;
        }

        .file-item-name {
            font-size: 14px;
            font-weight: 500;
            color: #1e293b;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-item-size {
            font-size: 12px;
            color: #64748b;
        }

        .file-item-remove {
            background: none;
            border: none;
            color: #ef4444;
            cursor: pointer;
            padding: 5px;
            border-radius: 4px;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .file-item-remove:hover {
            background-color: #fee2e2;
        }

        .empty-state {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 60vh;
            text-align: center;
        }

        .empty-state.show {
            display: flex;
        }

        .empty-state-icon {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, #F5F7FA 0%, #E1E5E9 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            position: relative;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .empty-state-icon::before {
            content: '';
            position: absolute;
            top: 8px;
            right: 8px;
            width: 85px;
            height: 85px;
            background: linear-gradient(135deg, #E1E5E9 0%, #D1D5DB 100%);
            border-radius: 8px;
            z-index: -1;
        }

        .blueprint-lines {
            position: absolute;
            width: 70px;
            height: 70px;
            z-index: 2;
        }

        .blueprint-lines::before,
        .blueprint-lines::after {
            content: '';
            position: absolute;
            background-color: #6B7280;
        }

        .blueprint-lines::before {
            width: 100%;
            height: 1px;
            top: 15px;
            left: 0;
        }

        .blueprint-lines::after {
            width: 100%;
            height: 1px;
            top: 30px;
            left: 0;
        }

        .blueprint-line-3 {
            position: absolute;
            width: 100%;
            height: 1px;
            background-color: #6B7280;
            top: 45px;
            left: 0;
        }

        .vertical-line {
            position: absolute;
            width: 1px;
            height: 100%;
            background-color: #6B7280;
            left: 15px;
            top: 0;
        }

        .vertical-line::after {
            content: '';
            position: absolute;
            width: 1px;
            height: 100%;
            background-color: #6B7280;
            left: 25px;
            top: 0;
        }

        .blueprint-circle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #6B7280;
            border-radius: 50%;
            top: 35px;
            left: 35px;
        }

        .play-button {
            width: 28px;
            height: 28px;
            background-color: #6B7280;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 12px;
            z-index: 3;
        }

        .play-button::before {
            content: '';
            width: 0;
            height: 0;
            border-left: 10px solid white;
            border-top: 7px solid transparent;
            border-bottom: 7px solid transparent;
            margin-left: 3px;
        }

        .empty-state h2 {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .empty-state p {
            font-size: 16px;
            color: #666;
            max-width: 400px;
            line-height: 1.5;
        }

        /* Create Project Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #a0aec0;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        .modal-body {
            padding: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2d3748;
            font-size: 14px;
        }

        .form-label.required::after {
            content: '*';
            color: #e53e3e;
            margin-left: 4px;
        }

        .form-input, .form-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus {
            outline: none;
            border-color: #3182ce;
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }

        .modal-footer {
            padding: 20px 24px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* File Viewer Modal - Larger */
        .file-viewer-modal {
            max-width: 1200px;
            width: 95%;
            max-height: 95vh;
        }

        /* Professional PDF Viewer Styles */
        .professional-pdf-viewer {
            width: 100%;
            height: 100%;
            background: #f8f9fa;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .pdf-document-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            position: relative;
        }

        .pdf-document-container iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .folder-viewer-modal {
            max-width: 1000px;
            width: 90%;
        }

        .btn-secondary, .btn-primary {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 15px !important;
            font-weight: 600 !important;
            font-family: 'Century Gothic', 'CenturyGothic', AppleGothic, sans-serif !important;
            letter-spacing: 0.3px !important;
            text-transform: uppercase !important;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-primary {
            background: #3182ce;
            color: white;
        }

        .btn-primary:hover {
            background: #2c5282;
        }

        .btn-primary:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        /* File Upload Modal */
        .upload-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .upload-modal-overlay.show {
            display: flex;
        }

        .upload-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.3s ease-out;
        }

        .upload-area {
            padding: 40px;
            border: 2px dashed #cbd5e0;
            border-radius: 8px;
            text-align: center;
            margin: 20px;
            background: #f7fafc;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #3182ce;
            background: #ebf8ff;
        }

        .upload-area.drag-over {
            border-color: #3182ce;
            background: #ebf8ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            color: #a0aec0;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 16px;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-subtext {
            font-size: 14px;
            color: #718096;
            margin-bottom: 16px;
        }

        .upload-button {
            background: #3182ce;
            color: white;
            padding: 10px 24px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-button:hover {
            background: #2c5282;
        }

        .file-input {
            display: none;
        }

        .file-list {
            padding: 0 20px 20px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f7fafc;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .file-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-size: 14px;
            font-weight: 500;
            color: #2d3748;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 12px;
            color: #718096;
        }

        .file-remove {
            background: #f56565;
            color: white;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .file-remove:hover {
            background: #e53e3e;
            transform: scale(1.1);
        }

        /* New Plan Modal Styles */
        .new-plan-modal {
            max-width: 700px;
            width: 90%;
        }

        .new-plan-modal .upload-area {
            margin: 30px;
            padding: 60px 40px;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .new-plan-modal .upload-area:hover {
            border-color: #3F80EA;
            background: #ebf8ff;
        }

        .new-plan-modal .upload-area.drag-over {
            border-color: #3F80EA;
            background: #ebf8ff;
            transform: scale(1.02);
        }

        .new-plan-modal .upload-icon {
            margin-bottom: 20px;
        }

        .new-plan-modal .upload-text {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 12px;
        }

        .upload-separator {
            font-size: 14px;
            color: #718096;
            margin: 16px 0;
            font-weight: 500;
        }

        .select-files-btn {
            background: #3F80EA;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .select-files-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        /* Integrations Section */
        .integrations-section {
            padding: 30px;
            border-top: 1px solid #e2e8f0;
        }

        .integrations-header {
            font-size: 16px;
            color: #4a5568;
            margin-bottom: 24px;
            text-align: center;
        }

        .integrations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            max-width: 700px;
            margin: 0 auto;
        }

        .integration-btn {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
            gap: 12px;
        }

        .integration-btn:hover {
            border-color: #3F80EA;
            background: #f8fafc;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(63, 128, 234, 0.1);
        }

        .integration-logo {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .integration-name {
            font-size: 14px;
            font-weight: 500;
            color: #4a5568;
            text-align: left;
        }

        .integration-logo.google-drive {
            background: transparent;
        }

        .integration-logo.sharepoint {
            background: transparent;
        }

        .integration-logo.dropbox {
            background: transparent;
        }

        .integration-logo.box {
            background: transparent;
        }

        .integration-logo.onedrive {
            background: transparent;
        }

        .integration-logo.desa-pdrive {
            background: transparent;
        }

        /* New Plan Footer */
        .new-plan-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        .more-options {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #3F80EA;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: color 0.2s;
        }

        .more-options:hover {
            color: #2563eb;
            text-decoration: underline;
        }

        .upload-files-btn {
            background: #87CEEB;
            color: #2d3748;
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .upload-files-btn:hover {
            background: #7bb8d4;
            transform: translateY(-1px);
        }

        .upload-files-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }

        /* Notification Animations */
        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        /* More Upload Options Modal */
        .more-options-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            backdrop-filter: blur(4px);
        }

        .more-options-modal-overlay.show {
            display: flex;
        }

        .more-options-modal {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 90%;
            max-width: 900px;
            height: 80vh;
            max-height: 600px;
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
            display: flex;
            position: relative;
        }

        .more-options-modal .modal-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: #a0aec0;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            z-index: 10;
        }

        .more-options-modal .modal-close:hover {
            background: #f7fafc;
            color: #4a5568;
        }

        /* Left Sidebar */
        .upload-sources-sidebar {
            width: 280px;
            background: #f8f9fa;
            border-right: 1px solid #e2e8f0;
            padding: 20px 0;
            overflow-y: auto;
        }

        .source-section {
            padding: 0 20px 20px;
            border-bottom: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }

        .source-header {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }

        .source-header i {
            color: #3F80EA;
            font-size: 18px;
        }

        .sources-list {
            padding: 0 10px;
        }

        .source-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 10px;
            margin-bottom: 4px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .source-item:hover {
            background: #e2e8f0;
        }

        .source-item.active {
            background: #3F80EA;
            color: white;
        }

        .source-item.active .source-icon {
            background: white;
        }

        .source-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .source-icon.dropbox {
            background: #0061FF;
        }

        .source-icon.dropbox svg {
            stroke: white;
            fill: none;
        }

        .source-icon.box {
            background: #0061D5;
        }

        .source-icon.google-drive {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .source-icon.onedrive,
        .source-icon.onedrive-business {
            background: #0078D4;
        }

        .source-icon.link {
            background: #f7fafc;
        }

        .source-item span {
            font-size: 14px;
            font-weight: 500;
        }

        /* Main Content Area */
        .upload-main-content {
            flex: 1;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            position: relative;
        }

        .upload-icon-large {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #9CA3AF;
            font-size: 24px;
        }

        .upload-drop-zone {
            width: 100%;
            max-width: 500px;
            height: 300px;
            border: 2px dashed #cbd5e0;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-drop-zone:hover {
            border-color: #3F80EA;
            background: #f8fafc;
        }

        .upload-file-icon {
            position: relative;
            margin-bottom: 20px;
        }

        .plus-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            font-weight: bold;
            color: #9CA3AF;
        }

        .upload-main-text {
            font-size: 20px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            text-align: center;
        }

        .upload-sub-text {
            font-size: 14px;
            color: #718096;
            text-align: center;
        }

        /* Bulk Actions Bar */
        .bulk-actions-bar {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            border: 1px solid #E2E8F0;
        }

        .selection-info {
            font-weight: 600;
            color: #3B82F6;
            font-size: 14px;
        }

        .bulk-action-btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .bulk-action-btn.select-all {
            background: #EFF6FF;
            color: #3B82F6;
        }

        .bulk-action-btn.select-all:hover {
            background: #DBEAFE;
        }

        .bulk-action-btn.deselect-all {
            background: #F3F4F6;
            color: #6B7280;
        }

        .bulk-action-btn.deselect-all:hover {
            background: #E5E7EB;
        }

        .bulk-action-btn.delete {
            background: #FEE2E2;
            color: #DC2626;
        }

        .bulk-action-btn.delete:hover {
            background: #FECACA;
        }

        /* Chat Widget */
        .chat-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 56px;
            height: 56px;
            background-color: #FF6B35;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
            transition: transform 0.2s;
        }

        .chat-widget:hover {
            transform: scale(1.1);
        }

        .chat-widget i {
            color: white;
            font-size: 20px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s;
            }

            .main-content {
                margin-left: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left project-dropdown" id="projectDropdown">
            <img src="/img/img.webp" alt="DESA Logo" class="desa-logo">
            <span class="logo"><%= projectName || 'Project' %></span>
            <i class="fas fa-chevron-down header-icon" id="projectDropdownToggle"></i>

            <!-- Project Dropdown Panel -->
            <div class="project-dropdown-content" id="projectDropdownPanel">
                <div class="project-dropdown-header">All Projects</div>

                <!-- Search Bar -->
                <div class="project-search-container">
                    <div class="project-search-wrapper">
                        <i class="fas fa-search project-search-icon"></i>
                        <input type="text" class="project-search-input" id="projectSearchInput" placeholder="Search projects...">
                    </div>
                </div>

                <!-- Project List -->
                <div class="project-list" id="projectList">
                    <!-- Action Items -->
                    <div class="project-actions-container">
                        <div class="project-action-item" onclick="window.location.href='/'">
                            <div class="project-action-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="project-action-text">Home</div>
                        </div>
                        <div class="project-action-item" onclick="openNewProjectModal()">
                            <div class="project-action-icon new-project">
                                <i class="fas fa-plus"></i>
                            </div>
                            <div class="project-action-text">New Project</div>
                        </div>
                    </div>

                    <% if (projects && projects.length > 0) { %>
                        <% projects.forEach(function(proj) { %>
                            <div class="project-item <%= proj.id === project?.id ? 'active' : '' %>" onclick="window.location.href='/project/<%= proj.id %>'" data-project-name="<%= proj.name.toLowerCase() %>" data-project-type="<%= (proj.type || '').toLowerCase() %>">
                                <div class="project-item-left">
                                    <div class="project-item-icon">
                                        <%= proj.name.charAt(0).toUpperCase() %>
                                    </div>
                                    <div class="project-item-info">
                                        <div class="project-item-name"><%= proj.name %></div>
                                        <% if (proj.type) { %>
                                            <div class="project-item-type"><%= proj.type %></div>
                                        <% } %>
                                    </div>
                                </div>
                                <div class="project-item-members"><%= proj.members %> members</div>
                            </div>
                        <% }); %>
                    <% } else { %>
                        <div style="padding: 20px; text-align: center; color: #a0aec0;">No projects available</div>
                    <% } %>
                    <div id="noProjectsFound" style="display: none; padding: 20px; text-align: center; color: #a0aec0;">
                        No projects found
                    </div>
                </div>
            </div>
        </div>
        
        <div class="header-center">
            <button class="hamburger-menu" id="hamburgerMenu">
                <i class="fas fa-bars"></i>
            </button>
            <div style="position: relative; width: 100%;">
                <input type="text" class="search-bar" placeholder="Search">
                <i class="fas fa-search" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; font-size: 14px;"></i>
            </div>
        </div>
        
        <div class="user-section">
            <span class="notification-icon" id="notificationBell" style="position: relative;">
                
                <span id="notificationBadge" style="
                    position: absolute;
                    top: -2px;
                    right: -2px;
                    background: #e53e3e;
                    color: white;
                    font-size: 10px;
                    font-weight: 600;
                    padding: 2px 5px;
                    border-radius: 10px;
                ">0</span>
            </span>
            <span class="notification-icon" id="helpIcon"></span>

            <!-- Notification Panel -->
            <div class="notification-panel" id="notificationPanel">
                <div class="panel-header">
                    <div class="panel-title">Notifications</div>
                    <div class="mark-all-read" id="markAllRead">Mark all as read</div>
                </div>

                <!-- Notification Filters -->
                <div class="notification-filters">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="People">People</button>
                    <button class="filter-btn" data-filter="Project">Project</button>
                    <button class="filter-btn" data-filter="Account">Account</button>
                    <button class="filter-btn" data-filter="Alerts">Alerts</button>
                    <button class="filter-btn" data-filter="Tasks">Tasks</button>
                    <button class="filter-btn" data-filter="Forms">Forms</button>
                </div>

                <div id="notificationsList"></div>
            </div>

            <!-- Help Panel -->
            <div class="help-panel" id="helpPanel">
                <div class="panel-header">
                    <div class="panel-title">Help & Support</div>
                </div>
                <div class="help-item" onclick="window.open('https://www.desa.ca/', '_blank')">
                    <div class="help-item-title"> Documentation</div>
                    <div class="help-item-desc">Browse our complete documentation</div>
                </div>
                <div class="help-item" onclick="alert('Video tutorials coming soon!')">
                    <div class="help-item-title"> Video Tutorials</div>
                    <div class="help-item-desc">Watch step-by-step video guides</div>
                </div>
                <div class="help-item" onclick="alert('Contact support at support@desa.ca')">
                    <div class="help-item-title"> Contact Support</div>
                    <div class="help-item-desc">Get help from our support team</div>
                </div>
                <div class="help-item" onclick="alert('Keyboard shortcuts coming soon!')">
                    <div class="help-item-title"> Keyboard Shortcuts</div>
                    <div class="help-item-desc">Learn useful keyboard shortcuts</div>
                </div>
                <div class="help-item" onclick="alert('Check out our latest updates!')">
                    <div class="help-item-title"> What's New</div>
                    <div class="help-item-desc">See the latest features and updates</div>
                </div>
            </div>

            <div class="user-dropdown" id="userDropdownToggle">
                <span style="color: white;"><%= user?.username || 'Guest' %></span>
                <span style="color: white;"></span>
                <div class="user-dropdown-content" id="userDropdown">
                    <div class="user-dropdown-header">
                        <div class="user-full-name"><%= user?.username || 'Guest' %></div>
                        <div class="user-email"><%= user?.email || 'guest@desa.com' %></div>
                    </div>
                    <div class="user-dropdown-menu">
                        <a href="#" class="user-dropdown-item" id="editProfileLink">Edit profile</a>
                        <a href="/account" class="user-dropdown-item">View account</a>
                        <a href="#" class="user-dropdown-item" onclick="signOut()">Sign out</a>
                    </div>
                </div>
            </div>
            <span></span>
        </div>
    </header>

    <!-- Sidebar -->
    <nav class="sidebar">
        <div class="sidebar-section">
            <div class="section-title">Field Management</div>
            <a href="#" class="nav-item active" id="plansNavItem">
                <i class="fas fa-drafting-compass"></i>
                <span class="nav-label">Plans</span>
            </a>
            <a href="/project/<%= project.id %>/specifications?name=<%= encodeURIComponent(project.name) %>" class="nav-item">
                <i class="fas fa-clipboard-list"></i>
                <span class="nav-label">Specifications</span>
            </a>
            <a href="/project/<%= project.id %>/tasks?name=<%= encodeURIComponent(project.name) %>" class="nav-item">
                <i class="fas fa-tasks"></i>
                <span class="nav-label">Tasks</span>
            </a>
            <a href="/project/<%= project.id %>/photos?name=<%= encodeURIComponent(project.name) %>" class="nav-item">
                <i class="fas fa-camera"></i>
                <span class="nav-label">Photos</span>
            </a>
            <a href="/project/<%= project.id %>/forms?name=<%= encodeURIComponent(project.name) %>" class="nav-item">
                <i class="fas fa-file-signature"></i>
                <span class="nav-label">Forms</span>
            </a>
            <a href="/project/<%= project.id %>/files?name=<%= encodeURIComponent(project.name) %>" class="nav-item">
                <i class="fas fa-paperclip"></i>
                <span class="nav-label">Files</span>
            </a>
        </div>


        <div class="sidebar-section" id="tasksSection" style="display: none;">
            <div class="section-title">Tasks</div>
            <a href="#" class="nav-item active">
                <i class="fas fa-star"></i>
                <span class="nav-label">My tasks</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-eye"></i>
                <span class="nav-label">Watched tasks</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-th"></i>
                <span class="nav-label">All tasks</span>
            </a>
            <a href="#" class="nav-item">
                <i class="fas fa-plus"></i>
                <span class="nav-label">New category</span>
            </a>
        </div>

        <div class="sidebar-bottom">
            <i class="fas fa-users"></i>
            <i class="fas fa-cog"></i>
            <i class="fas fa-trash"></i>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Modern Action Bar -->
        <div class="modern-action-bar">
            <div class="modern-action-left">
                <button class="modern-btn modern-btn-primary" onclick="openUploadModal()">
                    <i class="fas fa-plus"></i>
                    New plan
                </button>
                <button class="modern-btn modern-btn-secondary" onclick="openNewFolderModal()">
                    <i class="fas fa-plus"></i>
                    New folder
                </button>
                <div class="modern-dropdown-wrapper">
                    <button class="modern-btn modern-btn-secondary" id="actionsBtn" onclick="toggleActionsDropdown()">
                        Actions
                        <i class="fas fa-chevron-down" style="font-size: 12px; margin-left: 4px;"></i>
                    </button>
                    <div class="actions-dropdown" id="actionsDropdown">
                        <div class="actions-dropdown-item" onclick="selectAll()">
                            <i class="fas fa-check-square"></i>
                            Select all
                        </div>
                        <div class="actions-dropdown-item" onclick="deselectAll()">
                            <i class="fas fa-square"></i>
                            Deselect all
                        </div>
                        <div class="actions-dropdown-item" onclick="moveSelected()">
                            <i class="fas fa-folder-open"></i>
                            Move to folder
                        </div>
                        <div class="actions-dropdown-item" onclick="manageTags()">
                            <i class="fas fa-tags"></i>
                            Manage tags
                        </div>
                        <div class="actions-dropdown-item" onclick="batchEdit()">
                            <i class="fas fa-edit"></i>
                            Batch edit
                        </div>
                        <div class="actions-dropdown-item" onclick="scanNumberDescription()">
                            <i class="fas fa-barcode"></i>
                            Scan number/description
                        </div>
                        <div class="actions-dropdown-item" onclick="editNumberDescription()">
                            <i class="fas fa-pen"></i>
                            Edit number/description
                        </div>
                        <div class="actions-dropdown-item" onclick="rotateSheet()">
                            <i class="fas fa-redo"></i>
                            Rotate sheet
                        </div>
                        <div class="actions-dropdown-item" onclick="setScale()">
                            <i class="fas fa-ruler"></i>
                            Set scale
                        </div>
                        <div class="actions-dropdown-item" onclick="compare()">
                            <i class="fas fa-balance-scale"></i>
                            Compare
                        </div>
                        <div class="actions-dropdown-item" onclick="exportPlan()">
                            <i class="fas fa-file-export"></i>
                            Export plan
                        </div>
                        <div class="actions-dropdown-item" onclick="exportMarkupSummary()">
                            <i class="fas fa-file-alt"></i>
                            Export markup summary
                        </div>
                        <div class="actions-dropdown-item" onclick="exportQRCode()">
                            <i class="fas fa-qrcode"></i>
                            Export QR code
                        </div>
                        <div class="actions-dropdown-item delete-action" onclick="deleteSelected()">
                            <i class="fas fa-trash"></i>
                            Delete
                        </div>
                    </div>
                </div>
            </div>

            <div class="modern-action-right">
                <div class="filter-container">
                    <button class="modern-btn modern-btn-secondary" onclick="toggleFilterDropdown()">
                        <i class="fas fa-filter"></i>
                        Filter plans
                    </button>
                    <div class="filter-dropdown" id="filterDropdown">
                        <div class="filter-section">
                            <label class="filter-label">Search</label>
                            <input type="text" class="filter-search" id="searchInput" placeholder="Search files..." oninput="applyFilters()">
                        </div>
                        <div class="filter-section">
                            <label class="filter-label">File Type</label>
                            <label class="filter-option">
                                <input type="checkbox" value="all" checked onchange="toggleFileTypeFilter(this)"> All Files
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="pdf" onchange="applyFilters()"> PDF Documents
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="image" onchange="applyFilters()"> Images
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="document" onchange="applyFilters()"> Documents
                            </label>
                            <label class="filter-option">
                                <input type="checkbox" value="folder" onchange="applyFilters()"> Folders
                            </label>
                        </div>
                        <div class="filter-section">
                            <label class="filter-label">Sort By</label>
                            <select class="filter-select" id="sortSelect" onchange="applyFilters()">
                                <option value="date-desc">Date (Newest First)</option>
                                <option value="date-asc">Date (Oldest First)</option>
                                <option value="name-asc">Name (A-Z)</option>
                                <option value="name-desc">Name (Z-A)</option>
                                <option value="size-desc">Size (Largest First)</option>
                                <option value="size-asc">Size (Smallest First)</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button class="btn-filter-clear" onclick="clearFilters()">Clear All</button>
                            <button class="btn-filter-apply" onclick="toggleFilterDropdown()">Done</button>
                        </div>
                    </div>
                </div>
                <button class="modern-btn modern-btn-secondary" onclick="openVersionControlModal()">
                    Version control
                </button>
                <button class="modern-btn modern-btn-icon-primary" id="gridViewBtn" onclick="switchToGridView()">
                    <i class="fas fa-th"></i>
                </button>
                <button class="modern-btn modern-btn-icon-secondary" id="listViewBtn" onclick="switchToListView()">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>

        <!-- Plans Grid Container -->
        <div id="plansContainer" class="plans-grid">
            <!-- Plans and folders will be dynamically inserted here -->
        </div>

        <!-- Empty State (shown when no plans/folders exist) -->
        <div class="empty-state" id="emptyState">
            <div class="empty-state-icon">
                <div class="blueprint-lines"></div>
                <div class="blueprint-line-3"></div>
                <div class="vertical-line"></div>
                <div class="blueprint-circle"></div>
                <div class="play-button"></div>
            </div>
            <h2>Drop your plans here to get started</h2>
            <p>Plans will sync across all of your devices to provide your team with the latest information.</p>
        </div>

        <!-- Bulk Actions Bar -->
        <div class="bulk-actions-bar" id="bulkActions">
            <span class="selection-info" id="selectionCount">0 selected</span>
            <button class="bulk-action-btn select-all" onclick="selectAllPlans()">
                <i class="fas fa-check-square"></i>
                Select All
            </button>
            <button class="bulk-action-btn deselect-all" onclick="deselectAllPlans()">
                <i class="fas fa-square"></i>
                Deselect All
            </button>
            <button class="bulk-action-btn delete" onclick="deleteSelectedPlans()">
                <i class="fas fa-trash"></i>
                Delete Selected
            </button>
        </div>
    </main>

    <!-- Upload Plans Modal -->
    <div class="upload-modal-overlay" id="uploadModal">
        <div class="upload-modal new-plan-modal">
            <div class="modal-header">
                <h2 class="modal-title">Upload plans</h2>
                <button class="modal-close" onclick="closeUploadModal()">&times;</button>
            </div>
            
            <!-- Main Upload Area -->
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="3" width="18" height="18" rx="2" stroke="#9CA3AF" stroke-width="2" fill="none"/>
                        <rect x="7" y="7" width="10" height="10" rx="1" stroke="#9CA3AF" stroke-width="2" fill="none"/>
                        <path d="M7 7L17 17" stroke="#9CA3AF" stroke-width="2"/>
                    </svg>
                </div>
                <div class="upload-text">Drag and drop your plans here</div>
                <div class="upload-separator">or</div>
                <div style="display: flex; gap: 10px; justify-content: center;">
                <button type="button" class="select-files-btn" onclick="document.getElementById('fileInput').click()">
                        Select Files
                </button>
                    <button type="button" class="select-files-btn" onclick="document.getElementById('folderInput').click()">
                        Select Folder
                    </button>
                </div>
                <input type="file" id="fileInput" class="file-input" multiple>
                <input type="file" id="folderInput" class="file-input" webkitdirectory directory multiple>
            </div>

            <!-- Integrations Section -->
            <div class="integrations-section">
                <div class="integrations-header">Or setup plan sync using one of our integrations below.</div>
                <div class="integrations-grid">
                    <div class="integration-btn" onclick="connectIntegration('google-drive')">
                        <div class="integration-logo google-drive">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M10.3 8.9L0 8.9L10.1 25.3h7.3l5.0-8.4L10.3 8.9z" fill="#0066DA"/>
                                <path d="M26.2 8.9L17.3 8.9L8.5 25.3h7.3l5.0-8.4L26.2 8.9z" fill="#00AC47"/>
                                <path d="M18.9 25.3L27.7 25.3L17.5 8.9L10.3 8.9L18.9 25.3z" fill="#EA4335"/>
                                <path d="M18.6 17.0L27.4 17.0L23.8 25.3h-7.3l2.1-8.3z" fill="#FBBC04"/>
                            </svg>
                        </div>
                        <div class="integration-name">Google Drive</div>
                    </div>
                    
                    <div class="integration-btn" onclick="connectIntegration('sharepoint')">
                        <div class="integration-logo sharepoint">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <rect x="4" y="4" width="24" height="24" rx="4" fill="#0078D4"/>
                                <path d="M16 8L8 12L16 16L24 12L16 8Z" fill="white"/>
                                <path d="M8 22L16 26L24 22" fill="white"/>
                                <path d="M8 16L16 20L24 16" fill="white"/>
                                <circle cx="20" cy="10" r="2" fill="white"/>
                            </svg>
                        </div>
                        <div class="integration-name">SharePoint</div>
                    </div>
                    
                    <div class="integration-btn" onclick="connectIntegration('dropbox')">
                        <div class="integration-logo dropbox">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M9.3 2.7L18.0 11.3L9.3 20" stroke="#0061FF" stroke-width="2.5" fill="none"/>
                                <path d="M22.7 13.3L14.0 4.7L22.7 21.3" stroke="#0061FF" stroke-width="2.5" fill="none"/>
                                <circle cx="9.3" cy="22.7" r="2.7" fill="#0061FF"/>
                                <circle cx="22.7" cy="9.3" r="2.7" fill="#0061FF"/>
                            </svg>
                        </div>
                        <div class="integration-name">Dropbox</div>
                    </div>
                    
                    <div class="integration-btn" onclick="connectIntegration('box')">
                        <div class="integration-logo box">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <rect x="4" y="4" width="24" height="24" rx="4" fill="#0061D5"/>
                                <rect x="8" y="8" width="16" height="16" rx="3" fill="white"/>
                            </svg>
                        </div>
                        <div class="integration-name">Box</div>
                    </div>
                    
                    <div class="integration-btn" onclick="connectIntegration('onedrive')">
                        <div class="integration-logo onedrive">
                            <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                                <path d="M9.3 2.7C6.4 2.7 4 5.1 4 8s2.4 5.3 5.3 5.3h13.4c2.9 0 5.3-2.4 5.3-5.3s-2.4-5.3-5.3-5.3H9.3z" fill="#0078D4"/>
                                <path d="M9.3 10.7c-2.9 0-5.3 2.4-5.3 5.3s2.4 5.3 5.3 5.3h13.4c2.9 0 5.3-2.4 5.3-5.3s-2.4-5.3-5.3-5.3H9.3z" fill="#0078D4"/>
                            </svg>
                        </div>
                        <div class="integration-name">OneDrive</div>
                    </div>
                    
                    <div class="integration-btn" onclick="connectIntegration('desa-pdrive')">
                        <div class="integration-logo desa-pdrive">
                            <img src="/img/img.webp" alt="Desa Pdrive" width="32" height="32" style="border-radius: 6px;">
                        </div>
                        <div class="integration-name">Add Desa Pdrive</div>
                    </div>
                </div>
            </div>

            <!-- Selected Files List -->
            <div id="fileList" class="selected-files-list"></div>

            <!-- Bottom Actions -->
            <div class="modal-footer new-plan-footer">
                <div class="more-options" onclick="openMoreOptionsModal()">
                    <i class="fas fa-cloud"></i>
                    <span>More upload options</span>
                </div>
                <button type="button" class="upload-files-btn" onclick="uploadFiles()" id="uploadBtn">
                    <i class="fas fa-upload"></i>
                    Upload files
                </button>
            </div>
        </div>
    </div>

    <!-- More Upload Options Modal -->
    <div class="more-options-modal-overlay" id="moreOptionsModal">
        <div class="more-options-modal">
            <button class="modal-close" onclick="closeMoreOptionsModal()">&times;</button>
            
            <!-- Left Sidebar -->
            <div class="upload-sources-sidebar">
                <div class="source-section">
                    <div class="source-header">
                        <i class="fas fa-desktop"></i>
                        <span>My Device</span>
                    </div>
                </div>
                
                <div class="sources-list">
                    <div class="source-item" onclick="selectSource('dropbox')" data-source="dropbox">
                        <div class="source-icon dropbox">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M7 2L13.5 8.5L7 15" stroke="#0061FF" stroke-width="2" fill="none"/>
                                <path d="M17 9L10.5 2.5L17 16" stroke="#0061FF" stroke-width="2" fill="none"/>
                                <circle cx="7" cy="17" r="2" fill="#0061FF"/>
                                <circle cx="17" cy="7" r="2" fill="#0061FF"/>
                            </svg>
                        </div>
                        <span>Dropbox</span>
                    </div>
                    
                    <div class="source-item" onclick="selectSource('box')" data-source="box">
                        <div class="source-icon box">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <rect x="3" y="3" width="18" height="18" rx="3" fill="#0061D5"/>
                                <rect x="6" y="6" width="12" height="12" rx="2" fill="white"/>
                            </svg>
                        </div>
                        <span>Box</span>
                    </div>
                    
                    <div class="source-item" onclick="selectSource('google-drive')" data-source="google-drive">
                        <div class="source-icon google-drive">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M7.71 6.705L0 6.705L7.59 19h5.48l3.7-6.295L7.71 6.705z" fill="#0066DA"/>
                                <path d="M19.68 6.705L12.97 6.705L6.37 19h5.49l3.7-6.295L19.68 6.705z" fill="#00AC47"/>
                                <path d="M14.15 19L20.76 19L13.17 6.705L7.66 6.705L14.15 19z" fill="#EA4335"/>
                                <path d="M13.97 12.705L20.58 12.705L17.88 19h-5.49l1.58-6.295z" fill="#FBBC04"/>
                            </svg>
                        </div>
                        <span>Google Drive</span>
                    </div>
                    
                    <div class="source-item" onclick="selectSource('onedrive')" data-source="onedrive">
                        <div class="source-icon onedrive">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M7 2C4.79 2 3 3.79 3 6s1.79 4 4 4h10c2.21 0 4-1.79 4-4s-1.79-4-4-4H7z" fill="#0078D4"/>
                                <path d="M7 8c-2.21 0-4 1.79-4 4s1.79 4 4 4h10c2.21 0 4-1.79 4-4s-1.79-4-4-4H7z" fill="#0078D4"/>
                            </svg>
                        </div>
                        <span>OneDrive</span>
                    </div>
                    
                    <div class="source-item" onclick="selectSource('onedrive-business')" data-source="onedrive-business">
                        <div class="source-icon onedrive-business">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M7 2C4.79 2 3 3.79 3 6s1.79 4 4 4h10c2.21 0 4-1.79 4-4s-1.79-4-4-4H7z" fill="#0078D4"/>
                                <path d="M7 8c-2.21 0-4 1.79-4 4s1.79 4 4 4h10c2.21 0 4-1.79 4-4s-1.79-4-4-4H7z" fill="#0078D4"/>
                            </svg>
                        </div>
                        <span>OneDrive Business</span>
                    </div>
                    
                    <div class="source-item" onclick="selectSource('desa-pdrive')" data-source="desa-pdrive">
                        <div class="source-icon desa-pdrive">
                            <img src="/img/img.webp" alt="Desa Pdrive" width="20" height="20" style="border-radius: 50%;">
                        </div>
                        <span>Desa Pdrive</span>
                    </div>
                    
                    <div class="source-item active" onclick="selectSource('link')" data-source="link">
                        <div class="source-icon link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke="#6B7280" stroke-width="2" fill="none"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke="#6B7280" stroke-width="2" fill="none"/>
                            </svg>
                        </div>
                        <span>Link (URL)</span>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="upload-main-content">
                <div class="upload-icon-large">
                    <i class="fas fa-desktop"></i>
                </div>
                
                <div class="upload-drop-zone" id="moreOptionsDropZone">
                    <div class="upload-file-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                            <rect x="3" y="3" width="18" height="18" rx="2" stroke="#9CA3AF" stroke-width="2" fill="none"/>
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="#9CA3AF" stroke-width="2" fill="none"/>
                            <polyline points="14,2 14,8 20,8" stroke="#9CA3AF" stroke-width="2" fill="none"/>
                            <line x1="16" y1="13" x2="8" y2="13" stroke="#9CA3AF" stroke-width="2"/>
                            <line x1="16" y1="17" x2="8" y2="17" stroke="#9CA3AF" stroke-width="2"/>
                            <polyline points="10,9 9,9 8,9" stroke="#9CA3AF" stroke-width="2" fill="none"/>
                        </svg>
                        <div class="plus-icon">+</div>
                    </div>
                    
                    <div class="upload-main-text">Select Files to Upload</div>
                    <div class="upload-sub-text">or Drag and Drop, Copy and Paste Files.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Project Modal -->
    <div class="modal-overlay" id="createProjectModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create new project</h2>
                <button class="modal-close" onclick="closeCreateProjectModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createProjectForm">
                    <div class="form-group">
                        <label for="projectName" class="form-label required">Name</label>
                        <input
                            type="text"
                            id="projectName"
                            name="projectName"
                            class="form-input"
                            placeholder="Enter project name"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="projectCode" class="form-label">Code</label>
                        <input
                            type="text"
                            id="projectCode"
                            name="projectCode"
                            class="form-input"
                            placeholder="Enter project code"
                        >
                    </div>
                    <div class="form-group">
                        <label for="projectTemplate" class="form-label required">Start with...</label>
                        <select id="projectTemplate" name="projectTemplate" class="form-select" required>
                            <option value="blank">Blank project</option>
                            <option value="clone">Clone existing project</option>
                            <optgroup label="Project templates">
                                <option value="template1">Project Template</option>
                                <option value="template2">Synergy Builds</option>
                            </optgroup>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeCreateProjectModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="createProject()" id="createProjectBtn">Create project</button>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div class="modal-overlay" id="createFolderModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Create folder</h2>
                <button class="modal-close" onclick="closeNewFolderModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="createFolderForm">
                    <div class="form-group">
                        <label for="folderName" class="form-label required">Folder name</label>
                        <input
                            type="text"
                            id="folderName"
                            name="folderName"
                            class="form-input"
                            placeholder="Enter folder name"
                            required
                        >
                    </div>
                    <div class="form-group">
                        <label for="folderDescription" class="form-label">Description</label>
                        <input
                            type="text"
                            id="folderDescription"
                            name="folderDescription"
                            class="form-input"
                            placeholder="Enter folder description (optional)"
                        >
                    </div>
                    <div class="form-group">
                        <label for="folderType" class="form-label">Folder type</label>
                        <select id="folderType" name="folderType" class="form-select">
                            <option value="general">General</option>
                            <option value="plans">Plans</option>
                            <option value="specifications">Specifications</option>
                            <option value="photos">Photos</option>
                            <option value="documents">Documents</option>
                            <option value="forms">Forms</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeNewFolderModal()">Cancel</button>
                <button type="button" class="btn-primary" onclick="createFolder()" id="createFolderBtn">Create folder</button>
            </div>
        </div>
    </div>

    <!-- File Viewer Modal -->
    <div class="modal-overlay" id="fileViewerModal">
        <div class="modal file-viewer-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="fileViewerTitle">View File</h2>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <button class="btn-secondary" onclick="downloadCurrentFile()" style="padding: 8px 16px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button class="modal-close" onclick="closeFileViewer()">&times;</button>
                </div>
            </div>
            <div class="modal-body" style="padding: 0; height: 70vh; overflow: auto;">
                <div id="fileViewerContent" style="width: 100%; height: 100%; background: white;">
                    <!-- Professional PDF Viewer -->
                    <div class="professional-pdf-viewer">
                        <div class="pdf-document-container">
                            <div id="pdfIframeContainer" style="width: 100%; height: 100%; border: none;">
                                <!-- PDF iframe will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Folder Viewer Modal -->
    <div class="modal-overlay" id="folderViewerModal">
        <div class="modal folder-viewer-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="folderViewerTitle">Folder Contents</h2>
                <button class="modal-close" onclick="closeFolderViewer()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="folderViewerContent" class="plans-grid">
                    <!-- Folder contents will be loaded here -->
                </div>
                <div id="folderEmptyState" class="empty-state" style="display: none; height: 40vh;">
                    <div class="empty-state-icon" style="width: 80px; height: 80px;">
                        <i class="fas fa-folder-open" style="font-size: 40px; color: #9CA3AF;"></i>
                    </div>
                    <h3 style="color: #6B7280; margin-bottom: 8px;">This folder is empty</h3>
                    <p style="color: #9CA3AF;">Upload files to this folder to get started.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn-secondary" onclick="closeFolderViewer()">Close</button>
            </div>
        </div>
    </div>

    <!-- Chat Widget -->
    <div class="chat-widget">
        <i class="fas fa-comment"></i>
    </div>

    <script>
        // ============================================
        // CACHE BUSTER VERSION: <%= new Date().toISOString() %>
        // ============================================
        console.log('%c ========================================', 'color: red; font-weight: bold; font-size: 20px;');
        console.log('%c PROJECT-VIEW.EJS LOADED - VERSION: 2024-FIXED', 'color: green; font-weight: bold; font-size: 16px;');
        console.log('%c Cache Buster: <%= Date.now() %>', 'color: blue; font-size: 14px;');
        console.log('%c ========================================', 'color: red; font-weight: bold; font-size: 20px;');

        // If you DO NOT see the messages above in RED/GREEN/BLUE, your browser is loading CACHED code!

        // Global variables for notifications
        let notifications = [];

        // Global variables for plans management
        let selectedPlans = [];

        // Notification System
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 10001;
                font-weight: 600;
                font-size: 14px;
                max-width: 400px;
                animation: slideIn 0.3s ease-out;
            `;

            // Set colors based on type
            switch(type) {
                case 'success':
                    notification.style.background = '#10B981';
                    notification.style.color = 'white';
                    break;
                case 'error':
                    notification.style.background = '#EF4444';
                    notification.style.color = 'white';
                    break;
                case 'warning':
                    notification.style.background = '#F59E0B';
                    notification.style.color = 'white';
                    break;
                case 'info':
                default:
                    notification.style.background = '#3B82F6';
                    notification.style.color = 'white';
                    break;
            }

            notification.textContent = message;
            document.body.appendChild(notification);

            // Auto remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Load notifications from API
        async function loadNotifications() {
            try {
                const response = await fetch('/notifications/api/notifications');
                const result = await response.json();

                if (result.status === 'success') {
                    notifications = result.data;
                    updateNotificationBadge(result.unreadCount);
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Render notifications
        function renderNotifications() {
            const notificationsList = document.getElementById('notificationsList');
            const notificationBadge = document.getElementById('notificationBadge');

            const unreadCount = notifications.filter(n => n.unread).length;

            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = 'block';
            } else {
                notificationBadge.style.display = 'none';
            }

            if (notifications.length === 0) {
                notificationsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-text">No notifications</div>
                    </div>
                `;
                return;
            }

            notificationsList.innerHTML = notifications.map(notification => `
                <div class="notification-item ${notification.unread ? 'unread' : ''}" onclick="markAsRead(${notification.id})">
                    <div class="notification-header">
                        ${notification.unread ? '<div class="notification-icon-circle"></div>' : ''}
                        <div class="notification-content">
                            <div class="notification-title">${notification.title}</div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${notification.time}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Mark notification as read
        function markAsRead(id) {
            const notification = notifications.find(n => n.id === id);
            if (notification) {
                notification.unread = false;
                renderNotifications();
            }
        }

        // Update notification badge
        function updateNotificationBadge(count) {
            const badge = document.getElementById('notificationBadge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        // Add interactivity
        document.addEventListener('DOMContentLoaded', function() {
            // Hamburger menu toggle functionality
            const hamburgerMenu = document.getElementById('hamburgerMenu');
            const sidebar = document.querySelector('.sidebar');
            const mainContent = document.querySelector('.main-content');

            if (hamburgerMenu && sidebar && mainContent) {
                hamburgerMenu.addEventListener('click', function(e) {
                    e.preventDefault();
                    sidebar.classList.toggle('collapsed');
                    mainContent.classList.toggle('sidebar-collapsed');
                });
            } else {
                console.error('Could not find required elements for hamburger menu');
            }

            // Load notifications
            loadNotifications();

            // Navigation items - Plans stays on page, others navigate
            const navItems = document.querySelectorAll('.nav-item');
            const baseProjectName = <%- JSON.stringify(projectName || "Project") %>;
            const plansNavItem = document.getElementById('plansNavItem');
            const tasksSection = document.getElementById('tasksSection');

            // Plans item - toggle tasks section without navigation
            if (plansNavItem) {
                plansNavItem.addEventListener('click', function(e) {
                    e.preventDefault();

                    // Toggle Tasks section visibility
                    if (tasksSection.style.display === 'none' || tasksSection.style.display === '') {
                        tasksSection.style.display = 'block';
                    } else {
                        tasksSection.style.display = 'none';
                    }
                });
            }

            // Search functionality
            const searchBar = document.querySelector('.search-bar');
            searchBar.addEventListener('focus', function() {
                this.style.outline = 'none';
                this.style.border = '2px solid #3F80EA';
            });

            searchBar.addEventListener('blur', function() {
                this.style.border = 'none';
            });

            // Button hover effects
            const buttons = document.querySelectorAll('.btn');
            buttons.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px)';
                });
                
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });

            // Chat widget
            const chatWidget = document.querySelector('.chat-widget');
            chatWidget.addEventListener('click', function() {
                alert('Chat widget clicked!');
            });

            // Panel toggles
            const notificationBell = document.getElementById('notificationBell');
            const notificationPanel = document.getElementById('notificationPanel');
            const helpIcon = document.getElementById('helpIcon');
            const helpPanel = document.getElementById('helpPanel');
            const userDropdownToggle = document.getElementById('userDropdownToggle');
            const userDropdown = document.getElementById('userDropdown');

            if (notificationBell) {
                notificationBell.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const panel = notificationPanel;

                    helpPanel.classList.remove('show');
                    userDropdown.classList.remove('show');

                    if (panel) {
                        panel.classList.toggle('show');
                        if (panel.classList.contains('show')) {
                            renderNotifications();
                        }
                    }
                });
            }

            if (helpIcon) {
                helpIcon.addEventListener('click', function(e) {
                    e.stopPropagation();
                    helpPanel.classList.toggle('show');
                    notificationPanel.classList.remove('show');
                    userDropdown.classList.remove('show');
                });
            }

            if (userDropdownToggle) {
                userDropdownToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    userDropdown.classList.toggle('show');
                    notificationPanel.classList.remove('show');
                    helpPanel.classList.remove('show');
                });
            }

            // Mark all as read
            document.getElementById('markAllRead').addEventListener('click', function() {
                notifications.forEach(n => n.unread = false);
                renderNotifications();
            });

            // Project dropdown toggle
            const projectDropdownToggle = document.getElementById('projectDropdownToggle');
            const projectDropdownPanel = document.getElementById('projectDropdownPanel');
            const projectDropdown = document.getElementById('projectDropdown');
            const projectSearchInput = document.getElementById('projectSearchInput');

            if (projectDropdownToggle && projectDropdownPanel) {
                projectDropdownToggle.addEventListener('click', function(e) {
                    e.stopPropagation();
                    projectDropdownPanel.classList.toggle('show');

                    // Close other panels
                    if (notificationPanel) notificationPanel.classList.remove('show');
                    if (helpPanel) helpPanel.classList.remove('show');
                    if (userDropdown) userDropdown.classList.remove('show');

                    // Focus search input when dropdown opens
                    if (projectDropdownPanel.classList.contains('show') && projectSearchInput) {
                        setTimeout(() => projectSearchInput.focus(), 100);
                    }
                });

                // Prevent closing when clicking inside the dropdown
                projectDropdown.addEventListener('click', function(e) {
                    e.stopPropagation();
                });
            }

            // Project search functionality
            if (projectSearchInput) {
                projectSearchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const projectItems = document.querySelectorAll('.project-item');
                    const noProjectsFound = document.getElementById('noProjectsFound');
                    let visibleCount = 0;

                    projectItems.forEach(function(item) {
                        const projectName = item.getAttribute('data-project-name') || '';
                        const projectType = item.getAttribute('data-project-type') || '';

                        if (projectName.includes(searchTerm) || projectType.includes(searchTerm)) {
                            item.style.display = 'flex';
                            visibleCount++;
                        } else {
                            item.style.display = 'none';
                        }
                    });

                    // Show/hide "no results" message
                    if (visibleCount === 0 && searchTerm !== '') {
                        noProjectsFound.style.display = 'block';
                    } else {
                        noProjectsFound.style.display = 'none';
                    }
                });

                // Clear search when dropdown closes
                document.addEventListener('click', function() {
                    if (projectSearchInput && !projectDropdownPanel.classList.contains('show')) {
                        projectSearchInput.value = '';
                        // Reset all project items visibility
                        const projectItems = document.querySelectorAll('.project-item');
                        projectItems.forEach(item => item.style.display = 'flex');
                        document.getElementById('noProjectsFound').style.display = 'none';
                    }
                });
            }

            // Close panels when clicking outside
            document.addEventListener('click', function() {
                if (notificationPanel) notificationPanel.classList.remove('show');
                if (helpPanel) helpPanel.classList.remove('show');
                if (userDropdown) userDropdown.classList.remove('show');
                if (projectDropdownPanel) projectDropdownPanel.classList.remove('show');
            });
        });

        // Function to open new project modal
        function openNewProjectModal() {
            const modal = document.getElementById('createProjectModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Focus on the first input
            setTimeout(() => {
                document.getElementById('projectName').focus();
            }, 100);
        }

        // Close create project modal
        function closeCreateProjectModal() {
            const modal = document.getElementById('createProjectModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';

            // Reset form
            document.getElementById('createProjectForm').reset();
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('createProjectModal');
            if (e.target === modal) {
                closeCreateProjectModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('createProjectModal');
                if (modal.classList.contains('show')) {
                    closeCreateProjectModal();
                }
            }
        });

        // Create project function
        async function createProject() {
            const projectName = document.getElementById('projectName').value.trim();
            const projectCode = document.getElementById('projectCode').value.trim();
            const projectTemplate = document.getElementById('projectTemplate').value;

            // Validation
            if (!projectName) {
                alert('Please enter a project name');
                document.getElementById('projectName').focus();
                return;
            }

            // Show loading state
            const createBtn = document.getElementById('createProjectBtn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'Creating...';
            createBtn.disabled = true;

            try {
                const response = await fetch('/create-project', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: projectName,
                        code: projectCode,
                        template: projectTemplate
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #48bb78;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                        z-index: 10001;
                        font-weight: 600;
                    `;
                    notification.textContent = 'Project created successfully!';
                    document.body.appendChild(notification);

                    setTimeout(() => {
                        notification.remove();
                    }, 3000);

                    // Close modal
                    closeCreateProjectModal();

                    // Redirect to the main projects page to see the new project
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    alert('Failed to create project: ' + result.message);
                }
            } catch (error) {
                console.error('Error creating project:', error);
                alert('An error occurred while creating the project. Please try again.');
            } finally {
                // Reset button state
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            }
        }

        // Sign out functionality
        async function signOut() {
            try {
                // Show loading state
                const signOutBtn = document.querySelector('a[onclick="signOut()"]');
                const originalText = signOutBtn.textContent;
                signOutBtn.textContent = 'Signing out...';
                signOutBtn.style.pointerEvents = 'none';

                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success === true) {
                    // Show success notification
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #48bb78;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = 'Signed out successfully!';
                    document.body.appendChild(notification);

                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                } else {
                    // Show error message
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #f56565;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = 'Sign out failed. Please try again.';
                    document.body.appendChild(notification);

                    // Reset button
                    signOutBtn.textContent = originalText;
                    signOutBtn.style.pointerEvents = 'auto';

                    // Remove notification after 3 seconds
                    setTimeout(() => {
                        notification.remove();
                    }, 3000);
                }

            } catch (error) {
                console.error('Sign out error:', error);

                // Show error message
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #f56565;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
                    z-index: 10000;
                    font-weight: 600;
                `;
                notification.textContent = 'Connection error. Please try again.';
                document.body.appendChild(notification);

                // Reset button
                const signOutBtn = document.querySelector('a[onclick="signOut()"]');
                signOutBtn.textContent = 'Sign out';
                signOutBtn.style.pointerEvents = 'auto';

                // Remove notification after 3 seconds
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Edit profile link functionality
        document.addEventListener('DOMContentLoaded', function() {
            const editProfileLink = document.getElementById('editProfileLink');
            if (editProfileLink) {
                editProfileLink.addEventListener('click', function(e) {
                    e.preventDefault();
                    window.location.href = '/account';
                });
            }
        });

        // New Folder Modal Functions
        function openNewFolderModal() {
            const modal = document.getElementById('createFolderModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

            // Focus on the first input
            setTimeout(() => {
                document.getElementById('folderName').focus();
            }, 100);
        }

        function closeNewFolderModal() {
            const modal = document.getElementById('createFolderModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';

            // Reset form
            document.getElementById('createFolderForm').reset();
        }

        async function createFolder() {
            const folderName = document.getElementById('folderName').value.trim();
            const folderDescription = document.getElementById('folderDescription').value.trim();
            const folderType = document.getElementById('folderType').value;

            // Validation
            if (!folderName) {
                alert('Please enter a folder name');
                document.getElementById('folderName').focus();
                return;
            }

            // Show loading state
            const createBtn = document.getElementById('createFolderBtn');
            const originalText = createBtn.textContent;
            createBtn.textContent = 'Creating...';
            createBtn.disabled = true;

            try {
                // TODO: Replace with actual API endpoint when available
                // For now, simulate folder creation with a delay
                await new Promise(resolve => setTimeout(resolve, 1500));

                // Show success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #48bb78;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                    z-index: 10001;
                    font-weight: 600;
                `;
                notification.textContent = `Folder "${folderName}" created successfully!`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);

                // Close modal
                closeNewFolderModal();

            } catch (error) {
                console.error('Error creating folder:', error);
                alert('An error occurred while creating the folder. Please try again.');
            } finally {
                // Reset button state
                createBtn.textContent = originalText;
                createBtn.disabled = false;
            }
        }

        // Close New Folder modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('createFolderModal');
            if (e.target === modal) {
                closeNewFolderModal();
            }
        });

        // Close New Folder modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('createFolderModal');
                if (modal.classList.contains('show')) {
                    closeNewFolderModal();
                }
            }
        });

        // File Upload Modal Functionality
        let selectedFiles = [];

        // Open upload modal
        function openUploadModal(targetFolderId = null) {
            const modal = document.getElementById('uploadModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            setupDragAndDrop();
            
            // Store target folder for upload
            modal.dataset.targetFolder = targetFolderId || 'all-plans-folder';
        }

        // Close upload modal
        function closeUploadModal() {
            const modal = document.getElementById('uploadModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            selectedFiles = [];

            // Reset file inputs
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.value = '';
            }

            const folderInput = document.getElementById('folderInput');
            if (folderInput) {
                folderInput.value = '';
            }

            // Clear file list if it exists
            const fileList = document.getElementById('fileList');
            if (fileList) {
                fileList.innerHTML = '';
            }
        }

        // Setup drag and drop
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');

            if (!uploadArea) return;

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('drag-over');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('drag-over');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('drag-over');

                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }

        // Handle file selection from input
        function handleFileSelect(event) {
            const files = Array.from(event.target.files);
            handleFiles(files);
        }

        // Handle files (from drag-drop or file input)
        function handleFiles(files) {
            files.forEach(file => {
                // Check if file already exists
                const exists = selectedFiles.some(f => f.name === file.name && f.size === file.size);
                if (!exists) {
                    selectedFiles.push(file);
                }
            });
            displayFiles();
        }

        // Display selected files
        function displayFiles() {
            const fileList = document.getElementById('fileList');
            if (!fileList) {
                console.error('fileList element not found');
                return;
            }

            fileList.innerHTML = '';

            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';

            selectedFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';

                const fileExtension = String(file.name.split('.').pop() || '').toUpperCase().replace(/[^A-Z0-9]/g, '');
                const fileSize = formatFileSize(file.size);

                fileItem.innerHTML = `
                    <div class="file-item-info">
                        <div class="file-item-icon">
                            <i class="fas fa-file"></i>
                        </div>
                        <div class="file-item-details">
                            <div class="file-item-name">${file.name}</div>
                            <div class="file-item-size">${fileSize}  ${fileExtension}</div>
                        </div>
                    </div>
                    <button class="file-item-remove" onclick="removeFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                fileList.appendChild(fileItem);
            });
        }

        // Remove file from selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            displayFiles();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Upload files
        async function uploadFiles() {
            if (selectedFiles.length === 0) {
                alert('Please select files to upload');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            uploadBtn.disabled = true;

            try {
                // Get target folder from modal
                const modal = document.getElementById('uploadModal');
                const targetFolderId = modal.dataset.targetFolder || 'all-plans-folder';

                // Save plans to localStorage with file URLs
                // Use FileReader for files under 10MB to persist in localStorage
                const filePromises = selectedFiles.map(file => {
                    return new Promise((resolve) => {
                        const fileId = Date.now().toString() + Math.random().toString(36).substr(2, 9);

                        // For files under 10MB, create a persistent data URL
                        if (file.size < 10 * 1024 * 1024) {
                            const reader = new FileReader();

                            reader.onload = function(e) {
                                const dataURL = e.target.result;

                    const newPlan = {
                                    id: fileId,
                        name: file.name,
                        size: formatFileSize(file.size),
                        type: file.type,
                                    preview: dataURL,
                                    url: dataURL,
                        folderId: targetFolderId,
                        createdAt: new Date().toISOString()
                    };

                    plansData.push(newPlan);
                                resolve();
                            };

                            reader.readAsDataURL(file);
                        } else {
                            // For larger files, use blob URL (won't persist after refresh)
                            const fileURL = URL.createObjectURL(file);

                            const newPlan = {
                                id: fileId,
                                name: file.name,
                                size: formatFileSize(file.size),
                                type: file.type,
                                preview: fileURL,
                                url: fileURL,
                                folderId: targetFolderId,
                                createdAt: new Date().toISOString()
                            };

                            plansData.push(newPlan);
                            resolve();
                        }
                    });
                });

                // Wait for all files to be processed
                await Promise.all(filePromises);

                // Try to save to localStorage with quota handling
                try {
                    localStorage.setItem('plansData_' + '<%= project.id %>', JSON.stringify(plansData));
                } catch (e) {
                    if (e.name === 'QuotaExceededError') {
                        console.warn('LocalStorage quota exceeded. Storing only metadata without base64 data.');
                        // Save without the large base64 data
                        const lightweightPlans = plansData.map(plan => ({
                            ...plan,
                            data: plan.data ? plan.data.substring(0, 100) + '...[truncated]' : plan.data
                        }));
                        try {
                            localStorage.setItem('plansData_' + '<%= project.id %>', JSON.stringify(lightweightPlans));
                        } catch (e2) {
                            console.error('Failed to save even lightweight data:', e2);
                            alert('Warning: Unable to persist files locally due to storage limits. Files will be lost on page refresh.');
                        }
                    }
                }

                // Reload plans display
                loadPlans();

                // Show success notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10B981;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    z-index: 10001;
                    font-weight: 600;
                `;
                notification.textContent = `${selectedFiles.length} plan(s) uploaded successfully!`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);

                // Close modal
                closeUploadModal();

            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload files. Please try again.');
            } finally {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        }

        // Integration connection function
        function connectIntegration(integration) {
            // Integration URLs
            const integrationUrls = {
                'google-drive': 'https://drive.google.com/',
                'sharepoint': 'https://www.microsoft.com/en-us/microsoft-365/sharepoint/collaboration',
                'dropbox': 'https://www.dropbox.com/',
                'box': 'https://www.box.com/',
                'onedrive': 'https://onedrive.live.com/',
                'desa-pdrive': '#' // Replace with actual Desa Pdrive URL when available
            };

            const url = integrationUrls[integration];

            if (url && url !== '#') {
                // Open the integration service in a new tab
                window.open(url, '_blank');
            } else if (integration === 'desa-pdrive') {
                // Show notification for Desa Pdrive (not yet available)
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #3F80EA;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(63, 128, 234, 0.3);
                    z-index: 10001;
                    font-weight: 600;
                `;
                notification.textContent = 'Desa Pdrive integration coming soon!';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        // Plans and Folders Management
        let plansData = [];
        let foldersData = [];

        // Load data from database via API
        async function loadDataFromDB() {
            try {
                const projectId = <%- JSON.stringify(project.id) %>;

                // Load folders
                const foldersResponse = await fetch(`/api/folders?projectId=${projectId}`);
                const foldersResult = await foldersResponse.json();
                foldersData = foldersResult.success ? foldersResult.folders : [];

                // Load plans
                const plansResponse = await fetch(`/api/plans?projectId=${projectId}`);
                const plansResult = await plansResponse.json();
                plansData = plansResult.success ? plansResult.plans : [];

                // Initialize "All plans" folder if it doesn't exist
                await initializeAllPlansFolder();

                // Load the plans display
                loadPlans();
            } catch (error) {
                console.error('Error loading data:', error);
                showNotification('Error loading data from server', 'error');
            }
        }

        // Initialize "All plans" folder if it doesn't exist
        async function initializeAllPlansFolder() {
            const projectId = <%- JSON.stringify(project.id) %>;
            const allPlansFolder = foldersData.find(f => f.name === 'All plans');
            if (!allPlansFolder) {
                try {
                    const response = await fetch('/api/folders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            name: 'All plans',
                            projectId: projectId,
                            color: '#3b82f6',
                            icon: 'folder'
                        })
                    });
                    const result = await response.json();
                    if (result.success) {
                        foldersData.unshift(result.folder);
                    }
                } catch (error) {
                    console.error('Error creating All plans folder:', error);
                }
            }
        }

        // Initialize on page load
        loadDataFromDB();

        // Helper function to update folder counts
        function updateFolderCounts() {
            foldersData.forEach(folder => {
                const count = plansData.filter(p => p.folderId === folder.id).length;
                folder.itemCount = count;
            });
            // No need to save - counts are calculated on the fly
        }

        // Helper function to generate plan HTML
        function generatePlanHTML(plan) {
            const fileExt = String(plan.name.split('.').pop() || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            let previewHTML = '';

            if (plan.preview) {
                previewHTML = `<img src="${plan.preview}" alt="${plan.name}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                let iconHTML = '';
                if (fileExt === 'pdf') {
                    // Professional PDF document preview
                    iconHTML = `
                        <div class="pdf-document-preview" style="width: 100%; height: 100%; background: white; border: 1px solid #e5e7eb; border-radius: 4px; padding: 8px; font-family: Arial, sans-serif; font-size: 8px; line-height: 1.2; overflow: hidden; position: relative; display: block;">
                            <div class="pdf-doc-header" style="border-bottom: 1px solid #d1d5db; padding-bottom: 4px; margin-bottom: 6px;">
                                <div class="pdf-doc-title" style="font-weight: bold; font-size: 9px; color: #1f2937; text-transform: uppercase; letter-spacing: 0.5px;">DOCUMENT RECORD</div>
                                <div class="pdf-doc-subtitle" style="font-size: 7px; color: #6b7280; margin-top: 1px;">Technical Specification</div>
                            </div>
                            <div class="pdf-doc-content" style="flex: 1;">
                                <div class="pdf-doc-section" style="margin-bottom: 4px;">
                                    <div class="pdf-doc-field" style="display: flex; margin-bottom: 2px;">
                                        <span class="pdf-label" style="font-weight: bold; color: #374151; min-width: 25px; font-size: 7px;">DATE:</span>
                                        <span class="pdf-value" style="color: #1f2937; font-size: 7px; margin-left: 4px;">${new Date().toLocaleDateString()}</span>
                                    </div>
                                    <div class="pdf-doc-field" style="display: flex; margin-bottom: 2px;">
                                        <span class="pdf-label" style="font-weight: bold; color: #374151; min-width: 25px; font-size: 7px;">REFERENCE:</span>
                                        <span class="pdf-value" style="color: #1f2937; font-size: 7px; margin-left: 4px;">DOC-001</span>
                                    </div>
                                </div>
                                <div class="pdf-doc-section" style="margin-bottom: 4px;">
                                    <div class="pdf-doc-field" style="display: flex; margin-bottom: 2px;">
                                        <span class="pdf-label" style="font-weight: bold; color: #374151; min-width: 25px; font-size: 7px;">TO:</span>
                                        <span class="pdf-value" style="color: #1f2937; font-size: 7px; margin-left: 4px;">Project Manager</span>
                                    </div>
                                    <div class="pdf-doc-field" style="display: flex; margin-bottom: 2px;">
                                        <span class="pdf-label" style="font-weight: bold; color: #374151; min-width: 25px; font-size: 7px;">FROM:</span>
                                        <span class="pdf-value" style="color: #1f2937; font-size: 7px; margin-left: 4px;">Design Team</span>
                                    </div>
                                </div>
                                <div class="pdf-doc-table" style="border: 1px solid #d1d5db; border-radius: 2px; margin-top: 4px;">
                                    <div class="pdf-table-header" style="background: #f9fafb; border-bottom: 1px solid #d1d5db; display: flex; font-weight: bold; font-size: 6px;">
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1; border-right: 1px solid #f3f4f6;">Item</div>
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1; border-right: 1px solid #f3f4f6;">Description</div>
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1;">Status</div>
                                    </div>
                                    <div class="pdf-table-row" style="display: flex; border-bottom: 1px solid #f3f4f6;">
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1; border-right: 1px solid #f3f4f6;">A1</div>
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1; border-right: 1px solid #f3f4f6;">Foundation Plan</div>
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1;"></div>
                                    </div>
                                    <div class="pdf-table-row" style="display: flex;">
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1; border-right: 1px solid #f3f4f6;">A2</div>
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1; border-right: 1px solid #f3f4f6;">Floor Plan</div>
                                        <div class="pdf-table-cell" style="padding: 2px 4px; font-size: 6px; color: #374151; flex: 1;"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="pdf-doc-footer" style="position: absolute; bottom: 4px; right: 8px;">
                                <div class="pdf-doc-number" style="font-size: 8px; color: #6b7280; font-weight: bold;">1</div>
                            </div>
                        </div>
                    `;
                } else if (['doc', 'docx'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-word" style="font-size: 48px; color: #2B579A;"></i>';
                } else if (['xls', 'xlsx'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-excel" style="font-size: 48px; color: #217346;"></i>';
                } else if (['ppt', 'pptx'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-powerpoint" style="font-size: 48px; color: #D24726;"></i>';
                } else if (['zip', 'rar', '7z'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-archive" style="font-size: 48px; color: #F59E0B;"></i>';
                } else if (['jpg', 'jpeg', 'png', 'gif', 'svg'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-image" style="font-size: 48px; color: #8B5CF6;"></i>';
                } else if (['mp4', 'mov', 'avi', 'mkv'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-video" style="font-size: 48px; color: #EC4899;"></i>';
                } else if (['mp3', 'wav', 'flac'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-audio" style="font-size: 48px; color: #14B8A6;"></i>';
                } else if (['txt', 'md', 'json', 'xml'].includes(fileExt)) {
                    iconHTML = '<i class="fas fa-file-code" style="font-size: 48px; color: #3B82F6;"></i>';
                } else {
                    iconHTML = '<i class="fas fa-file" style="font-size: 48px; color: #9CA3AF;"></i>';
                }
                previewHTML = `<div class="plan-preview-icon">${iconHTML}</div>`;
            }

            const safePlanId = String(plan.id).replace(/'/g, "\\'").replace(/"/g, '\\"');
            const isPlanSelected = selectedPlans.includes(plan.id);
            const escapedPlanId = String(plan.id).replace(/\\/g, '\\\\').replace(/'/g, "\\'");
            const safePlanName = String(plan.name).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');

            return `
                <div class="plan-item ${isPlanSelected ? 'selected' : ''}" data-plan-id="${safePlanId}">
                    <div class="plan-checkbox" onclick="event.stopPropagation(); togglePlanSelection('${escapedPlanId}')">
                        <input type="checkbox" id="plan-checkbox-${safePlanId}" name="plan-checkbox-${safePlanId}" ${isPlanSelected ? 'checked' : ''} onchange="event.stopPropagation();">
                    </div>
                    <div class="plan-content" onclick="openPlan('${escapedPlanId}')">
                        <div class="plan-preview">
                            ${previewHTML}
                        </div>
                        <div class="plan-name">${safePlanName}</div>
                        <div class="plan-meta">${plan.size || 'Unknown size'}</div>
                    </div>
                </div>
            `;
        }

        // Folder dropdown management
        function toggleFolderDropdown(folderId) {
            // Close all other dropdowns
            document.querySelectorAll('.folder-dropdown-menu').forEach(menu => {
                if (menu.id !== `dropdown-${folderId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle current dropdown
            const dropdown = document.getElementById(`dropdown-${folderId}`);
            dropdown.classList.toggle('show');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.folder-dropdown')) {
                document.querySelectorAll('.folder-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Rename folder function
        function renameFolder(folderId) {
            const folder = foldersData.find(f => f.id === folderId);
            if (!folder) return;

            const newName = prompt('Enter new folder name:', folder.name);
            if (newName && newName.trim() && newName.trim() !== folder.name) {
                folder.name = newName.trim();
                localStorage.setItem('foldersData_' + '<%= project.id %>', JSON.stringify(foldersData));
                loadPlans();
                showNotification('Folder renamed successfully', 'success');
            }
        }

        // Delete folder function
        function deleteFolder(folderId) {
            const folder = foldersData.find(f => f.id === folderId);
            if (!folder) return;

            // Don't allow deleting "All plans" folder
            if (folder.name === 'All plans') {
                showNotification('Cannot delete the "All plans" folder', 'error');
                return;
            }

            const folderPlans = plansData.filter(p => p.folderId === folderId);
            const confirmMessage = folderPlans.length > 0 
                ? `Are you sure you want to delete "${folder.name}"? This will also delete ${folderPlans.length} plan(s) in this folder.`
                : `Are you sure you want to delete "${folder.name}"?`;

            if (confirm(confirmMessage)) {
                // Move plans to "All plans" folder
                const allPlansFolder = foldersData.find(f => f.name === 'All plans');
                if (allPlansFolder && folderPlans.length > 0) {
                    folderPlans.forEach(plan => {
                        plan.folderId = allPlansFolder.id;
                    });
                    localStorage.setItem('plansData_' + '<%= project.id %>', JSON.stringify(plansData));
                }

                // Delete folder
                foldersData = foldersData.filter(f => f.id !== folderId);
                localStorage.setItem('foldersData_' + '<%= project.id %>', JSON.stringify(foldersData));
                loadPlans();
                showNotification('Folder deleted successfully', 'success');
            }
        }

        // Load and display plans/folders on page load
        function loadPlans() {
            const plansContainer = document.getElementById('plansContainer');
            const emptyState = document.getElementById('emptyState');

            // Ensure we always have at least the "All plans" folder
            if (foldersData.length === 0) {
                foldersData = [{
                    id: 'all-plans-folder',
                    name: 'All plans',
                    itemCount: 0,
                    created: new Date().toISOString()
                }];
            }

            // Update folder counts
            updateFolderCounts();

            // Hide empty state
            emptyState.classList.remove('show');

            let html = '';

            // Get the "All plans" folder
            const allPlansFolder = foldersData.find(f => f.name === 'All plans');

            if (allPlansFolder) {
                const allPlansFolderPlans = plansData.filter(p => p.folderId === allPlansFolder.id);

                // Display plans in "All plans" folder
                allPlansFolderPlans.forEach(plan => {
                    html += generatePlanHTML(plan);
                });
            }


            plansContainer.innerHTML = html;

            // Show empty state if no content
            if (plansData.length === 0 && foldersData.filter(f => f.name !== 'All plans').length === 0) {
                emptyState.classList.add('show');
            }
        }

        // Selection management functions
        function togglePlanSelection(planId) {
            const index = selectedPlans.indexOf(planId);
            if (index > -1) {
                selectedPlans.splice(index, 1);
            } else {
                selectedPlans.push(planId);
            }
            loadPlans();
            updateSelectionUI();
        }

        function selectAllPlans() {
            selectedPlans = plansData.map(p => p.id);
            loadPlans();
            updateSelectionUI();
        }

        function deselectAllPlans() {
            selectedPlans = [];
            loadPlans();
            updateSelectionUI();
        }

        function deleteSelectedPlans() {
            if (selectedPlans.length === 0) {
                alert('Please select files to delete');
                return;
            }

            if (confirm(`Delete ${selectedPlans.length} selected file(s)?`)) {
                plansData = plansData.filter(p => !selectedPlans.includes(p.id));
                localStorage.setItem('plansData_' + '<%= project.id %>', JSON.stringify(plansData));
                selectedPlans = [];
                loadPlans();
                updateSelectionUI();

                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10B981;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    z-index: 10001;
                    font-weight: 600;
                `;
                notification.textContent = 'Selected files deleted successfully!';
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }
        }

        function updateSelectionUI() {
            const selectionCount = document.getElementById('selectionCount');
            const bulkActions = document.getElementById('bulkActions');
            const actionBadge = document.getElementById('actionBadge');

            if (selectedPlans.length > 0) {
                if (selectionCount) selectionCount.textContent = `${selectedPlans.length} selected`;
                if (bulkActions) bulkActions.style.display = 'flex';
                if (actionBadge) {
                    actionBadge.textContent = selectedPlans.length;
                    actionBadge.style.display = 'flex';
                }
            } else {
                if (bulkActions) bulkActions.style.display = 'none';
                if (actionBadge) actionBadge.style.display = 'none';
            }
        }

        // Filter and Search Functions
        let currentView = 'grid'; // 'grid' or 'list'

        function toggleFilterDropdown() {
            const dropdown = document.getElementById('filterDropdown');
            dropdown.classList.toggle('show');
        }

        function toggleFileTypeFilter(checkbox) {
            if (checkbox.value === 'all') {
                const allCheckboxes = document.querySelectorAll('.filter-option input[type="checkbox"]');
                allCheckboxes.forEach(cb => {
                    if (cb.value !== 'all') {
                        cb.checked = false;
                    }
                });
            } else {
                const allCheckbox = document.querySelector('.filter-option input[value="all"]');
                if (allCheckbox) allCheckbox.checked = false;
            }
            applyFilters();
        }

        function applyFilters() {
            const searchInput = document.getElementById('searchInput');
            const sortSelect = document.getElementById('sortSelect');

            if (!searchInput || !sortSelect) return;

            const searchTerm = searchInput.value.toLowerCase();
            const sortBy = sortSelect.value;

            // Get selected file types
            const fileTypeCheckboxes = document.querySelectorAll('.filter-option input[type="checkbox"]:checked');
            const selectedTypes = Array.from(fileTypeCheckboxes).map(cb => cb.value);
            const showAll = selectedTypes.includes('all') || selectedTypes.length === 0;

            // Filter plans
            let filteredPlans = plansData.filter(plan => {
                // Search filter
                const matchesSearch = plan.name.toLowerCase().includes(searchTerm);

                // File type filter
                let matchesType = showAll;
                if (!showAll) {
                    const fileExt = String(plan.name.split('.').pop() || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                    if (selectedTypes.includes('pdf') && fileExt === 'pdf') matchesType = true;
                    if (selectedTypes.includes('image') && ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(fileExt)) matchesType = true;
                    if (selectedTypes.includes('document') && ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt', 'md'].includes(fileExt)) matchesType = true;
                }

                return matchesSearch && matchesType;
            });

            // Filter folders
            let filteredFolders = foldersData.filter(folder => {
                const matchesSearch = folder.name.toLowerCase().includes(searchTerm);
                const matchesType = showAll || selectedTypes.includes('folder');
                return matchesSearch && matchesType;
            });

            // Sort
            filteredPlans = sortItems(filteredPlans, sortBy);
            filteredFolders = sortItems(filteredFolders, sortBy);

            // Display filtered and sorted results
            displayFilteredResults(filteredFolders, filteredPlans);
        }

        function sortItems(items, sortBy) {
            const sorted = [...items];

            switch(sortBy) {
                case 'name-asc':
                    sorted.sort((a, b) => a.name.localeCompare(b.name));
                    break;
                case 'name-desc':
                    sorted.sort((a, b) => b.name.localeCompare(a.name));
                    break;
                case 'date-asc':
                    sorted.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt));
                    break;
                case 'date-desc':
                    sorted.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    break;
                case 'size-asc':
                    sorted.sort((a, b) => {
                        const sizeA = parseSizeToBytes(a.size || '0');
                        const sizeB = parseSizeToBytes(b.size || '0');
                        return sizeA - sizeB;
                    });
                    break;
                case 'size-desc':
                    sorted.sort((a, b) => {
                        const sizeA = parseSizeToBytes(a.size || '0');
                        const sizeB = parseSizeToBytes(b.size || '0');
                        return sizeB - sizeA;
                    });
                    break;
            }

            return sorted;
        }

        function parseSizeToBytes(sizeStr) {
            const units = { 'B': 1, 'KB': 1024, 'MB': 1024*1024, 'GB': 1024*1024*1024 };
            const match = sizeStr.match(/^([\d.]+)\s*([A-Z]+)$/i);
            if (!match) return 0;
            return parseFloat(match[1]) * (units[match[2].toUpperCase()] || 1);
        }

        function displayFilteredResults(folders, plans) {
            const plansContainer = document.getElementById('plansContainer');
            const emptyState = document.getElementById('emptyState');

            if (folders.length === 0 && plans.length === 0) {
                plansContainer.innerHTML = '';
                emptyState.classList.add('show');
                return;
            }

            emptyState.classList.remove('show');
            let html = '';

            // Display plans
            plans.forEach(plan => {
                const fileExt = String(plan.name.split('.').pop() || '').toLowerCase().replace(/[^a-z0-9]/g, '');
                let previewHTML = '';

                if (plan.preview) {
                    previewHTML = `<img src="${plan.preview}" alt="${plan.name}">`;
                } else {
                    let iconHTML = '';
                    if (fileExt === 'pdf') {
                        iconHTML = '<i class="fas fa-file-pdf" style="font-size: 48px; color: #DC2626;"></i>';
                    } else if (['doc', 'docx'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-word" style="font-size: 48px; color: #2563EB;"></i>';
                    } else if (['xls', 'xlsx'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-excel" style="font-size: 48px; color: #10B981;"></i>';
                    } else if (['ppt', 'pptx'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-powerpoint" style="font-size: 48px; color: #F97316;"></i>';
                    } else if (['zip', 'rar', '7z'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-archive" style="font-size: 48px; color: #F59E0B;"></i>';
                    } else if (['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-image" style="font-size: 48px; color: #8B5CF6;"></i>';
                    } else if (['mp4', 'mov', 'avi', 'mkv'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-video" style="font-size: 48px; color: #EC4899;"></i>';
                    } else if (['mp3', 'wav', 'flac'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-audio" style="font-size: 48px; color: #14B8A6;"></i>';
                    } else if (['txt', 'md', 'json', 'xml'].includes(fileExt)) {
                        iconHTML = '<i class="fas fa-file-code" style="font-size: 48px; color: #3B82F6;"></i>';
                    } else {
                        iconHTML = '<i class="fas fa-file" style="font-size: 48px; color: #9CA3AF;"></i>';
                    }
                    previewHTML = `<div class="plan-preview-icon">${iconHTML}</div>`;
                }

                const safePlanId2 = String(plan.id).replace(/'/g, "\\'").replace(/"/g, '\\"');
                const isPlanSelected2 = selectedPlans.includes(plan.id);
                const escapedPlanId2 = String(plan.id).replace(/\\/g, '\\\\').replace(/'/g, "\\'");

                html += `
                    <div class="plan-item ${isPlanSelected2 ? 'selected' : ''}" data-plan-id="${safePlanId2}">
                        <div class="plan-checkbox" onclick="event.stopPropagation(); togglePlanSelection('${escapedPlanId2}')">
                            <input type="checkbox" ${isPlanSelected2 ? 'checked' : ''} onchange="event.stopPropagation();">
                        </div>
                        <div class="plan-content" onclick="openPlan('${escapedPlanId2}')">
                            <div class="plan-preview">
                                ${previewHTML}
                            </div>
                            <div class="plan-details">
                                <div class="plan-name">${plan.name}</div>
                                <div class="plan-meta">${plan.size || 'Unknown size'}</div>
                            </div>
                        </div>
                    </div>
                `;
                });
            }


            plansContainer.innerHTML = html;
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('sortSelect').value = 'date-desc';

            const allCheckboxes = document.querySelectorAll('.filter-option input[type="checkbox"]');
            allCheckboxes.forEach(cb => {
                cb.checked = cb.value === 'all';
            });

            applyFilters();
        }

        // View Toggle Functions
        function switchToGridView() {
            currentView = 'grid';
            const container = document.getElementById('plansContainer');
            container.className = 'plans-grid';

            document.getElementById('gridViewBtn').classList.add('active');
            document.getElementById('gridViewBtn').classList.remove('btn-secondary');
            document.getElementById('gridViewBtn').classList.add('btn-primary');

            document.getElementById('listViewBtn').classList.remove('active');
            document.getElementById('listViewBtn').classList.add('btn-secondary');
            document.getElementById('listViewBtn').classList.remove('btn-primary');

            loadPlans();
        }

        function switchToListView() {
            currentView = 'list';
            const container = document.getElementById('plansContainer');
            container.className = 'plans-list';

            document.getElementById('listViewBtn').classList.add('active');
            document.getElementById('listViewBtn').classList.remove('btn-secondary');
            document.getElementById('listViewBtn').classList.add('btn-primary');

            document.getElementById('gridViewBtn').classList.remove('active');
            document.getElementById('gridViewBtn').classList.add('btn-secondary');
            document.getElementById('gridViewBtn').classList.remove('btn-primary');

            loadPlans();
        }

        // Version Control Functions
        function openVersionControlModal() {
            alert('Version Control: This feature allows you to track file versions and changes.\n\nComing features:\n View file history\n Compare versions\n Restore previous versions\n Track who made changes\n Add version notes\n\nThis is a professional version control system for your project files!');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            const filterDropdown = document.getElementById('filterDropdown');
            const filterContainer = document.querySelector('.filter-container');

            if (filterDropdown && filterContainer) {
                if (!filterContainer.contains(event.target)) {
                    filterDropdown.classList.remove('show');
                }
            }
        });

        // Call loadPlans on page load
        document.addEventListener('DOMContentLoaded', loadPlans);

        // Setup file input event listeners
        document.addEventListener('DOMContentLoaded', function() {
            const fileInput = document.getElementById('fileInput');
            const folderInput = document.getElementById('folderInput');

            if (fileInput) {
                fileInput.addEventListener('change', handleFileSelect);
            }

            if (folderInput) {
                folderInput.addEventListener('change', handleFileSelect);
            }
        });

        async function createFolder() {
            const folderName = document.getElementById('folderName').value.trim();
            const folderDescription = document.getElementById('folderDescription').value.trim();
            const folderType = document.getElementById('folderType').value;

            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }

            const newFolder = {
                id: Date.now().toString(),
                name: folderName,
                description: folderDescription,
                type: folderType,
                itemCount: 0,
                createdAt: new Date().toISOString()
            };

            foldersData.push(newFolder);
            localStorage.setItem('foldersData_' + '<%= project.id %>', JSON.stringify(foldersData));

            // Close modal
            closeNewFolderModal();

            // Reload plans display
            loadPlans();

            // Show success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #10B981;
                color: white;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                z-index: 10001;
                font-weight: 600;
            `;
            notification.textContent = `Folder "${folderName}" created successfully!`;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Store current file for download
        let currentViewingFile = null;

        function openFolder(folderId) {
            const folder = foldersData.find(f => f.id === folderId);
            if (!folder) {
                alert('Folder not found');
                return;
            }

            // Get files in this folder
            const folderFiles = plansData.filter(p => p.folderId === folderId);

            // Update modal title
            document.getElementById('folderViewerTitle').textContent = folder.name;

            const folderContent = document.getElementById('folderViewerContent');
            const emptyState = document.getElementById('folderEmptyState');

            if (folderFiles.length === 0) {
                folderContent.innerHTML = '';
                emptyState.style.display = 'flex';
            } else {
                emptyState.style.display = 'none';
                let html = '';

                folderFiles.forEach(file => {
                    html += `
                        <div class="plan-item" onclick="openPlan('${file.id}')">
                            <div class="plan-preview">
                                ${file.preview ? `<img src="${file.preview}" alt="${file.name}">` : '<div class="plan-preview-icon"></div>'}
                            </div>
                            <div class="plan-name">${file.name}</div>
                            <div class="plan-meta">${file.size || 'Unknown size'}</div>
                        </div>
                    `;
                });

                folderContent.innerHTML = html;
            }

            // Show modal
            const modal = document.getElementById('folderViewerModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeFolderViewer() {
            const modal = document.getElementById('folderViewerModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function openPlan(planId) {
            const plan = plansData.find(p => p.id === planId);
            if (!plan) {
                alert('File not found');
                return;
            }

            currentViewingFile = plan;

            // Update modal title
            document.getElementById('fileViewerTitle').textContent = plan.name;

            const viewerContent = document.getElementById('fileViewerContent');

            // Determine file type
            const fileExtension = String(plan.name.split('.').pop() || '').toLowerCase().replace(/[^a-z0-9]/g, '');
            const fileName = plan.name;

            // Clear previous content
            viewerContent.innerHTML = '';

            // Handle different file types
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp', 'svg'].includes(fileExtension)) {
                // Image viewer
                if (plan.preview) {
                    viewerContent.innerHTML = `
                        <img src="${plan.preview}" alt="${fileName}" style="max-width: 100%; max-height: 100%; object-fit: contain;">
                    `;
                } else {
                    viewerContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-image" style="font-size: 64px; color: #CBD5E0; margin-bottom: 16px;"></i>
                            <p style="color: #718096;">Image preview not available</p>
                            <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">${fileName}</p>
                        </div>
                    `;
                }
            } else if (fileExtension === 'pdf') {
                // Professional PDF viewer using iframe
                if (plan.preview || plan.url) {
                    const pdfContainer = document.getElementById('pdfIframeContainer');
                    if (pdfContainer) {
                        pdfContainer.innerHTML = `
                            <iframe src="${plan.preview || plan.url}"
                                    style="width: 100%; height: 100%; border: none;"
                                    allow="fullscreen"
                                    allowfullscreen></iframe>
                        `;
                    }
                } else {
                    viewerContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-file-pdf" style="font-size: 64px; color: #E53E3E; margin-bottom: 16px;"></i>
                            <p style="color: #718096; font-weight: 500;">PDF Document</p>
                            <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">${fileName}</p>
                            <p style="color: #A0AEC0; font-size: 14px; margin-top: 16px;">Preview not available. Click Download to view the file.</p>
                        </div>
                    `;
                }
            } else if (['mp4', 'webm', 'ogg', 'mov'].includes(fileExtension)) {
                // Video viewer
                if (plan.preview || plan.url) {
                    viewerContent.innerHTML = `
                        <video controls style="max-width: 100%; max-height: 100%;">
                            <source src="${plan.preview || plan.url}" type="video/${fileExtension}">
                            Your browser does not support the video tag.
                        </video>
                    `;
                } else {
                    viewerContent.innerHTML = `
                        <div style="text-align: center; padding: 40px;">
                            <i class="fas fa-video" style="font-size: 64px; color: #805AD5; margin-bottom: 16px;"></i>
                            <p style="color: #718096;">Video preview not available</p>
                            <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">${fileName}</p>
                        </div>
                    `;
                }
            } else if (['txt', 'md', 'json', 'js', 'css', 'html', 'xml', 'csv'].includes(fileExtension)) {
                // Text file viewer
                viewerContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file-code" style="font-size: 64px; color: #4299E1; margin-bottom: 16px;"></i>
                        <p style="color: #718096; font-weight: 500;">Text Document</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">${fileName}</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 16px;">Text preview not available. Click Download to view the file.</p>
                    </div>
                `;
            } else if (['dwg', 'dxf'].includes(fileExtension)) {
                // CAD file
                viewerContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-drafting-compass" style="font-size: 64px; color: #48BB78; margin-bottom: 16px;"></i>
                        <p style="color: #718096; font-weight: 500;">CAD Drawing</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">${fileName}</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 16px;">CAD viewer not available. Click Download to view the file in a CAD application.</p>
                    </div>
                `;
            } else if (['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(fileExtension)) {
                // Microsoft Office files
                const icons = {
                    doc: 'fa-file-word',
                    docx: 'fa-file-word',
                    xls: 'fa-file-excel',
                    xlsx: 'fa-file-excel',
                    ppt: 'fa-file-powerpoint',
                    pptx: 'fa-file-powerpoint'
                };
                const colors = {
                    doc: '#2B579A',
                    docx: '#2B579A',
                    xls: '#217346',
                    xlsx: '#217346',
                    ppt: '#D24726',
                    pptx: '#D24726'
                };
                viewerContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas ${icons[fileExtension]}" style="font-size: 64px; color: ${colors[fileExtension]}; margin-bottom: 16px;"></i>
                        <p style="color: #718096; font-weight: 500;">Office Document</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">${fileName}</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 16px;">Preview not available. Click Download to open in Microsoft Office.</p>
                    </div>
                `;
            } else {
                // Generic file
                viewerContent.innerHTML = `
                    <div style="text-align: center; padding: 40px;">
                        <i class="fas fa-file" style="font-size: 64px; color: #A0AEC0; margin-bottom: 16px;"></i>
                        <p style="color: #718096; font-weight: 500;">${fileName}</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 8px;">File type: .${fileExtension.toUpperCase()}</p>
                        <p style="color: #A0AEC0; font-size: 14px; margin-top: 16px;">Preview not available for this file type.</p>
                    </div>
                `;
            }

            // Show modal
            const modal = document.getElementById('fileViewerModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeFileViewer() {
            const modal = document.getElementById('fileViewerModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
            currentViewingFile = null;
        }

        function downloadCurrentFile() {
            if (!currentViewingFile) {
                alert('No file selected');
                return;
            }

            // Since files are stored in localStorage, create a download link
            if (currentViewingFile.preview || currentViewingFile.url) {
                const link = document.createElement('a');
                link.href = currentViewingFile.preview || currentViewingFile.url;
                link.download = currentViewingFile.name;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // Show notification
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #10B981;
                    color: white;
                    padding: 16px 24px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    z-index: 10001;
                    font-weight: 600;
                `;
                notification.textContent = `Downloading ${currentViewingFile.name}...`;
                document.body.appendChild(notification);

                setTimeout(() => {
                    notification.remove();
                }, 3000);
            } else {
                alert('File download not available. File may not have been fully uploaded.');
            }
        }

        // Actions Dropdown Functions
        function toggleActionsDropdown() {
            const dropdown = document.getElementById('actionsDropdown');
            dropdown.classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const actionsBtn = document.getElementById('actionsBtn');
            const dropdown = document.getElementById('actionsDropdown');

            if (dropdown && actionsBtn) {
                if (!actionsBtn.contains(event.target) && !dropdown.contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            }
        });

        function selectAll() {
            selectedPlans = plansData.map(p => p.id);
            loadPlans();
            updateSelectionUI();
            showNotification('All plans selected', 'success');
            toggleActionsDropdown();
        }

        function deleteSelected() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to delete', 'error');
                toggleActionsDropdown();
                return;
            }

            const deleteCount = selectedPlans.length;
            const confirmMessage = `Are you sure you want to delete ${deleteCount} selected item(s)? This action cannot be undone.`;
            if (confirm(confirmMessage)) {
                // Remove selected plans from the data
                plansData = plansData.filter(plan => !selectedPlans.includes(plan.id));
                selectedPlans = [];
                loadPlans();
                updateSelectionUI();
                showNotification(`${deleteCount} item(s) deleted successfully`, 'success');
            }
            toggleActionsDropdown();
        }

        function moveSelected() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to move', 'error');
                toggleActionsDropdown();
                return;
            }

            // Show folder selection modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Move to Folder</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Move ${selectedPlans.length} selected item(s) to:</p>
                        <select id="moveFolderSelect" class="form-input" style="width: 100%; margin: 10px 0;">
                            <option value="">Select a folder...</option>
                            <option value="folder1">Architecture Plans</option>
                            <option value="folder2">Structural Plans</option>
                            <option value="folder3">MEP Plans</option>
                            <option value="new">Create New Folder</option>
                        </select>
                        <div id="newFolderInput" style="display: none; margin-top: 10px;">
                            <input type="text" id="newFolderName" placeholder="New folder name" class="form-input" style="width: 100%;">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="confirmMove()">Move</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Show new folder input when "Create New Folder" is selected
            document.getElementById('moveFolderSelect').addEventListener('change', function() {
                const newFolderInput = document.getElementById('newFolderInput');
                newFolderInput.style.display = this.value === 'new' ? 'block' : 'none';
            });

            window.confirmMove = function() {
                const folderSelect = document.getElementById('moveFolderSelect');
                const newFolderName = document.getElementById('newFolderName');
                
                if (folderSelect.value === 'new') {
                    if (!newFolderName.value.trim()) {
                        showNotification('Please enter a folder name', 'error');
                        return;
                    }
                    showNotification(`Moving ${selectedPlans.length} item(s) to new folder "${newFolderName.value}"`, 'success');
                } else if (folderSelect.value) {
                    showNotification(`Moving ${selectedPlans.length} item(s) to selected folder`, 'success');
                } else {
                    showNotification('Please select a folder', 'error');
                    return;
                }
                
                modal.remove();
                toggleActionsDropdown();
            };

            toggleActionsDropdown();
        }

        function downloadSelected() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to download', 'error');
                toggleActionsDropdown();
                return;
            }

            // Simulate download process
            showNotification(`Preparing ${selectedPlans.length} file(s) for download...`, 'info');
            
            setTimeout(() => {
                selectedPlans.forEach((planId, index) => {
                    const plan = plansData.find(p => p.id === planId);
                    if (plan) {
                        // Create a download link for each file
                        const link = document.createElement('a');
                        link.href = plan.url || '#';
                        link.download = plan.name || `plan_${planId}`;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
                showNotification(`${selectedPlans.length} file(s) downloaded successfully`, 'success');
            }, 1000);

            toggleActionsDropdown();
        }

        function deselectAll() {
            selectedPlans = [];
            loadPlans();
            updateSelectionUI();
            toggleActionsDropdown();
        }

        function manageTags() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to manage tags', 'error');
                toggleActionsDropdown();
                return;
            }

            // Show tag management modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Manage Tags</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Manage tags for ${selectedPlans.length} selected item(s):</p>
                        <div style="margin: 15px 0;">
                            <label>Available Tags:</label>
                            <div id="availableTags" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0;">
                                <span class="tag" data-tag="architecture">Architecture</span>
                                <span class="tag" data-tag="structural">Structural</span>
                                <span class="tag" data-tag="mep">MEP</span>
                                <span class="tag" data-tag="reviewed">Reviewed</span>
                                <span class="tag" data-tag="approved">Approved</span>
                                <span class="tag" data-tag="draft">Draft</span>
                            </div>
                        </div>
                        <div style="margin: 15px 0;">
                            <label>Selected Tags:</label>
                            <div id="selectedTags" style="display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; min-height: 30px; border: 1px dashed #ccc; padding: 5px;">
                            </div>
                        </div>
                        <div style="margin: 15px 0;">
                            <input type="text" id="newTagInput" placeholder="Add custom tag" class="form-input" style="width: 100%;">
                            <button onclick="addCustomTag()" class="btn btn-secondary" style="margin-top: 5px;">Add Tag</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="applyTags()">Apply Tags</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Add tag selection functionality
            document.querySelectorAll('#availableTags .tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    const tagText = this.textContent;
                    const tagValue = this.dataset.tag;
                    
                    if (!this.classList.contains('selected')) {
                        this.classList.add('selected');
                        this.style.backgroundColor = '#3182ce';
                        this.style.color = 'white';
                        
                        const selectedTagsDiv = document.getElementById('selectedTags');
                        const selectedTag = document.createElement('span');
                        selectedTag.className = 'tag selected-tag';
                        selectedTag.textContent = tagText;
                        selectedTag.dataset.tag = tagValue;
                        selectedTag.innerHTML += ' <span onclick="removeSelectedTag(this)" style="cursor: pointer; margin-left: 5px;">&times;</span>';
                        selectedTagsDiv.appendChild(selectedTag);
                    }
                });
            });

            window.addCustomTag = function() {
                const input = document.getElementById('newTagInput');
                const tagName = input.value.trim();
                
                if (tagName && !document.querySelector(`[data-tag="${tagName.toLowerCase()}"]`)) {
                    const selectedTagsDiv = document.getElementById('selectedTags');
                    const selectedTag = document.createElement('span');
                    selectedTag.className = 'tag selected-tag';
                    selectedTag.textContent = tagName;
                    selectedTag.dataset.tag = tagName.toLowerCase();
                    selectedTag.innerHTML += ' <span onclick="removeSelectedTag(this)" style="cursor: pointer; margin-left: 5px;">&times;</span>';
                    selectedTagsDiv.appendChild(selectedTag);
                    input.value = '';
                }
            };

            window.removeSelectedTag = function(element) {
                const tagElement = element.parentElement;
                const tagValue = tagElement.dataset.tag;
                
                // Remove from available tags selection
                const availableTag = document.querySelector(`#availableTags [data-tag="${tagValue}"]`);
                if (availableTag) {
                    availableTag.classList.remove('selected');
                    availableTag.style.backgroundColor = '';
                    availableTag.style.color = '';
                }
                
                tagElement.remove();
            };

            window.applyTags = function() {
                const selectedTagElements = document.querySelectorAll('#selectedTags .selected-tag');
                const tags = Array.from(selectedTagElements).map(tag => tag.dataset.tag);
                
                if (tags.length === 0) {
                    showNotification('Please select at least one tag', 'error');
                    return;
                }
                
                showNotification(`Applied ${tags.length} tag(s) to ${selectedPlans.length} item(s)`, 'success');
                modal.remove();
                toggleActionsDropdown();
            };

            toggleActionsDropdown();
        }

        function batchEdit() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to edit', 'error');
                toggleActionsDropdown();
                return;
            }

            // Show batch edit modal
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3>Batch Edit</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Edit properties for ${selectedPlans.length} selected item(s):</p>
                        
                        <div style="margin: 15px 0;">
                            <label>Document Number:</label>
                            <input type="text" id="batchDocNumber" placeholder="Enter document number" class="form-input" style="width: 100%; margin: 5px 0;">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label>Description:</label>
                            <textarea id="batchDescription" placeholder="Enter description" class="form-input" style="width: 100%; margin: 5px 0; height: 80px;"></textarea>
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label>Status:</label>
                            <select id="batchStatus" class="form-input" style="width: 100%; margin: 5px 0;">
                                <option value="">Select status...</option>
                                <option value="draft">Draft</option>
                                <option value="review">Under Review</option>
                                <option value="approved">Approved</option>
                                <option value="issued">Issued</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="applyBatchEdit()">Apply Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            window.applyBatchEdit = function() {
                const docNumber = document.getElementById('batchDocNumber').value.trim();
                const description = document.getElementById('batchDescription').value.trim();
                const status = document.getElementById('batchStatus').value;

                // Apply changes to selected plans
                selectedPlans.forEach(planId => {
                    const plan = plansData.find(p => p.id === planId);
                    if (plan) {
                        if (docNumber) plan.docNumber = docNumber;
                        if (description) plan.description = description;
                        if (status) plan.status = status;
                        plan.lastModified = new Date().toISOString();
                    }
                });

                loadPlans();
                showNotification(`Updated ${selectedPlans.length} item(s) successfully`, 'success');
                modal.remove();
                toggleActionsDropdown();
            };

            toggleActionsDropdown();
        }

        function scanNumberDescription() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to scan', 'error');
                toggleActionsDropdown();
                return;
            }

            showNotification('Starting scan process...', 'info');
            
            setTimeout(() => {
                let scannedCount = 0;
                selectedPlans.forEach(planId => {
                    const plan = plansData.find(p => p.id === planId);
                    if (plan) {
                        const mockExtractedText = `Document ${plan.name || 'Unknown'}: Architectural drawing - Floor plan - Scale 1:100 - Rev A`;
                        
                        if (mockExtractedText.includes('Floor plan')) {
                            plan.description = 'Floor plan';
                        }
                        if (mockExtractedText.includes('Scale 1:100')) {
                            plan.scale = '1:100';
                        }
                        if (mockExtractedText.includes('Rev A')) {
                            plan.revision = 'Rev A';
                        }
                        if (!plan.docNumber) {
                            plan.docNumber = `DOC-${planId}`;
                        }
                        
                        scannedCount++;
                    }
                });
                
                loadPlans();
                showNotification(`Successfully scanned ${scannedCount} document(s)`, 'success');
            }, 2000);

            toggleActionsDropdown();
        }

        function editNumberDescription() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to edit', 'error');
                toggleActionsDropdown();
                return;
            }

            const firstPlan = plansData.find(p => p.id === selectedPlans[0]);
            if (!firstPlan) {
                showNotification('Selected file not found', 'error');
                toggleActionsDropdown();
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3>Edit Number/Description</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Editing ${selectedPlans.length} selected item(s):</p>
                        
                        <div style="margin: 15px 0;">
                            <label>Document Number:</label>
                            <input type="text" id="editDocNumber" value="${firstPlan.docNumber || ''}" placeholder="Enter document number" class="form-input" style="width: 100%; margin: 5px 0;">
                        </div>
                        
                        <div style="margin: 15px 0;">
                            <label>Description:</label>
                            <textarea id="editDescription" placeholder="Enter description" class="form-input" style="width: 100%; margin: 5px 0; height: 100px;">${firstPlan.description || ''}</textarea>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="applyEdit()">Apply Changes</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            window.applyEdit = function() {
                const docNumber = document.getElementById('editDocNumber').value.trim();
                const description = document.getElementById('editDescription').value.trim();

                selectedPlans.forEach(planId => {
                    const plan = plansData.find(p => p.id === planId);
                    if (plan) {
                        if (docNumber) plan.docNumber = docNumber;
                        if (description) plan.description = description;
                        plan.lastModified = new Date().toISOString();
                    }
                });

                loadPlans();
                showNotification(`Updated ${selectedPlans.length} item(s) successfully`, 'success');
                modal.remove();
                toggleActionsDropdown();
            };

            toggleActionsDropdown();
        }

        function rotateSheet() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to rotate', 'error');
                toggleActionsDropdown();
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Rotate Sheet</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Rotate ${selectedPlans.length} selected item(s):</p>
                        <div style="text-align: center; margin: 20px 0;">
                            <button class="btn btn-secondary" onclick="applyRotation(90)" style="margin: 5px;">90 Clockwise</button>
                            <button class="btn btn-secondary" onclick="applyRotation(180)" style="margin: 5px;">180</button>
                            <button class="btn btn-secondary" onclick="applyRotation(270)" style="margin: 5px;">90 Counter-clockwise</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            window.applyRotation = function(degrees) {
                selectedPlans.forEach(planId => {
                    const plan = plansData.find(p => p.id === planId);
                    if (plan) {
                        plan.rotation = degrees;
                        plan.lastModified = new Date().toISOString();
                    }
                });
                
                loadPlans();
                showNotification(`Rotated ${selectedPlans.length} item(s) by ${degrees}`, 'success');
                modal.remove();
                toggleActionsDropdown();
            };

            toggleActionsDropdown();
        }

        function setScale() {
            if (selectedPlans.length === 0) {
                showNotification('Please select files to set scale', 'error');
                toggleActionsDropdown();
                return;
            }

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h3>Set Scale</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <p>Set scale for ${selectedPlans.length} selected item(s):</p>
                        <div style="margin: 15px 0;">
                            <label>Scale:</label>
                            <select id="scaleSelect" class="form-input" style="width: 100%; margin: 10px 0;">
                                <option value="">Select scale...</option>
                                <option value="1:50">1:50</option>
                                <option value="1:100">1:100</option>
                                <option value="1:200">1:200</option>
                                <option value="1:500">1:500</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancel</button>
                        <button class="btn btn-primary" onclick="applyScale()">Apply Scale</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            window.applyScale = function() {
                const scale = document.getElementById('scaleSelect').value;
                
                if (!scale) {
                    showNotification('Please select a scale', 'error');
                    return;
                }
                
                selectedPlans.forEach(planId => {
                    const plan = plansData.find(p => p.id === planId);
                    if (plan) {
                        plan.scale = scale;
                        plan.lastModified = new Date().toISOString();
                    }
                });
                
                loadPlans();
                showNotification(`Set scale to ${scale} for ${selectedPlans.length} item(s)`, 'success');
                modal.remove();
                toggleActionsDropdown();
            };

            toggleActionsDropdown();
        }

        function compare() {
            alert('Compare functionality will be implemented soon!');
            toggleActionsDropdown();
        }

        function exportPlan() {
            alert('Export plan functionality will be implemented soon!');
            toggleActionsDropdown();
        }

        function exportMarkupSummary() {
            alert('Export markup summary functionality will be implemented soon!');
            toggleActionsDropdown();
        }

        function exportQRCode() {
            alert('Export QR code functionality will be implemented soon!');
            toggleActionsDropdown();
        }

        // More Options Modal Functions
        function openMoreOptionsModal() {
            const modal = document.getElementById('moreOptionsModal');
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeMoreOptionsModal() {
            const modal = document.getElementById('moreOptionsModal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        function selectSource(source) {
            // Remove active class from all items
            document.querySelectorAll('.source-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Add active class to selected item
            document.querySelector(`[data-source="${source}"]`).classList.add('active');
            
            // Update main content based on selected source
            updateMainContent(source);
        }

        function updateMainContent(source) {
            const mainText = document.querySelector('.upload-main-text');
            const subText = document.querySelector('.upload-sub-text');
            const uploadIcon = document.querySelector('.upload-icon-large i');
            
            switch(source) {
                case 'dropbox':
                    mainText.textContent = 'Connect to Dropbox';
                    subText.textContent = 'Access your Dropbox files and folders.';
                    uploadIcon.className = 'fab fa-dropbox';
                    break;
                case 'box':
                    mainText.textContent = 'Connect to Box';
                    subText.textContent = 'Access your Box files and folders.';
                    uploadIcon.className = 'fas fa-cube';
                    break;
                case 'google-drive':
                    mainText.textContent = 'Connect to Google Drive';
                    subText.textContent = 'Access your Google Drive files and folders.';
                    uploadIcon.className = 'fab fa-google-drive';
                    break;
                case 'onedrive':
                    mainText.textContent = 'Connect to OneDrive';
                    subText.textContent = 'Access your OneDrive files and folders.';
                    uploadIcon.className = 'fab fa-microsoft';
                    break;
                case 'onedrive-business':
                    mainText.textContent = 'Connect to OneDrive Business';
                    subText.textContent = 'Access your OneDrive Business files and folders.';
                    uploadIcon.className = 'fab fa-microsoft';
                    break;
                case 'desa-pdrive':
                    mainText.textContent = 'Connect to Desa Pdrive';
                    subText.textContent = 'Access your Desa Pdrive files and folders.';
                    uploadIcon.className = 'fas fa-hdd';
                    break;
                case 'link':
                    mainText.textContent = 'Select Files to Upload';
                    subText.textContent = 'or Drag and Drop, Copy and Paste Files.';
                    uploadIcon.className = 'fas fa-desktop';
                    break;
            }
        }

        // Close more options modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('moreOptionsModal');
            if (e.target === modal) {
                closeMoreOptionsModal();
            }
        });

        // Close upload modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('uploadModal');
            if (e.target === modal) {
                closeUploadModal();
            }
        });
    </script>
</body>
</html>
