<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans | <%= projectName %></title>
    <link rel="icon" type="image/webp" href="/img/img.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="/js/notifications.js?v=<%= Date.now() %>"></script>
    <script src="/js/chat-widget.js?v=<%= Date.now() %>"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Root font size - base for rem units - FIXED FOR 100% ZOOM */
        :root {
            font-size: 14px; /* Reduced from 16px - this makes everything proportionally smaller */

            --action-bar-height: 3.75rem;
            --sidebar-width: 16.25rem;
            --sidebar-collapsed-width: 5rem;
            --toolbar-width: 3.75rem;
            --toolbar-offset: clamp(0.75rem, 2vw, 1.5rem);
            --pdf-padding-vertical: clamp(1.5rem, 4vh, 3.75rem);
            --pdf-padding-horizontal: clamp(1rem, 2vw, 2.5rem);
            --pdf-padding-bottom: clamp(6.25rem, 15vh, 12.5rem);
            --dropdown-top-offset: clamp(3.75rem, 8vh, 6.25rem);
            --fullscreen-padding-offset: clamp(1.875rem, 4vh, 3.125rem);
        }

        /* Responsive font scaling for different screen sizes - OPTIMIZED */
        @media screen and (max-width: 1400px) {
            :root {
                font-size: 12px; /* Smaller for laptops */
            }
        }

        @media screen and (min-width: 1401px) and (max-width: 1920px) {
            :root {
                font-size: 13px; /* Standard monitors */
            }
        }

        @media screen and (min-width: 1921px) and (max-width: 2560px) {
            :root {
                font-size: 14px; /* Large monitors */
            }
        }

        @media screen and (min-width: 2561px) {
            :root {
                font-size: 16px; /* Ultra-wide/4K monitors */
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
            font-size: 1rem;
        }

        .container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Action Bar - RESPONSIVE */
        .action-bar {
            background: white;
            padding: clamp(0.75rem, 2vh, 1rem) clamp(1rem, 3vw, 1.5rem);
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            flex-wrap: wrap;
            min-height: auto;
            overflow-y: auto;
        }

        .action-bar-left,
        .action-bar-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .btn-primary,
        .btn-secondary {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: clamp(0.875rem, 1.5vw, 1.0625rem);
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
            border: none;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
        }

        /* Plans Content Area */
        .plans-content {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: clamp(1rem, 3vh, 1.5rem);
        }

        /* Empty State - RESPONSIVE */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .empty-state-icon {
            width: clamp(8rem, 15vw, 10rem);
            height: clamp(6rem, 12vh, 7.5rem);
            margin-bottom: clamp(1rem, 3vh, 1.5rem);
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 0.75rem;
            position: relative;
        }

        .empty-state-icon-inner {
            width: 100px;
            height: 80px;
            border: 3px solid #d1d5db;
            border-radius: 8px;
            background: white;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state-play {
            width: 50px;
            height: 50px;
            background: #9ca3af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .empty-state-play::before {
            content: 'â–¶';
            margin-left: 3px;
        }

        .empty-state-title {
            font-size: clamp(1rem, 2.5vw, 1.25rem);
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }

        .empty-state-description {
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
            color: #6b7280;
            max-width: 25rem;
            line-height: 1.5;
        }

        /* Folder Section - RESPONSIVE */
        .folder-section {
            margin-bottom: clamp(1.5rem, 4vh, 2rem);
        }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.5rem 0.75rem;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }

        .folder-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .folder-icon {
            font-size: 1.125rem;
            color: #6b7280;
        }

        .folder-name {
            flex: 1;
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
            font-weight: 500;
            color: #1f2937;
        }

        .folder-dropdown {
            position: relative;
        }

        .folder-dropdown-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            color: #6b7280;
            font-size: 14px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .folder-dropdown-btn:hover {
            background: #f3f4f6;
        }

        .folder-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            z-index: 100;
            margin-top: -2px;
        }

        .folder-dropdown-menu.show {
            display: block;
        }

        .folder-dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s;
            display: block;
            text-align: left;
            border: none;
            background: none;
            width: 100%;
        }

        .folder-dropdown-item:hover {
            background: #f9fafb;
        }

        .folder-dropdown-item.danger {
            color: #dc2626;
        }

        .folder-dropdown-item.danger:hover {
            background: #fef2f2;
        }

        /* Plans Grid - RESPONSIVE */
        .plans-grid,
        .folder-plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(clamp(14rem, 20vw, 17.5rem), 1fr));
            gap: clamp(1rem, 2vw, 1.5rem);
            padding: 0 0.75rem;
        }

        .folder-plans-grid {
            background: #fafbfc;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
            padding: 0.75rem;
        }

        /* Plan Card - RESPONSIVE */
        .plan-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 0.25rem 0.75rem rgba(0, 0, 0, 0.08);
        }

        .plan-card:hover {
            box-shadow: 0 0.5rem 1.25rem rgba(0, 0, 0, 0.12);
            transform: translateY(-0.25rem);
        }

        .plan-thumbnail {
            width: 100%;
            height: clamp(12rem, 18vh, 15.625rem);
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem 0.75rem 0 0;
        }

        .plan-thumbnail canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 0.5rem;
        }

        .plan-info {
            padding: 1rem;
            background: white;
        }

        .plan-name {
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
            font-weight: 600;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* New Plan Card */
        .new-plan-card {
            background: transparent;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-plan-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .new-plan-content {
            text-align: center;
            color: #9ca3af;
        }

        .new-plan-content i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .new-plan-content span {
            display: block;
            font-size: 14px;
            font-weight: 500;
        }

        /* Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .upload-modal.show {
            display: flex;
        }

        .upload-modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-modal-header {
            padding: 32px 40px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .upload-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
        }

        .upload-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            line-height: 1;
        }

        .upload-modal-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .upload-modal-body {
            padding: 32px 40px;
        }

        /* QR Code Modal - Positioned inside PDF Viewer */
        .pdf-qr-code-modal {
            position: fixed;
            top: var(--action-bar-height);
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .pdf-qr-code-modal.show {
            display: flex;
        }

        .sidebar.collapsed ~ .pdf-qr-code-modal {
            left: var(--sidebar-collapsed-width);
        }

        .pdf-qr-code-overlay {
            position: fixed;
            top: var(--action-bar-height);
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10001;
        }

        .sidebar.collapsed ~ .pdf-qr-code-overlay {
            left: var(--sidebar-collapsed-width);
        }

        .pdf-qr-code-content {
            position: relative;
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: qrModalSlideIn 0.3s ease;
            z-index: 10002;
        }

        @keyframes qrModalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .pdf-qr-code-header {
            padding: 24px 32px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pdf-qr-code-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .pdf-qr-code-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s ease;
        }

        .pdf-qr-code-close:hover {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .pdf-qr-code-body {
            padding: 32px;
            text-align: center;
        }

        .upload-dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            background-color: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-dropzone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .upload-dropzone.drag-over {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        /* Drag and drop visual feedback */
        .folder-section.drag-over {
            background-color: #dbeafe;
            border-color: #3b82f6;
            border: 2px dashed #3b82f6;
            transition: all 0.2s ease;
        }

        .folder-section.drag-over .folder-plans-grid {
            background-color: #eff6ff;
        }

        .plan-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            cursor: grabbing;
        }

        .plan-card.drag-over {
            border: 2px dashed #3b82f6;
            background-color: #eff6ff;
        }

        /* Loading spinner for drag and drop operations */
        .drag-drop-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease-out;
        }

        .drag-drop-spinner-container {
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            animation: scaleUp 0.3s ease-out;
        }

        .drag-drop-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid #e5e7eb;
            border-top-color: #3b82f6;
            border-right-color: #2563eb;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .drag-drop-loading-text {
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
            text-align: center;
        }

        .drag-drop-loading-subtext {
            font-size: 13px;
            color: #6b7280;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes scaleUp {
            from {
                transform: scale(0.8);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .upload-icon-wrapper {
            margin: 0 auto 20px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon-box {
            width: 56px;
            height: 48px;
            border: 2px solid #9ca3af;
            border-radius: 4px;
            position: relative;
            background: white;
        }

        .upload-icon-lines {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
        }

        .upload-icon-line {
            height: 2px;
            background-color: #d1d5db;
            margin-bottom: 6px;
        }

        .upload-icon-line:last-child {
            margin-bottom: 0;
            width: 60%;
        }

        .upload-text {
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .upload-or {
            font-size: 14px;
            color: #9ca3af;
            margin: 16px 0;
        }

        .upload-select-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-select-btn:hover {
            background-color: #2563eb;
        }

        .upload-file-list {
            margin-top: 24px;
            display: none;
        }

        .upload-file-list.show {
            display: block;
        }

        .upload-file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .upload-file-icon {
            width: 32px;
            height: 32px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #6b7280;
        }

        .upload-file-info {
            flex: 1;
        }

        .upload-file-name {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .upload-file-size {
            font-size: 12px;
            color: #9ca3af;
        }

        .upload-file-remove {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .upload-file-remove:hover {
            color: #dc2626;
        }

        .upload-integration-section {
            margin-top: 32px;
        }

        .upload-integration-text {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            text-align: center;
        }

        .upload-integration-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .upload-integration-btn {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .upload-integration-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-integration-icon {
            width: 28px;
            height: 28px;
        }

        .upload-integration-name {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }

        .upload-more-options {
            width: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s;
        }

        .upload-more-options:hover {
            background: #f9fafb;
        }

        .upload-files-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
            transition: all 0.2s;
        }

        .upload-files-btn:hover {
            background-color: #2563eb;
        }

        .upload-files-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Upload Progress Bar */
        .upload-progress-container {
            width: 100%;
            margin: 24px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .upload-progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .upload-progress-text {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .upload-progress-percent {
            font-size: 14px;
            font-weight: 600;
            color: #3b82f6;
        }

        .upload-progress-bar-wrapper {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .upload-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6 0%, #2563eb 100%);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }

        .upload-progress-status {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }

        /* Upload Success Message */
        .upload-success-container {
            width: 100%;
            padding: 40px 20px;
            text-align: center;
            animation: slideIn 0.4s ease;
        }

        .upload-success-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .upload-success-checkmark {
            width: 80px;
            height: 80px;
            background: #10b981;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
            animation: scaleIn 0.5s ease cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .upload-success-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .upload-success-message {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .upload-success-btn {
            padding: 10px 24px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 12px;
        }

        .upload-success-btn:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        /* Animations */
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Create Folder Modal */
        .create-folder-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .create-folder-modal.show {
            display: flex;
        }

        .create-folder-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .create-folder-header {
            padding: 24px 24px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .create-folder-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .create-folder-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .create-folder-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .create-folder-body {
            padding: 0 24px 24px;
        }

        .create-folder-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .create-folder-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .create-folder-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-folder-btn:hover {
            background-color: #2563eb;
        }

        .create-folder-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 32px 48px;
            border-radius: 12px;
            text-align: center;
        }

        .loading-spinner i {
            font-size: 48px;
            color: #3b82f6;
            margin-bottom: 16px;
        }

        .loading-spinner p {
            font-size: 16px;
            color: #6b7280;
        }

        /* Bottom status bar */
        /* Status Bar - RESPONSIVE */
        .status-bar {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 0.5rem clamp(1rem, 3vw, 1.5rem);
            font-size: clamp(0.6875rem, 1.2vw, 0.8125rem);
            color: #6b7280;
        }

        /* Sidebar - RESPONSIVE */
        .sidebar {
            width: var(--sidebar-width);
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: width 0.3s ease;
            z-index: 10001;
            position: relative;
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
        }

        .sidebar.collapsed .logo span {
            display: none;
        }

        .sidebar.collapsed .logo .dropdown-icon {
            display: none;
        }

        .sidebar.collapsed .section-title {
            display: none;
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .sidebar.collapsed .task-item span {
            display: none;
        }

        .sidebar.collapsed .tasks-section {
            margin-top: 10px;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .sidebar.collapsed .task-item {
            padding: 8px 12px;
            justify-content: center;
            margin-bottom: 5px;
        }

        .sidebar.collapsed .task-item .badge {
            display: none;
        }

        .sidebar.collapsed .task-item i {
            width: auto;
            font-size: 16px;
        }

        /* Hide main content completely when PDF viewer is open */
        body:has(.pdf-viewer-modal.show) .main-content {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
        }

        .logo {
            padding: clamp(0.75rem, 2vh, 1rem) clamp(1rem, 2vw, 1.25rem);
            display: flex;
            align-items: center;
            gap: 0.625rem;
            border-bottom: 1px solid #34495e;
        }

        .logo-img {
            width: clamp(2.25rem, 4vw, 2.75rem);
            height: clamp(2.25rem, 4vw, 2.75rem);
            object-fit: contain;
        }

        .logo i {
            color: #3498db;
            font-size: 1.5rem;
        }

        .logo span {
            font-weight: 700;
            font-size: clamp(0.875rem, 2vw, 1.125rem);
            color: #ecf0f1;
        }

        .logo .dropdown-icon {
            margin-left: auto;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo .dropdown-icon.open {
            transform: rotate(180deg);
        }

        /* Sidebar Project Dropdown */
        .sidebar-project-dropdown {
            position: absolute;
            top: 65px;
            left: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: calc(100% - 40px);
            min-width: 200px;
            max-height: 350px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .sidebar-project-dropdown.show {
            display: block;
        }

        .sidebar-project-search {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-project-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .sidebar-project-search input:focus {
            border-color: #3498db;
        }

        .sidebar-project-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
        }

        .sidebar-project-item:hover {
            background-color: #f8f8f8;
            border-left-color: #3498db;
        }

        .sidebar-project-item.active {
            background-color: #ebf8ff;
            border-left-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }

        .sidebar-project-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background-color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .sidebar-project-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sidebar Dropdown Header with Home and Create buttons */
        .sidebar-project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            gap: 8px;
        }

        .sidebar-home-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            padding: 8px 12px;
            background-color: transparent;
            border: 1.5px solid #FFD700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #FFD700;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 600;
        }

        .sidebar-home-btn i {
            color: #FFD700;
            font-size: 14px;
        }

        .sidebar-home-btn:hover {
            background-color: rgba(255, 215, 0, 0.15);
            border-color: #FFD700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .sidebar-create-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: #FF6B6B;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-weight: bold;
        }

        .sidebar-create-btn i {
            color: white;
        }

        .sidebar-create-btn:hover {
            background-color: #FF5252;
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 107, 107, 0.4);
        }

        .sidebar-create-btn:active {
            transform: scale(0.95);
        }

        .section-title {
            padding: 8px 16px 15px;
            font-size: 13px;
            text-transform: uppercase;
            color: #3498db;
            letter-spacing: 1.5px;
            font-weight: 800;
            opacity: 0.95;
        }

        .menu-item {
            padding: clamp(0.625rem, 1.5vh, 0.75rem) clamp(1rem, 2vw, 1.25rem);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: clamp(0.9375rem, 1.8vw, 1.1875rem);
            color: #ecf0f1;
        }

        .menu-item:hover {
            background-color: #34495e;
        }

        .menu-item.active {
            background-color: #3498db;
            color: white;
        }

        .menu-item i {
            width: 1.25rem;
            text-align: center;
            font-size: 1.125rem;
        }

        .tasks-section {
            margin-top: 30px;
            border-top: 2px solid rgba(52, 152, 219, 0.4);
            padding-top: 18px;
            padding-bottom: 15px;
            flex-shrink: 0;
        }

        .task-item {
            padding: 11px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 18px;
            color: #ffffff;
            border-radius: 8px;
            margin-bottom: 7px;
            position: relative;
            overflow: hidden;
        }

        .task-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        .task-item:hover {
            background-color: rgba(52, 152, 219, 0.12);
            color: #ffffff;
            transform: translateX(3px);
            box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.2);
        }

        .task-item:hover::before {
            background-color: #3498db;
        }

        .task-item.active {
            background-color: rgba(52, 152, 219, 0.2);
            color: #ffffff;
            font-weight: 600;
            letter-spacing: 0.3px;
            box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.3);
        }

        .task-item.active::before {
            background-color: #3498db;
            width: 4px;
        }

        .task-item .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-item .badge {
            background-color: #3498db;
            color: white;
            padding: 4px 9px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 800;
            min-width: 22px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
        }

        .task-item:hover .badge {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }

        .task-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .task-item:hover i {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            border-top: 2px solid rgba(52, 152, 219, 0.3);
            margin-top: auto;
            justify-content: center;
        }

        .footer-icon {
            cursor: pointer;
            color: #7f8c8d;
            transition: all 0.3s ease;
            font-size: 20px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            padding: 6px;
        }

        .footer-icon:hover {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.15);
            transform: scale(1.1);
        }

        /* Header Section */
        .header {
            background-color: white;
            padding: 12px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            gap: 20px;
            position: relative;
            z-index: 10001; /* Higher than PDF viewer (10000) to stay on top */
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 0;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #374151;
            transition: color 0.2s;
            z-index: 10001;
            position: relative;
        }

        .sidebar-toggle-btn:hover {
            color: #1f2937;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 8px 15px;
            border-radius: 4px;
            width: 300px;
            min-width: 200px;
            max-width: 100%;
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            margin-left: 10px;
            width: 100%;
            font-size: 14px;
        }

        .search-box i {
            color: #9ca3af;
            font-size: 16px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .notification-icon:hover {
            transform: scale(1.1);
        }

        .notification-panel, .help-panel {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .notification-panel.show, .help-panel.show {
            display: block;
        }

        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .mark-all-read {
            font-size: 12px;
            color: #3498db;
            cursor: pointer;
            transition: color 0.2s;
        }

        .mark-all-read:hover {
            color: #2563eb;
        }

        .help-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .help-item:hover {
            background-color: #f9fafb;
        }

        .help-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .help-item-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .user-dropdown {
            position: relative;
            cursor: pointer;
        }

        .user-dropdown > span:first-child {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }

        .user-dropdown > span:last-child {
            font-size: 12px;
            color: #9ca3af;
        }

        .user-dropdown-content {
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 250px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown-content.show {
            display: block;
        }

        .user-dropdown-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-full-name {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .user-email {
            font-size: 12px;
            color: #6b7280;
        }

        .user-dropdown-menu {
            padding: 8px 0;
        }

        .user-dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 20px;
            border: none;
            background: none;
            text-align: left;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background-color: #f9fafb;
        }

        /* Notification Styles */
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f7fafc;
        }

        .notification-item.unread {
            background: #ebf8ff;
        }

        .notification-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 5px;
        }

        .notification-icon-circle {
            width: 8px;
            height: 8px;
            background: #3182ce;
            border-radius: 50%;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .notification-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .notification-type-badge.People {
            background: #e6f7ff;
            color: #1890ff;
        }

        .notification-type-badge.Project {
            background: #f0f5ff;
            color: #6366f1;
        }

        .notification-type-badge.Account {
            background: #fff7e6;
            color: #fa8c16;
        }

        .notification-type-badge.Alerts {
            background: #fff1f0;
            color: #f5222d;
        }

        .notification-type-badge.Tasks {
            background: #f6ffed;
            color: #52c41a;
        }

        .notification-type-badge.Forms {
            background: #f9f0ff;
            color: #722ed1;
        }

        /* Help Item Styles */
        .help-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .help-item:hover {
            background: #f7fafc;
        }

        .help-item-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .help-item-desc {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        /* ========== PDF VIEWER MODAL STYLES ========== */

        /* PDF Viewer Modal */
        .pdf-viewer-modal {
            display: flex;
            flex-direction: column;
            position: fixed;
            top: var(--action-bar-height);
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 10000;
            margin: 0 !important;
            padding: 0 !important;
            visibility: hidden;
            opacity: 0;
            transition: left 0.3s ease;
            overflow: hidden;
        }

        .pdf-viewer-modal.show {
            visibility: visible;
            opacity: 1;
        }

        /* When sidebar is collapsed, expand PDF viewer to full width */
        .sidebar.collapsed ~ .pdf-viewer-modal {
            left: var(--sidebar-collapsed-width);
        }

        .sidebar.collapsed ~ .pdf-viewer-modal.show {
            left: var(--sidebar-collapsed-width);
        }

        /* Enhanced Fullscreen Mode - UPDATED */
        .pdf-viewer-modal.fullscreen-mode {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            right: 0 !important;
            bottom: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 99999 !important;
            background: #ffffff !important;
        }

        /* Hide UI elements in fullscreen - UPDATED */
        .pdf-viewer-modal.fullscreen-mode .pdf-viewer-secondary-header {
            display: none !important;
        }

        .pdf-viewer-modal.fullscreen-mode .pdf-tasks-sidebar {
            display: none !important;
        }

        /* KEEP search and eye controls visible in fullscreen */
        .pdf-viewer-modal.fullscreen-mode .pdf-top-right-controls {
            display: flex !important;
            position: fixed !important;
            top: 20px !important;
            right: 20px !important;
            z-index: 100000 !important;
        }

        .pdf-viewer-modal.fullscreen-mode .pdf-bottom-panel {
            display: none !important;
        }

        .pdf-viewer-modal.fullscreen-mode .pdf-date-selector {
            display: none !important;
        }

        .pdf-viewer-modal.fullscreen-mode .pdf-bottom-name-bar {
            display: none !important;
        }

        /* Keep toolbar visible in fullscreen - UPDATED positioning */
        .pdf-viewer-modal.fullscreen-mode .pdf-left-sidebar {
            background-color: rgba(31, 41, 55, 0.95) !important;
            opacity: 1;
            transition: opacity 0.3s ease;
            position: fixed !important;
            left: var(--toolbar-offset) !important;
            top: var(--toolbar-offset) !important;
            z-index: 100000 !important;
        }

        .pdf-viewer-modal.fullscreen-mode .pdf-left-sidebar:hover {
            opacity: 1;
        }

        /* Expand document area to full width in fullscreen - UPDATED */
        .pdf-viewer-modal.fullscreen-mode .pdf-center-content {
            width: 100% !important;
            margin-left: 0 !important;
            padding-left: calc(var(--toolbar-width) + var(--fullscreen-padding-offset)) !important;
        }

        .pdf-viewer-modal.fullscreen-mode .pdf-document-area {
            width: 100% !important;
            max-width: 100% !important;
            padding: var(--fullscreen-padding-offset) clamp(8px, 1vw, 16px) clamp(8px, 1vh, 16px) clamp(8px, 1vw, 16px) !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            overflow: auto !important;
            background: #ffffff !important;
            height: calc(100vh - var(--fullscreen-padding-offset)) !important;
            border: none !important;
        }

        /* PDF content in fullscreen - FIT TO SCREEN */
        .pdf-viewer-modal.fullscreen-mode #pdfDocumentContent {
            width: auto !important;
            max-width: none !important;
            margin: 0 auto !important;
            background: transparent !important;
            padding: 0 !important;
        }

        .pdf-viewer-modal.fullscreen-mode #pdfDocumentContent canvas {
            width: auto !important;
            max-width: none !important;
            height: auto !important;
            margin: 0 !important;
            display: block !important;
            background: white !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
            image-rendering: pixelated !important;
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            -ms-interpolation-mode: high-quality !important;
            -webkit-backface-visibility: hidden !important;
            backface-visibility: hidden !important;
            -webkit-font-smoothing: antialiased !important;
            -moz-osx-font-smoothing: grayscale !important;
            filter: contrast(1.05) saturate(1.02) !important;
            will-change: transform !important;
            contain: layout style paint !important;
        }

        /* PDF canvas - let browser handle scaling naturally */
        .pdf-viewer-modal.fullscreen-mode #pdfDocumentContent canvas {
            transform: none !important;
            transform-origin: top center !important;
            image-rendering: crisp-edges !important;
            image-rendering: -webkit-optimize-contrast !important;
            filter: contrast(1.05) saturate(1.02) !important;
            will-change: transform !important;
        }


        /* Eye dropdown in fullscreen mode */
        .pdf-viewer-modal.fullscreen-mode .eye-dropdown-menu {
            position: fixed !important;
            top: var(--dropdown-top-offset) !important;
            right: var(--toolbar-offset) !important;
            z-index: 100001 !important;
        }

        /* Left Sidebar with Tools */
        .pdf-tools-sidebar {
            width: 60px;
            background: #3a3f47;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            gap: 8px;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            background: #3a3f47;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #4a5058;
        }

        .tool-btn.active {
            background: #5a6268;
        }

        .zoom-group {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 8px;
        }

        .zoom-group .tool-btn {
            border-radius: 0;
            height: 38px;
        }

        .zoom-group .tool-btn:first-child {
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #2a2f37;
        }

        .zoom-group .tool-btn:last-child {
            border-radius: 0 0 8px 8px;
        }

        .tool-separator {
            width: 30px;
            height: 1px;
            background: #5a6268;
            margin: 8px 0;
        }

        .tool-btn.record {
            background: #dc2626;
        }

        .tool-btn.record:hover {
            background: #b91c1c;
        }

        .pdf-nav-arrows {
            margin-top: auto;
            display: flex;
            gap: 0;
        }

        .pdf-nav-arrows .tool-btn {
            width: 28px;
            height: 44px;
            border-radius: 0;
            font-size: 14px;
        }

        .pdf-nav-arrows .tool-btn:first-child {
            border-radius: 8px 0 0 8px;
            border-right: 1px solid #2a2f37;
        }

        .pdf-nav-arrows .tool-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .pdf-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            overflow: hidden;
        }

        .pdf-top-bar {
            background: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }

        .pdf-search {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Professional PDF Search Styles */
        .pdf-search-professional {
            position: absolute;
            top: 12px;
            right: 16px;
            width: 320px;
            background: white;
            border: 1px solid #e0e7ff;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(37, 99, 235, 0.15);
            z-index: 10004;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease;
        }

        .search-pro-header {
            padding: 8px;
            border-bottom: 1px solid #f0f4ff;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .search-pro-input-wrapper {
            display: flex;
            align-items: center;
            gap: 6px;
            background: #f9fafb;
            border-radius: 6px;
            padding: 0 10px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .search-pro-input-wrapper:focus-within {
            border-color: #2563eb;
            background: white;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .search-pro-icon {
            color: #9ca3af;
            font-size: 13px;
            flex-shrink: 0;
        }

        .search-pro-input {
            flex: 1;
            border: none;
            outline: none;
            font-size: 13px;
            padding: 8px 0;
            background: transparent;
            color: #1f2937;
        }

        .search-pro-input::placeholder {
            color: #9ca3af;
        }

        .search-pro-counter {
            font-size: 11px;
            font-weight: 600;
            color: #2563eb;
            background: #eff6ff;
            padding: 2px 6px;
            border-radius: 3px;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .search-pro-controls {
            display: flex;
            gap: 4px;
            justify-content: flex-end;
        }

        .search-pro-btn {
            width: 32px;
            height: 32px;
            border: 1px solid #e5e7eb;
            background: white;
            border-radius: 5px;
            color: #6b7280;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            transition: all 0.2s;
        }

        .search-pro-btn:hover {
            background: #f3f4f6;
            border-color: #2563eb;
            color: #2563eb;
        }

        .search-pro-btn:active {
            background: #eff6ff;
        }

        .close-btn {
            margin-left: 4px;
        }

        .search-pro-results {
            max-height: 280px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .search-pro-results-list {
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .search-result-item {
            padding: 8px 10px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border-left: 3px solid #2563eb;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e5e7eb;
        }

        .search-result-item:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #e0e7ff 100%);
            border-color: #2563eb;
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
        }

        .search-result-item.active {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
            border-color: #1d4ed8;
            color: white;
        }

        .search-result-item.active .result-number,
        .search-result-item.active .result-context {
            color: white;
        }

        .result-number {
            font-size: 10px;
            font-weight: 700;
            color: #2563eb;
            margin-bottom: 2px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .result-context {
            font-size: 12px;
            color: #374151;
            line-height: 1.3;
            word-break: break-word;
        }

        .search-result-more {
            padding: 8px 10px;
            text-align: center;
            color: #6b7280;
            font-size: 11px;
            font-weight: 500;
            margin-top: 4px;
            background: #f9fafb;
            border-radius: 4px;
        }

        /* Scrollbar Styling */
        .search-pro-results::-webkit-scrollbar {
            width: 6px;
        }

        .search-pro-results::-webkit-scrollbar-track {
            background: transparent;
        }

        .search-pro-results::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .search-pro-results::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }

        .search-icon, .view-icon {
            width: 36px;
            height: 36px;
            background: #f3f4f6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .tasks-panel {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tasks-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .new-task-btn {
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        /* PDF Document Area - RESPONSIVE */
        .pdf-document-area {
            flex: 1;
            overflow: auto;
            background: #f5f5f5;
            padding: var(--pdf-padding-vertical) var(--pdf-padding-horizontal) var(--pdf-padding-bottom);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #d1d5db;
        }

        .pdf-document-container {
            width: 100%;
            max-width: 900px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 40px 60px 60px 60px;
            margin: 0 auto;
            min-height: calc(100vh - 200px);
            position: relative;
        }

        .doc-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .company-logo {
            background: #FDB714;
            color: black;
            font-size: 32px;
            font-weight: 900;
            padding: 8px 16px;
            border-radius: 4px;
            letter-spacing: 2px;
        }

        .company-info {
            font-size: 11px;
            color: #374151;
            line-height: 1.4;
            margin-top: 8px;
        }

        .project-info {
            text-align: right;
            font-size: 11px;
            color: #374151;
            line-height: 1.6;
        }

        .doc-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .doc-title h2 {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .doc-title h3 {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .doc-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px 40px;
            margin-bottom: 30px;
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            color: #6b7280;
            text-align: right;
        }

        .description-box {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 30px;
            font-size: 11px;
            line-height: 1.6;
            color: #374151;
        }

        .workflow-section {
            margin-bottom: 30px;
        }

        .workflow-title {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .workflow-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            border: 1px solid #e5e7eb;
        }

        .workflow-table th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 10px 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }

        .workflow-table td {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            color: #6b7280;
        }

        .workflow-table td a {
            color: #3b82f6;
            text-decoration: none;
        }

        .alert-box {
            background: #fef2f2;
            border: 2px solid #dc2626;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
        }

        .doc-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-top: 30px;
            border-top: 2px solid #e5e7eb;
            font-size: 10px;
            color: #6b7280;
            font-weight: 500;
            background: white;
            position: relative;
        }

        .bottom-right-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10001;
        }

        .date-compare-box {
            background: #3a3f47;
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .date-display {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .compare-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
        }

        .bottom-edit-bar {
            position: fixed;
            bottom: 0;
            left: 60px;
            right: 0;
            background: #2a2f37;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .edit-label {
            background: #3a3f47;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-viewer-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-viewer-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* ===== PDF VIEWER SECONDARY HEADER ===== */
        .pdf-viewer-secondary-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: auto;
            min-height: 56px;
            position: relative;
            z-index: 10003;
            margin: 0 !important;
            flex-shrink: 0;
        }

        .pdf-secondary-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-back-btn {
            background: none;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #374151;
            cursor: pointer;
            font-size: 17px;
            font-weight: 500;
            transition: all 0.2s;
            padding: 8px 16px;
            border-radius: 6px;
        }

        .pdf-back-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .pdf-hamburger-btn {
            background: none;
            border: 1px solid #d1d5db;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            padding: 8px 12px;
            border-radius: 6px;
            z-index: 10002;
        }

        .pdf-hamburger-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .pdf-secondary-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-action-btn, .pdf-filter-btn, .pdf-version-btn {
            background: white;
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 17px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .pdf-action-btn:hover, .pdf-filter-btn:hover, .pdf-version-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #1f2937;
        }

        /* ===== PDF ACTIONS DROPDOWN MENU ===== */
        .pdf-actions-dropdown {
            position: relative;
            display: inline-block;
        }

        .pdf-actions-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            min-width: 200px;
            display: none;
            z-index: 10005;
            overflow: visible;
            padding: 4px 0;
        }

        .pdf-actions-dropdown-menu.show {
            display: block;
            animation: dropdownFadeIn 0.15s ease-out;
        }

        @keyframes dropdownFadeIn {
            from {
                opacity: 0;
                transform: translateY(-4px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .pdf-actions-item {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #1f2937;
            transition: background-color 0.15s;
            display: block;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            line-height: 1.5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .pdf-actions-item:hover {
            background-color: #f3f4f6;
        }

        .pdf-actions-item.danger {
            color: #dc2626;
        }

        .pdf-actions-item.danger:hover {
            background-color: #fef2f2;
        }

        .pdf-actions-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }

        /* ===== PDF ROTATION SUBMENU STYLES ===== */

        /* Container for items with submenus */
        .pdf-actions-item-with-submenu {
            position: relative;
        }

        /* Make the rotate button show chevron on the right */
        .pdf-actions-item-with-submenu .pdf-actions-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        /* Rotation submenu styling - appears on hover */
        .pdf-rotate-submenu {
            position: absolute;
            left: 100%;
            top: 0;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: none;
            z-index: 10006;
            padding: 8px;
            margin-left: 4px;
            flex-direction: row;
            gap: 8px;
            min-width: auto;
        }

        /* Show submenu on hover */
        .pdf-actions-item-with-submenu:hover .pdf-rotate-submenu,
        .pdf-rotate-submenu:hover {
            display: flex;
        }

        /* Rotation option buttons */
        .pdf-rotate-option {
            width: auto;
            padding: 10px 16px;
            border: 1px solid #d1d5db;
            background: white;
            text-align: center;
            font-size: 15px;
            font-weight: 500;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            color: #1f2937;
            cursor: pointer;
            transition: all 0.15s;
            display: inline-block;
            line-height: 1.5;
            white-space: nowrap;
            border-radius: 4px;
        }

        .pdf-rotate-option:hover {
            background-color: #f3f4f6;
        }

        /* Rotation animation for canvas */
        @keyframes rotateAnimation {
            from {
                opacity: 0.7;
            }
            to {
                opacity: 1;
            }
        }

        /* Applied to canvas during rotation */
        .rotating {
            animation: rotateAnimation 0.4s ease-out;
        }

        /* ===== VERSION CONTROL MODAL ===== */
        .version-control-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10002;
        }

        .version-control-modal.show {
            display: flex;
        }

        .version-control-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
            position: relative;
        }

        .version-control-header {
            padding: 20px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        .version-control-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .version-control-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .version-control-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .version-control-body {
            padding: 20px 24px;
            overflow-y: auto;
            flex: 1;
        }

        .version-new-btn {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 0 auto 24px auto;
            transition: all 0.2s;
        }

        .version-new-btn:hover {
            background-color: #1d4ed8;
        }

        .version-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .version-item {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 0;
            padding: 16px;
            display: flex;
            gap: 16px;
            transition: all 0.2s;
            position: relative;
            border-bottom: none;
        }

        .version-item:first-child {
            border-radius: 8px 8px 0 0;
        }

        .version-item:last-child {
            border-radius: 0 0 8px 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .version-item:only-child {
            border-radius: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .version-item:hover {
            background: #f9fafb;
        }

        .version-thumbnail {
            width: 120px;
            height: 160px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .version-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .version-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding-right: 120px;
        }

        .version-name {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .version-meta {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .version-field {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .version-field-label {
            font-size: 13px;
            color: #374151;
            font-weight: 500;
            min-width: 80px;
        }

        .version-field-value {
            font-size: 13px;
            color: #6b7280;
            flex: 1;
        }

        .version-field-input {
            flex: 1;
            padding: 6px 10px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
            color: #1f2937;
        }

        .version-field-input:focus {
            outline: none;
            border-color: #2563eb;
        }

        .version-field-notes-value {
            margin-left: 88px;
            margin-top: -4px;
        }

        .version-actions {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .version-btn {
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            min-width: 80px;
        }

        .version-btn-delete {
            background-color: #dc2626;
            color: white;
        }

        .version-btn-delete:hover {
            background-color: #b91c1c;
        }

        .version-btn-edit {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .version-btn-edit:hover {
            background-color: #f3f4f6;
        }

        .version-btn-save {
            background-color: #2563eb;
            color: white;
        }

        .version-btn-save:hover {
            background-color: #1d4ed8;
        }

        .version-btn-cancel {
            background-color: #dc2626;
            color: white;
        }

        .version-btn-cancel:hover {
            background-color: #b91c1c;
        }

        .version-expand-btn {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
        }

        .version-expand-btn:hover {
            background: #f3f4f6;
        }

        .version-expand-btn i {
            font-size: 12px;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ===== PDF VIEWER MAIN WRAPPER ===== */
        .pdf-viewer-main-wrapper {
            display: flex;
            flex-direction: row;
            flex: 1;
            overflow: hidden;
            position: relative;
            margin: 0 !important;
            padding: 0 !important;
            top: 0 !important;
            width: 100%;
            height: 100%;
            min-height: 0;
            z-index: 1;
            pointer-events: none;
        }

        .pdf-viewer-main-wrapper > * {
            pointer-events: auto;
        }

        /* ===== PDF TOOLBAR STYLES - RESPONSIVE ===== */
        .pdf-left-sidebar {
            background-color: #1f2937;
            border-radius: 0.5rem;
            box-shadow: 0 1.25rem 1.5625rem -0.3125rem rgba(0, 0, 0, 0.1);
            padding: 0.5rem;
            display: none;
            flex-direction: column;
            gap: 0.25rem;
            width: auto;
            height: auto;
            position: absolute;
            left: var(--toolbar-offset);
            top: var(--toolbar-offset);
            z-index: 10001;
            min-width: auto;
            max-width: none;
            border-right: none;
            overflow: visible;
            flex-shrink: 0;
            pointer-events: auto;
        }

        /* Show toolbar only when PDF viewer is open */
        .pdf-viewer-modal.show .pdf-left-sidebar {
            display: flex;
        }

        .pdf-tool-btn {
            width: 3rem;
            height: 3rem;
            border: none;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #374151;
            color: #d1d5db;
            font-size: 1.25rem;
            padding: 0;
            margin: 0;
            flex-shrink: 0;
        }

        .pdf-tool-btn:hover {
            background-color: #4b5563;
            color: #ffffff;
        }

        .pdf-tool-btn.active {
            background-color: #2563eb;
            color: #ffffff;
        }

        .pdf-tool-btn.record {
            position: relative;
        }

        .pdf-tool-btn.record.recording {
            background-color: #dc2626;
            color: #ffffff;
        }

        .record-icon {
            width: 20px;
            height: 20px;
            border: 2px solid currentColor;
            border-radius: 50%;
        }

        .record-icon.recording {
            background-color: currentColor;
            animation: pdf-pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pdf-pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        .pdf-tool-separator {
            height: 1px;
            background-color: #4b5563;
            margin: 0.25rem 0;
            width: 100%;
        }

        /* Navigation Arrows Container */
        .nav-arrows-container {
            background-color: #1f2937;
            border-radius: 0.5rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            padding: 0;
            display: flex;
            gap: 0;
            margin-top: 0.5rem;
            width: 100%;
        }

        .nav-btn {
            width: 50%;
            height: 3rem;
            border: none;
            background-color: #374151;
            color: #d1d5db;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease-in-out;
            padding: 0;
            margin: 0;
        }

        .nav-btn:hover {
            background-color: #4b5563;
            color: #ffffff;
        }

        .nav-btn:first-child {
            border-radius: 0.375rem 0 0 0.375rem;
            border-right: 1px solid #2a2f37;
        }

        .nav-btn:last-child {
            border-radius: 0 0.375rem 0.375rem 0;
        }

        /* ===== PDF CENTER CONTENT ===== */
        .pdf-center-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
            width: 100%;
            min-width: 0;
            min-height: 0;
        }

        /* Enhanced PDF document area */
        .pdf-document-area {
            flex: 1;
            overflow: auto;
            background: #f5f5f5;
            padding: var(--pdf-padding-vertical) var(--pdf-padding-horizontal) var(--pdf-padding-bottom) var(--pdf-padding-horizontal);
            position: relative;
            display: flex;
            align-items: center; /* âœ… CHANGED: center instead of flex-start */
            justify-content: center;
            border-top: 1px solid #d1d5db;
            border-left: 1px solid #d1d5db;
            border-right: 1px solid #d1d5db;
            border-bottom: none;
            perspective: 1000px;
            cursor: default;
            user-select: none;
            /* âœ… ADDED: Ensure scrollbars are always visible when content overflows */
            overflow-x: auto !important;
            overflow-y: auto !important;
        }

        .pdf-document-area.grabbing {
            cursor: grabbing !important;
        }

        .pdf-document-area::-webkit-scrollbar {
            display: none;
        }

        /* Enhanced PDF document content container */
        #pdfDocumentContent {
            width: auto; /* âœ… CHANGED: auto instead of 100% */
            max-width: none;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            background: transparent;
            padding: 0; /* âœ… Padding will be added dynamically when zoomed */
            box-shadow: none !important;
            outline: none !important;
            border: none !important;
            filter: none !important;
            min-height: auto;
            align-items: center;
            justify-content: center;
            /* âœ… ADDED: Allow content to expand beyond viewport */
            min-width: min-content;
        }

        /* PDF document content rotation support */
        #pdfDocumentContent {
            transition: transform 0.4s ease-out;
            transform-origin: center center;
        }

        /* PDF canvas styling */
        #pdfDocumentContent canvas {
            display: block !important;
            margin: 0 auto 20px auto !important;
            background: white !important;
            border: 1px solid #d1d5db !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            image-rendering: -webkit-optimize-contrast !important;
            image-rendering: crisp-edges !important;
            -ms-interpolation-mode: high-quality !important;
        }

        /* Remove white frame from all canvas elements */
        canvas {
            border-radius: 0px !important;
            box-shadow: none !important;
            filter: none !important;
        }

        /* PDF Top Right Controls - In Header */
        .pdf-top-right-controls-header {
            display: flex;
            gap: 8px;
            align-items: center;
            position: relative;
        }

        /* PDF Top Right Controls */
        .pdf-top-right-controls {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
            z-index: 10001;
            background: white;
            padding: 6px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .pdf-control-icon {
            width: 40px;
            height: 40px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            color: #374151;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .pdf-control-icon:hover {
            background: #e5e7eb;
            border-color: #d1d5db;
        }

        /* Eye Dropdown Menu */
        .eye-dropdown-menu {
            position: absolute;
            top: 60px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 320px;
            max-height: 600px;
            overflow-y: auto;
            display: none;
            z-index: 10010;
        }

        .eye-dropdown-menu.show {
            display: block;
        }

        .eye-dropdown-header {
            padding: 16px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .eye-dropdown-section {
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
        }

        .eye-dropdown-label {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
        }

        .eye-dropdown-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .eye-dropdown-colors {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .eye-color-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
        }

        .eye-color-circle.selected {
            border-color: #3b82f6;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }

        /* PDF Name Display at Bottom */
        .pdf-bottom-name-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 10002;
            height: 48px;
            border-top: 1px solid #e5e7eb;
        }

        .pdf-name-display {
            background: #1f2937;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pdf-name-display:hover {
            background: #374151;
            transform: scale(1.02);
        }

        .pdf-name-display i {
            color: #9ca3af;
            transition: color 0.2s;
        }

        .pdf-name-display:hover i {
            color: #60a5fa;
        }

        /* ===== PDF RIGHT TASKS SIDEBAR ===== */
        .pdf-tasks-sidebar {
            width: 480px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
        }

        .pdf-tasks-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 20px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: auto;
            flex-shrink: 0;
        }

        .pdf-tasks-title {
            font-size: 17px;
            font-weight: 500;
            color: #1f2937;
        }

        .pdf-tasks-header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pdf-tasks-close-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #6b7280;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pdf-tasks-close-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .pdf-tasks-add-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #2563eb;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pdf-tasks-add-btn:hover {
            background: #eff6ff;
        }

        /* New Tasks Button - Magnifying Glass Icon */
        /* REMOVED - Old circular button style */
        /* .pdf-tasks-new-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: white;
            border: none;
            border-radius: 50%;
            width: 80px;
            height: 80px;
            font-size: 32px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(59, 130, 246, 0.35);
        }

        .pdf-tasks-new-btn:hover {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            box-shadow: 0 12px 28px rgba(59, 130, 246, 0.45);
            transform: scale(1.08);
        }

        .pdf-tasks-new-btn:active {
            transform: scale(0.95);
        }

        .pdf-tasks-new-btn i {
            font-size: 36px;
        }

        .pdf-tasks-new-btn span {
            display: none;
        } */

        /* Professional New Task Button - Immediately Under Header */
        .pdf-tasks-new-text-btn {
            background: white;
            border: none;
            border-bottom: 1px solid #f3f4f6;
            color: #1f2937;
            font-size: 17px;
            cursor: pointer;
            padding: 14px 24px;
            width: 100%;
            text-align: left;
            transition: all 0.2s;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }

        .pdf-tasks-new-text-btn i {
            font-size: 12px;
            color: #9ca3af;
            transition: color 0.2s;
        }

        .pdf-tasks-new-text-btn:hover {
            background: #fafbfc;
            color: #3b82f6;
        }

        .pdf-tasks-new-text-btn:hover i {
            color: #3b82f6;
        }

        .pdf-tasks-new-text-btn:active {
            background: #f3f4f6;
        }

        .pdf-tasks-content {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .pdf-tasks-content::-webkit-scrollbar {
            width: 6px;
        }

        .pdf-tasks-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .pdf-tasks-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        /* ===== PDF BOTTOM PANELS ===== */
        .pdf-bottom-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 14px 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            z-index: 10001;
            min-width: auto;
        }

        .pdf-panel-title {
            font-size: 12px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 6px;
        }

        .pdf-date-display {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .pdf-compare-btn {
            background: white;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .pdf-compare-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .pdf-date-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10001;
            min-width: 160px;
        }

        .pdf-date-selector input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            color: #1f2937;
        }

        .pdf-date-selector input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .pdf-edit-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: transparent;
            padding: 0;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 10002;
            height: 0;
        }


        .pdf-edit-label {
            background: #3a3f47;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pdf-edit-label:hover {
            background: #4a5158;
        }

        /* Plan Details Modal */
        .plan-details-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .plan-details-modal.show {
            display: flex;
        }

        .plan-details-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .plan-details-header {
            padding: 24px 24px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }

        .plan-details-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .plan-details-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .plan-details-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .plan-details-body {
            padding: 24px;
        }

        .plan-details-field {
            margin-bottom: 20px;
        }

        .plan-details-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .plan-details-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .plan-details-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .plan-details-save-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 8px;
        }

        .plan-details-save-btn:hover {
            background-color: #2563eb;
        }

        .plan-details-save-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Recent Activity Modal Styles */
        /* ===== ENTERPRISE PROFESSIONAL RECENT ACTIVITY MODAL ===== */

        .recent-activity-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }

        .recent-activity-modal.show {
            display: flex;
        }

        .recent-activity-content {
            background: white;
            border-radius: 16px;
            width: 95%;
            max-width: 1100px;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.35);
            animation: modalSlideUp 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        /* Professional Gradient Header */
        .recent-activity-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            padding: 32px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .recent-activity-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
            pointer-events: none;
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 1;
        }

        .header-icon-wrapper {
            width: 56px;
            height: 56px;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .header-icon-wrapper i {
            font-size: 28px;
            color: white;
        }

        .header-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .recent-activity-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin: 0;
            letter-spacing: -0.5px;
        }

        .header-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
            margin: 0;
            font-weight: 400;
        }

        .recent-activity-close {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 20px;
            color: white;
            cursor: pointer;
            padding: 12px;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.3s ease;
            z-index: 1;
        }

        .recent-activity-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* Advanced Filter Section */
        .recent-activity-filters {
            padding: 24px 40px;
            background: #f8f9fa;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .filter-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .filter-label {
            font-size: 12px;
            font-weight: 700;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .filter-buttons {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .activity-filter-btn {
            padding: 10px 20px;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-filter-btn i {
            font-size: 14px;
            color: #9ca3af;
            transition: color 0.3s;
        }

        .activity-filter-btn:hover {
            border-color: #667eea;
            background: #f5f3ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .activity-filter-btn:hover i {
            color: #667eea;
        }

        .activity-filter-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
        }

        .activity-filter-btn.active i {
            color: white;
        }

        .filter-count {
            background: rgba(0, 0, 0, 0.1);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
        }

        .activity-filter-btn:not(.active) .filter-count {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* Search and Sort Controls */
        .filter-controls {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .search-wrapper {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-wrapper i {
            position: absolute;
            left: 16px;
            color: #9ca3af;
            font-size: 14px;
        }

        .activity-search {
            width: 100%;
            padding: 12px 16px 12px 44px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        .activity-search:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .sort-dropdown {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
        }

        .sort-dropdown:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* Activity Timeline Body */
        .recent-activity-body {
            flex: 1;
            overflow-y: auto;
            padding: 32px 40px;
            background: #fafbfc;
        }

        .recent-activity-body::-webkit-scrollbar {
            width: 8px;
        }

        .recent-activity-body::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .recent-activity-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .recent-activity-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* Professional Activity Items */
        .activity-date-group {
            margin-bottom: 40px;
        }

        .activity-date-header {
            font-size: 13px;
            font-weight: 800;
            color: #667eea;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .activity-date-header::after {
            content: '';
            flex: 1;
            height: 2px;
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.3) 0%, transparent 100%);
        }

        .activity-item {
            position: relative;
            padding: 24px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 16px;
            transition: all 0.3s ease;
            display: flex;
            gap: 24px;
            align-items: flex-start;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .activity-item:hover {
            border-color: #667eea;
            box-shadow: 0 12px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }

        .activity-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px 0 0 12px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .activity-item:hover::before {
            opacity: 1;
        }

        .activity-user-avatar {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 20px;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            border: 3px solid white;
        }

        .activity-user-avatar::after {
            content: '';
            position: absolute;
            bottom: -2px;
            right: -2px;
            width: 16px;
            height: 16px;
            background: #10b981;
            border: 3px solid white;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .activity-details {
            flex: 1;
            min-width: 0;
        }

        .activity-user-name {
            font-size: 16px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 6px;
        }

        .activity-action {
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 12px;
            line-height: 1.6;
        }

        .activity-action strong {
            color: #374151;
            font-weight: 700;
        }

        .activity-meta {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 14px;
        }

        .activity-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 13px;
            color: #9ca3af;
            font-weight: 500;
        }

        .activity-meta-item i {
            font-size: 12px;
            color: #cbd5e1;
        }

        .activity-folder-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #fbbf24;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            color: #92400e;
            box-shadow: 0 2px 4px rgba(251, 191, 36, 0.2);
        }

        .activity-folder-badge i {
            font-size: 11px;
        }

        .activity-thumbnail {
            width: 88px;
            height: 120px;
            border-radius: 10px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: 2px solid #e5e7eb;
            overflow: hidden;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.08);
            position: relative;
            transition: all 0.3s;
        }

        .activity-item:hover .activity-thumbnail {
            transform: scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.12);
        }

        .activity-thumbnail canvas {
            width: 100%;
            height: 100%;
            display: block;
            background: white;
            border-radius: 8px;
        }

        .activity-thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .activity-thumbnail i {
            font-size: 36px;
            color: #d1d5db;
        }

        .activity-time-badge {
            position: absolute;
            top: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Statistics Footer */
        .activity-footer {
            padding: 20px 40px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-top: 1px solid #e5e7eb;
        }

        .footer-stats {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 40px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .stat-item i {
            font-size: 24px;
            color: #667eea;
        }

        .stat-item span:nth-child(2) {
            font-size: 28px;
            font-weight: 800;
            color: #1f2937;
            line-height: 1;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-divider {
            width: 1px;
            height: 40px;
            background: #d1d5db;
        }

        /* Empty State */
        .activity-empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .activity-empty-icon {
            width: 140px;
            height: 140px;
            margin: 0 auto 32px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 56px;
            color: #9ca3af;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.08);
        }

        .activity-empty-title {
            font-size: 22px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 12px;
        }

        .activity-empty-description {
            font-size: 15px;
            color: #9ca3af;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes modalSlideUp {
            from {
                opacity: 0;
                transform: translateY(50px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ===== TASK CREATION MODAL ===== */
        .task-creation-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10005;
        }

        .task-creation-modal.show {
            display: flex;
        }

        /* Task Modal - RESPONSIVE */
        .task-creation-content {
            background: #fafbfc;
            width: clamp(85%, 95%, 95%);
            max-width: 68.75rem;
            max-height: 95vh;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
        }

        .task-creation-header {
            padding: clamp(0.75rem, 2vh, 1rem) clamp(1rem, 2vw, 1.25rem);
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 1.25rem;
        }

        .task-header-left {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            flex: 1;
        }

        .task-header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .task-attributes-label {
            font-size: 17px;
            font-weight: 500;
            color: #6b7280;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .task-icon-square {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 4px;
            flex-shrink: 0;
        }

        .task-header-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .task-number {
            font-size: 17px;
            color: #6b7280;
            font-weight: 500;
        }

        .task-title-edit {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-title-input {
            border: none;
            font-size: 17px;
            font-weight: 500;
            color: #1f2937;
            padding: 4px 0;
            outline: none;
            min-width: 200px;
        }

        .task-title-input:focus {
            border-bottom: 2px solid #3b82f6;
        }

        .task-title-icon {
            color: #3b82f6;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-title-icon:hover {
            transform: scale(1.1);
            color: #2563eb;
        }

        .task-close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .task-close-btn:hover {
            background: #f3f4f6;
            color: #ef4444;
            transform: scale(1.1);
        }

        /* Body */
        .task-creation-body {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .task-left-section {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 24px;
            border-right: 1px solid #e5e7eb; /* THIN ASH VERTICAL LINE */
            background: white;
        }

        .task-right-section {
            width: 380px;
            padding: 16px 20px;
            background: #fafbfc;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .task-section {
            margin-bottom: 24px;
        }

        .task-section-label {
            display: block;
            font-size: 17px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .task-links {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-link-btn {
            background: none;
            border: none;
            color: #3b82f6;
            font-size: 17px;
            font-weight: 500;
            cursor: pointer;
            padding: 4px 0;
            transition: color 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .task-link-btn:hover {
            color: #2563eb;
        }

        .task-separator {
            color: #d1d5db;
            font-size: 17px;
            font-weight: 500;
        }

        .dropdown-trigger {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Task Attributes */
        .task-attributes-header {
            font-size: 17px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        .task-attribute-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .task-attribute-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 17px;
            font-weight: 500;
            color: #6b7280;
            min-width: 120px;
        }

        .task-attribute-label i {
            font-size: 16px;
            color: #6b7280;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Professional Status Icon Styling */
        .task-attribute-row:first-of-type .task-attribute-label i {
            color: #3b82f6;
            font-size: 18px;
            transition: all 0.3s ease;
        }

        .task-attribute-row:first-of-type .task-attribute-label:hover i {
            color: #2563eb;
            transform: scale(1.15);
            filter: drop-shadow(0 2px 4px rgba(59, 130, 246, 0.3));
        }

        .task-attribute-value {
            flex: 1;
            text-align: right;
        }

        .task-select,
        .task-input {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 6px 10px;
            font-size: 17px;
            font-weight: 500;
            color: #374151;
            background: white;
            width: 100%;
            max-width: 200px;
        }

        .task-select:focus,
        .task-input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        /* Plan Attachment */
        .task-plan-attachment {
            margin: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .task-attachment-preview {
            position: relative;
            width: 100%;
            max-width: 260px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .task-attachment-preview canvas {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 0;
            position: relative;
            z-index: 1;
            background: white;
        }

        .task-attachment-edit {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: white;
            border: 1.5px solid #d1d5db;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            z-index: 2;
        }

        .task-attachment-edit:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: scale(1.05);
        }

        .task-attachment-edit i {
            font-size: 12px;
            color: #6b7280;
        }

        .task-attachment-name {
            font-size: 17px;
            font-weight: 500;
            color: #1f2937;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9fafb;
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        /* Footer */
        .task-creation-footer {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            background: white;
            position: relative;
            bottom: 0;
            left: 0;
            right: 0;
        }

        .task-footer-left {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px;
            max-width: calc(100% - 120px);
        }

        .task-attach-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .task-attach-btn i {
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .task-attach-btn:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .task-attach-btn:hover i {
            transform: scale(1.1);
        }

        .task-message-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 14px;
            outline: none;
            background: white;
            transition: border-color 0.2s;
        }

        .task-message-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .task-share-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .task-share-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .task-share-btn:active {
            transform: translateY(0);
        }

        /* ===== INLINE MESSAGE & SHARE IN LEFT SECTION ===== */
        .task-message-share-container {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 0;
            border-top: 1px solid #e5e7eb;
            margin-top: 12px;
        }

        .task-attach-icon-btn {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .task-attach-icon-btn i {
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .task-attach-icon-btn:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .task-attach-icon-btn:hover i {
            transform: scale(1.1);
        }

        .task-message-inline-input {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 10px 14px;
            font-size: 14px;
            outline: none;
            background: white;
            transition: border-color 0.2s;
        }

        .task-message-inline-input:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .task-share-inline-btn {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 10px 24px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .task-share-inline-btn:hover {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .task-share-inline-btn:active {
            transform: translateY(0);
        }

        /* ===== FOOTER ON LEFT SIDE - OPPOSITE WATCHERS ===== */
        .task-footer-left-bottom {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-top: auto;
            padding-top: 24px;
        }

        .task-attach-btn-left {
            width: 40px;
            height: 40px;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: #6b7280;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .task-attach-btn-left i {
            font-size: 18px;
            transition: all 0.2s ease;
        }

        .task-attach-btn-left:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
            color: #3b82f6;
        }

        .task-attach-btn-left:hover i {
            transform: scale(1.1);
        }

        .task-message-input-left {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 9px 14px;
            font-size: 14px;
            outline: none;
            background: white;
            transition: border-color 0.2s;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .task-message-input-left:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .task-message-input-left::placeholder {
            color: #9ca3af;
        }

        .task-share-btn-left {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 6px;
            padding: 9px 18px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            white-space: nowrap;
            flex-shrink: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .task-share-btn-left:hover {
            background: #2563eb;
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .task-share-btn-left i {
            font-size: 11px;
        }

        /* ===== NAVIGATION ARROWS - VISIBLE OUTSIDE MODAL ===== */
        .task-nav-arrow {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.98);
            border: 2px solid #e5e7eb;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10007;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            transition: all 0.2s ease;
            color: #374151;
            font-size: 24px;
        }

        .task-nav-arrow:hover {
            background: white;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            color: #1f2937;
            border-color: #3b82f6;
        }

        .task-nav-left {
            left: calc(50% - 630px);
        }

        .task-nav-right {
            right: calc(50% - 630px);
        }

        .task-nav-arrow:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Hide arrows on small screens */
        @media (max-width: 1400px) {
            .task-nav-arrow {
                display: none;
            }
        }

        /* ===== PROFESSIONAL PIN MARKER STYLES ===== */
        .task-pin-marker {
            position: absolute;
            width: 48px;
            height: 58px;
            transform: translate(-50%, -100%);
            z-index: 10000;
            pointer-events: auto;
            cursor: pointer;
            filter: drop-shadow(0 6px 12px rgba(255, 107, 53, 0.5));
            animation: pinDrop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            transition: transform 0.2s ease;
        }

        .task-pin-marker:hover {
            transform: translate(-50%, -100%) scale(1.15);
            filter: drop-shadow(0 8px 16px rgba(255, 107, 53, 0.7));
        }

        .task-pin-marker svg {
            width: 100%;
            height: 100%;
        }

        .task-pin-marker .pin-pulse {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            background: rgba(255, 107, 53, 0.3);
            border-radius: 50%;
            animation: pulse 2s ease-out infinite;
            pointer-events: none;
        }

        @keyframes pinDrop {
            0% {
                transform: translate(-50%, -250%) scale(0.2);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -95%) scale(1.15);
            }
            65% {
                transform: translate(-50%, -102%) scale(0.95);
            }
            80% {
                transform: translate(-50%, -98%) scale(1.05);
            }
            100% {
                transform: translate(-50%, -100%) scale(1);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0.7;
            }
            50% {
                transform: translateX(-50%) scale(1.5);
                opacity: 0.3;
            }
            100% {
                transform: translateX(-50%) scale(2.2);
                opacity: 0;
            }
        }

        /* Professional crosshair cursor with pin icon */
        .pdf-document-area.adding-task-mode {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><defs><filter id="shadow"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.5"/></filter></defs><path fill="%23FF6B35" stroke="%23ffffff" stroke-width="1.5" d="M16 6c-3.3 0-6 2.7-6 6 0 4.5 6 10.5 6 10.5s6-6 6-10.5c0-3.3-2.7-6-6-6zm0 8c-1.1 0-2-0.9-2-2s0.9-2 2-2 2 0.9 2 2-0.9 2-2 2z" filter="url(%23shadow)"/><line x1="16" y1="1" x2="16" y2="5" stroke="%23FF6B35" stroke-width="2"/><line x1="16" y1="27" x2="16" y2="31" stroke="%23FF6B35" stroke-width="2"/><line x1="1" y1="16" x2="5" y2="16" stroke="%23FF6B35" stroke-width="2"/><line x1="27" y1="16" x2="31" y2="16" stroke="%23FF6B35" stroke-width="2"/></svg>') 16 16, crosshair !important;
        }

        .pdf-document-area.adding-task-mode * {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><defs><filter id="shadow"><feDropShadow dx="0" dy="1" stdDeviation="1" flood-opacity="0.5"/></filter></defs><path fill="%23FF6B35" stroke="%23ffffff" stroke-width="1.5" d="M16 6c-3.3 0-6 2.7-6 6 0 4.5 6 10.5 6 10.5s6-6 6-10.5c0-3.3-2.7-6-6-6zm0 8c-1.1 0-2-0.9-2-2s0.9-2 2-2 2 0.9 2 2-0.9 2-2 2z" filter="url(%23shadow)"/><line x1="16" y1="1" x2="16" y2="5" stroke="%23FF6B35" stroke-width="2"/><line x1="16" y1="27" x2="16" y2="31" stroke="%23FF6B35" stroke-width="2"/><line x1="1" y1="16" x2="5" y2="16" stroke="%23FF6B35" stroke-width="2"/><line x1="27" y1="16" x2="31" y2="16" stroke="%23FF6B35" stroke-width="2"/></svg>') 16 16, crosshair !important;
        }

        /* Highlight effect when clicking on task */
        .task-pin-marker.highlight {
            animation: highlightPulse 1.5s ease-out;
        }

        @keyframes highlightPulse {
            0%, 100% {
                transform: translate(-50%, -100%) scale(1);
                filter: drop-shadow(0 6px 12px rgba(255, 107, 53, 0.5));
            }
            25% {
                transform: translate(-50%, -100%) scale(1.3);
                filter: drop-shadow(0 12px 24px rgba(255, 107, 53, 0.9));
            }
            50% {
                transform: translate(-50%, -100%) scale(1.15);
                filter: drop-shadow(0 8px 16px rgba(255, 107, 53, 0.7));
            }
            75% {
                transform: translate(-50%, -100%) scale(1.25);
                filter: drop-shadow(0 10px 20px rgba(255, 107, 53, 0.8));
            }
        }

        .pdf-tool-btn[data-tool="addtask"].active {
            background-color: #FF6B35 !important;
            color: white !important;
        }

        /* Task card highlight animation */
        @keyframes taskHighlight {
            0%, 100% {
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                border-left-color: #FF6B35;
            }
            25% {
                box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.3), 0 4px 12px rgba(0, 0, 0, 0.15);
                border-left-color: #f7931e;
            }
            50% {
                box-shadow: 0 0 0 8px rgba(255, 107, 53, 0.2), 0 6px 16px rgba(0, 0, 0, 0.2);
                border-left-color: #FF6B35;
            }
            75% {
                box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.3), 0 4px 12px rgba(0, 0, 0, 0.15);
                border-left-color: #f7931e;
            }
        }

        /* ===== PROFESSIONAL TASK MODAL STYLING - MATCH IMAGE 2 ===== */
        .task-creation-modal {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
        }

        .task-creation-content {
            background: #fafbfc;
        }

        .task-number {
            font-size: clamp(0.875rem, 1.5vw, 1.0625rem);
            font-weight: 500;
            color: #6b7280;
        }

        .task-title-input,
        .task-select,
        .task-input {
            font-size: clamp(0.875rem, 1.5vw, 1.0625rem);
            padding: clamp(0.375rem, 1vh, 0.5rem) clamp(0.625rem, 1vw, 0.75rem);
        }

        .task-section-label {
            font-size: clamp(0.875rem, 1.5vw, 1.0625rem);
            font-weight: 500;
            color: #374151;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .task-link-btn {
            font-size: clamp(0.875rem, 1.5vw, 1.0625rem);
            font-weight: 500;
            color: #2563eb;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .task-attributes-header {
            font-size: clamp(0.875rem, 1.5vw, 1.0625rem);
            font-weight: 500;
            color: #1f2937;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: white;
            padding: clamp(0.375rem, 1vh, 0.5rem) clamp(0.625rem, 1vw, 0.75rem);
            border-radius: 0.5rem 0.5rem 0 0;
            border: 1px solid #e5e7eb;
            border-bottom: none;
        }

        .task-attribute-row {
            background: white;
            border-left: 1px solid #e5e7eb;
            border-right: 1px solid #e5e7eb;
            padding: 8px 12px;
        }

        .task-attribute-row:last-child {
            border-bottom: 1px solid #e5e7eb;
            border-radius: 0 0 8px 8px;
        }

        .task-attribute-label {
            font-size: 17px;
            font-weight: 500;
            color: #6b7280;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .task-select, .task-input {
            font-size: 17px;
            font-weight: 500;
            color: #374151;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: white;
            border: 1px solid #d1d5db;
        }

        /* ===== ENHANCED PDF PREVIEW WITH DOCUMENT STYLING ===== */
        .task-plan-attachment {
            margin: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: white;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .task-attachment-preview {
            position: relative;
            width: 100%;
            max-width: 260px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            padding: 0;
            margin-bottom: 12px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .task-attachment-preview canvas {
            width: 100%;
            height: auto;
            display: block;
            border-radius: 0;
            position: relative;
            z-index: 1;
            background: white;
        }

        /* Pin marker overlay on preview */
        .task-attachment-preview-pin {
            position: absolute;
            width: 28px;
            height: 36px;
            z-index: 3;
            pointer-events: none;
            transform: translate(-50%, -100%);
        }

        .task-attachment-preview-pin svg {
            width: 100%;
            height: 100%;
            filter: drop-shadow(0 2px 4px rgba(255, 107, 53, 0.4));
            display: block;
        }

        .task-attachment-edit {
            position: absolute;
            top: 16px;
            right: 16px;
            width: 32px;
            height: 32px;
            background: white;
            border: 1.5px solid #d1d5db;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: all 0.2s;
            z-index: 2;
        }

        .task-attachment-edit:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            transform: scale(1.05);
        }

        .task-attachment-edit i {
            font-size: 12px;
            color: #6b7280;
        }

        .task-attachment-name {
            font-size: 17px;
            font-weight: 500;
            color: #1f2937;
            text-align: center;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f9fafb;
            padding: 8px 16px;
            border-radius: 4px;
            border: 1px solid #e5e7eb;
        }

        /* ===== STATUS DROPDOWN STYLING - IMAGE 3 ===== */
        .status-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            display: none;
            z-index: 10010;
            padding: 8px 0;
        }

        .status-dropdown-menu.show {
            display: block;
        }

        .status-dropdown-header {
            padding: 8px 16px;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid #f3f4f6;
            margin-bottom: 4px;
        }

        .status-dropdown-item {
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            transition: background-color 0.15s;
        }

        .status-dropdown-item:hover {
            background-color: #f9fafb;
        }

        .status-color-box {
            width: 20px;
            height: 20px;
            border-radius: 3px;
            flex-shrink: 0;
        }

        .status-dropdown-divider {
            height: 1px;
            background: #e5e7eb;
            margin: 4px 0;
        }

        .status-dropdown-delete {
            color: #dc2626;
            padding: 10px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.15s;
        }

        .status-dropdown-delete:hover {
            background-color: #fef2f2;
        }

        /* ===== PROFESSIONAL MAP PIN MARKER - IMAGE 2 STYLE ===== */
        .pdf-task-pin {
            position: absolute;
            transform: translate(-50%, -100%);
            z-index: 10001;
            cursor: pointer;
            transition: all 0.3s ease;
            animation: pinDrop 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .pdf-task-pin:hover {
            transform: translate(-50%, -100%) scale(1.15);
            filter: drop-shadow(0 8px 20px rgba(255, 107, 53, 0.6));
        }

        .pdf-task-pin-svg {
            position: relative;
            z-index: 2;
            display: block;
        }

        /* Pulsing effect around pin */
        .pdf-task-pin-pulse {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 32px;
            height: 32px;
            background: rgba(255, 107, 53, 0.25);
            border-radius: 50%;
            animation: pinPulse 2.5s ease-out infinite;
            z-index: 1;
        }

        /* Pin drop animation */
        @keyframes pinDrop {
            0% {
                transform: translate(-50%, -300%) scale(0.3);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -95%) scale(1.1);
            }
            65% {
                transform: translate(-50%, -102%) scale(0.95);
            }
            80% {
                transform: translate(-50%, -98%) scale(1.05);
            }
            100% {
                transform: translate(-50%, -100%) scale(1);
                opacity: 1;
            }
        }

        /* Pulse animation */
        @keyframes pinPulse {
            0% {
                transform: translateX(-50%) scale(0.8);
                opacity: 0.6;
            }
            50% {
                transform: translateX(-50%) scale(1.8);
                opacity: 0.2;
            }
            100% {
                transform: translateX(-50%) scale(2.5);
                opacity: 0;
            }
        }

        /* Highlight animation when clicked */
        .pdf-task-pin.pin-highlight {
            animation: pinHighlight 1.5s ease-out;
        }

        @keyframes pinHighlight {
            0%, 100% {
                transform: translate(-50%, -100%) scale(1);
                filter: drop-shadow(0 6px 12px rgba(255, 107, 53, 0.4));
            }
            25% {
                transform: translate(-50%, -100%) scale(1.35);
                filter: drop-shadow(0 12px 28px rgba(255, 107, 53, 0.8));
            }
            50% {
                transform: translate(-50%, -100%) scale(1.15);
                filter: drop-shadow(0 8px 20px rgba(255, 107, 53, 0.6));
            }
            75% {
                transform: translate(-50%, -100%) scale(1.25);
                filter: drop-shadow(0 10px 24px rgba(255, 107, 53, 0.7));
            }
        }

        /* Cursor when in add task mode */
        .pdf-document-area.adding-task-mode {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"><defs><filter id="shadow"><feDropShadow dx="0" dy="2" stdDeviation="1.5" flood-opacity="0.4"/></filter></defs><path d="M16 4C10.5 4 6 8.5 6 14c0 7.5 10 18 10 18s10-10.5 10-18c0-5.5-4.5-10-10-10zm0 13.5c-2 0-3.5-1.5-3.5-3.5s1.5-3.5 3.5-3.5 3.5 1.5 3.5 3.5-1.5 3.5-3.5 3.5z" fill="%23FF6B35" stroke="%23ffffff" stroke-width="2" filter="url(%23shadow)"/></svg>') 16 32, crosshair !important;
        }

        .pdf-document-area.adding-task-mode * {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="40" viewBox="0 0 32 40"><defs><filter id="shadow"><feDropShadow dx="0" dy="2" stdDeviation="1.5" flood-opacity="0.4"/></filter></defs><path d="M16 4C10.5 4 6 8.5 6 14c0 7.5 10 18 10 18s10-10.5 10-18c0-5.5-4.5-10-10-10zm0 13.5c-2 0-3.5-1.5-3.5-3.5s1.5-3.5 3.5-3.5 3.5 1.5 3.5 3.5-1.5 3.5-3.5 3.5z" fill="%23FF6B35" stroke="%23ffffff" stroke-width="2" filter="url(%23shadow)"/></svg>') 16 32, crosshair !important;
        }

        /* ===== TASKS SIDEBAR PANEL - IMAGE 4 ===== */
        .pdf-tasks-list {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .pdf-task-card {
            padding: 14px 20px;
            border-left: 4px solid #ff6b35;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .pdf-task-card:hover {
            background: #fef3f0;
            border-left-color: #f7931e;
        }

        .pdf-task-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .pdf-task-card-number {
            width: 28px;
            height: 28px;
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 700;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            flex-shrink: 0;
            border: 2px solid white;
            box-shadow: 0 2px 8px rgba(255, 107, 53, 0.3);
        }

        .pdf-task-card-title {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .pdf-task-card-meta {
            font-size: 12px;
            color: #6b7280;
            margin-left: 36px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        /* Responsive Typography */
        h1, h2, h3, h4, h5, h6 {
            font-size: clamp(1rem, 2.5vw, 1.5rem);
        }

        p, span, div {
            font-size: clamp(0.875rem, 1.5vw, 1rem);
        }

        /* Header - RESPONSIVE */
        .header {
            background-color: white;
            padding: clamp(0.625rem, 1.5vh, 0.75rem) clamp(1.25rem, 3vw, 1.875rem);
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            gap: clamp(0.75rem, 2vw, 1.25rem);
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 0.5rem clamp(0.75rem, 1.5vw, 0.9375rem);
            border-radius: 0.25rem;
            width: clamp(12.5rem, 25vw, 18.75rem);
        }

        .search-box input {
            font-size: clamp(0.75rem, 1.5vw, 0.875rem);
        }

    </style>
    <script>
        // Detect and adjust layout for browser zoom changes
        function adjustForZoom() {
            const zoom = window.devicePixelRatio || 1;
            const root = document.documentElement;

            // Update CSS variables based on zoom level
            if (zoom > 1.2) {
                // High zoom (125%+): tighter spacing
                root.style.setProperty('--toolbar-offset', 'clamp(8px, 1.5vw, 16px)');
                root.style.setProperty('--pdf-padding-vertical', 'clamp(16px, 3vh, 40px)');
                root.style.setProperty('--pdf-padding-horizontal', 'clamp(12px, 1.5vw, 30px)');
                root.style.setProperty('--pdf-padding-bottom', 'clamp(80px, 12vh, 150px)');
                root.style.setProperty('--dropdown-top-offset', 'clamp(50px, 7vh, 80px)');
                root.style.setProperty('--fullscreen-padding-offset', 'clamp(24px, 3vh, 40px)');
            } else if (zoom > 1.0) {
                // Normal to high zoom (100-125%): medium spacing
                root.style.setProperty('--toolbar-offset', 'clamp(10px, 2vw, 20px)');
                root.style.setProperty('--pdf-padding-vertical', 'clamp(20px, 4vh, 50px)');
                root.style.setProperty('--pdf-padding-horizontal', 'clamp(14px, 2vw, 35px)');
                root.style.setProperty('--pdf-padding-bottom', 'clamp(90px, 14vh, 180px)');
                root.style.setProperty('--dropdown-top-offset', 'clamp(55px, 8vh, 90px)');
                root.style.setProperty('--fullscreen-padding-offset', 'clamp(28px, 4vh, 45px)');
            } else {
                // Low zoom (< 100%): normal spacing
                root.style.setProperty('--toolbar-offset', 'clamp(12px, 2vw, 24px)');
                root.style.setProperty('--pdf-padding-vertical', 'clamp(24px, 4vh, 60px)');
                root.style.setProperty('--pdf-padding-horizontal', 'clamp(16px, 2vw, 40px)');
                root.style.setProperty('--pdf-padding-bottom', 'clamp(100px, 15vh, 200px)');
                root.style.setProperty('--dropdown-top-offset', 'clamp(60px, 8vh, 100px)');
                root.style.setProperty('--fullscreen-padding-offset', 'clamp(30px, 4vh, 50px)');
            }
        }

        // Call on page load
        window.addEventListener('load', adjustForZoom);

        // Call when window resizes (zoom changes trigger resize)
        window.addEventListener('resize', adjustForZoom);

        // Initial call
        adjustForZoom();
    </script>
</head>
<body>
    <div class="container">
        <!-- Sidebar (WITH LOGO, PROJECT NAME AND DROPDOWN) -->
        <div class="sidebar">
            <!-- Logo Section with Project Name and Dropdown -->
            <div class="logo" id="sidebarLogoToggle" style="cursor: pointer; position: relative;">
                <img src="/img/img.webp" alt="Desa Logo" class="logo-img">
                <span style="font-size: 18px; color: #ecf0f1; font-weight: 600; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; flex: 1; line-height: 1.2;" id="sidebarProjectName"><%= projectName || 'Select Project' %></span>
                <i class="fas fa-chevron-down dropdown-icon" id="sidebarLogoDropdownIcon"></i>

                <!-- Project Dropdown Menu -->
                <div class="sidebar-project-dropdown" id="projectDropdown" style="display: none;">
                    <div class="sidebar-project-header">
                        <button class="sidebar-home-btn" onclick="goHome()">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="sidebar-create-btn" onclick="openCreateProjectModal()" title="Create new project">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="sidebar-project-search">
                        <input type="text" placeholder="Search projects..." id="projectSearch">
                    </div>
                    <div id="projectList"></div>
                </div>
            </div>

            <div class="section-title">Pages</div>

            <div class="menu-item">
                <i class="fas fa-edit"></i>
                <span>Plans</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-clipboard-check"></i>
                <span>Specifications</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-camera"></i>
                <span>Photos</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-file-invoice"></i>
                <span>Forms</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-folder"></i>
                <span>Files</span>
            </div>

            <div class="tasks-section">
                <div class="section-title">Tasks</div>

                <div class="task-item active">
                    <div class="left">
                        <i class="fas fa-star"></i>
                        <span>My tasks</span>
                    </div>
                    <span class="badge" id="myTasksBadge" style="display: none;">0</span>
                </div>

                <div class="task-item">
                    <div class="left">
                        <i class="fas fa-eye"></i>
                        <span>Watched tasks</span>
                    </div>
                    <span class="badge" id="watchedTasksBadge" style="display: none;">0</span>
                </div>

                <div class="task-item">
                    <div class="left">
                        <i class="fas fa-th"></i>
                        <span>All tasks</span>
                    </div>
                    <span class="badge" id="allTasksBadge" style="display: none;">0</span>
                </div>

                <div class="task-item">
                    <div class="left">
                        <i class="fas fa-plus"></i>
                        <span>New category</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <i class="fas fa-users footer-icon"></i>
                <i class="fas fa-cog footer-icon"></i>
                <i class="fas fa-trash footer-icon"></i>
            </div>
        </div>

        <!-- Main Content (UPDATED) -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-section">
                    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="Toggle Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search">
                    </div>
                </div>

                <div class="header-right">
                    <div class="user-section">
                        <!-- Notification Bell -->
                        <span class="notification-icon" id="notificationBell" style="position: relative;">
                            ðŸ””
                            <span id="notificationBadge" style="
                                position: absolute;
                                top: -2px;
                                right: -2px;
                                background: #e53e3e;
                                color: white;
                                font-size: 10px;
                                font-weight: 600;
                                padding: 2px 5px;
                                border-radius: 10px;
                            ">0</span>
                        </span>

                        <!-- Help Icon -->
                        <span class="notification-icon" id="helpIcon">â“</span>

                        <!-- Notification Panel -->
                        <div class="notification-panel" id="notificationPanel">
                            <div class="panel-header">
                                <div class="panel-title">Notifications</div>
                                <div class="mark-all-read" id="markAllRead">Mark all as read</div>
                            </div>
                            <div id="notificationsList"></div>
                        </div>

                        <!-- Help Panel -->
                        <div class="help-panel" id="helpPanel">
                            <div class="panel-header">
                                <div class="panel-title">Help & Support</div>
                            </div>
                            <div class="help-item" onclick="window.open('https://www.desa.ca/', '_blank')">
                                <div class="help-item-title">ðŸ“š Documentation</div>
                                <div class="help-item-desc">Browse our complete documentation</div>
                            </div>
                            <div class="help-item" onclick="contactSupport()">
                                <div class="help-item-title">ðŸ’¬ Contact Support</div>
                                <div class="help-item-desc">Get help from our support team</div>
                            </div>
                        </div>

                        <!-- User Dropdown -->
                        <div class="user-dropdown" id="userDropdownToggle">
                            <span><%= user ? user.username : 'Guest' %></span>
                            <span>â–¼</span>
                            <div class="user-dropdown-content" id="userDropdown">
                                <div class="user-dropdown-header">
                                    <div class="user-full-name"><%= user ? user.username : 'Guest' %></div>
                                    <div class="user-email"><%= user ? user.email : 'guest@example.com' %></div>
                                </div>
                                <div class="user-dropdown-menu">
                                    <a href="/account" class="user-dropdown-item">View account</a>
                                    <a href="#" class="user-dropdown-item" onclick="signOut()">Sign out</a>
                                </div>
                            </div>
                        </div>

                        <span>ðŸ‡¨ðŸ‡¦</span>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div class="action-bar-left">
                    <button class="btn-primary" onclick="openUploadModal()">
                        <i class="fas fa-plus"></i>
                        <span>New plan</span>
                    </button>
                    <button class="btn-secondary" onclick="openCreateFolderModal()">
                        <i class="fas fa-plus"></i>
                        <span>New folder</span>
                    </button>
                    <button class="btn-secondary">
                        <span>Actions</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <button class="btn-secondary" onclick="openRecentActivityModal()">
                        <i class="fas fa-clock"></i>
                        <span>Recent Activity</span>
                    </button>
                </div>
                <div class="action-bar-right">
                    <button class="btn-secondary">
                        <i class="fas fa-filter"></i>
                        <span>Filter plans</span>
                    </button>
                    <button class="btn-secondary">
                        <span>Version control</span>
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            <!-- Plans Content -->
            <div class="plans-content" id="plansContent">
                <!-- Empty State (shown when no files) -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">
                        <div class="empty-state-icon-inner">
                            <div class="empty-state-play"></div>
                        </div>
                    </div>
                    <h2 class="empty-state-title">Drop your plans here to get started</h2>
                    <p class="empty-state-description">Plans will sync across all of your devices to provide your team with the latest information.</p>
                </div>

                <!-- Plans View (shown when files exist) -->
                <div id="plansView" style="display: none;">
                    <!-- All plans folder -->
                    <div class="folder-section" id="allPlansSection" style="display: none;">
                        <div class="folder-header">
                            <input type="checkbox" class="folder-checkbox" id="allPlansCheckbox">
                            <i class="fas fa-folder folder-icon"></i>
                            <span class="folder-name" id="allPlansName">All plans (0 plans)</span>
                            <div class="folder-dropdown">
                                <button class="folder-dropdown-btn" onclick="toggleFolderDropdown('allPlansDropdown')">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="folder-dropdown-menu" id="allPlansDropdown">
                                    <button class="folder-dropdown-item" onclick="createNewPlanInFolder('all')">New plan</button>
                                    <button class="folder-dropdown-item" onclick="selectFolder('all')">Select folder</button>
                                    <button class="folder-dropdown-item" onclick="deselectFolder('all')">Deselect folder</button>
                                </div>
                            </div>
                        </div>
                        <div class="plans-grid" id="allPlansGrid">
                            <!-- Plans will be added here -->
                        </div>
                    </div>

                    <!-- Custom folders -->
                    <div id="customFoldersContainer"></div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <span id="statusText">0 plans</span>
            </div>
        </div>
    </div>

    <!-- Upload Plans Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h2 class="upload-modal-title">Upload plans</h2>
                <button class="upload-modal-close" onclick="closeUploadModal()">Ã—</button>
            </div>
            <div class="upload-modal-body">
                <div class="upload-dropzone" id="dropzone">
                    <div class="upload-icon-wrapper">
                        <div class="upload-icon-box">
                            <div class="upload-icon-lines">
                                <div class="upload-icon-line"></div>
                                <div class="upload-icon-line"></div>
                                <div class="upload-icon-line"></div>
                            </div>
                        </div>
                    </div>
                    <p class="upload-text">Drag and drop your plans here</p>
                    <p class="upload-or">or</p>
                    <button class="upload-select-btn" onclick="document.getElementById('fileInput').click()">
                        Select files
                    </button>
                </div>

                <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">

                <div id="uploadFileList" class="upload-file-list"></div>

                <div class="upload-integration-section">
                    <p class="upload-integration-text">Or setup plan sync using one of our integrations below</p>
                    <div class="upload-integration-grid">
                        <button class="upload-integration-btn" onclick="alert('Google Drive integration coming soon')">
                            <img src="https://www.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" alt="Google Drive" class="upload-integration-icon">
                            <span class="upload-integration-name">Google Drive</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('SharePoint integration coming soon')">
                            <svg class="upload-integration-icon" width="28" height="28" viewBox="0 0 32 32">
                                <circle cx="16" cy="16" r="14" fill="#036C70"/>
                                <circle cx="12" cy="12" r="6" fill="#03787C" opacity="0.8"/>
                                <circle cx="20" cy="12" r="6" fill="#00A4A6" opacity="0.7"/>
                                <circle cx="16" cy="20" r="6" fill="#00B7C3" opacity="0.6"/>
                            </svg>
                            <span class="upload-integration-name">SharePoint</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('Dropbox integration coming soon')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Dropbox_Icon.svg" alt="Dropbox" class="upload-integration-icon">
                            <span class="upload-integration-name">Dropbox</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('Box integration coming soon')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/57/Box%2C_Inc._logo.svg" alt="Box" class="upload-integration-icon">
                            <span class="upload-integration-name">Box</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('OneDrive integration coming soon')">
                            <svg class="upload-integration-icon" width="28" height="28" viewBox="0 0 32 32">
                                <path fill="#0364B8" d="M22 12c-1.1 0-2.1.2-3.1.6-.9-2.9-3.5-5-6.6-5-3.9 0-7 3.1-7 7 0 .3 0 .6.1.9C3.1 16.1 1 18.5 1 21.5 1 25.1 3.9 28 7.5 28h14c4.1 0 7.5-3.4 7.5-7.5S26.1 12 22 12z"/>
                            </svg>
                            <span class="upload-integration-name">OneDrive</span>
                        </button>
                    </div>
                    <button class="upload-more-options" onclick="alert('More options coming soon')">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>More upload options</span>
                    </button>
                </div>

                <!-- Upload Progress Bar -->
                <div id="uploadProgressContainer" class="upload-progress-container" style="display: none;">
                    <div class="upload-progress-header">
                        <span class="upload-progress-text">Uploading files...</span>
                        <span class="upload-progress-percent" id="progressPercent">0%</span>
                    </div>
                    <div class="upload-progress-bar-wrapper">
                        <div class="upload-progress-bar" id="uploadProgressBar">
                            <div class="upload-progress-fill" id="uploadProgressFill"></div>
                        </div>
                    </div>
                    <div class="upload-progress-status" id="uploadProgressStatus"></div>
                </div>

                <!-- Upload Success Message -->
                <div id="uploadSuccessContainer" class="upload-success-container" style="display: none;">
                    <div class="upload-success-content">
                        <div class="upload-success-checkmark">
                            <i class="fas fa-check"></i>
                        </div>
                        <h3 class="upload-success-title">Upload Successful!</h3>
                        <p class="upload-success-message" id="uploadSuccessMessage">Your files have been uploaded successfully</p>
                        <button class="upload-success-btn" onclick="closeUploadModal()">Done</button>
                    </div>
                </div>

                <button class="upload-files-btn" id="uploadBtn" onclick="uploadFiles()" disabled>
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload files</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div id="createFolderModal" class="create-folder-modal">
        <div class="create-folder-content">
            <div class="create-folder-header">
                <h3 class="create-folder-title">Create folder</h3>
                <button class="create-folder-close" onclick="closeCreateFolderModal()">Ã—</button>
            </div>
            <div class="create-folder-body">
                <input type="text" class="create-folder-input" id="folderNameInput" placeholder="Add name" autocomplete="off">
                <button class="create-folder-btn" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing files...</p>
        </div>
    </div>

    <script>
        // Global state
        let plans = [];
        let folders = [];
        let selectedFiles = [];
        let uploadFolderId = null; // Track which folder to upload to (null = All Plans)
        let uploadFolderName = null; // Track folder name for display
        let projects = <% if (projects) { %><%- JSON.stringify(projects) %><% } else { %>[]<% } %>;
        let notifications = [];
        let currentFilter = 'all';

        // Request queue for controlling concurrent PDF preview fetches
        let previewRequestQueue = [];
        let activePreviewRequests = 0;
        const MAX_CONCURRENT_PREVIEWS = 6; // Increased for faster loading of all files

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPlans();
            setupDragAndDrop();
            setupFileInput();
            loadProjectsInDropdown();
            loadNotifications();
            setupTaskEventListeners();
        });

        // Setup task item event listeners
        function setupTaskEventListeners() {
            const taskItems = document.querySelectorAll('.tasks-section .task-item');
            taskItems.forEach((item, index) => {
                item.addEventListener('click', function(e) {
                    // Remove active class from all task items
                    taskItems.forEach(t => t.classList.remove('active'));

                    // Add active class to clicked item
                    item.classList.add('active');

                    // Get task type
                    const taskTypeSpan = item.querySelector('span:nth-child(2)');
                    const taskType = taskTypeSpan ? taskTypeSpan.textContent.trim() : 'All tasks';

                    // Display tasks based on type
                    showTaskDetails(taskType);
                });
            });
        }

        // Show task details based on task type
        function showTaskDetails(taskType) {
            // Create a modal or side panel to show uploaded files as tasks
            console.log('Showing tasks for:', taskType);

            let tasksToShow = [];

            if (taskType === 'My tasks') {
                // Show all uploaded plans as tasks
                tasksToShow = plans;
            } else if (taskType === 'Watched tasks') {
                // Show watched tasks (currently empty for future feature)
                tasksToShow = [];
            } else if (taskType === 'All tasks') {
                // Show all plans as tasks
                tasksToShow = plans;
            }

            // You can implement a tasks panel here to display the tasks
            // For now, this just logs the task details
            console.log(`Found ${tasksToShow.length} tasks for "${taskType}":`, tasksToShow);
        }

        // Get current project ID from URL
        function getCurrentProjectId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('projectId') || null;
        }

        // Get storage key for current project
        function getProjectStorageKey(key) {
            const projectId = getCurrentProjectId();
            return projectId ? `project_${projectId}_${key}` : key;
        }

        // Queue PDF preview requests to avoid overwhelming the browser
        function queuePreviewRequest(previewUrl, containerId) {
            return new Promise((resolve) => {
                previewRequestQueue.push({ previewUrl, containerId, resolve });
                processPreviewQueue();
            });
        }

        // Process queued preview requests
        function processPreviewQueue() {
            while (activePreviewRequests < MAX_CONCURRENT_PREVIEWS && previewRequestQueue.length > 0) {
                const { previewUrl, containerId, resolve } = previewRequestQueue.shift();
                activePreviewRequests++;

                generatePDFPreviewFromURL(previewUrl, containerId)
                    .finally(() => {
                        activePreviewRequests--;
                        resolve();
                        processPreviewQueue();
                    });
            }
        }

        // Load plans from database (project-specific)
        async function loadPlans() {
            const projectId = getCurrentProjectId();

            if (!projectId) {
                plans = [];
                folders = [];
                updateView();
                return;
            }

            try {
                // Fetch plans and folders in parallel for faster loading
                const [plansResponse, foldersResponse] = await Promise.all([
                    fetch(`/api/plans?projectId=${projectId}`),
                    fetch(`/api/folders?projectId=${projectId}`)
                ]);

                const plansResult = await plansResponse.json();
                const foldersResult = await foldersResponse.json();

                if (plansResult.success) {
                    plans = plansResult.plans || [];
                } else {
                    plans = [];
                }

                if (foldersResult.success) {
                    folders = foldersResult.folders || [];
                } else {
                    folders = [];
                }

                // Step 6: Initialize planRotations object with loaded rotations
                planRotations = {};
                plans.forEach(plan => {
                    planRotations[plan.id] = plan.rotation || 0;
                });
                console.log('ðŸ“ Initialized planRotations:', planRotations);

            } catch (error) {
                console.error('Error loading plans:', error);
                plans = [];
                folders = [];
            }

            updateView();
            updateTaskCounts();
        }

        // Update task counts in sidebar
        function updateTaskCounts() {
            const myTasksBadge = document.getElementById('myTasksBadge');
            const watchedTasksBadge = document.getElementById('watchedTasksBadge');
            const allTasksBadge = document.getElementById('allTasksBadge');

            // Count all plans as tasks
            const totalTasks = plans.length;

            // For now: My tasks = all tasks (you can customize this logic later)
            // Watched tasks = 0 (placeholder for future feature)
            // All tasks = total tasks

            const myTasksCount = totalTasks;
            const watchedTasksCount = 0;
            const allTasksCount = totalTasks;

            // Update badges with counts
            if (myTasksCount > 0) {
                myTasksBadge.textContent = myTasksCount;
                myTasksBadge.style.display = 'inline-block';
            } else {
                myTasksBadge.style.display = 'none';
            }

            if (watchedTasksCount > 0) {
                watchedTasksBadge.textContent = watchedTasksCount;
                watchedTasksBadge.style.display = 'inline-block';
            } else {
                watchedTasksBadge.style.display = 'none';
            }

            if (allTasksCount > 0) {
                allTasksBadge.textContent = allTasksCount;
                allTasksBadge.style.display = 'inline-block';
            } else {
                allTasksBadge.style.display = 'none';
            }
        }

        // Update view based on plans
        function updateView() {
            const emptyState = document.getElementById('emptyState');
            const plansView = document.getElementById('plansView');
            const allPlansSection = document.getElementById('allPlansSection');
            const statusText = document.getElementById('statusText');

            if (plans.length === 0) {
                emptyState.style.display = 'flex';
                plansView.style.display = 'none';
                statusText.textContent = '0 plans';
            } else {
                emptyState.style.display = 'none';
                plansView.style.display = 'block';
                allPlansSection.style.display = 'block';

                // Setup drag and drop for All Plans section
                allPlansSection.ondragover = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    allPlansSection.classList.add('drag-over');
                };
                allPlansSection.ondragenter = (e) => {
                    e.preventDefault();
                    allPlansSection.classList.add('drag-over');
                };
                allPlansSection.ondragleave = (e) => {
                    allPlansSection.classList.remove('drag-over');
                };
                allPlansSection.ondrop = (e) => handleAllPlansDrop(e);

                // Update All plans folder
                // Find the "All Plans" folder and count plans in it
                const allPlansFolder = folders.find(f => f.name && f.name.toLowerCase() === 'all plans');
                let allPlansCount = 0;

                if (allPlansFolder) {
                    // Count plans assigned to the All Plans folder
                    allPlansCount = plans.filter(p => p.folderId === allPlansFolder.id || (p.folder === 'All Plans')).length;
                } else {
                    // Fallback: count unassigned plans if no All Plans folder exists
                    allPlansCount = plans.filter(p => !p.folderId && !p.folder).length;
                }

                const allPlansName = document.getElementById('allPlansName');
                allPlansName.textContent = `All plans (${allPlansCount} ${allPlansCount === 1 ? 'plan' : 'plans'})`;

                // Update All Plans folder icon based on content
                const allPlansIcon = allPlansCount > 0 ? 'fa-folder-open' : 'fa-folder';
                const allPlansFolderIcon = document.querySelector('#allPlansSection .folder-icon');
                if (allPlansFolderIcon) {
                    allPlansFolderIcon.className = `fas ${allPlansIcon} folder-icon`;
                }

                // Render plans
                renderPlans();

                // Render folders
                renderFolders();

                // Load all previews in batches (for both All Plans and Folder sections)
                setupPreviewLazyLoading();

                statusText.textContent = `${plans.length} ${plans.length === 1 ? 'plan' : 'plans'}`;
            }
        }

        // Render plans in grid
        function renderPlans() {
            const grid = document.getElementById('allPlansGrid');
            grid.innerHTML = '';

            // Find the "All Plans" folder
            const allPlansFolder = folders.find(f => f.name && f.name.toLowerCase() === 'all plans');

            // Add plans that are in the All Plans folder
            plans.forEach((plan, index) => {
                // Show plans in the All Plans folder OR unassigned plans (for backward compatibility)
                const isInAllPlans = allPlansFolder && (plan.folderId === allPlansFolder.id || plan.folder === 'All Plans');
                const isUnassigned = !plan.folderId && !plan.folder;

                if (isInAllPlans || isUnassigned) {
                    const card = createPlanCard(plan, index);
                    grid.appendChild(card);
                }
            });

            // Add "New plan" card
            const newPlanCard = document.createElement('div');
            newPlanCard.className = 'new-plan-card';
            newPlanCard.onclick = openUploadModal;
            newPlanCard.innerHTML = `
                <div class="new-plan-content">
                    <i class="fas fa-plus"></i>
                    <span>New plan</span>
                </div>
            `;
            grid.appendChild(newPlanCard);
        }

        // Setup preview loading for all plan cards
        function setupPreviewLazyLoading() {
            const cards = document.querySelectorAll('.plan-card');

            // Load all cards in batches for optimal performance
            // Use requestIdleCallback if available for non-blocking loading
            let cardIndex = 0;
            const batchSize = 20; // Larger batches for faster processing
            const batchInterval = 50; // Shorter interval between batches

            function processBatch() {
                const startTime = performance.now();
                const endIndex = Math.min(cardIndex + batchSize, cards.length);

                for (let i = cardIndex; i < endIndex; i++) {
                    loadPlanPreview(cards[i]);
                }

                cardIndex = endIndex;

                // If more cards to process, schedule next batch
                if (cardIndex < cards.length) {
                    // Use requestIdleCallback if available, otherwise use setTimeout
                    if ('requestIdleCallback' in window) {
                        requestIdleCallback(() => processBatch(), { timeout: 100 });
                    } else {
                        requestAnimationFrame(() => {
                            setTimeout(processBatch, batchInterval);
                        });
                    }
                }
            }

            // Start processing batches immediately
            processBatch();
        }

        // Create plan card with PDF preview
        function createPlanCard(plan, index) {
            const card = document.createElement('div');
            card.className = 'plan-card';
            card.draggable = true;
            card.id = `plan-card-${index}`;
            card.dataset.planIndex = index;
            card.ondragstart = (e) => handlePlanDragStart(e, index);
            card.ondragend = (e) => handlePlanDragEnd(e);
            card.ondragover = (e) => handlePlanCardDragOver(e);
            card.ondrop = (e) => handlePlanCardDrop(e, index);
            card.ondragenter = (e) => handlePlanCardDragEnter(e);
            card.ondragleave = (e) => handlePlanCardDragLeave(e);
            card.onclick = () => viewPlan(index);

            // Use plan ID and timestamp for truly unique thumbnail identifier
            const thumbnailId = `thumbnail-${plan.id || plan.name}-${Date.now()}-${Math.random()}`;

            const thumbnail = document.createElement('div');
            thumbnail.className = 'plan-thumbnail';
            thumbnail.id = thumbnailId;

            const info = document.createElement('div');
            info.className = 'plan-info';
            info.innerHTML = `<div class="plan-name">${plan.sheetNumber || plan.name}</div>`;

            card.appendChild(thumbnail);
            card.appendChild(info);

            // Store preview data for lazy loading
            card.dataset.previewUrl = plan.preview || '';
            card.dataset.previewType = plan.type || '';
            card.dataset.thumbnailId = thumbnailId;

            return card;
        }

        // Load preview for a plan card (called when card becomes visible)
        function loadPlanPreview(card) {
            const previewUrl = card.dataset.previewUrl;
            const previewType = card.dataset.previewType;
            const thumbnailId = card.dataset.thumbnailId;

            if (!previewUrl || card.dataset.previewLoaded === 'true') {
                return; // Already loaded or no preview
            }

            card.dataset.previewLoaded = 'true';

            if (previewType.includes('pdf')) {
                // Use request queue to limit concurrent PDF loads
                queuePreviewRequest(previewUrl, thumbnailId);
            } else if (previewType.includes('image')) {
                const container = document.getElementById(thumbnailId);
                if (container) {
                    container.innerHTML = `<img src="${previewUrl}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
            }
        }

        // Generate PDF preview from URL endpoint
        async function generatePDFPreviewFromURL(previewUrl, containerId) {
            try {
                // Fetch PDF data from preview endpoint
                const response = await fetch(previewUrl);
                if (!response.ok) {
                    console.error(`Failed to fetch preview: ${response.status}`);
                    return;
                }

                const arrayBuffer = await response.arrayBuffer();

                // Convert ArrayBuffer to base64 in chunks
                const bytes = new Uint8Array(arrayBuffer);
                let binary = '';
                const chunkSize = 65536;
                for (let i = 0; i < bytes.length; i += chunkSize) {
                    const chunk = bytes.subarray(i, i + chunkSize);
                    binary += String.fromCharCode.apply(null, chunk);
                }
                const base64Data = btoa(binary);

                // Now use the existing function with base64 data
                await generatePDFPreview(base64Data, containerId);
            } catch (error) {
                console.error('Error loading PDF preview from URL:', error);
            }
        }

        // Generate PDF preview using PDF.js
        async function generatePDFPreview(pdfData, containerId) {
            try {
                const loadingTask = pdfjsLib.getDocument({ data: atob(pdfData) });
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);

                // Calculate scale to fill the thumbnail width
                const thumbWidth = 300;  // Standard thumbnail width
                const thumbHeight = 250;  // Thumbnail height
                const unscaledViewport = page.getViewport({ scale: 1 });
                const scale = thumbWidth / unscaledViewport.width * 1.2;  // Scale up to fill and zoom into header

                const viewport = page.getViewport({ scale: scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = thumbHeight;
                canvas.width = thumbWidth;

                // Set canvas style for better rendering
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '100%';
                canvas.style.objectFit = 'cover';

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                await page.render(renderContext).promise;

                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(canvas);
                }
            } catch (error) {
                console.error('Error generating PDF preview:', error);
            }
        }

        // Render custom folders
        function renderFolders() {
            const container = document.getElementById('customFoldersContainer');
            container.innerHTML = '';

            folders.forEach((folder, index) => {
                // Skip "All Plans" folders - they show in the special section at top
                if (folder.name.toLowerCase() === 'all plans') {
                    return;
                }

                const folderSection = document.createElement('div');
                folderSection.className = 'folder-section';
                folderSection.draggable = false;
                folderSection.id = `folder-section-${index}`;

                // Set drag handlers using addEventListener for better reliability
                folderSection.addEventListener('dragover', (e) => handleFolderDragOver(e, index));
                folderSection.addEventListener('dragenter', (e) => handleFolderDragEnter(e, index));
                folderSection.addEventListener('dragleave', (e) => handleFolderDragLeave(e, index));
                folderSection.addEventListener('drop', (e) => handleFolderDrop(e, index));

                // Get plans in this folder
                const folderPlans = plans.filter(p => p.folderId === folder.id || p.folder === folder.name);
                const planCount = folderPlans.length;

                // Determine if folder is open (has files) or closed (empty)
                const folderIcon = planCount > 0 ? 'fa-folder-open' : 'fa-folder';

                folderSection.innerHTML = `
                    <div class="folder-header">
                        <input type="checkbox" class="folder-checkbox">
                        <i class="fas ${folderIcon} folder-icon"></i>
                        <span class="folder-name">${folder.name} (${planCount})</span>
                        <div class="folder-dropdown">
                            <button class="folder-dropdown-btn" onclick="toggleFolderDropdown('folder-${index}-dropdown')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="folder-dropdown-menu" id="folder-${index}-dropdown">
                                <button class="folder-dropdown-item" onclick="createNewPlanInFolder('${folder.name}')">New plan</button>
                                <button class="folder-dropdown-item" onclick="renameFolder(${index})">Rename folder</button>
                                <button class="folder-dropdown-item danger" onclick="deleteFolder(${index})">Delete folder</button>
                            </div>
                        </div>
                    </div>
                    <div class="folder-plans-grid" id="folder-${index}-plans">
                        <!-- Plans will be rendered here -->
                    </div>
                `;
                container.appendChild(folderSection);

                // Render plans inside this folder
                const plansGrid = folderSection.querySelector(`#folder-${index}-plans`);
                folderPlans.forEach((plan, planIndex) => {
                    const card = createPlanCard(plan, plans.indexOf(plan));
                    plansGrid.appendChild(card);
                });
            });
        }

        // ========== DRAG AND DROP FOR PLANS BETWEEN FOLDERS ==========

        // Handle plan drag start
        function handlePlanDragStart(e, planIndex) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('planIndex', planIndex);
            e.target.closest('.plan-card').classList.add('dragging');
        }

        // Handle plan drag end
        function handlePlanDragEnd(e) {
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('dragging');
                card.classList.remove('drag-over');
            });
            document.querySelectorAll('.folder-section').forEach(folder => {
                folder.classList.remove('drag-over');
            });
        }

        // Handle plan card drag over (for reordering within folder)
        function handlePlanCardDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
        }

        // Handle plan card drag enter (for reordering within folder)
        function handlePlanCardDragEnter(e) {
            e.preventDefault();
            e.stopPropagation();
            const card = e.target.closest('.plan-card');
            if (card && !card.classList.contains('dragging')) {
                card.classList.add('drag-over');
            }
        }

        // Handle plan card drag leave (for reordering within folder)
        function handlePlanCardDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            const card = e.target.closest('.plan-card');
            if (card) {
                card.classList.remove('drag-over');
            }
        }

        // Handle plan card drop (for reordering within folder)
        function handlePlanCardDrop(e, targetIndex) {
            e.preventDefault();
            e.stopPropagation();

            const card = e.target.closest('.plan-card');
            if (card) {
                card.classList.remove('drag-over');
            }

            const draggedPlanIndex = parseInt(e.dataTransfer.getData('planIndex'));
            console.log('Plan drop detected:', { draggedPlanIndex, targetIndex });

            // Only reorder if within the same folder (same grid container)
            const draggedCard = document.getElementById(`plan-card-${draggedPlanIndex}`);
            const targetCard = document.getElementById(`plan-card-${targetIndex}`);

            if (draggedCard && targetCard) {
                const draggedGrid = draggedCard.closest('.folder-plans-grid, #allPlansGrid');
                const targetGrid = targetCard.closest('.folder-plans-grid, #allPlansGrid');

                // Check if both cards are in the same grid (same folder)
                if (draggedGrid && draggedGrid === targetGrid && draggedPlanIndex !== targetIndex) {
                    console.log('Reordering plans in same folder');
                    reorderPlansInFolder(draggedPlanIndex, targetIndex);
                }
            }
        }

        // Reorder plans within a folder
        function reorderPlansInFolder(fromIndex, toIndex) {
            if (fromIndex === toIndex) return;

            // Get the plan being moved
            const movedPlan = plans[fromIndex];

            // Remove from old position
            plans.splice(fromIndex, 1);

            // Adjust toIndex if needed (if we removed from before toIndex)
            let adjustedToIndex = toIndex;
            if (fromIndex < toIndex) {
                adjustedToIndex = toIndex - 1;
            }

            // Insert at new position
            plans.splice(adjustedToIndex, 0, movedPlan);

            console.log('Plans reordered. New order:', plans.map(p => p.name));

            // Re-render to show new order
            updateView();

            // Save to backend
            savePlansOrder();
        }

        // Save the new plans order to backend
        async function savePlansOrder() {
            try {
                const response = await fetch('/api/plans/reorder', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        planIds: plans.map(p => p.id)
                    })
                });

                if (!response.ok) {
                    console.error('Failed to save plans order');
                }
            } catch (error) {
                console.error('Error saving plans order:', error);
            }
        }

        // Handle folder drag over
        function handleFolderDragOver(e, folderIndex) {
            e.preventDefault();
            e.stopPropagation();
            e.dataTransfer.dropEffect = 'move';
            const folderSection = document.getElementById(`folder-section-${folderIndex}`);
            if (folderSection) {
                folderSection.classList.add('drag-over');
            }
        }

        // Handle folder drag enter
        function handleFolderDragEnter(e, folderIndex) {
            e.preventDefault();
            e.stopPropagation();
            const folderSection = document.getElementById(`folder-section-${folderIndex}`);
            if (folderSection) {
                folderSection.classList.add('drag-over');
            }
        }

        // Handle folder drag leave
        function handleFolderDragLeave(e, folderIndex) {
            e.preventDefault();
            e.stopPropagation();
            const folderSection = document.getElementById(`folder-section-${folderIndex}`);
            if (folderSection) {
                folderSection.classList.remove('drag-over');
            }
        }

        // Handle folder drop
        function handleFolderDrop(e, folderIndex) {
            e.preventDefault();
            e.stopPropagation();

            const folderSection = document.getElementById(`folder-section-${folderIndex}`);
            if (folderSection) {
                folderSection.classList.remove('drag-over');
            }

            const planIndex = parseInt(e.dataTransfer.getData('planIndex'));
            const targetFolder = folders[folderIndex];

            if (targetFolder && !isNaN(planIndex)) {
                movePlanToFolder(planIndex, targetFolder.name);
            }
        }

        // Handle drop on "All plans" section
        function handleAllPlansDrop(e) {
            e.preventDefault();
            const allPlansSection = document.getElementById('allPlansSection');
            if (allPlansSection) {
                allPlansSection.classList.remove('drag-over');
            }

            const planIndex = parseInt(e.dataTransfer.getData('planIndex'));
            // Move plan back to All Plans (null folderId)
            if (plans[planIndex]) {
                movePlanToFolder(planIndex, null);
            }
        }

        // Show loading spinner for drag and drop operation
        function showDragDropLoadingSpinner() {
            let overlay = document.getElementById('dragDropLoadingOverlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'dragDropLoadingOverlay';
                overlay.className = 'drag-drop-loading-overlay';
                overlay.innerHTML = `
                    <div class="drag-drop-spinner-container">
                        <div class="drag-drop-spinner"></div>
                        <div class="drag-drop-loading-text">Moving Plan</div>
                        <div class="drag-drop-loading-subtext">Please wait...</div>
                    </div>
                `;
                document.body.appendChild(overlay);
            }
            overlay.style.display = 'flex';
        }

        // Hide loading spinner after drag and drop operation
        function hideDragDropLoadingSpinner() {
            const overlay = document.getElementById('dragDropLoadingOverlay');
            if (overlay) {
                overlay.style.display = 'none';
            }
        }

        // Move plan to folder with optimistic updates
        async function movePlanToFolder(planIndex, targetFolderName) {
            console.log('movePlanToFolder called:', { planIndex, targetFolderName, totalPlans: plans.length });

            if (planIndex === undefined || planIndex === null || !plans[planIndex]) {
                console.error('Plan not found at index:', planIndex);
                return;
            }

            // Show loading spinner
            showDragDropLoadingSpinner();

            const plan = plans[planIndex];
            console.log('Plan to move:', plan.name, 'Current folder:', plan.folder);

            let newFolderId = null;
            let newFolderName = targetFolderName;

            // Find the target folder's ID
            if (targetFolderName) {
                const targetFolder = folders.find(f => f.name === targetFolderName);
                console.log('Target folder:', targetFolder);
                if (targetFolder) {
                    newFolderId = targetFolder.id;
                } else {
                    console.error('Target folder not found:', targetFolderName);
                    hideDragDropLoadingSpinner();
                    return;
                }
            }

            // OPTIMISTIC UPDATE: Update UI immediately
            plan.folder = newFolderName;
            plan.folderId = newFolderId;
            console.log('Plan updated locally. New folder:', newFolderName);

            // Re-render the plans to reflect changes
            updateView();

            // Save changes to backend
            try {
                const response = await fetch(`/api/plans/${plan.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folderId: newFolderId,
                        folder: newFolderName
                    })
                });
                console.log('Backend response status:', response.status);

                // Hide spinner after operation completes
                setTimeout(() => {
                    hideDragDropLoadingSpinner();
                }, 500); // Show spinner for at least 500ms for better UX

                if (!response.ok) {
                    console.error('Failed to save plan move to backend');
                }
            } catch (error) {
                console.error('Error moving plan:', error);
                hideDragDropLoadingSpinner();
            }
        }

        // ========== END DRAG AND DROP ==========

        // Modal functions
        function openUploadModal(folderId = null, folderName = null) {
            const projectId = getCurrentProjectId();
            if (!projectId) {
                alert('Please select a project first');
                return;
            }
            // Set the upload destination folder
            uploadFolderId = folderId; // null = All Plans
            uploadFolderName = folderName;

            document.getElementById('uploadModal').classList.add('show');
            selectedFiles = [];
            updateUploadFileList();

            // Update modal title to show destination
            const modalTitle = document.querySelector('.upload-modal-title');
            if (modalTitle) {
                if (folderName) {
                    modalTitle.textContent = `Upload to ${folderName} Folder`;
                } else {
                    modalTitle.textContent = 'Upload Plans';
                }
            }
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
            selectedFiles = [];
            updateUploadFileList();
        }

        function openCreateFolderModal() {
            const projectId = getCurrentProjectId();
            if (!projectId) {
                alert('Please select a project first');
                return;
            }
            document.getElementById('createFolderModal').classList.add('show');
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderNameInput').focus();
        }

        function closeCreateFolderModal() {
            document.getElementById('createFolderModal').classList.remove('show');
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const dropzone = document.getElementById('dropzone');
            const emptyState = document.getElementById('emptyState');

            // Dropzone handlers
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => {
                    dropzone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => {
                    dropzone.classList.remove('drag-over');
                }, false);
            });

            dropzone.addEventListener('drop', handleDrop, false);

            // Empty state drop
            emptyState.addEventListener('dragenter', preventDefaults, false);
            emptyState.addEventListener('dragover', preventDefaults, false);
            emptyState.addEventListener('drop', handleEmptyStateDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleEmptyStateDrop(e) {
            preventDefaults(e);
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                openUploadModal();
                setTimeout(() => handleFiles(files), 300);
            }
        }

        // File input setup
        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                handleFiles(this.files);
            });
        }

        // Handle selected files
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            updateUploadFileList();
        }

        // Update upload file list
        function updateUploadFileList() {
            const listContainer = document.getElementById('uploadFileList');
            const uploadBtn = document.getElementById('uploadBtn');

            if (selectedFiles.length === 0) {
                listContainer.classList.remove('show');
                uploadBtn.disabled = true;
            } else {
                listContainer.classList.add('show');
                uploadBtn.disabled = false;

                listContainer.innerHTML = '';
                selectedFiles.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'upload-file-item';
                    item.innerHTML = `
                        <div class="upload-file-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="upload-file-info">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="upload-file-remove" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            }
        }

        // Remove file from selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateUploadFileList();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Upload files with progress bar
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const projectId = getCurrentProjectId();
            const maxFileSize = 10 * 1024 * 1024; // 10MB limit

            // Validate file sizes
            for (const file of selectedFiles) {
                if (file.size > maxFileSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    return;
                }
            }

            // Hide upload button and show progress bar
            document.getElementById('uploadBtn').style.display = 'none';
            document.getElementById('uploadProgressContainer').style.display = 'block';
            document.getElementById('uploadSuccessContainer').style.display = 'none';

            // Animate progress from 0 to 90% while uploading
            let progress = 0;
            const progressInterval = setInterval(() => {
                if (progress < 90) {
                    progress += Math.random() * 30;
                    if (progress > 90) progress = 90;
                    updateProgressBar(progress);
                }
            }, 200);

            // Process and upload files
            const formData = new FormData();
            formData.append('projectId', projectId);

            // Add folder context if uploading to specific folder
            if (uploadFolderId) {
                formData.append('folderId', uploadFolderId);
            }
            if (uploadFolderName) {
                formData.append('folder', uploadFolderName);
            }

            // Add all files to FormData
            for (const file of selectedFiles) {
                formData.append('plans', file);
            }

            try {
                // Send to database using FormData (handles large files better)
                const response = await fetch('/api/plans/upload', {
                    method: 'POST',
                    body: formData
                });

                clearInterval(progressInterval);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    updateProgressBar(0);
                    document.getElementById('uploadProgressContainer').style.display = 'none';
                    document.getElementById('uploadBtn').style.display = 'flex';
                    alert(`Error uploading files: ${response.status} ${response.statusText}`);
                    return;
                }

                const result = await response.json();
                if (result.success || result.status === 'success') {
                    // Complete the progress bar to 100%
                    updateProgressBar(100);

                    // Wait a moment then show success
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Hide progress bar and show success message
                    document.getElementById('uploadProgressContainer').style.display = 'none';
                    document.getElementById('uploadSuccessContainer').style.display = 'block';
                    document.getElementById('uploadSuccessMessage').textContent = `Successfully uploaded ${selectedFiles.length} file${selectedFiles.length === 1 ? '' : 's'}`;

                    // Wait for user to see success message
                    await new Promise(resolve => setTimeout(resolve, 1000));

                } else {
                    clearInterval(progressInterval);
                    updateProgressBar(0);
                    document.getElementById('uploadProgressContainer').style.display = 'none';
                    document.getElementById('uploadBtn').style.display = 'flex';
                    alert(`Error uploading files: ${result.message || 'Unknown error'}`);
                    return;
                }
            } catch (error) {
                clearInterval(progressInterval);
                console.error('Error uploading files:', error);
                updateProgressBar(0);
                document.getElementById('uploadProgressContainer').style.display = 'none';
                document.getElementById('uploadBtn').style.display = 'flex';
                alert(`Error uploading files: ${error.message}`);
                return;
            }

            // Close modal and reload plans
            await new Promise(resolve => setTimeout(resolve, 1500));
            closeUploadModal();
            updateProgressBar(0);
            document.getElementById('uploadBtn').style.display = 'flex';
            await loadPlans();
        }

        // Helper function to update progress bar
        function updateProgressBar(percent) {
            const fill = document.getElementById('uploadProgressFill');
            const percentDisplay = document.getElementById('progressPercent');
            fill.style.width = percent + '%';
            percentDisplay.textContent = Math.round(percent) + '%';
        }

        // Create folder
        async function createFolder() {
            const input = document.getElementById('folderNameInput');
            const folderName = input.value.trim();

            if (!folderName) {
                showNotification('Please enter a folder name', 'error');
                return;
            }

            const projectId = getCurrentProjectId();

            try {
                // Save to database
                const response = await fetch('/api/folders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        projectId: projectId,
                        name: folderName
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    showNotification(`Error creating folder: ${response.status} ${response.statusText}`, 'error');
                    return;
                }

                const result = await response.json();
                if (result.success || result.folderId) {
                    showNotification(`âœ… Folder "${folderName}" created successfully!`, 'success');
                    closeCreateFolderModal();
                    await loadPlans();
                } else {
                    showNotification(`Error creating folder: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                showNotification(`Error creating folder: ${error.message}`, 'error');
            }
        }

        // Folder dropdown toggle
        function toggleFolderDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.folder-dropdown-menu');

            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });

            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.folder-dropdown')) {
                document.querySelectorAll('.folder-dropdown-menu').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        // Folder actions
        function createNewPlanInFolder(folderName) {
            // Find the folder ID
            let folderId = null;
            if (folderName && folderName !== 'all') {
                const folder = folders.find(f => f.name === folderName);
                if (folder) {
                    folderId = folder.id;
                }
            }
            // Open upload modal with folder context
            openUploadModal(folderId, folderName === 'all' ? null : folderName);
            toggleFolderDropdown('');
        }

        function selectFolder(folderName) {
            alert(`Select ${folderName} folder`);
            toggleFolderDropdown('');
        }

        function deselectFolder(folderName) {
            alert(`Deselect ${folderName} folder`);
            toggleFolderDropdown('');
        }

        async function renameFolder(index) {
            const newName = prompt('Enter new folder name:', folders[index].name);
            if (newName && newName.trim()) {
                const folder = folders[index];
                try {
                    // Update in database
                    const response = await fetch(`/api/folders/${folder.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: newName.trim()
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        folder.name = newName.trim();
                        showNotification(`âœ… Folder renamed to "${newName.trim()}"`, 'success');
                        updateView();
                    } else {
                        showNotification('Error renaming folder', 'error');
                    }
                } catch (error) {
                    console.error('Error renaming folder:', error);
                    showNotification('Error renaming folder', 'error');
                }
            }
            toggleFolderDropdown('');
        }

        async function deleteFolder(index) {
            if (confirm(`Are you sure you want to delete the folder "${folders[index].name}"?`)) {
                const folder = folders[index];
                const folderName = folder.name;
                try {
                    // Delete from database
                    const response = await fetch(`/api/folders/${folder.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        folders.splice(index, 1);
                        showNotification(`âœ… Folder "${folderName}" deleted successfully`, 'success');
                        updateView();
                    } else {
                        showNotification('Error deleting folder', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting folder:', error);
                    showNotification('Error deleting folder', 'error');
                }
            }
            toggleFolderDropdown('');
        }

        // View plan
        function viewPlan(index) {
            // Open PDF viewer with the selected plan
            const plan = plans[index];
            if (plan) {
                // Track the current plan index for navigation
                currentPlanIndex = index;
                currentPDFPlan = index; // Track for edit feature

                // Step 5: Load saved rotation from database
                if (plan.rotation) {
                    planRotations[plan.id] = plan.rotation;
                } else {
                    planRotations[plan.id] = 0;
                }

                // Reset zoom to 100% for new plan
                resetPDFZoom(plan.id);

                // Create PDF data object with plan information
                const pdfData = {
                    plan: plan,
                    html: generatePDFViewerContent(plan)
                };
                openPDFViewer(pdfData);

                console.log('Viewing plan at index:', index, 'of', plans.length);
                console.log('âœ… currentPDFPlan set to:', currentPDFPlan);
                console.log('ðŸ“ Loaded rotation:', planRotations[plan.id]);
                console.log('ðŸ” Zoom reset to 100%');
            }
        }

        // Generate PDF viewer content based on uploaded plan
        function generatePDFViewerContent(plan) {
            return `
                <div class="doc-header">
                    <div class="doc-logo">
                        <div class="company-logo">DESA</div>
                        <div class="company-info">
                            <strong>DESA Wire</strong><br>
                            Project Management System<br>
                            Plans & Documents<br>
                            P: (403) 255-6521
                        </div>
                    </div>
                    <div class="project-info">
                        <strong>Document: ${plan.name || 'Untitled'}</strong><br>
                        File Size: ${plan.size || 'N/A'}<br>
                        Type: ${plan.type || 'application/pdf'}<br>
                        Uploaded: ${new Date(plan.createdAt).toLocaleDateString()}
                    </div>
                </div>

                <div class="doc-title">
                    <h2>${plan.name || 'Document Preview'}</h2>
                    <h3>Uploaded Document</h3>
                </div>

                <div class="doc-info-grid">
                    <div class="info-row">
                        <span class="info-label">File Name</span>
                        <span class="info-value">${plan.name || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">File Size</span>
                        <span class="info-value">${plan.size || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Upload Date</span>
                        <span class="info-value">${new Date(plan.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">File Type</span>
                        <span class="info-value">${plan.type || 'PDF Document'}</span>
                    </div>
                </div>

                <div class="description-box">
                    <strong>Document Information</strong><br>
                    This is the uploaded document preview for <strong>${plan.name || 'your file'}</strong>.
                    You can use the tools on the left to annotate, mark up, or review this document.
                </div>

                <div class="workflow-section">
                    <div class="workflow-title">Document Details</div>
                    <table class="workflow-table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>File Name</td>
                                <td>${plan.name || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td>File Size</td>
                                <td>${plan.size || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td>File Type</td>
                                <td>${plan.type || 'PDF'}</td>
                            </tr>
                            <tr>
                                <td>Created</td>
                                <td>${new Date(plan.createdAt).toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="doc-footer">
                    <div>DESA Wire</div>
                    <div>Document Preview</div>
                    <div>Generated: ${new Date().toLocaleString()}</div>
                </div>
            `;
        }

        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Header functionality
        const notificationBell = document.getElementById('notificationBell');
        const helpIcon = document.getElementById('helpIcon');
        const userDropdownToggle = document.getElementById('userDropdownToggle');
        const notificationPanel = document.getElementById('notificationPanel');
        const helpPanel = document.getElementById('helpPanel');
        const userDropdown = document.getElementById('userDropdown');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebar = document.querySelector('.sidebar');

        // Sidebar logo and project dropdown
        const sidebarLogoToggle = document.getElementById('sidebarLogoToggle');
        const sidebarLogoDropdownIcon = document.getElementById('sidebarLogoDropdownIcon');
        const projectDropdown = document.getElementById('projectDropdown');

        // Notification bell toggle
        notificationBell.addEventListener('click', function() {
            notificationPanel.classList.toggle('show');
            helpPanel.classList.remove('show');
            userDropdown.classList.remove('show');
        });

        // Help icon toggle
        helpIcon.addEventListener('click', function() {
            helpPanel.classList.toggle('show');
            notificationPanel.classList.remove('show');
            userDropdown.classList.remove('show');
        });

        // User dropdown toggle
        userDropdownToggle.addEventListener('click', function() {
            userDropdown.classList.toggle('show');
            notificationPanel.classList.remove('show');
            helpPanel.classList.remove('show');
        });

        // Sidebar toggle
        sidebarToggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
        });

        // Sidebar logo and project dropdown toggle
        sidebarLogoToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            projectDropdown.style.display = projectDropdown.style.display === 'none' ? 'block' : 'none';
            sidebarLogoDropdownIcon.style.transform = projectDropdown.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0)';
        });

        // Close panels when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.notification-icon') && !e.target.closest('.notification-panel')) {
                notificationPanel.classList.remove('show');
            }
            if (!e.target.closest('#helpIcon') && !e.target.closest('.help-panel')) {
                helpPanel.classList.remove('show');
            }
            if (!e.target.closest('.user-dropdown')) {
                userDropdown.classList.remove('show');
            }
            // Don't close project dropdown if clicking anywhere inside it
            const isClickInsideProjectDropdown = e.target.closest('#projectDropdown') ||
                                                 e.target.closest('#sidebarLogoToggle') ||
                                                 e.target.closest('.sidebar-project-dropdown');

            if (!isClickInsideProjectDropdown) {
                projectDropdown.style.display = 'none';
                if (sidebarLogoDropdownIcon) {
                    sidebarLogoDropdownIcon.style.transform = 'rotate(0)';
                }
            }
        });

        // Load notifications from server
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();

                if (result.status === 'success') {
                    notifications = result.data;
                    updateNotificationBadge(result.unreadCount);
                    renderNotifications();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Update notification badge
        function updateNotificationBadge(count = 0) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Render notifications
        function renderNotifications(filter = 'all') {
            const notificationsList = document.getElementById('notificationsList');
            const notificationBadge = document.getElementById('notificationBadge');

            const unreadCount = notifications.filter(n => n.unread).length;

            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = 'block';
            } else {
                notificationBadge.style.display = 'none';
            }

            // Filter notifications
            let filteredNotifications = notifications;
            if (filter !== 'all') {
                filteredNotifications = notifications.filter(n => n.type === filter);
            }

            if (filteredNotifications.length === 0) {
                notificationsList.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #a0aec0;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ðŸ””</div>
                        <div style="font-size: 14px;">No ${filter === 'all' ? '' : filter + ' '}notifications</div>
                    </div>
                `;
                return;
            }

            notificationsList.innerHTML = filteredNotifications.map(notification => `
                <div class="notification-item ${notification.unread ? 'unread' : ''}" onclick="markAsRead(${notification.id})">
                    <div class="notification-header">
                        ${notification.unread ? '<div class="notification-icon-circle"></div>' : ''}
                        <div class="notification-content">
                            <div class="notification-title">
                                ${notification.title || 'Notification'}
                                ${notification.type ? `<span class="notification-type-badge ${notification.type}">${notification.type}</span>` : ''}
                            </div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${notification.createdAt ? new Date(notification.createdAt).toLocaleDateString() : 'Just now'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Mark notification as read
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    // Update local notification
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.unread = false;
                    }
                    renderNotifications();
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Sign out function
        async function signOut() {
            try {
                // Call logout API
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #48bb78;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = 'Signed out successfully. Redirecting...';
                    document.body.appendChild(notification);

                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                } else {
                    alert('Error signing out. Please try again.');
                }
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        }

        // Contact support function
        function contactSupport() {
            const supportEmail = 'support@desawire.com';
            const subject = 'Support Request';
            const body = 'Hello Desa Wire Support,\n\nI need help with:\n\n';
            window.location.href = `mailto:${supportEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // Go home function
        function goHome() {
            window.location.href = '/';
        }

        // Open create project modal function
        function openCreateProjectModal() {
            alert('Create project modal coming soon');
        }

        // Load and display projects in sidebar dropdown
        function loadProjectsInDropdown() {
            const projectList = document.getElementById('projectList');
            const searchInput = document.getElementById('projectSearch');

            if (!projects || projects.length === 0) {
                projectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No projects available</div>';
                return;
            }

            renderProjectsList(projects);

            // Setup search functionality
            if (searchInput) {
                // Prevent dropdown from closing when clicking search input
                searchInput.addEventListener('click', function(e) {
                    e.stopPropagation();
                });

                // Prevent dropdown from closing when typing in search
                searchInput.addEventListener('keydown', function(e) {
                    e.stopPropagation();
                });

                searchInput.addEventListener('input', function(e) {
                    e.stopPropagation();
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredProjects = projects.filter(project => {
                        const projectName = (project.name || project.projectName || 'Unnamed Project').toLowerCase();
                        return projectName.includes(searchTerm);
                    });
                    renderProjectsList(filteredProjects);
                });
            }
        }

        // Render projects list
        function renderProjectsList(projectsToRender) {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';

            if (projectsToRender.length === 0) {
                projectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No projects found</div>';
                return;
            }

            projectsToRender.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'sidebar-project-item';

                // Get first letter of project name for icon
                const firstLetter = (project.name || project.projectName || 'P').charAt(0).toUpperCase();

                projectItem.innerHTML = `
                    <div class="sidebar-project-icon">${firstLetter}</div>
                    <div style="flex: 1;">
                        <div class="sidebar-project-name">${project.name || project.projectName || 'Unnamed Project'}</div>
                    </div>
                `;
                projectItem.style.cursor = 'pointer';
                projectItem.style.padding = '12px 16px';
                projectItem.style.borderBottom = '1px solid #f0f0f0';
                projectItem.style.transition = 'background-color 0.2s';
                projectItem.style.color = '#374151';

                projectItem.onmouseover = function() {
                    projectItem.style.backgroundColor = '#f9fafb';
                };

                projectItem.onmouseout = function() {
                    projectItem.style.backgroundColor = 'transparent';
                };

                projectItem.onclick = function() {
                    // Update selected project
                    const projectName = project.name || project.projectName || 'Unnamed Project';
                    document.getElementById('sidebarProjectName').textContent = projectName;
                    projectDropdown.style.display = 'none';
                    sidebarLogoDropdownIcon.style.transform = 'rotate(0)';

                    // Clear search input
                    const searchInput = document.getElementById('projectSearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }

                    // Update URL and reload content without navigating away from mainplan
                    if (project.id) {
                        window.location.href = `/mainplan?projectId=${project.id}&name=${encodeURIComponent(projectName)}`;
                    }
                };

                projectList.appendChild(projectItem);
            });
        }

        // ========== PDF VIEWER FUNCTIONS ==========

        // Helper function to render PDF from preview data (URL or base64)
        async function renderPDFFromPreview(plan, container) {
            if (!plan.preview) return;

            // Show loading state
            container.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; gap: 12px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #3b82f6;"></i>
                    <span>Loading PDF...</span>
                </div>
            `;

            try {
                let base64Data;

                // Check if preview is a URL (new format) or data URL (old format)
                if (plan.preview.startsWith('http') || plan.preview.startsWith('/')) {
                    // Fetch PDF from endpoint and convert to base64
                    const response = await fetch(plan.preview);
                    if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);

                    const arrayBuffer = await response.arrayBuffer();
                    const bytes = new Uint8Array(arrayBuffer);
                    let binary = '';
                    const chunkSize = 65536;
                    for (let i = 0; i < bytes.length; i += chunkSize) {
                        const chunk = bytes.subarray(i, i + chunkSize);
                        binary += String.fromCharCode.apply(null, chunk);
                    }
                    base64Data = btoa(binary);
                } else {
                    // Old format: extract base64 from data URL
                    base64Data = plan.preview.split(',')[1] || plan.preview;
                }

                renderPDFInViewer(base64Data, container, plan);
            } catch (error) {
                console.error('Error loading PDF:', error);
                container.innerHTML = '<div style="padding: 20px; color: #dc2626;">Error loading PDF</div>';
            }
        }

        function openPDFViewer(pdfData) {
            const modal = document.getElementById('pdfViewerModal');
            const contentContainer = document.getElementById('pdfDocumentContent');

            // Clear the container
            contentContainer.innerHTML = '';

            // Show loading state
            contentContainer.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; height: 100%; gap: 12px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #3b82f6;"></i>
                    <span>Loading PDF...</span>
                </div>
            `;

            // Load actual PDF file using PDF.js
            if (pdfData && pdfData.plan && pdfData.plan.preview) {
                // Check if preview is a URL (new format) or data URL (old format)
                if (pdfData.plan.preview.startsWith('http') || pdfData.plan.preview.startsWith('/')) {
                    // Fetch PDF from endpoint and convert to base64
                    fetch(pdfData.plan.preview)
                        .then(response => {
                            if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
                            return response.arrayBuffer();
                        })
                        .then(arrayBuffer => {
                            // Convert ArrayBuffer to base64
                            const bytes = new Uint8Array(arrayBuffer);
                            let binary = '';
                            const chunkSize = 65536;
                            for (let i = 0; i < bytes.length; i += chunkSize) {
                                const chunk = bytes.subarray(i, i + chunkSize);
                                binary += String.fromCharCode.apply(null, chunk);
                            }
                            const base64Data = btoa(binary);
                            renderPDFInViewer(base64Data, contentContainer, pdfData.plan);
                        })
                        .catch(error => {
                            console.error('Error fetching PDF:', error);
                            contentContainer.innerHTML = '<div style="padding: 20px; color: #dc2626;">Error loading PDF</div>';
                        });
                } else {
                    // Old format: extract base64 from data URL
                    const base64Data = pdfData.plan.preview.split(',')[1] || pdfData.plan.preview;
                    renderPDFInViewer(base64Data, contentContainer, pdfData.plan);
                }

                // Update bottom name bar with clickable edit button
                const nameBar = document.querySelector('.pdf-name-display');
                if (nameBar) {
                    nameBar.innerHTML = `<i class="fas fa-pen"></i><span id="pdfBottomNameDisplay">${pdfData.plan.name || 'Document.pdf'}</span>`;

                    // Remove old click listener
                    const newNameBar = nameBar.cloneNode(true);
                    nameBar.parentNode.replaceChild(newNameBar, nameBar);

                    // Add click listener to the new element
                    const freshNameBar = document.querySelector('.pdf-name-display');
                    if (freshNameBar) {
                        freshNameBar.style.cursor = 'pointer';
                        freshNameBar.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            console.log('ðŸ“ Bottom name bar edit clicked!');
                            console.log('currentPlanIndex:', currentPlanIndex);
                            console.log('currentPDFPlan:', currentPDFPlan);

                            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

                            if (planIndex !== -1 && plans && plans[planIndex]) {
                                console.log('âœ… Opening Plan Details modal');
                                openPlanDetailsModal(planIndex);
                            } else {
                                console.warn('âŒ No plan selected');
                                showNotification('Please open a plan first', 'error');
                            }
                        });
                        console.log('âœ… Bottom name bar edit listener attached');
                    }
                }
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';

        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SEPARATE SCALING FOR BIG MONITORS vs LAPTOPS - PDF FULLSCREEN FIX
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function getOptimalPDFScale(pageViewport) {
            const pdfDocumentArea = document.querySelector('.pdf-document-area');
            const pdfViewerModal = document.querySelector('.pdf-viewer-modal');

            if (!pdfDocumentArea) {
                return 1.2; // Fallback scale
            }

            // ===== SCREEN DETECTION =====
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const screenDiagonal = Math.sqrt(Math.pow(screenWidth, 2) + Math.pow(screenHeight, 2));
            const dpi = window.devicePixelRatio || 1;

            // Detect screen type
            const isLaptop = screenWidth < 1600 || screenDiagonal < 2000;
            const isLargeMonitor = screenWidth >= 2400;
            const isFullscreen = pdfViewerModal && pdfViewerModal.classList.contains('fullscreen-mode');

            // Get container and page dimensions
            let containerWidth = pdfDocumentArea.offsetWidth;
            let containerHeight = pdfDocumentArea.offsetHeight;
            const pageWidth = pageViewport.width;
            const pageHeight = pageViewport.height;
            const isLandscape = pageWidth > pageHeight;

            // DEBUG: Log everything
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ðŸ–¥ï¸ SCREEN TYPE:', isLaptop ? 'LAPTOP' : (isLargeMonitor ? 'BIG MONITOR' : 'MEDIUM'));
            console.log('ðŸ“º SCREEN SIZE:', screenWidth + 'x' + screenHeight);
            console.log('â›¶ FULLSCREEN MODE:', isFullscreen ? 'YES âœ…' : 'NO âŒ');
            console.log('ðŸ“ CONTAINER:', containerWidth + 'x' + containerHeight);
            console.log('ðŸ“„ PAGE:', Math.round(pageWidth) + 'x' + Math.round(pageHeight));
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            let targetScale;

            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LAPTOP SCALING - EXTRA CONSERVATIVE (Fit entire page, no scroll)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            if (isLaptop) {
                if (isFullscreen) {
                    // LAPTOP FULLSCREEN - RESPONSIVE FIT
                    // Use 75% of space to ensure entire page fits without scrolling

                    // Available space with 25% margin on all sides
                    const availableWidth = containerWidth * 0.75;
                    const availableHeight = containerHeight * 0.75;

                    // Calculate what scale fits both dimensions
                    const widthScale = availableWidth / pageWidth;
                    const heightScale = availableHeight / pageHeight;

                    // Use the SMALLER scale to ensure entire page fits
                    targetScale = Math.min(widthScale, heightScale);

                    // No additional limits - let it scale naturally to fit
                    // This ensures responsive behavior on any laptop screen size

                    console.log('ðŸ–¥ï¸ LAPTOP FULLSCREEN (RESPONSIVE FIT):', {
                        containerWidth,
                        containerHeight,
                        availableWidth: availableWidth.toFixed(0),
                        availableHeight: availableHeight.toFixed(0),
                        pageWidth: Math.round(pageWidth),
                        pageHeight: Math.round(pageHeight),
                        widthScale: widthScale.toFixed(2),
                        heightScale: heightScale.toFixed(2),
                        calculatedScale: targetScale.toFixed(2) + 'x',
                        result: 'âœ… ENTIRE PAGE FITS RESPONSIVELY'
                    });
                } else {
                    // Laptop normal view (not fullscreen)
                    const widthScale = (containerWidth * 0.85) / pageWidth;
                    const heightScale = (containerHeight * 0.85) / pageHeight;
                    targetScale = Math.min(widthScale, heightScale);
                    targetScale = Math.max(0.8, Math.min(targetScale, 1.3));
                }
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // BIG MONITOR SCALING - AGGRESSIVE (Fill the screen)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            else if (isLargeMonitor) {
                if (isFullscreen) {
                    // BIG MONITOR FULLSCREEN
                    // Goal: Fill screen, PDF should be large and readable
                    // Strategy: Use 85% of space, allow 2.0x-3.5x scale

                    const widthScale = (containerWidth * 0.85) / pageWidth;
                    const heightScale = (containerHeight * 0.85) / pageHeight;
                    targetScale = Math.min(widthScale, heightScale);

                    // CRITICAL: Min 2.0x, Max 3.5x for big monitors
                    // This ensures PDF fills the large screen properly
                    targetScale = Math.max(2.0, Math.min(targetScale, 3.5));

                    console.log('ðŸ–¥ï¸ BIG MONITOR FULLSCREEN:', {
                        containerWidth,
                        containerHeight,
                        calculatedScale: targetScale.toFixed(2) + 'x',
                        result: targetScale >= 2.2 && targetScale <= 3.2 ? 'âœ… PERFECT' : 'âš ï¸ ADJUST'
                    });
                } else {
                    // Big monitor normal view
                    const widthScale = (containerWidth * 0.82) / pageWidth;
                    const heightScale = (containerHeight * 0.82) / pageHeight;
                    targetScale = Math.min(widthScale, heightScale);
                    targetScale = Math.max(1.0, Math.min(targetScale, 2.5));
                }
            }
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MEDIUM MONITOR SCALING (1600-2399px)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            else {
                if (isFullscreen) {
                    // MEDIUM MONITOR FULLSCREEN
                    // Use 65% of viewport (further reduced)
                    const widthScale = (containerWidth * 0.65) / pageWidth;
                    const heightScale = (containerHeight * 0.65) / pageHeight;
                    targetScale = Math.min(widthScale, heightScale);
                    targetScale = Math.max(0.6, Math.min(targetScale, 1.1));
                } else {
                    // Medium monitor normal view
                    const widthScale = (containerWidth * 0.83) / pageWidth;
                    const heightScale = (containerHeight * 0.83) / pageHeight;
                    targetScale = Math.min(widthScale, heightScale);
                    targetScale = Math.max(0.9, Math.min(targetScale, 2.0));
                }
            }

            // ===== SUMMARY LOGGING =====
            console.log('ðŸ“Š PDF SCALE SUMMARY:', {
                screenType: isLaptop ? 'ðŸ–¥ï¸ LAPTOP' : (isLargeMonitor ? 'ðŸ–¥ï¸ BIG MONITOR' : 'ðŸ–¥ï¸ MEDIUM'),
                screenSize: `${screenWidth}Ã—${screenHeight}`,
                mode: isFullscreen ? 'â›¶ FULLSCREEN' : 'ðŸªŸ NORMAL',
                finalScale: targetScale.toFixed(2) + 'x',
                pageSize: `${Math.round(pageWidth)}Ã—${Math.round(pageHeight)}`,
                orientation: isLandscape ? 'â†”ï¸ LANDSCAPE' : 'â†•ï¸ PORTRAIT'
            });

            return targetScale;
        }

        function renderPDFInViewer(base64Data, container, planData) {
            try {
                const decodedData = atob(base64Data);
                const byteArray = new Uint8Array(decodedData.length);
                for (let i = 0; i < decodedData.length; i++) {
                    byteArray[i] = decodedData.charCodeAt(i);
                }

                const loadingTask = pdfjsLib.getDocument({ data: byteArray });
                loadingTask.promise.then(pdf => {
                    container.innerHTML = '';

                    const pagesContainer = document.createElement('div');
                    pagesContainer.style.cssText = `
                        width: 100%;
                        max-width: 100%;
                        background: transparent;
                        box-shadow: none;
                        padding: 0;
                        margin: 0 auto;
                        display: flex;
                        flex-direction: column;
                        align-items: center;
                        gap: 20px;
                    `;
                    pagesContainer.id = 'pdfDocumentContent';
                    container.appendChild(pagesContainer);

                    const dpr = window.devicePixelRatio || 1;
                    const numPages = Math.min(pdf.numPages, 10);

                    // Set the total pages for navigation
                    totalPDFPages = numPages;
                    currentPDFPage = 1;

                    // Get first page to calculate scale (all pages use same scale)
                    pdf.getPage(1).then(firstPage => {
                        const firstPageViewport = firstPage.getViewport({ scale: 1 });

                        // Calculate optimal scale based on ACTUAL page dimensions
                        const optimalScale = getOptimalPDFScale(firstPageViewport);

                        console.log('Rendering PDF with scale:', optimalScale);
                        console.log('Page dimensions:', firstPageViewport.width, 'x', firstPageViewport.height);

                        // Render all pages with the calculated scale
                        for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                            pdf.getPage(pageNum).then(page => {
                                const viewport = page.getViewport({ scale: optimalScale });

                                const canvas = document.createElement('canvas');
                                const context = canvas.getContext('2d', {
                                    alpha: false,
                                    desynchronized: false,
                                    willReadFrequently: false
                                });

                                // Set canvas size for high DPI with enhanced quality
                                canvas.width = viewport.width * dpr;
                                canvas.height = viewport.height * dpr;

                                // Set display size to match viewport (scaled size)
                                let displayWidth = viewport.width;
                                let displayHeight = viewport.height;

                                canvas.style.width = displayWidth + 'px';
                                canvas.style.height = displayHeight + 'px';
                                canvas.style.display = 'block';
                                canvas.style.marginBottom = pageNum < numPages ? '20px' : '0';
                                canvas.style.border = '1px solid #d1d5db';
                                canvas.style.boxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                                canvas.style.backgroundColor = 'white';

                                const renderContext = {
                                    canvasContext: context,
                                    viewport: page.getViewport({ scale: optimalScale * dpr }),
                                    intent: 'display',
                                    renderInteractiveForms: false
                                };

                                page.render(renderContext).promise.then(() => {
                                    pagesContainer.appendChild(canvas);
                                }).catch(error => {
                                    console.error('Error rendering page:', pageNum, error);
                                });
                            }).catch(error => {
                                console.error('Error loading page:', pageNum, error);
                            });
                        }
                    }).catch(error => {
                        console.error('Error loading first page:', error);
                    });
                }).catch(error => {
                    console.error('Error loading PDF:', error);
                    container.innerHTML = '<div style="padding: 20px; color: red; text-align: center;">Error loading PDF: ' + error.message + '</div>';
                });
            } catch (error) {
                console.error('Error in renderPDFInViewer:', error);
                container.innerHTML = '<div style="padding: 20px; color: red; text-align: center;">Error rendering PDF: ' + error.message + '</div>';
            }
        }

        function closePDFViewer() {
            const modal = document.getElementById('pdfViewerModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // PDF Toolbar Functionality
        // ===== ADD TASK WITH PIN LOCATION - COMPLETE SYSTEM =====
        let addTaskMode = false;
        let taskPinLocation = null;
        if (!window.taskPinMarkers) window.taskPinMarkers = {}; // Store all pins by task ID
        const taskPinMarkers = window.taskPinMarkers;

        // Initialize add task mode
        function initAddTaskMode() {
            addTaskMode = true;
            taskPinLocation = null;

            // Change cursor to professional crosshair with pin
            const documentArea = document.querySelector('.pdf-document-area');
            if (documentArea) {
                documentArea.classList.add('adding-task-mode');
            }

            // Highlight the button
            const addTaskBtn = document.querySelector('.pdf-tool-btn[data-tool="addtask"]');
            if (addTaskBtn) {
                addTaskBtn.classList.add('active');
            }

            console.log('âœ… Add task mode activated - cursor changed to crosshair with pin');
        }

        // Handle click on PDF to place pin
        function handleAddTaskClick(e) {
            if (!addTaskMode) return;

            const documentArea = document.querySelector('.pdf-document-area');
            const pdfContent = document.getElementById('pdfDocumentContent');

            if (!documentArea || !pdfContent) return;

            // Get click coordinates relative to PDF (accounting for scroll)
            const rect = pdfContent.getBoundingClientRect();
            const x = e.clientX - rect.left + pdfContent.scrollLeft;
            const y = e.clientY - rect.top + pdfContent.scrollTop;

            // Store pin location
            taskPinLocation = { x, y };

            // Generate unique task ID
            const taskId = 'task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);

            // Add visual pin marker (STAYS VISIBLE ON PDF)
            addPinMarker(x, y, taskId);

            // Reset cursor
            documentArea.classList.remove('adding-task-mode');

            // Remove active state from button
            const addTaskBtn = document.querySelector('.pdf-tool-btn[data-tool="addtask"]');
            if (addTaskBtn) {
                addTaskBtn.classList.remove('active');
            }

            addTaskMode = false;

            // Open the FULL task creation modal with all fields
            openTaskCreationModalWithPin(x, y, taskId);

            console.log('âœ… Pin placed at', x, y, 'Task ID:', taskId);
        }

        // Add professional pin marker to PDF
        function addPinMarker(x, y, taskId) {
            const pdfContent = document.getElementById('pdfDocumentContent');
            if (!pdfContent) return;

            // Create pin marker element
            const marker = document.createElement('div');
            marker.className = 'task-pin-marker';
            marker.dataset.taskId = taskId;
            marker.style.cssText = `
                position: absolute;
                left: ${x}px;
                top: ${y}px;
                z-index: 10000;
            `;

            // Professional pin with pulse effect and number
            const pinNumber = Object.keys(taskPinMarkers).length + 1;
            marker.innerHTML = `
                <div class="pin-pulse"></div>
                <svg width="48" height="58" viewBox="0 0 24 32" fill="none">
                    <defs>
                        <filter id="shadow-${taskId}" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur in="SourceAlpha" stdDeviation="2"/>
                            <feOffset dx="0" dy="3" result="offsetblur"/>
                            <feComponentTransfer>
                                <feFuncA type="linear" slope="0.4"/>
                            </feComponentTransfer>
                            <feMerge>
                                <feMergeNode/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                    </defs>
                    <path d="M12 2C7.6 2 4 5.6 4 10c0 7 8 16 8 16s8-9 8-16c0-4.4-3.6-8-8-8z"
                          fill="#FF6B35"
                          stroke="#fff"
                          stroke-width="2"
                          filter="url(#shadow-${taskId})"/>
                    <circle cx="12" cy="10" r="4.5" fill="#fff"/>
                    <text x="12" y="13.5" text-anchor="middle" font-size="9" font-weight="bold" fill="#FF6B35">${pinNumber}</text>
                </svg>
            `;

            // Click pin to highlight and scroll to it
            marker.addEventListener('click', function(e) {
                e.stopPropagation();
                marker.classList.add('highlight');
                setTimeout(() => marker.classList.remove('highlight'), 1500);

                // If task exists in sidebar, highlight it
                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskCard) {
                    taskCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    taskCard.style.animation = 'none';
                    setTimeout(() => {
                        taskCard.style.animation = 'taskHighlight 1.5s ease-out';
                    }, 10);
                }
            });

            pdfContent.appendChild(marker);
            taskPinMarkers[taskId] = { element: marker, x, y, pinNumber };

            console.log('âœ… Pin marker added - Total pins:', Object.keys(taskPinMarkers).length);
        }

        // Open FULL task creation modal (the one you showed in screenshot)
        function openTaskCreationModalWithPin(x, y, taskId) {
            // Just call the unified function with pin coordinates
            openTaskCreationModal(taskId, x, y);
        }

        // Generate thumbnail with pin marker - FIXED TO SHOW SVG PIN
        async function generateThumbnailWithPin(plan, pinX, pinY) {
            const canvas = document.getElementById('taskPlanThumbnail');
            if (!canvas || !plan.preview) return;

            try {
                let bytes;

                // Check if preview is a URL (new format) or data URL (old format)
                if (plan.preview.startsWith('http') || plan.preview.startsWith('/')) {
                    // Fetch PDF from endpoint
                    const response = await fetch(plan.preview);
                    if (!response.ok) throw new Error(`Failed to fetch: ${response.status}`);
                    const arrayBuffer = await response.arrayBuffer();
                    bytes = new Uint8Array(arrayBuffer);
                } else {
                    // Old format: extract base64 from data URL and convert back to bytes
                    const base64Data = plan.preview.split(',')[1] || plan.preview;
                    const binaryString = atob(base64Data);
                    bytes = new Uint8Array(binaryString.length);
                    for (let i = 0; i < binaryString.length; i++) {
                        bytes[i] = binaryString.charCodeAt(i);
                    }
                }

                const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                const page = await pdf.getPage(1);

                const context = canvas.getContext('2d');
                const viewport = page.getViewport({ scale: 0.35 });

                canvas.width = 200;
                canvas.height = 280;

                // Render the PDF page
                await page.render({ canvasContext: context, viewport: viewport }).promise;

                // Add SVG pin overlay using the proper function
                const taskNumber = Object.keys(taskPinMarkers).length || 1;
                setTimeout(() => {
                    addPinMarkerToPreview(pinX, pinY, taskNumber);
                }, 100);

                console.log('âœ… Thumbnail generated - SVG pin will be overlaid');
            } catch (error) {
                console.error('Error generating thumbnail with pin:', error);
            }
        }

        // Update task metadata in modal header
        function updateTaskMetadata(plan) {
            const taskNumberElement = document.querySelector('.task-number');
            if (taskNumberElement) {
                const taskCount = Object.keys(taskPinMarkers).length;

                const userElement = document.querySelector('.user-dropdown span');
                let userAbbr = 'GUEST';
                if (userElement) {
                    const username = userElement.textContent.trim();
                    userAbbr = username.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
                }

                const pdfName = plan.name || 'desa wire';

                taskNumberElement.textContent = `#${taskCount} | @${userAbbr} | ${pdfName}`;

                // Update the task plan name
                const taskPlanNameElement = document.getElementById('taskPlanName');
                if (taskPlanNameElement) {
                    taskPlanNameElement.textContent = pdfName;
                }
            }
        }

        // Delete task and remove pin
        function deleteTaskAndPin(taskId) {
            if (!confirm('Delete this task and remove the pin from the PDF?')) {
                return;
            }

            // Remove pin from PDF
            if (taskPinMarkers[taskId]) {
                taskPinMarkers[taskId].element.remove();
                delete taskPinMarkers[taskId];
                console.log('âœ… Pin removed - Remaining pins:', Object.keys(taskPinMarkers).length);
            }

            // Remove task card from sidebar
            const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
            if (taskCard) {
                taskCard.remove();
                console.log('âœ… Task card removed from sidebar');
            }
        }

        // Initialize click listener for PDF area
        document.addEventListener('DOMContentLoaded', function() {
            const documentArea = document.querySelector('.pdf-document-area');
            if (documentArea) {
                documentArea.addEventListener('click', handleAddTaskClick);
                console.log('âœ… PDF click listener initialized for task placement');
            }
        });

        // Watch for modal open/close
        const pdfViewerModal = document.getElementById('pdfViewerModal');
        if (pdfViewerModal) {
            const observer = new MutationObserver(() => {
                if (pdfViewerModal.classList.contains('show')) {
                    // Re-attach click listener when PDF viewer opens
                    setTimeout(() => {
                        const documentArea = document.querySelector('.pdf-document-area');
                        if (documentArea) {
                            documentArea.removeEventListener('click', handleAddTaskClick);
                            documentArea.addEventListener('click', handleAddTaskClick);
                        }
                    }, 500);
                }
            });
            observer.observe(pdfViewerModal, { attributes: true });
        }

        // ===== PDF ZOOM AND RESET FUNCTIONS =====
        if (!window.planZoomLevels) window.planZoomLevels = {};
        if (!window.ZOOM_MIN) window.ZOOM_MIN = 100;
        if (!window.ZOOM_MAX) window.ZOOM_MAX = 300;
        const ZOOM_MIN = window.ZOOM_MIN;
        const ZOOM_MAX = window.ZOOM_MAX;

        function resetPDFZoom(planId) {
            window.planZoomLevels[planId] = ZOOM_MIN;
            const container = document.getElementById('pdfDocumentContent');
            if (container) {
                const pdfCanvas = container.querySelector('canvas');
                if (pdfCanvas) {
                    pdfCanvas.style.transform = 'scale(1)';
                    pdfCanvas.style.transformOrigin = 'top center';
                    pdfCanvas.style.transition = 'transform 0.2s ease-out';
                }
            }
            console.log('âœ… PDF zoom reset to 100%');
        }

        // ===== ZOOM FUNCTIONS =====
        const ZOOM_INCREMENT = 25;

        function zoomInPDF() {
            const container = document.getElementById('pdfDocumentContent');
            if (!container) return;

            const plan = plans[currentPlanIndex];
            if (!plan) return;

            const currentZoom = window.planZoomLevels[plan.id] || ZOOM_MIN;
            const newZoom = Math.min(currentZoom + ZOOM_INCREMENT, ZOOM_MAX);

            if (newZoom === currentZoom) return;

            window.planZoomLevels[plan.id] = newZoom;
            applyZoomToPDF(newZoom, container);
            console.log(`âœ… Zoomed in: ${newZoom}%`);
        }

        function zoomOutPDF() {
            const container = document.getElementById('pdfDocumentContent');
            if (!container) return;

            const plan = plans[currentPlanIndex];
            if (!plan) return;

            const currentZoom = window.planZoomLevels[plan.id] || ZOOM_MIN;
            const newZoom = Math.max(currentZoom - ZOOM_INCREMENT, ZOOM_MIN);

            if (newZoom === currentZoom) return;

            window.planZoomLevels[plan.id] = newZoom;
            applyZoomToPDF(newZoom, container);
            console.log(`âœ… Zoomed out: ${newZoom}%`);
        }

        function applyZoomToPDF(zoomLevel, container) {
            const zoomMultiplier = zoomLevel / ZOOM_MIN;
            const documentArea = document.querySelector('.pdf-document-area');
            const pdfCanvas = container.querySelector('canvas');

            // Apply transform ONLY to the canvas, not the container
            if (pdfCanvas) {
                pdfCanvas.style.transform = `scale(${zoomMultiplier})`;
                pdfCanvas.style.transformOrigin = 'top center';
                pdfCanvas.style.transition = 'transform 0.2s ease-out';
            }

            // Adjust document area to handle scrolling for zoomed content
            if (documentArea) {
                documentArea.style.overflow = 'auto';
                documentArea.style.transition = 'none';

                // Scroll to center after zoom completes
                setTimeout(() => {
                    const scrollX = (documentArea.scrollWidth - documentArea.clientWidth) / 2;
                    const scrollY = (documentArea.scrollHeight - documentArea.clientHeight) / 2;
                    documentArea.scrollLeft = scrollX;
                    documentArea.scrollTop = scrollY;
                }, 50);
            }

            console.log(`âœ… Applied zoom: ${zoomLevel}% (${zoomMultiplier}x scale) to PDF canvas only`);
        }

        // ===== TASK MODAL FUNCTIONS =====
        // Open Task Creation Modal (works with OR without pin)
        function openTaskCreationModal(taskId = null, pinX = null, pinY = null) {
            const modal = document.getElementById('taskCreationModal');
            if (!modal) {
                console.error('âŒ Task modal not found');
                return;
            }

            console.log('ðŸŽ¯ Opening task modal:', { taskId, pinX, pinY });

            // Get current plan details
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            let pdfName = 'Document';
            let plan = null;

            if (planIndex !== -1 && plans && plans[planIndex]) {
                plan = plans[planIndex];
                pdfName = plan.name || plan.sheetNumber || 'Document';
            } else {
                console.warn('âš ï¸ No plan found at index:', planIndex);
            }

            // Get user abbreviation
            const userElement = document.querySelector('.user-dropdown span');
            let userAbbr = 'USER';
            if (userElement) {
                const username = userElement.textContent.trim();
                userAbbr = username.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
            }

            // Get task number
            const taskCount = Object.keys(taskDataStore).length + 1;

            // Update modal header
            const taskNumberElement = document.querySelector('.task-number');
            if (taskNumberElement) {
                taskNumberElement.textContent = `#${taskCount} | @${userAbbr} | ${pdfName}`;
            }

            // Clear input fields
            const taskTitleInput = document.getElementById('taskTitleInput');
            if (taskTitleInput) {
                taskTitleInput.value = '';
                taskTitleInput.placeholder = 'Enter task title';
            }

            // Reset status
            const selectedStatus = document.getElementById('selectedStatus');
            if (selectedStatus) {
                selectedStatus.textContent = 'Priority 2';
            }

            // Update plan name
            const taskPlanNameElement = document.getElementById('taskPlanName');
            if (taskPlanNameElement) {
                taskPlanNameElement.textContent = pdfName;
            }

            // Store task ID and pin coordinates
            if (taskId) {
                modal.dataset.currentTaskId = taskId;
                currentTaskId = taskId;
            } else {
                modal.dataset.currentTaskId = 'task-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                currentTaskId = modal.dataset.currentTaskId;
            }

            if (pinX !== null && pinY !== null) {
                modal.dataset.pinX = pinX;
                modal.dataset.pinY = pinY;
            } else {
                // No pin location - remove dataset
                delete modal.dataset.pinX;
                delete modal.dataset.pinY;
            }

            // Show modal FIRST
            modal.classList.add('show');

            // âœ… FORCE ARROWS TO BE VISIBLE
            setTimeout(() => {
                const leftArrow = document.querySelector('.task-nav-left');
                const rightArrow = document.querySelector('.task-nav-right');

                if (leftArrow) {
                    leftArrow.style.display = 'flex';
                    leftArrow.style.visibility = 'visible';
                    console.log('âœ… Left arrow visible');
                }

                if (rightArrow) {
                    rightArrow.style.display = 'flex';
                    rightArrow.style.visibility = 'visible';
                    console.log('âœ… Right arrow visible');
                }
            }, 100);

            // âœ… CRITICAL FIX: Generate thumbnail properly
            if (plan && plan.preview) {
                setTimeout(() => {
                    const canvas = document.getElementById('taskPlanThumbnail');
                    const preview = document.querySelector('.task-attachment-preview');

                    if (!canvas || !preview) {
                        console.error('âŒ Canvas or preview not found');
                        return;
                    }

                    // Clear any existing pins
                    const existingPins = preview.querySelectorAll('.task-attachment-preview-pin');
                    existingPins.forEach(pin => pin.remove());

                    const base64Data = plan.preview.split(',')[1] || plan.preview;

                    console.log('ðŸ“¸ Generating thumbnail...');

                    if (pinX !== null && pinY !== null) {
                        // WITH PIN
                        console.log('ðŸ“ WITH pin location:', pinX, pinY);
                        generateThumbnailWithPin(plan, pinX, pinY);

                        // Add pin marker overlay after thumbnail renders
                        setTimeout(() => {
                            addPinMarkerToPreview(pinX, pinY, taskCount);
                        }, 300);
                    } else {
                        // WITHOUT PIN - Just show PDF thumbnail
                        console.log('ðŸ“„ WITHOUT pin - showing plain thumbnail');
                        generatePDFThumbnail(base64Data, 'taskPlanThumbnail');
                    }
                }, 150);
            } else {
                console.warn('âš ï¸ No plan preview available');

                // Show placeholder icon
                const preview = document.querySelector('.task-attachment-preview');
                if (preview) {
                    preview.innerHTML = `
                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; background: #f3f4f6;">
                            <i class="fas fa-file-pdf" style="font-size: 48px; color: #9ca3af;"></i>
                        </div>
                    `;
                }
            }

            console.log('âœ… Task modal opened -', pinX !== null ? 'WITH pin' : 'WITHOUT pin');
        }

        // Close task creation modal
        function closeTaskCreationModal() {
            const modal = document.getElementById('taskCreationModal');
            if (!modal) return;

            // Get task ID
            const taskId = modal.dataset.currentTaskId;

            // Check if task has pin
            const hasPinX = modal.dataset.pinX;
            const hasPinY = modal.dataset.pinY;

            // If pin exists, ask user if they want to keep it
            if (taskId && hasPinX && hasPinY && window.taskPinMarkers && window.taskPinMarkers[taskId]) {
                const keepPin = confirm('Keep the pin on the PDF? (Cancel to remove it)');
                if (!keepPin) {
                    // Remove pin if user doesn't want to keep it
                    window.taskPinMarkers[taskId].element.remove();
                    delete window.taskPinMarkers[taskId];
                    console.log('âœ… Pin removed - user closed modal without saving');
                } else {
                    console.log('âœ… Pin kept on PDF');
                }
            }

            modal.classList.remove('show');
            modal.removeAttribute('data-current-task-id');
            modal.removeAttribute('data-pin-x');
            modal.removeAttribute('data-pin-y');

            currentTaskId = null;
        }

        let pdfActiveTool = null;
        let pdfIsRecording = false;
        let pdfIsFullscreen = false;

        function initPDFToolbar() {
            const toolButtons = document.querySelectorAll('.pdf-left-sidebar .pdf-tool-btn[data-tool]');
            const recordBtn = document.getElementById('pdfRecordBtn');
            const undoBtn = document.getElementById('pdfUndoBtn');

            const toolLabels = {
                fullscreen: 'Fullscreen',
                add: 'Add',
                remove: 'Remove',
                location: 'Location',
                link: 'Link',
                draw: 'Draw',
                duplicate: 'Duplicate',
                shape: 'Shape',
                text: 'Text',
                tag: 'Tag',
                cursor: 'Cursor'
            };

            // Find and setup fullscreen button
            const fullscreenBtn = document.querySelector('.pdf-left-sidebar .pdf-tool-btn[data-tool="fullscreen"]');
            if (fullscreenBtn) {
                // Remove all existing event listeners by cloning and replacing
                const newFullscreenBtn = fullscreenBtn.cloneNode(true);
                fullscreenBtn.parentNode.replaceChild(newFullscreenBtn, fullscreenBtn);
                const updatedFullscreenBtn = document.querySelector('.pdf-left-sidebar .pdf-tool-btn[data-tool="fullscreen"]');

                updatedFullscreenBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();

                    const pdfModal = document.getElementById('pdfViewerModal');

                    if (pdfModal) {
                        pdfIsFullscreen = !pdfIsFullscreen;

                        if (pdfIsFullscreen) {
                            // Enter fullscreen mode
                            pdfModal.classList.add('fullscreen-mode');
                            this.classList.add('active');

                            // Request browser fullscreen API
                            if (pdfModal.requestFullscreen) {
                                pdfModal.requestFullscreen();
                            } else if (pdfModal.webkitRequestFullscreen) {
                                pdfModal.webkitRequestFullscreen();
                            } else if (pdfModal.msRequestFullscreen) {
                                pdfModal.msRequestFullscreen();
                            }

                            console.log('Fullscreen enabled');

                            // Re-render PDF with new scale after short delay
                            setTimeout(() => {
                                if (currentPlanIndex >= 0 && plans[currentPlanIndex]) {
                                    const plan = plans[currentPlanIndex];
                                    const container = document.getElementById('pdfDocumentContent');
                                    if (plan.preview && container) {
                                        renderPDFFromPreview(plan, container);
                                    }
                                }
                            }, 100);
                        } else {
                            // Exit fullscreen mode
                            pdfModal.classList.remove('fullscreen-mode');
                            this.classList.remove('active');

                            // Exit browser fullscreen API
                            if (document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement) {
                                if (document.exitFullscreen) {
                                    document.exitFullscreen().catch(() => {});
                                } else if (document.webkitExitFullscreen) {
                                    document.webkitExitFullscreen();
                                } else if (document.msExitFullscreen) {
                                    document.msExitFullscreen();
                                }
                            }

                            console.log('Fullscreen disabled');

                            // Re-render PDF with normal scale after short delay
                            setTimeout(() => {
                                if (currentPlanIndex >= 0 && plans[currentPlanIndex]) {
                                    const plan = plans[currentPlanIndex];
                                    const container = document.getElementById('pdfDocumentContent');
                                    if (plan.preview && container) {
                                        renderPDFFromPreview(plan, container);
                                    }
                                }
                            }, 100);
                        }
                    }
                });
            }

            // Setup zoom button handlers
            const zoomInBtn = document.getElementById('pdfZoomInBtn');
            if (zoomInBtn) {
                zoomInBtn.removeEventListener('click', window.zoomInBtnHandler);
                window.zoomInBtnHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    zoomInPDF();
                };
                zoomInBtn.addEventListener('click', window.zoomInBtnHandler);
            }

            const zoomOutBtn = document.getElementById('pdfZoomOutBtn');
            if (zoomOutBtn) {
                zoomOutBtn.removeEventListener('click', window.zoomOutBtnHandler);
                window.zoomOutBtnHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    zoomOutPDF();
                };
                zoomOutBtn.addEventListener('click', window.zoomOutBtnHandler);
            }

            // Setup tool buttons with event delegation to avoid duplicate listeners
            const toolButtonsContainer = document.querySelector('.pdf-left-sidebar');
            if (toolButtonsContainer) {
                // Use event delegation on the container
                const handleToolClick = (e) => {
                    const button = e.target.closest('.pdf-tool-btn[data-tool]');
                    if (!button) return;

                    const tool = button.getAttribute('data-tool');

                    // Skip fullscreen button from general tool handling
                    if (tool === 'fullscreen') {
                        return;
                    }

                    if (pdfActiveTool === tool) {
                        button.classList.remove('active');
                        pdfActiveTool = null;
                    } else {
                        const allToolButtons = document.querySelectorAll('.pdf-left-sidebar .pdf-tool-btn[data-tool]');
                        allToolButtons.forEach(btn => {
                            if (btn.getAttribute('data-tool') !== 'fullscreen') {
                                btn.classList.remove('active');
                            }
                        });
                        button.classList.add('active');
                        pdfActiveTool = tool;
                        console.log('Active tool:', toolLabels[tool]);
                    }
                };

                // Remove old listener and add new one
                toolButtonsContainer.removeEventListener('click', window.toolButtonHandler);
                window.toolButtonHandler = handleToolClick;
                toolButtonsContainer.addEventListener('click', handleToolClick);
            }

            const updatedRecordBtn = document.getElementById('pdfRecordBtn');
            if (updatedRecordBtn) {
                // Remove old listeners by using event delegation
                updatedRecordBtn.removeEventListener('click', window.recordBtnHandler);
                window.recordBtnHandler = function() {
                    pdfIsRecording = !pdfIsRecording;
                    const recordIcon = this.querySelector('.record-icon');

                    if (pdfIsRecording) {
                        this.classList.add('recording');
                        if (recordIcon) recordIcon.classList.add('recording');
                        console.log('Recording started');
                    } else {
                        this.classList.remove('recording');
                        if (recordIcon) recordIcon.classList.remove('recording');
                        console.log('Recording stopped');
                    }
                };
                updatedRecordBtn.addEventListener('click', window.recordBtnHandler);
            }

            const updatedUndoBtn = document.getElementById('pdfUndoBtn');
            if (updatedUndoBtn) {
                updatedUndoBtn.removeEventListener('click', window.undoBtnHandler);
                window.undoBtnHandler = function() {
                    console.log('Undo action');
                };
                updatedUndoBtn.addEventListener('click', window.undoBtnHandler);
            }

            // Navigation arrows functionality
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) {
                prevBtn.removeEventListener('click', window.prevBtnHandler);
                window.prevBtnHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Previous plan - Current index:', currentPlanIndex, 'Total plans:', plans.length);
                    // Call PDF viewer previous plan function if available
                    if (typeof previousPDFPage === 'function') {
                        previousPDFPage();
                    }
                };
                prevBtn.addEventListener('click', window.prevBtnHandler);
            }

            if (nextBtn) {
                nextBtn.removeEventListener('click', window.nextBtnHandler);
                window.nextBtnHandler = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Next plan - Current index:', currentPlanIndex, 'Total plans:', plans.length);
                    // Call PDF viewer next plan function if available
                    if (typeof nextPDFPage === 'function') {
                        nextPDFPage();
                    }
                };
                nextBtn.addEventListener('click', window.nextBtnHandler);
            }
        }

        // Listen for fullscreen change events to sync state
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('msfullscreenchange', handleFullscreenChange);

        function handleFullscreenChange() {
            const pdfModal = document.getElementById('pdfViewerModal');
            const fullscreenBtn = document.querySelector('.pdf-left-sidebar .pdf-tool-btn[data-tool="fullscreen"]');

            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.msFullscreenElement) {
                // Exited fullscreen (via ESC key or browser UI)
                pdfIsFullscreen = false;
                if (pdfModal) pdfModal.classList.remove('fullscreen-mode');
                if (fullscreenBtn) fullscreenBtn.classList.remove('active');
            }
        }

        // Initialize toolbar when PDF viewer opens
        function setupToolbarObserver() {
            const pdfViewerModal = document.getElementById('pdfViewerModal');
            if (!pdfViewerModal) {
                // Element not found yet, try again after a short delay
                setTimeout(setupToolbarObserver, 100);
                return;
            }

            const observer = new MutationObserver(() => {
                if (pdfViewerModal.classList.contains('show')) {
                    initPDFToolbar();
                } else if (!pdfViewerModal.classList.contains('show')) {
                    // Reset fullscreen state when PDF viewer is closed
                    pdfIsFullscreen = false;
                }
            });

            observer.observe(pdfViewerModal, { attributes: true });
        }

        // Wait for document to be ready before setting up observer
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupToolbarObserver);
        } else {
            setupToolbarObserver();
        }

        // Handle window resize - recalculate PDF scale on screen size change
        let resizeTimeout;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(function() {
                const pdfViewerModal = document.getElementById('pdfViewerModal');
                if (pdfViewerModal && pdfViewerModal.classList.contains('show')) {
                    console.log('Window resized - recalculating PDF scale');
                    // Get current plan and re-render
                    if (currentPlanIndex >= 0 && plans[currentPlanIndex]) {
                        const plan = plans[currentPlanIndex];
                        const container = document.getElementById('pdfDocumentContent');
                        if (plan.preview && container) {
                            renderPDFFromPreview(plan, container);
                        }
                    }
                }
            }, 300); // Wait 300ms after resize stops
        });

        // Toggle tasks panel visibility
        function toggleTasksPanel() {
            const tasksPanel = document.querySelector('.pdf-tasks-sidebar');
            if (tasksPanel) {
                tasksPanel.style.display = tasksPanel.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Toggle PDF search
        function togglePDFSearch() {
            const searchContainer = document.getElementById('pdfSearchContainer');
            if (!searchContainer) {
                createPDFSearchBox();
            } else {
                searchContainer.classList.toggle('hidden');
                if (!searchContainer.classList.contains('hidden')) {
                    document.getElementById('pdfSearchInput').focus();
                }
            }
        }

        function createPDFSearchBox() {
            const searchHTML = `
                <div id="pdfSearchContainer" class="pdf-search-professional">
                    <div class="search-pro-header">
                        <div class="search-pro-input-wrapper">
                            <i class="fas fa-search search-pro-icon"></i>
                            <input type="text" id="pdfSearchInput" class="search-pro-input" placeholder="Search in PDF..." autocomplete="off" />
                            <div class="search-pro-counter">
                                <span id="searchCurrentMatch">0</span>/<span id="searchTotalMatches">0</span>
                            </div>
                        </div>
                        <div class="search-pro-controls">
                            <button class="search-pro-btn prev-match" onclick="searchPreviousMatch()" title="Previous match">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="search-pro-btn next-match" onclick="searchNextMatch()" title="Next match">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="search-pro-btn close-btn" onclick="closePDFSearch()" title="Close search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div id="searchResultsPanel" class="search-pro-results">
                        <div id="searchResultsList" class="search-pro-results-list"></div>
                    </div>
                </div>
            `;

            const pdfDocumentContent = document.getElementById('pdfDocumentContent');
            if (pdfDocumentContent) {
                pdfDocumentContent.insertAdjacentHTML('beforebegin', searchHTML);
                setupSearchListeners();
            }
        }

        function setupSearchListeners() {
            const searchInput = document.getElementById('pdfSearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const query = e.target.value.trim();
                    if (query.length > 0) {
                        searchPDFContent(query);
                    } else {
                        clearSearchResults();
                    }
                });

                searchInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closePDFSearch();
                    }
                });
            }
        }

        let pdfSearchMatches = [];
        let currentMatchIndex = -1;

        function searchPDFContent(query) {
            const pdfContent = document.getElementById('pdfDocumentContent');
            const resultsList = document.getElementById('searchResultsList');
            const totalMatches = document.getElementById('searchTotalMatches');
            const currentMatch = document.getElementById('searchCurrentMatch');

            if (!pdfContent || !resultsList) return;

            pdfSearchMatches = [];
            currentMatchIndex = -1;

            let matches = 0;
            const text = pdfContent.innerText || pdfContent.textContent || '';

            if (!text || query.length === 0) {
                totalMatches.textContent = '0';
                currentMatch.textContent = '0';
                resultsList.innerHTML = '';
                return;
            }

            const regex = new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');

            // Search in text content
            let searchResult;
            while ((searchResult = regex.exec(text)) !== null) {
                matches++;
                const start = Math.max(0, searchResult.index - 50);
                const end = Math.min(text.length, searchResult.index + query.length + 50);
                const context = text.substring(start, end).trim();
                pdfSearchMatches.push({
                    index: matches,
                    context: context,
                    position: searchResult.index
                });
            }

            // Update total matches
            totalMatches.textContent = matches;
            currentMatch.textContent = matches > 0 ? '1' : '0';

            // Display results
            resultsList.innerHTML = '';
            pdfSearchMatches.slice(0, 8).forEach((result, idx) => {
                const resultItem = document.createElement('div');
                resultItem.className = 'search-result-item' + (idx === 0 && matches > 0 ? ' active' : '');
                resultItem.innerHTML = `
                    <div class="result-number">Match #${result.index}</div>
                    <div class="result-context">${result.context.substring(0, 80)}...</div>
                `;
                resultItem.onclick = () => selectSearchMatch(idx);
                resultsList.appendChild(resultItem);
            });

            if (pdfSearchMatches.length > 8) {
                const moreItem = document.createElement('div');
                moreItem.className = 'search-result-more';
                moreItem.textContent = `+${pdfSearchMatches.length - 8} more matches`;
                resultsList.appendChild(moreItem);
            }

            if (matches > 0) {
                currentMatchIndex = 0;
            }
        }

        function selectSearchMatch(index) {
            currentMatchIndex = index;
            document.getElementById('searchCurrentMatch').textContent = index + 1;
            updateActiveMatch();
        }

        function searchNextMatch() {
            if (pdfSearchMatches.length === 0) return;
            currentMatchIndex = (currentMatchIndex + 1) % pdfSearchMatches.length;
            document.getElementById('searchCurrentMatch').textContent = currentMatchIndex + 1;
            updateActiveMatch();
        }

        function searchPreviousMatch() {
            if (pdfSearchMatches.length === 0) return;
            currentMatchIndex = (currentMatchIndex - 1 + pdfSearchMatches.length) % pdfSearchMatches.length;
            document.getElementById('searchCurrentMatch').textContent = currentMatchIndex + 1;
            updateActiveMatch();
        }

        function updateActiveMatch() {
            const resultsList = document.getElementById('searchResultsList');
            const items = resultsList.querySelectorAll('.search-result-item');
            items.forEach((item, idx) => {
                item.classList.remove('active');
                if (idx === currentMatchIndex) {
                    item.classList.add('active');
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        function clearSearchResults() {
            const resultsList = document.getElementById('searchResultsList') || document.querySelector('.search-compact-results');
            const resultsCount = document.getElementById('searchResultsCount') || document.querySelector('.search-compact-count');
            if (resultsList) resultsList.innerHTML = '';
            if (resultsCount) resultsCount.textContent = '0 results';
        }

        function closePDFSearch() {
            const searchContainer = document.getElementById('pdfSearchContainer');
            if (searchContainer) {
                searchContainer.remove();
            }
            clearSearchResults();
        }

        // Toggle eye dropdown
        function toggleEyeDropdown() {
            const dropdown = document.getElementById('eyeDropdownMenu');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close eye dropdown when clicking outside (add to existing click handler)
        document.addEventListener('click', function(e) {
            const eyeBtn = document.getElementById('eyeDropdownBtn');
            const dropdown = document.getElementById('eyeDropdownMenu');

            if (dropdown && eyeBtn && !eyeBtn.contains(e.target) && !dropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Keyboard shortcut for closing
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePDFViewer();
            }
        });

        // Toast notification system
        function showNotification(message, type = 'success') {
            // Create notification container if it doesn't exist
            let container = document.getElementById('notificationContainer');
            if (!container) {
                container = document.createElement('div');
                container.id = 'notificationContainer';
                container.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    z-index: 10000;
                    pointer-events: none;
                `;
                document.body.appendChild(container);
            }

            // Create notification element
            const notification = document.createElement('div');
            const bgColor = type === 'success' ? '#10b981' : '#ef4444';
            const borderColor = type === 'success' ? '#059669' : '#dc2626';

            notification.style.cssText = `
                background: ${bgColor};
                color: white;
                padding: 12px 16px;
                border-radius: 6px;
                margin-bottom: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                font-size: 14px;
                font-weight: 500;
                display: flex;
                align-items: center;
                gap: 8px;
                pointer-events: auto;
                animation: slideInRight 0.3s ease-out;
                border-left: 4px solid ${borderColor};
            `;

            notification.textContent = message;
            container.appendChild(notification);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease-out';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // Add animation styles if not already present
        if (!document.getElementById('notificationAnimationStyles')) {
            const style = document.createElement('style');
            style.id = 'notificationAnimationStyles';
            style.textContent = `
                @keyframes slideInRight {
                    from {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }

                @keyframes slideOutRight {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(400px);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }

        /* ===== PDF NAVIGATION ===== */
        let currentPDFPage = 1;
        let totalPDFPages = 1;
        let currentPlanIndex = -1; // Track current plan being viewed
        let currentPDFPlan = -1; // Track current plan for edit feature
        let planRotations = {}; // Track rotation angles per plan ID

        function previousPDFPage() {
            // Navigate to previous plan
            if (currentPlanIndex > 0) {
                currentPlanIndex--;
                viewPlan(currentPlanIndex);
                console.log('Previous plan - Index:', currentPlanIndex);
            }
        }

        function nextPDFPage() {
            // Navigate to next plan
            if (currentPlanIndex < plans.length - 1) {
                currentPlanIndex++;
                viewPlan(currentPlanIndex);
                console.log('Next plan - Index:', currentPlanIndex);
            }
        }

        function scrollToPDFPage(pageNum) {
            const pagesContainer = document.querySelector('#pdfDocumentContent');
            const documentArea = document.querySelector('.pdf-document-area');

            if (pagesContainer) {
                const canvases = pagesContainer.querySelectorAll('canvas');
                if (canvases[pageNum - 1]) {
                    const targetCanvas = canvases[pageNum - 1];
                    console.log('Scrolling to page:', pageNum);

                    // Scroll the canvas into view with smooth behavior
                    targetCanvas.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

                    // Alternative: Scroll the document area
                    if (documentArea) {
                        const offset = targetCanvas.offsetTop - documentArea.offsetTop;
                        documentArea.scrollTop = offset;
                    }
                }
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PLAN DETAILS EDIT FEATURE - Functions
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Track which plan is being edited
        let currentEditingPlanIndex = -1;

        // Open plan details modal for editing
        function openPlanDetailsModal(planIndex) {
            console.log('openPlanDetailsModal called with planIndex:', planIndex);
            console.log('plans array:', plans);

            const plan = plans[planIndex];
            if (!plan) {
                console.error('Plan not found at index:', planIndex);
                return;
            }

            console.log('Plan found:', plan);

            // Store current editing plan index
            currentEditingPlanIndex = planIndex;

            // Populate modal fields
            const sheetInput = document.getElementById('planSheetNumber');
            const descInput = document.getElementById('planDescription');
            const modal = document.getElementById('planDetailsModal');

            console.log('Modal:', modal);
            console.log('Sheet input:', sheetInput);
            console.log('Desc input:', descInput);

            if (sheetInput) sheetInput.value = plan.sheetNumber || plan.name || '';
            if (descInput) descInput.value = plan.description || '';

            // Show modal
            if (modal) {
                modal.classList.add('show');
                console.log('Modal shown');
            } else {
                console.error('Modal not found');
            }
        }

        // Close plan details modal
        function closePlanDetailsModal() {
            document.getElementById('planDetailsModal').classList.remove('show');
            currentEditingPlanIndex = -1;
        }

        // Save plan details
        async function savePlanDetails() {
            if (currentEditingPlanIndex === -1) return;

            const plan = plans[currentEditingPlanIndex];
            const sheetNumber = document.getElementById('planSheetNumber').value.trim();
            const description = document.getElementById('planDescription').value.trim();

            if (!sheetNumber) {
                showNotification('Please enter a sheet number', 'error');
                return;
            }

            try {
                console.log('Saving plan details...');
                console.log('Plan ID:', plan.id);
                console.log('Sheet Number:', sheetNumber);
                console.log('Description:', description);

                // Update in database
                const response = await fetch(`/api/plans/${plan.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: sheetNumber,
                        sheetNumber: sheetNumber,
                        description: description
                    })
                });

                console.log('API Response Status:', response.status);
                const result = await response.json();
                console.log('API Response:', result);

                if (result.success || response.ok) {
                    // Update local data
                    plan.name = sheetNumber;
                    plan.sheetNumber = sheetNumber;
                    plan.description = description;

                    // Update PDF viewer bottom name display if viewing a PDF
                    const bottomNameDisplay = document.getElementById('pdfBottomNameDisplay');
                    if (bottomNameDisplay) {
                        bottomNameDisplay.textContent = sheetNumber;
                    }

                    console.log('âœ… Plan updated locally and in database');
                    showNotification('âœ… Plan details updated successfully!', 'success');
                    closePlanDetailsModal();
                    updateView();
                } else {
                    console.error('API returned error:', result);
                    showNotification('Error updating plan details: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                console.error('Error saving plan details:', error);
                showNotification('Error saving plan details: ' + error.message, 'error');
            }
        }

        // Close plan details modal when clicking outside
        document.addEventListener('click', function(e) {
            const planDetailsModal = document.getElementById('planDetailsModal');
            const planDetailsContent = document.querySelector('.plan-details-content');

            if (planDetailsModal &&
                e.target === planDetailsModal &&
                !planDetailsContent.contains(e.target)) {
                closePlanDetailsModal();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const planDetailsModal = document.getElementById('planDetailsModal');
                if (planDetailsModal && planDetailsModal.classList.contains('show')) {
                    closePlanDetailsModal();
                }
            }
        });

        // Handle Edit Plan Details button click
        function handleEditPlanClick() {
            console.log('=== EDIT PLAN CLICK HANDLER ===');
            console.log('currentPDFPlan:', currentPDFPlan);
            console.log('currentPlanIndex:', currentPlanIndex);
            console.log('plans array length:', plans.length);

            // Use currentPlanIndex instead of currentPDFPlan for better reliability
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex !== -1 && plans && plans[planIndex]) {
                console.log('âœ… Opening modal for plan:', plans[planIndex].name);
                openPlanDetailsModal(planIndex);
            } else {
                console.warn('âŒ Cannot open modal - no plan selected');
                console.warn('currentPlanIndex:', currentPlanIndex);
                console.warn('currentPDFPlan:', currentPDFPlan);
                showNotification('Please open a plan first', 'error');
            }
        }

        // ===== PDF ROTATION SUBMENU FUNCTIONS =====
        let rotateSubmenuTimeout = null;

        // Show rotation submenu with timeout to prevent flickering
        function showRotateSubmenu() {
            if (rotateSubmenuTimeout) {
                clearTimeout(rotateSubmenuTimeout);
            }
            const submenu = document.getElementById('rotateSubmenu');
            if (submenu) {
                submenu.style.display = 'block';
            }
        }

        // Hide rotation submenu with timeout
        function hideRotateSubmenu() {
            rotateSubmenuTimeout = setTimeout(() => {
                const submenu = document.getElementById('rotateSubmenu');
                if (submenu) {
                    submenu.style.display = 'none';
                }
            }, 100);
        }

        // Main rotation function - applies rotation to PDF and saves to database
        async function rotatePDFSheet(degrees) {
            console.log('ðŸ”„ Rotation initiated with degrees:', degrees);

            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            console.log('Plan index:', planIndex, 'currentPlanIndex:', currentPlanIndex, 'currentPDFPlan:', currentPDFPlan);

            if (planIndex === -1 || !plans || !plans[planIndex]) {
                console.warn('No plan found');
                showNotification('Please open a plan first', 'error');
                return;
            }

            const plan = plans[planIndex];
            if (!plan.id) {
                console.warn('No plan ID');
                showNotification('Plan ID not found', 'error');
                return;
            }

            try {
                console.log('Rotating plan:', plan.id);

                // Initialize rotation for this plan if not exists
                if (!planRotations[plan.id]) {
                    planRotations[plan.id] = 0;
                }

                // Calculate new rotation angle (cumulative)
                planRotations[plan.id] = (planRotations[plan.id] + degrees) % 360;

                // Normalize to 0-360 range
                if (planRotations[plan.id] < 0) {
                    planRotations[plan.id] += 360;
                }

                console.log('New rotation angle:', planRotations[plan.id]);

                // Apply rotation to current PDF viewer
                await renderRotatedPDF(plan, planRotations[plan.id]);

                // Update thumbnail in grid
                updatePlanThumbnail(planIndex, planRotations[plan.id]);

                // Save rotation to database
                await saveRotationToDatabase(plan.id, planRotations[plan.id]);

                // Show feedback
                const rotationDisplay = planRotations[plan.id] === 0 ? 'reset' : `${planRotations[plan.id]}Â°`;
                showNotification(`ðŸ“ PDF rotated to ${rotationDisplay}`, 'success');

                // Close actions dropdown
                if (typeof togglePDFActionsDropdown === 'function') {
                    togglePDFActionsDropdown();
                }

            } catch (error) {
                console.error('Error rotating PDF:', error);
                showNotification('Error rotating PDF', 'error');
            }
        }

        // Render PDF with rotation applied
        async function renderRotatedPDF(plan, rotationDegrees) {
            try {
                const pdfViewer = document.querySelector('#pdfDocumentContent');
                if (!pdfViewer) return;

                // Apply CSS rotation directly to the content
                pdfViewer.style.transform = `rotate(${rotationDegrees}deg)`;
                pdfViewer.style.transition = 'transform 0.4s ease-out';
                pdfViewer.style.transformOrigin = 'center center';

                // Add rotation animation class to canvases
                const canvases = pdfViewer.querySelectorAll('canvas');
                canvases.forEach(canvas => {
                    canvas.classList.add('rotating');
                    setTimeout(() => canvas.classList.remove('rotating'), 400);
                });

                // Store rotation in plan object for persistence
                plan.rotation = rotationDegrees;

                console.log('PDF rotated to', rotationDegrees, 'degrees');

            } catch (error) {
                console.error('Error rendering rotated PDF:', error);
            }
        }

        // Update plan thumbnail in grid with rotation
        function updatePlanThumbnail(planIndex, rotationDegrees) {
            try {
                const thumbnails = document.querySelectorAll('.plan-item');
                if (thumbnails[planIndex]) {
                    const img = thumbnails[planIndex].querySelector('img');
                    if (img) {
                        img.style.transform = `rotate(${rotationDegrees}deg)`;
                    }
                }
            } catch (error) {
                console.error('Error updating thumbnail:', error);
            }
        }

        // Save rotation to database
        async function saveRotationToDatabase(planId, rotationDegrees) {
            try {
                const response = await fetch(`/api/plans/${planId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rotation: rotationDegrees
                    })
                });

                if (!response.ok) {
                    throw new Error(`API error: ${response.status}`);
                }

                const result = await response.json();
                if (!result.success) {
                    console.warn('Server returned success: false');
                }

            } catch (error) {
                console.error('Error saving rotation to database:', error);
                showNotification('Could not save rotation to database', 'warning');
            }
        }

        // ===== PDF ACTIONS DROPDOWN FUNCTIONS =====

        // Toggle PDF Actions dropdown
        function togglePDFActionsDropdown(event) {
            if (event) {
                event.stopPropagation();
            }
            const dropdown = document.getElementById('pdfActionsDropdownMenu');
            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const actionsDropdown = document.querySelector('.pdf-actions-dropdown');
            const dropdown = document.getElementById('pdfActionsDropdownMenu');

            if (dropdown && actionsDropdown &&
                !actionsDropdown.contains(e.target)) {
                dropdown.classList.remove('show');
            }
        });

        // 1. Edit number/description
        function editPlanNumberDescription() {
            console.log('Edit number/description clicked');
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex !== -1 && plans && plans[planIndex]) {
                openPlanDetailsModal(planIndex);
                togglePDFActionsDropdown();
            } else {
                showNotification('Please open a plan first', 'error');
            }
        }

        // 3. Manage tags
        function managePDFTags() {
            console.log('Manage tags clicked');
            showNotification('ðŸ·ï¸ Manage tags feature coming soon', 'info');
            togglePDFActionsDropdown();
        }

        // 4. Set scale
        function setPDFScale() {
            console.log('Set scale clicked');
            showNotification('ðŸ“ Set scale feature coming soon', 'info');
            togglePDFActionsDropdown();
        }

        // 5. Compare
        function comparePDFVersions() {
            console.log('Compare clicked');
            showNotification('ðŸ” Compare feature coming soon', 'info');
            togglePDFActionsDropdown();
        }

        // 6. Export as PDF
        function exportAsPDF() {
            console.log('Export as PDF clicked');
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex !== -1 && plans && plans[planIndex]) {
                const plan = plans[planIndex];
                showNotification('ðŸ“„ Exporting PDF...', 'success');

                // Create download link
                const link = document.createElement('a');
                link.href = plan.preview;
                link.download = `${plan.name || 'document'}.pdf`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                setTimeout(() => {
                    showNotification('âœ… PDF exported successfully!', 'success');
                }, 500);
            } else {
                showNotification('Please open a plan first', 'error');
            }

            togglePDFActionsDropdown();
        }

        // 7. Export markup summary
        function exportMarkupSummary() {
            console.log('Export markup summary clicked');
            showNotification('ðŸ“‹ Export markup summary feature coming soon', 'info');
            togglePDFActionsDropdown();
        }

        // 8. Export QR code
        async function exportQRCode() {
            console.log('Export QR code clicked');

            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex === -1 || !plans || !plans[planIndex]) {
                showNotification('Please open a plan first', 'error');
                togglePDFActionsDropdown();
                return;
            }

            const plan = plans[planIndex];
            const projectName = '<%= projectName %>' || 'Project';

            // Close actions dropdown
            togglePDFActionsDropdown();

            // Generate QR code URL (you can customize this URL to your needs)
            const qrCodeURL = `${window.location.origin}/plan/${plan.id}`;

            // Show the QR modal
            openQRCodeModal(plan, projectName, qrCodeURL);
        }

        // Open QR Code Modal - FIXED VERSION
        function openQRCodeModal(plan, projectName, qrCodeURL) {
            const modal = document.getElementById('qrCodeModal');
            const container = document.getElementById('qrCodeContainer');

            if (!modal || !container) {
                console.error('QR modal elements not found');
                return;
            }

            // Clear previous QR code
            container.innerHTML = '';

            // Create a wrapper div for all content (for downloading)
            const downloadWrapper = document.createElement('div');
            downloadWrapper.id = 'qrDownloadWrapper';
            downloadWrapper.style.cssText = 'display: inline-block; background: white; padding: 24px; border-radius: 8px;';

            // Add project info above QR code
            const infoDiv = document.createElement('div');
            infoDiv.style.cssText = 'text-align: center; margin-bottom: 16px;';
            infoDiv.innerHTML = `
                <div style="font-size: 14px; font-weight: 600; color: #6b7280; margin-bottom: 4px;">
                    ${projectName}
                </div>
                <div style="font-size: 16px; font-weight: 700; color: #1f2937; margin-bottom: 8px;">
                    ${plan.name || plan.sheetNumber || 'Document'}
                </div>
            `;

            // Create QR code wrapper
            const qrWrapper = document.createElement('div');
            qrWrapper.id = 'qrCodeImage';
            qrWrapper.style.cssText = 'display: inline-block; padding: 16px; background: white; margin-bottom: 12px;';

            // Add Fieldwire-style branding
            const brandingDiv = document.createElement('div');
            brandingDiv.style.cssText = 'display: flex; align-items: center; justify-content: center; gap: 8px; margin-top: 12px;';
            brandingDiv.innerHTML = `
                <img src="/img/img.webp" alt="Logo" style="width: 24px; height: 24px;">
                <span style="font-size: 12px; font-weight: 600; color: #374151;">DESA Wire</span>
            `;

            // Assemble the download wrapper
            downloadWrapper.appendChild(infoDiv);
            downloadWrapper.appendChild(qrWrapper);
            downloadWrapper.appendChild(brandingDiv);
            container.appendChild(downloadWrapper);

            // Generate QR code using QRCode.js
            try {
                // Create QR code instance
                const qrcode = new QRCode(qrWrapper, {
                    text: qrCodeURL,
                    width: 256,
                    height: 256,
                    colorDark: "#000000",
                    colorLight: "#ffffff",
                    correctLevel: QRCode.CorrectLevel.H
                });

                console.log('âœ… QR code generated');

                // Show modal
                modal.classList.add('show');

                // CRITICAL: Wait for QR code to ACTUALLY render in DOM
                // We need to wait for the canvas/img element to be created
                setTimeout(() => {
                    const qrCanvas = qrWrapper.querySelector('canvas');
                    const qrImg = qrWrapper.querySelector('img');

                    if (qrCanvas || qrImg) {
                        console.log('âœ… QR code element found:', qrCanvas ? 'canvas' : 'img');
                        // Wait a bit more for rendering to complete
                        setTimeout(() => {
                            downloadQRCode();
                        }, 500);
                    } else {
                        console.error('âŒ QR code element not found');
                        showNotification('Error: QR code not rendered', 'error');
                    }
                }, 1000); // Wait 1 second for QR code to render

            } catch (error) {
                console.error('Error generating QR code:', error);
                showNotification('Error generating QR code', 'error');
            }
        }

        // Close QR Code Modal
        function closeQRCodeModal() {
            const modal = document.getElementById('qrCodeModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Download QR Code as Image - COMPLETE VERSION WITH ALL ELEMENTS
        function downloadQRCode() {
            const wrapper = document.getElementById('qrDownloadWrapper');
            if (!wrapper) {
                console.error('QR download wrapper not found');
                showNotification('Error: QR code not ready', 'error');
                return;
            }

            // Verify QR code is actually rendered
            const qrWrapper = document.getElementById('qrCodeImage');
            const qrCanvas = qrWrapper?.querySelector('canvas');
            const qrImg = qrWrapper?.querySelector('img');

            if (!qrCanvas && !qrImg) {
                console.error('âŒ QR code not rendered yet');
                showNotification('QR code still loading, please try again', 'error');
                return;
            }

            console.log('âœ… Starting download...');
            console.log('QR Code element found:', qrCanvas ? 'canvas' : 'img');

            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            const plan = plans[planIndex];
            const projectName = '<%= projectName %>' || 'Project';
            const fileName = `${projectName}-${plan.name || 'QR'}.png`;

            // Always use html2canvas to capture the entire wrapper with all elements
            console.log('âœ… Capturing complete QR wrapper with html2canvas');
            html2canvas(wrapper, {
                backgroundColor: '#ffffff', // Explicitly set white background
                scale: 4, // Higher scale for maximum clarity and quality
                logging: false,
                useCORS: true,
                allowTaint: true,
                imageTimeout: 5000,
                windowWidth: wrapper.scrollWidth,
                windowHeight: wrapper.scrollHeight,
                onclone: function(clonedDoc) {
                    // Ensure the cloned wrapper has proper styling
                    const clonedWrapper = clonedDoc.getElementById('qrDownloadWrapper');
                    if (clonedWrapper) {
                        clonedWrapper.style.backgroundColor = '#ffffff';
                        clonedWrapper.style.display = 'inline-block';
                        clonedWrapper.style.padding = '24px';
                        clonedWrapper.style.borderRadius = '8px';
                    }

                    // Ensure the QR canvas is visible
                    const clonedQrWrapper = clonedDoc.getElementById('qrCodeImage');
                    if (clonedQrWrapper) {
                        clonedQrWrapper.style.display = 'inline-block';
                        clonedQrWrapper.style.backgroundColor = 'transparent';
                    }

                    console.log('âœ… Cloned document styled with white background');
                }
            }).then(canvas => {
                console.log('âœ… Canvas created:', canvas.width, 'x', canvas.height);
                console.log('âœ… Canvas resolution: ' + (canvas.width * canvas.height) + ' pixels');

                // Convert canvas to blob with maximum quality
                canvas.toBlob(blob => {
                    if (!blob) {
                        console.error('Failed to create blob');
                        showNotification('Error downloading QR code', 'error');
                        return;
                    }

                    console.log('âœ… Blob created, size:', (blob.size / 1024).toFixed(2) + ' KB');

                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = fileName;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);

                    console.log('âœ… Download triggered - File: ' + fileName);
                    showNotification('âœ… QR code downloaded successfully!\n\nFile: ' + fileName, 'success');
                }, 'image/png', 1.0); // Maximum quality
            }).catch(error => {
                console.error('âŒ Error downloading QR code:', error);
                showNotification('Error downloading QR code: ' + error.message, 'error');
            });
        }

        // Close QR modal when clicking outside (on overlay)
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('qrCodeModal');
            const overlay = modal?.querySelector('.pdf-qr-code-overlay');
            const content = modal?.querySelector('.pdf-qr-code-content');

            if (modal && overlay && e.target === overlay && !content?.contains(e.target)) {
                closeQRCodeModal();
            }
        });

        // 9. Delete plan
        async function deletePDFPlan() {
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex === -1 || !plans || !plans[planIndex]) {
                showNotification('Please open a plan first', 'error');
                togglePDFActionsDropdown();
                return;
            }

            const plan = plans[planIndex];

            // Close dropdown first
            togglePDFActionsDropdown();

            if (confirm(`Are you sure you want to delete "${plan.name || 'this plan'}"?\n\nThis action cannot be undone.`)) {
                try {
                    const response = await fetch(`/api/plans/${plan.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();

                    if (result.success) {
                        showNotification('âœ… Plan deleted successfully', 'success');
                        plans.splice(planIndex, 1);
                        closePDFViewer();
                        updateView();
                    } else {
                        showNotification('âŒ Error deleting plan', 'error');
                    }
                } catch (error) {
                    console.error('Error deleting plan:', error);
                    showNotification('âŒ Error deleting plan', 'error');
                }
            }
        }

        // ===== VERSION CONTROL MODAL FUNCTIONS =====

        // Track editing state
        let editingVersionId = null;

        // Open version control modal
        function openVersionControlModal() {
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex === -1 || !plans || !plans[planIndex]) {
                showNotification('Please open a plan first', 'error');
                return;
            }

            const modal = document.getElementById('versionControlModal');
            if (modal) {
                modal.classList.add('show');
                loadVersionHistory(plans[planIndex].id);
            }

            // Close actions dropdown
            if (typeof togglePDFActionsDropdown === 'function') {
                togglePDFActionsDropdown();
            }
        }

        // Close version control modal
        function closeVersionControlModal() {
            const modal = document.getElementById('versionControlModal');
            if (modal) {
                modal.classList.remove('show');
            }
            editingVersionId = null;
        }

        // Load version history from database
        async function loadVersionHistory(planId) {
            try {
                const response = await fetch(`/api/plans/${planId}/versions`);
                const result = await response.json();

                if (result.success && result.versions) {
                    renderVersionList(result.versions);
                } else {
                    renderVersionList([]);
                }
            } catch (error) {
                console.error('Error loading versions:', error);
                renderVersionList([]);
            }
        }

        // Render version list with editable fields
        function renderVersionList(versions) {
            const versionList = document.getElementById('versionList');

            if (!versions || versions.length === 0) {
                versionList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #9ca3af;">
                        <p>No version history available</p>
                    </div>
                `;
                return;
            }

            versionList.innerHTML = versions.map((version, index) => {
                const isEditing = editingVersionId === version.id;
                const uploadDate = new Date(version.createdAt);
                const formattedDate = uploadDate.toLocaleDateString('en-US', { month: '2-digit', day: '2-digit', year: '2-digit' });
                const formattedTime = uploadDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });

                return `
                    <div class="version-item" id="version-item-${version.id}">
                        <div class="version-thumbnail">
                            <img src="${version.preview || '/img/pdf-placeholder.png'}" alt="Version thumbnail">
                        </div>
                        <div class="version-info">
                            <div class="version-name">${version.name || 'desa wire.pdf'}</div>
                            <div class="version-meta">
                                Uploaded by ${version.uploadedBy || 'Stephen Aniagyei'} on ${formattedDate} ${formattedTime}
                            </div>

                            ${isEditing ? `
                                <div class="version-field">
                                    <span class="version-field-label">Description:</span>
                                    <input type="text" class="version-field-input" id="desc-${version.id}"
                                           value="${version.description || ''}" placeholder="2025-11-07">
                                </div>
                                <div class="version-field">
                                    <span class="version-field-label">Notes:</span>
                                    <input type="text" class="version-field-input" id="notes-${version.id}"
                                           value="${version.notes || ''}" placeholder="--">
                                </div>
                            ` : `
                                <div class="version-field">
                                    <span class="version-field-label">Description:</span>
                                    <span class="version-field-value">${version.description || '--'}</span>
                                </div>
                                <div class="version-field">
                                    <span class="version-field-label">Notes:</span>
                                </div>
                                <div class="version-field-notes-value">
                                    <span class="version-field-value">${version.notes || '--'}</span>
                                </div>
                            `}
                        </div>

                        <div class="version-actions">
                            ${isEditing ? `
                                <button class="version-btn version-btn-save" onclick="saveVersionEdit('${version.id}')">
                                    <i class="fas fa-check"></i>
                                </button>
                                <button class="version-btn version-btn-cancel" onclick="cancelVersionEdit()">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : `
                                ${index === 0 ? `
                                    <button class="version-btn version-btn-delete" onclick="deleteVersion('${version.id}')">
                                        Delete
                                    </button>
                                ` : ''}
                                <button class="version-btn version-btn-edit" onclick="editVersion('${version.id}')">
                                    Edit
                                </button>
                            `}
                            <button class="version-expand-btn" onclick="toggleVersionExpand('${version.id}')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Edit version
        function editVersion(versionId) {
            editingVersionId = versionId;
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            if (planIndex !== -1 && plans && plans[planIndex]) {
                loadVersionHistory(plans[planIndex].id);
            }
        }

        // Cancel version edit
        function cancelVersionEdit() {
            editingVersionId = null;
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            if (planIndex !== -1 && plans && plans[planIndex]) {
                loadVersionHistory(plans[planIndex].id);
            }
        }

        // Save version edit
        async function saveVersionEdit(versionId) {
            const descInput = document.getElementById(`desc-${versionId}`);
            const notesInput = document.getElementById(`notes-${versionId}`);

            if (!descInput || !notesInput) return;

            const description = descInput.value.trim();
            const notes = notesInput.value.trim();

            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            if (planIndex === -1 || !plans || !plans[planIndex]) {
                showNotification('Please open a plan first', 'error');
                return;
            }

            const planId = plans[planIndex].id;

            try {
                const response = await fetch(`/api/plans/${planId}/versions/${versionId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: description,
                        notes: notes
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('âœ… Version updated successfully', 'success');
                    editingVersionId = null;
                    loadVersionHistory(planId);
                } else {
                    showNotification('Error updating version', 'error');
                }
            } catch (error) {
                console.error('Error saving version:', error);
                showNotification('Error updating version', 'error');
            }
        }

        // Delete version
        async function deleteVersion(versionId) {
            if (!confirm('Are you sure you want to delete this version?')) {
                return;
            }

            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            if (planIndex === -1 || !plans || !plans[planIndex]) {
                showNotification('Please open a plan first', 'error');
                return;
            }

            const planId = plans[planIndex].id;

            try {
                const response = await fetch(`/api/plans/${planId}/versions/${versionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('âœ… Version deleted successfully', 'success');
                    loadVersionHistory(planId);
                } else {
                    showNotification('Error deleting version', 'error');
                }
            } catch (error) {
                console.error('Error deleting version:', error);
                showNotification('Error deleting version', 'error');
            }
        }

        // Toggle version expand/collapse (placeholder for future feature)
        function toggleVersionExpand(versionId) {
            console.log('Toggle expand for version:', versionId);
            // Future feature: expand to show more details
        }

        // Create new version
        async function createNewVersion() {
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;

            if (planIndex === -1 || !plans || !plans[planIndex]) {
                showNotification('Please open a plan first', 'error');
                return;
            }

            const plan = plans[planIndex];
            const today = new Date().toISOString().split('T')[0];

            try {
                const response = await fetch(`/api/plans/${plan.id}/versions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        description: today,
                        notes: '--'
                    })
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('âœ… New version created', 'success');
                    loadVersionHistory(plan.id);
                } else {
                    showNotification('Error creating version', 'error');
                }
            } catch (error) {
                console.error('Error creating version:', error);
                showNotification('Error creating version', 'error');
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const versionModal = document.getElementById('versionControlModal');
            const versionContent = document.querySelector('.version-control-content');

            if (versionModal && e.target === versionModal && !versionContent.contains(e.target)) {
                closeVersionControlModal();
            }
        });

        // ===== RECENT ACTIVITY MODAL FUNCTIONS =====
        let currentActivityFilter = 'all';

        // Generate PDF thumbnail from base64 data
        async function generatePDFThumbnail(base64Data, containerId) {
            try {
                console.log('ðŸ”„ Generating PDF thumbnail for:', containerId);

                // Decode base64
                const binaryString = atob(base64Data);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }

                // Load PDF
                const pdf = await pdfjsLib.getDocument({ data: bytes }).promise;
                const page = await pdf.getPage(1);

                // Get canvas
                const canvas = document.getElementById(containerId);
                if (!canvas) {
                    console.error('âŒ Canvas not found:', containerId);
                    return;
                }

                const context = canvas.getContext('2d');

                // Calculate scale to fit canvas (200x280)
                const viewport = page.getViewport({ scale: 1 });
                const scaleX = 200 / viewport.width;
                const scaleY = 280 / viewport.height;
                const scale = Math.min(scaleX, scaleY) * 0.9; // 90% to add padding

                const scaledViewport = page.getViewport({ scale: scale });

                canvas.width = 200;
                canvas.height = 280;

                // Clear canvas
                context.fillStyle = '#ffffff';
                context.fillRect(0, 0, canvas.width, canvas.height);

                // Center the PDF on canvas
                const offsetX = (canvas.width - scaledViewport.width) / 2;
                const offsetY = (canvas.height - scaledViewport.height) / 2;

                // Render PDF
                await page.render({
                    canvasContext: context,
                    viewport: scaledViewport,
                    transform: [1, 0, 0, 1, offsetX, offsetY]
                }).promise;

                console.log('âœ… PDF thumbnail generated successfully');
            } catch (error) {
                console.error('âŒ Error generating PDF thumbnail:', error);

                // Show error icon
                const container = document.getElementById(containerId);
                if (container && container.parentElement) {
                    container.parentElement.innerHTML = `
                        <div style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 8px; background: #fef2f2; color: #dc2626;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 32px;"></i>
                            <span style="font-size: 12px;">Failed to load</span>
                        </div>
                    `;
                }
            }
        }

        // Open recent activity modal
        function openRecentActivityModal() {
            const modal = document.getElementById('recentActivityModal');
            if (modal) {
                modal.classList.add('show');
                loadRecentActivity();
            }
        }

        // Close recent activity modal
        function closeRecentActivityModal() {
            const modal = document.getElementById('recentActivityModal');
            if (modal) {
                modal.classList.remove('show');
            }
        }

        // Filter activity
        function filterActivity(filter) {
            currentActivityFilter = filter;

            // Update active button
            const filterButtons = document.querySelectorAll('.activity-filter-btn');
            filterButtons.forEach(btn => btn.classList.remove('active'));
            event.target.closest('.activity-filter-btn').classList.add('active');

            // Reload activity
            loadRecentActivity();
        }

        // Load recent activity from plans data
        // Enhanced load recent activity with statistics
        async function loadRecentActivity() {
            const activityBody = document.getElementById('recentActivityBody');
            if (!activityBody) return;

            activityBody.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #667eea;"></i>
                    <p style="margin-top: 16px; color: #6b7280;">Loading activity...</p>
                </div>
            `;

            try {
                const projectId = getCurrentProjectId();
                if (!projectId) {
                    showEmptyActivityState('No project selected');
                    return;
                }

                const response = await fetch(`/api/plans?projectId=${projectId}`);
                const result = await response.json();

                if (result.success && result.plans && result.plans.length > 0) {
                    const activities = result.plans.map(plan => ({
                        id: plan.id,
                        username: plan.uploadedBy || 'Unknown User',
                        action: 'uploaded',
                        fileName: plan.name || plan.sheetNumber || 'Untitled',
                        folderName: plan.folder || 'All Plans',
                        timestamp: plan.createdAt,
                        preview: plan.preview,
                        type: plan.type
                    }));

                    console.log('ðŸ“Š Loaded activities:', activities);
                    updateFilterCounts(activities);
                    updateStatistics(activities);
                    const filteredActivities = filterActivitiesByTime(activities);
                    renderActivities(filteredActivities);
                } else {
                    showEmptyActivityState('No uploads yet');
                    updateFilterCounts([]);
                    updateStatistics([]);
                }
            } catch (error) {
                console.error('Error loading activity:', error);
                showEmptyActivityState('Error loading activity');
            }
        }

        // Update filter counts
        function updateFilterCounts(activities) {
            const now = new Date();

            document.getElementById('filterCountAll').textContent = activities.length;

            const todayCount = activities.filter(a => {
                const diff = (now - new Date(a.timestamp)) / (1000 * 60 * 60 * 24);
                return diff < 1;
            }).length;
            document.getElementById('filterCountToday').textContent = todayCount;

            const weekCount = activities.filter(a => {
                const diff = (now - new Date(a.timestamp)) / (1000 * 60 * 60 * 24);
                return diff < 7;
            }).length;
            document.getElementById('filterCountWeek').textContent = weekCount;

            const monthCount = activities.filter(a => {
                const diff = (now - new Date(a.timestamp)) / (1000 * 60 * 60 * 24);
                return diff < 30;
            }).length;
            document.getElementById('filterCountMonth').textContent = monthCount;
        }

        // Update statistics
        function updateStatistics(activities) {
            document.getElementById('totalUploads').textContent = activities.length;

            const uniqueUsers = [...new Set(activities.map(a => a.username))].length;
            document.getElementById('activeUsers').textContent = uniqueUsers;

            const uniqueFolders = [...new Set(activities.map(a => a.folderName))].length;
            document.getElementById('foldersUsed').textContent = uniqueFolders;
        }

        // Filter activities by time period
        function filterActivitiesByTime(activities) {
            const now = new Date();

            if (currentActivityFilter === 'all') {
                return activities;
            }

            return activities.filter(activity => {
                const activityDate = new Date(activity.timestamp);
                const diffInMs = now - activityDate;
                const diffInDays = diffInMs / (1000 * 60 * 60 * 24);

                if (currentActivityFilter === 'today') {
                    return diffInDays < 1;
                } else if (currentActivityFilter === 'week') {
                    return diffInDays < 7;
                } else if (currentActivityFilter === 'month') {
                    return diffInDays < 30;
                }

                return true;
            });
        }

        // Render activities grouped by date
        function renderActivities(activities) {
            const activityBody = document.getElementById('recentActivityBody');

            if (activities.length === 0) {
                showEmptyActivityState('No activity found for this period');
                return;
            }

            // Group activities by date
            const groupedActivities = groupActivitiesByDate(activities);

            let html = '';
            const pdfActivities = []; // Collect PDF activities to process after rendering

            for (const [dateLabel, items] of Object.entries(groupedActivities)) {
                html += `
                    <div class="activity-date-group">
                        <div class="activity-date-header">${dateLabel}</div>
                `;

                items.forEach(activity => {
                    const userInitial = activity.username.charAt(0).toUpperCase();
                    const timeStr = formatTime(activity.timestamp);
                    const dateStr = formatDate(activity.timestamp);
                    const relativeTime = getRelativeTime(activity.timestamp);

                    html += `
                        <div class="activity-item">
                            <div class="activity-user-avatar">${userInitial}</div>

                            <div class="activity-details">
                                <div class="activity-user-name">${activity.username}</div>
                                <div class="activity-action">
                                    ${activity.action} <strong>${activity.fileName}</strong>
                                </div>

                                <div class="activity-meta">
                                    <div class="activity-meta-item">
                                        <i class="fas fa-clock"></i>
                                        ${timeStr} â€¢ ${dateStr}
                                    </div>
                                    <div class="activity-folder-badge">
                                        <i class="fas fa-folder"></i>
                                        ${activity.folderName}
                                    </div>
                                </div>
                            </div>

                            <div class="activity-thumbnail">
                                ${activity.preview ?
                                    (activity.type && activity.type.includes('pdf') ?
                                        `<canvas id="pdf-thumb-${activity.id}" style="width: 100%; height: 100%; display: block;"></canvas>` :
                                        `<img src="${activity.preview}" alt="Preview" style="width: 100%; height: 100%; object-fit: cover; max-width: 100%;">`) :
                                    `<i class="fas fa-file"></i>`
                                }
                            </div>

                            <div class="activity-time-badge">${relativeTime}</div>
                        </div>
                    `;

                    // Collect PDF activities for processing
                    if (activity.preview && activity.type && activity.type.includes('pdf')) {
                        pdfActivities.push(activity);
                    }
                });

                html += `</div>`;
            }

            activityBody.innerHTML = html;

            // Generate PDF thumbnails after rendering
            pdfActivities.forEach((activity, index) => {
                // Stagger the PDF loading to avoid overwhelming the browser
                setTimeout(async () => {
                    try {
                        console.log(`ðŸ”„ [${index + 1}/${pdfActivities.length}] Fetching PDF preview from: ${activity.preview}`);
                        // Fetch the PDF data from the preview endpoint
                        const response = await fetch(activity.preview);
                        if (!response.ok) {
                            console.error(`âŒ Failed to fetch preview: ${response.status} ${response.statusText}`);
                            return;
                        }
                        const arrayBuffer = await response.arrayBuffer();
                        console.log(`âœ… Received PDF data: ${arrayBuffer.byteLength} bytes for ${activity.id}`);

                        // Convert ArrayBuffer to base64 in chunks to avoid call stack size exceeded
                        const bytes = new Uint8Array(arrayBuffer);
                        let binary = '';
                        const chunkSize = 65536; // 64KB chunks
                        for (let i = 0; i < bytes.length; i += chunkSize) {
                            const chunk = bytes.subarray(i, i + chunkSize);
                            binary += String.fromCharCode.apply(null, chunk);
                        }
                        const base64Data = btoa(binary);
                        console.log(`âœ… Converted to base64: ${base64Data.length} chars`);

                        // Pass just the base64 data (without the data: prefix)
                        generatePDFThumbnail(base64Data, `pdf-thumb-${activity.id}`);
                    } catch (error) {
                        console.error(`Error loading PDF preview for ${activity.id}:`, error);
                    }
                }, 100 + (index * 200)); // Stagger requests by 200ms each
            });
        }

        // Group activities by date
        function groupActivitiesByDate(activities) {
            const groups = {};

            // Get today's date normalized to midnight (local timezone)
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // Get yesterday's date normalized to midnight (local timezone)
            const yesterday = new Date(today);
            yesterday.setDate(yesterday.getDate() - 1);

            activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

            activities.forEach(activity => {
                const activityDate = new Date(activity.timestamp);
                // Normalize activity date to midnight for accurate day comparison
                const normalizedActivityDate = new Date(activityDate);
                normalizedActivityDate.setHours(0, 0, 0, 0);

                // Calculate days difference using normalized dates
                const diffInDays = Math.floor((today - normalizedActivityDate) / (1000 * 60 * 60 * 24));

                let label;
                if (diffInDays === 0) {
                    label = 'Today';
                } else if (diffInDays === 1) {
                    label = 'Yesterday';
                } else if (diffInDays < 7) {
                    label = `${diffInDays} days ago`;
                } else {
                    label = activityDate.toLocaleDateString('en-US', {
                        month: 'long',
                        day: 'numeric',
                        year: 'numeric'
                    });
                }

                if (!groups[label]) {
                    groups[label] = [];
                }
                groups[label].push(activity);
            });

            return groups;
        }

        // Show empty state
        function showEmptyActivityState(message) {
            const activityBody = document.getElementById('recentActivityBody');
            activityBody.innerHTML = `
                <div class="activity-empty-state">
                    <div class="activity-empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <div class="activity-empty-title">${message}</div>
                    <div class="activity-empty-description">
                        Upload activity will appear here once files are added
                    </div>
                </div>
            `;
        }

        // Format time (HH:MM AM/PM)
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: true
            });
        }

        // Format date (MMM DD, YYYY)
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric',
                year: 'numeric'
            });
        }

        // Get relative time (e.g., "2 hours ago")
        function getRelativeTime(timestamp) {
            const now = new Date();
            const past = new Date(timestamp);
            const diffInSeconds = Math.floor((now - past) / 1000);

            if (diffInSeconds < 60) {
                return 'Just now';
            } else if (diffInSeconds < 3600) {
                const minutes = Math.floor(diffInSeconds / 60);
                return `${minutes}m ago`;
            } else if (diffInSeconds < 86400) {
                const hours = Math.floor(diffInSeconds / 3600);
                return `${hours}h ago`;
            } else if (diffInSeconds < 604800) {
                const days = Math.floor(diffInSeconds / 86400);
                return `${days}d ago`;
            } else {
                return formatDate(timestamp);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('recentActivityModal');
            const content = document.querySelector('.recent-activity-content');

            if (modal && e.target === modal && !content.contains(e.target)) {
                closeRecentActivityModal();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('recentActivityModal');
                if (modal && modal.classList.contains('show')) {
                    closeRecentActivityModal();
                }
            }
        });
    </script>

    <!-- PDF VIEWER MODAL -->
    <div class="pdf-viewer-modal" id="pdfViewerModal">
        <!-- Secondary Header Bar (Inside Modal) -->
        <div class="pdf-viewer-secondary-header">
            <div class="pdf-secondary-left">
                <button class="pdf-back-btn" onclick="closePDFViewer()">
                    <i class="fas fa-arrow-left"></i>
                    <span>All plans</span>
                </button>
                <button class="pdf-hamburger-btn" id="pdfHeaderHamburgerBtn" title="Toggle Sidebar" onclick="document.getElementById('sidebarToggleBtn').click()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="pdf-secondary-center">
                    <div class="pdf-actions-dropdown">
                        <button class="pdf-action-btn" id="pdfActionsBtn" onclick="togglePDFActionsDropdown(event)">
                            <span>Actions</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>

                        <!-- Actions Dropdown Menu -->
                        <div class="pdf-actions-dropdown-menu" id="pdfActionsDropdownMenu">
                            <button class="pdf-actions-item" onclick="editPlanNumberDescription()">
                                Edit number/description
                            </button>

                            <div class="pdf-actions-item-with-submenu">
                                <button class="pdf-actions-item" onmouseenter="showRotateSubmenu()" onmouseleave="hideRotateSubmenu()">
                                    Rotate sheet
                                    <i class="fas fa-chevron-right" style="margin-left: auto; font-size: 11px;"></i>
                                </button>
                                <!-- Rotation Submenu -->
                                <div class="pdf-rotate-submenu" id="rotateSubmenu" onmouseenter="showRotateSubmenu()" onmouseleave="hideRotateSubmenu()">
                                    <button class="pdf-rotate-option" onclick="rotatePDFSheet(-90)">
                                        -90Â°
                                    </button>
                                    <button class="pdf-rotate-option" onclick="rotatePDFSheet(180)">
                                        180Â°
                                    </button>
                                    <button class="pdf-rotate-option" onclick="rotatePDFSheet(90)">
                                        90Â°
                                    </button>
                                </div>
                            </div>

                            <button class="pdf-actions-item" onclick="managePDFTags()">
                                Manage tags
                            </button>

                            <button class="pdf-actions-item" onclick="setPDFScale()">
                                Set scale
                            </button>

                            <button class="pdf-actions-item" onclick="comparePDFVersions()">
                                Compare
                            </button>

                            <div class="pdf-actions-divider"></div>

                            <button class="pdf-actions-item" onclick="exportAsPDF()">
                                Export as PDF
                            </button>

                            <button class="pdf-actions-item" onclick="exportMarkupSummary()">
                                Export markup summary
                            </button>

                            <button class="pdf-actions-item" onclick="exportQRCode()">
                                Export QR code
                            </button>

                            <div class="pdf-actions-divider"></div>

                            <button class="pdf-actions-item danger" onclick="deletePDFPlan()">
                                Delete plan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="pdf-filter-btn">
                    <i class="fas fa-filter"></i>
                    Filter tasks
                </button>
                <button class="pdf-version-btn" onclick="openVersionControlModal()">Version control</button>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="pdf-viewer-main-wrapper">
            <!-- Center Content Area -->
            <div class="pdf-center-content">
                <!-- Document Display Area -->
                <div class="pdf-document-area">
                    <!-- Left Sidebar with Tools - Inside PDF Area -->
                    <div class="pdf-left-sidebar">
                        <!-- Fullscreen -->
                        <button class="pdf-tool-btn" data-tool="fullscreen" title="Fullscreen">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"/></svg>
                        </button>

                        <!-- Zoom In -->
                        <button class="pdf-tool-btn" id="pdfZoomInBtn" title="Zoom In (+)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>

                        <!-- Zoom Out -->
                        <button class="pdf-tool-btn" id="pdfZoomOutBtn" title="Zoom Out (-)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>

                        <!-- Add Task -->
                        <button class="pdf-tool-btn" data-tool="addtask" title="Add task (â‡§+T)" onclick="initAddTaskMode()">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
                        </button>

                        <!-- Link -->
                        <button class="pdf-tool-btn" data-tool="link" title="Link">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/></svg>
                        </button>

                        <!-- Draw -->
                        <button class="pdf-tool-btn" data-tool="draw" title="Draw">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                        </button>

                        <!-- Duplicate -->
                        <button class="pdf-tool-btn" data-tool="duplicate" title="Duplicate">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                        </button>

                        <!-- Shape -->
                        <button class="pdf-tool-btn" data-tool="shape" title="Shape">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/></svg>
                        </button>

                        <!-- Text -->
                        <button class="pdf-tool-btn" data-tool="text" title="Text">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 7 4 4 20 4 20 7"/><line x1="9" y1="20" x2="15" y2="20"/><line x1="12" y1="4" x2="12" y2="20"/></svg>
                        </button>

                        <!-- Tag -->
                        <button class="pdf-tool-btn" data-tool="tag" title="Tag">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg>
                        </button>

                        <!-- Divider -->
                        <div class="pdf-tool-separator"></div>

                        <!-- Record Button -->
                        <button class="pdf-tool-btn record" id="pdfRecordBtn" title="Record">
                            <div class="record-icon"></div>
                        </button>

                        <!-- Cursor -->
                        <button class="pdf-tool-btn" data-tool="cursor" title="Cursor">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="m13 13 6 6"/></svg>
                        </button>

                        <!-- Undo Button -->
                        <button class="pdf-tool-btn" id="pdfUndoBtn" title="Undo">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/></svg>
                        </button>

                        <!-- Navigation Arrows -->
                        <div class="nav-arrows-container">
                            <button class="nav-btn" id="prevBtn" title="Previous Page">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
                            </button>
                            <button class="nav-btn" id="nextBtn" title="Next Page">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
                            </button>
                        </div>
                    </div>

                    <!-- Top Right Controls (Search and Eye) - Over PDF -->
                    <div class="pdf-top-right-controls">
                        <button class="pdf-control-icon" title="Search" onclick="togglePDFSearch()">
                            <i class="fas fa-search"></i>
                        </button>
                        <button class="pdf-control-icon" title="View Options" onclick="toggleEyeDropdown()" id="eyeDropdownBtn">
                            <i class="fas fa-eye"></i>
                        </button>

                        <!-- Eye Dropdown Menu -->
                        <div class="eye-dropdown-menu" id="eyeDropdownMenu">
                            <div class="eye-dropdown-header">Show</div>

                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label">
                                    <input type="checkbox" checked> All layers
                                </label>
                            </div>

                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label">
                                    <input type="checkbox" checked> Tasks
                                </label>
                                <div style="padding-left: 26px;">
                                    <label class="eye-dropdown-label">
                                        <input type="checkbox" checked> Filtered tasks
                                    </label>
                                    <label class="eye-dropdown-label">
                                        <input type="checkbox" checked> Other tasks
                                    </label>
                                </div>
                            </div>

                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label">
                                    <input type="checkbox" checked> Markups
                                </label>
                                <div class="eye-dropdown-colors">
                                    <div class="eye-color-circle selected" style="background: #dc2626;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #2563eb;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #f59e0b;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #16a34a;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #d946ef;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #06b6d4;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #eab308;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #22c55e;"><i class="fas fa-check"></i></div>
                                    <div class="eye-color-circle selected" style="background: #fff; border: 1px solid #e5e7eb;"><i class="fas fa-check" style="color: #000;"></i></div>
                                    <div class="eye-color-circle selected" style="background: #000;"><i class="fas fa-check"></i></div>
                                </div>
                                <label class="eye-dropdown-label" style="margin-top: 8px;">
                                    <input type="checkbox" checked> <span style="color: #9333ea;">â— Private</span>
                                </label>
                            </div>

                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> Attachments</label>
                            </div>
                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> Plan links</label>
                            </div>
                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> Form Links</label>
                            </div>
                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> Photos</label>
                            </div>
                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> RFIs</label>
                            </div>
                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> Specifications</label>
                            </div>
                            <div class="eye-dropdown-section">
                                <label class="eye-dropdown-label"><input type="checkbox" checked> Submittals</label>
                            </div>
                        </div>
                    </div>

                    <div id="pdfDocumentContent">
                        <!-- Document content loads here -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Tasks Panel -->
            <div class="pdf-tasks-sidebar">
                <div class="pdf-tasks-header">
                    <h3 class="pdf-tasks-title">Tasks</h3>
                    <div class="pdf-tasks-header-actions">
                        <button class="pdf-tasks-close-btn" onclick="toggleTasksPanel()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="pdf-tasks-content">
                    <button class="pdf-tasks-new-text-btn" onclick="openTaskCreationModal()">
                        <i class="fas fa-plus"></i>
                        <span>New task</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Panels -->
        <div class="pdf-bottom-panel">
            <div class="pdf-panel-title">Date Compare</div>
            <div class="pdf-date-display">2025-10-17</div>
            <button class="pdf-compare-btn">Compare</button>
        </div>

        <!-- Date Selector -->
        <div class="pdf-date-selector">
            <input type="date" value="2025-10-17">
        </div>

        <!-- Edit Bar -->
        <!-- Bottom Name Bar -->
        <div class="pdf-bottom-name-bar">
            <div class="pdf-name-display">
                <i class="fas fa-pen"></i>
                <span>Document.pdf</span>
            </div>
        </div>

        <!-- QR Code Export Modal - Inside PDF Viewer -->
        <div id="qrCodeModal" class="pdf-qr-code-modal">
            <div class="pdf-qr-code-overlay"></div>
            <div class="pdf-qr-code-content">
                <div class="pdf-qr-code-header">
                    <h2 class="pdf-qr-code-title">Plan QR Code</h2>
                    <button class="pdf-qr-code-close" onclick="closeQRCodeModal()">Ã—</button>
                </div>
                <div class="pdf-qr-code-body">
                    <!-- Success Icon -->
                    <div style="width: 80px; height: 80px; margin: 0 auto 24px; background: #e0f2fe; border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-check" style="font-size: 40px; color: #0284c7;"></i>
                    </div>

                    <!-- Success Message -->
                    <h3 style="font-size: 18px; font-weight: 600; color: #1f2937; margin-bottom: 8px;">
                        Your QR code has been generated!
                    </h3>
                    <p style="font-size: 14px; color: #6b7280; margin-bottom: 32px;">
                        Click below if it hasn't started downloading yet.
                    </p>

                    <!-- QR Code Container -->
                    <div id="qrCodeContainer" style="display: inline-block; padding: 24px; background: white; border: 1px solid #e5e7eb; border-radius: 8px; margin-bottom: 24px;">
                        <!-- QR code will be generated here -->
                    </div>

                    <!-- Download Button -->
                    <button class="btn-primary" onclick="downloadQRCode()" style="width: 100%; max-width: 300px; margin: 0 auto; justify-content: center;">
                        <i class="fas fa-download"></i>
                        <span>Download</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Plan Details Modal -->
    <div id="planDetailsModal" class="plan-details-modal">
        <div class="plan-details-content">
            <div class="plan-details-header">
                <h2 class="plan-details-title">Plan Details</h2>
                <button class="plan-details-close" onclick="closePlanDetailsModal()">Ã—</button>
            </div>
            <div class="plan-details-body">
                <div class="plan-details-field">
                    <label class="plan-details-label">Sheet #</label>
                    <input type="text" class="plan-details-input" id="planSheetNumber" placeholder="e.g., desa wire1">
                </div>
                <div class="plan-details-field">
                    <label class="plan-details-label">Description</label>
                    <input type="text" class="plan-details-input" id="planDescription" placeholder="e.g., Second Floor">
                </div>
                <button class="plan-details-save-btn" onclick="savePlanDetails()">Save changes</button>
            </div>
        </div>
    </div>

    <!-- Sheet Version Control Modal -->
    <div id="versionControlModal" class="version-control-modal">
        <div class="version-control-content">
            <div class="version-control-header">
                <h2 class="version-control-title">Sheet Version Control</h2>
                <button class="version-control-close" onclick="closeVersionControlModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="version-control-body">
                <button class="version-new-btn" onclick="createNewVersion()">
                    <i class="fas fa-plus"></i>
                    New version
                </button>
                <div class="version-list" id="versionList">
                    <!-- Versions will be loaded here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity Modal - ENTERPRISE ULTIMATE EDITION -->
    <div id="recentActivityModal" class="recent-activity-modal">
        <div class="recent-activity-content">
            <!-- Modern Professional Header with Gradient -->
            <div class="recent-activity-header">
                <div class="header-content">
                    <div class="header-icon-wrapper">
                        <i class="fas fa-history"></i>
                    </div>
                    <div class="header-text">
                        <h2 class="recent-activity-title">Upload Activity Timeline</h2>
                        <p class="header-subtitle">Real-time document tracking and monitoring</p>
                    </div>
                </div>
                <button class="recent-activity-close" onclick="closeRecentActivityModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Advanced Filter Bar -->
            <div class="recent-activity-filters">
                <div class="filter-section">
                    <div class="filter-label">Time Period</div>
                    <div class="filter-buttons">
                        <button class="activity-filter-btn active" onclick="filterActivity('all')">
                            <i class="fas fa-globe"></i>
                            <span>All Time</span>
                            <span class="filter-count" id="filterCountAll">0</span>
                        </button>
                        <button class="activity-filter-btn" onclick="filterActivity('today')">
                            <i class="fas fa-sun"></i>
                            <span>Today</span>
                            <span class="filter-count" id="filterCountToday">0</span>
                        </button>
                        <button class="activity-filter-btn" onclick="filterActivity('week')">
                            <i class="fas fa-calendar-week"></i>
                            <span>This Week</span>
                            <span class="filter-count" id="filterCountWeek">0</span>
                        </button>
                        <button class="activity-filter-btn" onclick="filterActivity('month')">
                            <i class="fas fa-calendar-alt"></i>
                            <span>This Month</span>
                            <span class="filter-count" id="filterCountMonth">0</span>
                        </button>
                    </div>
                </div>

                <!-- Search and Sort Controls -->
                <div class="filter-controls">
                    <div class="search-wrapper">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search activity..." class="activity-search" id="activitySearch">
                    </div>
                    <select class="sort-dropdown">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="name">By Name</option>
                    </select>
                </div>
            </div>

            <!-- Activity Timeline Body -->
            <div class="recent-activity-body" id="recentActivityBody">
                <!-- Activity items will be loaded here -->
            </div>

            <!-- Statistics Footer -->
            <div class="activity-footer">
                <div class="footer-stats">
                    <div class="stat-item">
                        <i class="fas fa-upload"></i>
                        <span id="totalUploads">0</span>
                        <span class="stat-label">Total Uploads</span>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <i class="fas fa-user"></i>
                        <span id="activeUsers">0</span>
                        <span class="stat-label">Active Users</span>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <i class="fas fa-folder"></i>
                        <span id="foldersUsed">0</span>
                        <span class="stat-label">Folders</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Zoom Control System with Centered Zoom + Drag to Pan -->
    <script>
        // Track zoom levels per plan (use global if already defined, otherwise create it)
        if (!window.planZoomLevels) window.planZoomLevels = {};
        // Note: ZOOM_MIN, ZOOM_MAX, ZOOM_INCREMENT are declared in the main script tag
        // Reference globals directly - do NOT redeclare to avoid "already declared" error
        const planZoomLevels = window.planZoomLevels;

        // Drag-to-pan state
        let isPanning = false;
        let startX = 0;
        let startY = 0;
        let scrollLeft = 0;
        let scrollTop = 0;

        // Note: zoomInPDF, zoomOutPDF, applyZoomToPDF, and resetPDFZoom are defined in the main script tag
        // They are referenced here via window.planZoomLevels global variable

        // ðŸ–ï¸ DRAG TO PAN FUNCTIONALITY - FIXED VERSION
        function initializePDFDragToPan() {
            const documentArea = document.querySelector('.pdf-document-area');

            if (!documentArea) {
                console.log('âŒ PDF document area not found');
                return;
            }

            console.log('âœ… Initializing drag-to-pan');

            // Remove old listeners to prevent duplicates
            documentArea.onmousedown = null;
            documentArea.onmousemove = null;
            documentArea.onmouseup = null;
            documentArea.onmouseleave = null;

            // Mouse down - start dragging
            documentArea.addEventListener('mousedown', function(e) {
                const plan = plans[currentPlanIndex];
                if (!plan) return;

                const currentZoom = planZoomLevels[plan.id] || window.ZOOM_MIN;

                // Only allow panning if zoomed in
                if (currentZoom > window.ZOOM_MIN) {
                    isPanning = true;
                    startX = e.pageX;
                    startY = e.pageY;
                    scrollLeft = documentArea.scrollLeft;
                    scrollTop = documentArea.scrollTop;

                    documentArea.classList.add('grabbing');
                    e.preventDefault();
                    console.log('ðŸ–ï¸ Started panning');
                }
            });

            // Mouse move - pan the PDF
            documentArea.addEventListener('mousemove', function(e) {
                if (!isPanning) return;

                e.preventDefault();
                const dx = e.pageX - startX;
                const dy = e.pageY - startY;

                documentArea.scrollLeft = scrollLeft - dx;
                documentArea.scrollTop = scrollTop - dy;
            });

            // Mouse up - stop dragging
            documentArea.addEventListener('mouseup', function() {
                if (isPanning) {
                    isPanning = false;
                    documentArea.classList.remove('grabbing');
                    updateCursor();
                    console.log('ðŸ–ï¸ Stopped panning');
                }
            });

            // Mouse leave - stop dragging
            documentArea.addEventListener('mouseleave', function() {
                if (isPanning) {
                    isPanning = false;
                    documentArea.classList.remove('grabbing');
                    updateCursor();
                }
            });

            // Update cursor based on zoom level
            function updateCursor() {
                const plan = plans[currentPlanIndex];
                if (!plan) return;

                const currentZoom = planZoomLevels[plan.id] || window.ZOOM_MIN;
                documentArea.style.cursor = currentZoom > window.ZOOM_MIN ? 'grab' : 'default';
            }

            // Initial cursor update
            updateCursor();
        }

        // Initialize drag-to-pan when PDF viewer opens
        // Note: pdfViewerModal is already defined in the first script tag
        // Reference it directly to avoid redeclaration error
        const pdfViewerModalForDragPan = document.getElementById('pdfViewerModal');
        if (pdfViewerModalForDragPan) {
            const observer = new MutationObserver(() => {
                if (pdfViewerModalForDragPan.classList.contains('show')) {
                    setTimeout(initializePDFDragToPan, 500);
                }
            });
            observer.observe(pdfViewerModalForDragPan, { attributes: true });
        }

        // Keyboard shortcuts for zoom
        document.addEventListener('keydown', function(e) {
            const pdfModal = document.getElementById('pdfViewerModal');
            if (!pdfModal || !pdfModal.classList.contains('show')) return;

            if ((e.ctrlKey || e.metaKey) && (e.key === '+' || e.key === '=')) {
                e.preventDefault();
                zoomInPDF();
            } else if ((e.ctrlKey || e.metaKey) && e.key === '-') {
                e.preventDefault();
                zoomOutPDF();
            } else if ((e.ctrlKey || e.metaKey) && e.key === '0') {
                e.preventDefault();
                const plan = plans[currentPlanIndex];
                if (plan) resetPDFZoom(plan.id);
            }
        });

        // ===== TASK CREATION MODAL FUNCTIONS =====
        // Note: openTaskCreationModal and closeTaskCreationModal are defined in the main script tag

        // Update the existing "+ New task" button click handler
        document.addEventListener('DOMContentLoaded', function() {
            // Find and update the "+ New task" button in tasks panel
            const tasksAddBtn = document.querySelector('.pdf-tasks-add-btn');
            if (tasksAddBtn) {
                tasksAddBtn.onclick = openTaskCreationModal;
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const taskModal = document.getElementById('taskCreationModal');
            const taskContent = document.querySelector('.task-creation-content');

            if (taskModal && e.target === taskModal && !taskContent.contains(e.target)) {
                closeTaskCreationModal();
            }
        });

        // Close modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const taskModal = document.getElementById('taskCreationModal');
                if (taskModal && taskModal.classList.contains('show')) {
                    closeTaskCreationModal();
                }
            }
        });
    </script>

    <!-- Task Creation Modal - FIXED VERSION -->
    <div id="taskCreationModal" class="task-creation-modal">
        <!-- Navigation Arrows - OUTSIDE content box -->
        <button class="task-nav-arrow task-nav-left" onclick="navigatePreviousTask()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="task-nav-arrow task-nav-right" onclick="navigateNextTask()">
            <i class="fas fa-chevron-right"></i>
        </button>

        <div class="task-creation-content">
            <!-- Header -->
            <div class="task-creation-header">
                <div class="task-header-left">
                    <div class="task-icon-square">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="white" stroke="white" stroke-width="2">
                            <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                            <circle cx="12" cy="10" r="3"/>
                        </svg>
                    </div>
                    <div class="task-header-text">
                        <span class="task-number" id="taskModalNumber">#1 | @IA | desa wire</span>
                        <div class="task-title-edit">
                            <input type="text" class="task-title-input" id="taskTitleInput" placeholder="Enter task title">
                            <i class="fas fa-pen task-title-icon"></i>
                        </div>
                    </div>
                </div>

                <div class="task-header-right">
                    <span class="task-attributes-label">Task Attributes</span>
                    <button class="task-close-btn" onclick="closeTaskCreationModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="task-creation-body">
                <!-- Left Side - Related Tasks, Checklist, and Message/Share -->
                <div class="task-left-section">
                    <div class="task-section">
                        <label class="task-section-label">Related Tasks:</label>
                        <div class="task-links">
                            <button class="task-link-btn">+ New task</button>
                            <span class="task-separator">|</span>
                            <button class="task-link-btn">+ Existing task</button>
                        </div>
                    </div>

                    <div class="task-section">
                        <label class="task-section-label">Checklist:</label>
                        <div class="task-links">
                            <button class="task-link-btn">+ New item</button>
                            <span class="task-separator">|</span>
                            <button class="task-link-btn dropdown-trigger">
                                + Add checklist
                                <i class="fas fa-caret-down"></i>
                            </button>
                        </div>
                    </div>

                    <!-- âœ… Message/Share at bottom of left side -->
                    <div class="task-footer-left-bottom">
                        <button class="task-attach-btn-left" title="Attach file">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <input type="text" class="task-message-input-left" placeholder="Enter message here...">
                        <button class="task-share-btn-left" onclick="saveTaskAndShowPin()">
                            Share
                            <i class="fas fa-caret-down"></i>
                        </button>
                    </div>
                </div>

                <!-- Right Side - Task Attributes -->
                <div class="task-right-section">
                    <!-- Status -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-check-circle"></i>
                            <span>Status</span>
                        </div>
                        <div class="task-attribute-value" style="position: relative;">
                            <button class="task-select" id="statusDropdownBtn" onclick="toggleStatusDropdown(event)" style="text-align: left; width: 100%; display: flex; align-items: center; justify-content: space-between;">
                                <span id="selectedStatus">Priority 2</span>
                                <i class="fas fa-chevron-down" style="font-size: 11px;"></i>
                            </button>

                            <!-- Status Dropdown Menu -->
                            <div class="status-dropdown-menu" id="statusDropdownMenu">
                                <div class="status-dropdown-header">
                                    <i class="fas fa-check-circle" style="font-size: 11px;"></i>
                                    <span>Status</span>
                                    <span style="margin-left: auto; color: #9ca3af;">Priority 2</span>
                                </div>

                                <div class="status-dropdown-item" onclick="selectStatus('Priority 1', '#dc2626')">
                                    <div class="status-color-box" style="background: #dc2626;"></div>
                                    <span>Priority 1</span>
                                </div>

                                <div class="status-dropdown-item" onclick="selectStatus('Priority 2', '#f59e0b')">
                                    <div class="status-color-box" style="background: #f59e0b;"></div>
                                    <span>Priority 2</span>
                                </div>

                                <div class="status-dropdown-item" onclick="selectStatus('Priority 3', '#eab308')">
                                    <div class="status-color-box" style="background: #eab308;"></div>
                                    <span>Priority 3</span>
                                </div>

                                <div class="status-dropdown-item" onclick="selectStatus('Completed', '#10b981')">
                                    <div class="status-color-box" style="background: #10b981;"></div>
                                    <span>Completed</span>
                                </div>

                                <div class="status-dropdown-item" onclick="selectStatus('Verified', '#60a5fa')">
                                    <div class="status-color-box" style="background: #60a5fa;"></div>
                                    <span>Verified</span>
                                </div>

                                <div class="status-dropdown-divider"></div>

                                <div class="status-dropdown-delete" onclick="deleteTask()">
                                    <i class="fas fa-trash"></i>
                                    <span>Delete task</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Category -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-th"></i>
                            <span>Category</span>
                        </div>
                        <div class="task-attribute-value">
                            <select class="task-select">
                                <option value="">--</option>
                            </select>
                        </div>
                    </div>

                    <!-- Assignee -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-user"></i>
                            <span>Assignee</span>
                        </div>
                        <div class="task-attribute-value">
                            <select class="task-select">
                                <option>Stephen</option>
                            </select>
                        </div>
                    </div>

                    <!-- Plan Attachment Area -->
                    <div class="task-plan-attachment">
                        <div class="task-attachment-preview">
                            <canvas id="taskPlanThumbnail" width="200" height="280"></canvas>
                            <button class="task-attachment-edit">
                                <i class="fas fa-pen"></i>
                            </button>
                        </div>
                        <div class="task-attachment-name" id="taskPlanName">desa wire</div>
                    </div>

                    <!-- Location -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>Location</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="text" class="task-input" placeholder="--">
                        </div>
                    </div>

                    <!-- Start Date -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="far fa-calendar"></i>
                            <span>Start date</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="date" class="task-input">
                        </div>
                    </div>

                    <!-- End Date -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="far fa-calendar"></i>
                            <span>End date</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="date" class="task-input">
                        </div>
                    </div>

                    <!-- Manpower -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-users"></i>
                            <span>Manpower</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="text" class="task-input" placeholder="--">
                        </div>
                    </div>

                    <!-- Cost -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-dollar-sign"></i>
                            <span>Cost</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="text" class="task-input" placeholder="--">
                        </div>
                    </div>

                    <!-- Tags -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="fas fa-tag"></i>
                            <span>Tags</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="text" class="task-input" placeholder="--">
                        </div>
                    </div>

                    <!-- Watchers -->
                    <div class="task-attribute-row">
                        <div class="task-attribute-label">
                            <i class="far fa-eye"></i>
                            <span>Watchers</span>
                        </div>
                        <div class="task-attribute-value">
                            <input type="text" class="task-input" placeholder="SAN" value="SAN">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
    // ===== ENHANCED TASK SYSTEM - COMPLETE IMPLEMENTATION =====

    // Global state
    if (!window.taskPinMarkers) window.taskPinMarkers = {};
    if (!window.taskDataStore) window.taskDataStore = {};
    let taskCounter = 1;
    let currentTaskId = null;

    // Toggle Status Dropdown (Image 3)
    function toggleStatusDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('statusDropdownMenu');
        if (dropdown) {
            dropdown.classList.toggle('show');
        }
    }

    // Select Status from Dropdown
    function selectStatus(statusName, statusColor) {
        const selectedSpan = document.getElementById('selectedStatus');
        if (selectedSpan) {
            selectedSpan.textContent = statusName;
            selectedSpan.style.color = statusColor;
        }

        const dropdown = document.getElementById('statusDropdownMenu');
        if (dropdown) {
            dropdown.classList.remove('show');
        }
    }

    // Delete Task Function
    function deleteTask() {
        if (!currentTaskId) return;

        if (confirm('Delete this task?')) {
            // Remove pin from PDF
            if (taskPinMarkers[currentTaskId]) {
                taskPinMarkers[currentTaskId].element.remove();
                delete taskPinMarkers[currentTaskId];
            }

            // Remove from task list
            const taskCard = document.querySelector(`[data-task-id="${currentTaskId}"]`);
            if (taskCard) {
                taskCard.remove();
            }

            // Remove from data store
            delete taskDataStore[currentTaskId];

            closeTaskCreationModal();
            showNotification('Task deleted successfully', 'success');
        }
    }

    // Save Task and Show Pin (Image 4)
    function saveTaskAndShowPin() {
        const modal = document.getElementById('taskCreationModal');
        const taskTitle = document.getElementById('taskTitleInput').value.trim();

        if (!taskTitle) {
            showNotification('Please enter a task title', 'error');
            return;
        }

        const taskId = currentTaskId || modal.dataset.currentTaskId;
        const pinX = modal.dataset.pinX ? parseFloat(modal.dataset.pinX) : null;
        const pinY = modal.dataset.pinY ? parseFloat(modal.dataset.pinY) : null;

        // Get task number
        const taskNumber = Object.keys(taskDataStore).length + 1;

        // Store task data
        taskDataStore[taskId] = {
            id: taskId,
            number: taskNumber,
            title: taskTitle,
            pinX: pinX,
            pinY: pinY,
            status: document.getElementById('selectedStatus').textContent,
            createdAt: new Date()
        };

        // Add to sidebar tasks list
        addTaskToSidebar(taskDataStore[taskId]);

        // Add pin to PDF (only if coordinates exist)
        if (pinX !== null && pinY !== null) {
            if (!taskPinMarkers[taskId]) {
                addProfessionalPin(pinX, pinY, taskId, taskNumber);
            }
        }

        closeTaskCreationModal();
        showNotification('âœ… Task created successfully!', 'success');
    }

    // Add Professional Pin to PDF (Image 2 Style - Map Pin/Location Icon)
    function addProfessionalPin(x, y, taskId, taskNumber) {
        const pdfContent = document.getElementById('pdfDocumentContent');
        if (!pdfContent) return;

        const pin = document.createElement('div');
        pin.className = 'pdf-task-pin';
        pin.dataset.taskId = taskId;
        pin.style.left = x + 'px';
        pin.style.top = y + 'px';

        // Image 2 style: Map pin/location marker with number
        pin.innerHTML = `
            <svg class="pdf-task-pin-svg" width="36" height="48" viewBox="0 0 36 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <filter id="shadow-${taskId}" x="-50%" y="-30%" width="200%" height="200%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="3"/>
                        <feOffset dx="0" dy="4" result="offsetblur"/>
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.35"/>
                        </feComponentTransfer>
                        <feMerge>
                            <feMergeNode/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                    <linearGradient id="pinGradient-${taskId}" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#f7931e;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <!-- Main pin body (teardrop shape) -->
                <path d="M18 4 C10.268 4 4 10.268 4 18 C4 25.732 18 44 18 44 S32 25.732 32 18 C32 10.268 25.732 4 18 4 Z"
                      fill="url(#pinGradient-${taskId})"
                      stroke="white"
                      stroke-width="2.5"
                      filter="url(#shadow-${taskId})"/>

                <!-- Inner white circle for number -->
                <circle cx="18" cy="18" r="9" fill="white"/>

                <!-- Task number text -->
                <text x="18" y="23"
                      text-anchor="middle"
                      font-size="12"
                      font-weight="bold"
                      fill="#ff6b35"
                      font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif">
                    ${taskNumber}
                </text>
            </svg>

            <!-- Pulsing effect -->
            <div class="pdf-task-pin-pulse"></div>
        `;

        // Click pin to reopen task modal and highlight
        pin.addEventListener('click', function(e) {
            e.stopPropagation();

            // Highlight animation
            pin.classList.add('pin-highlight');
            setTimeout(() => pin.classList.remove('pin-highlight'), 1500);

            // Reopen modal
            reopenTaskModal(taskId);
        });

        pdfContent.appendChild(pin);
        taskPinMarkers[taskId] = { element: pin, x, y, number: taskNumber };

        console.log('âœ… Professional map pin added - Task #' + taskNumber);
    }

    // Add Task to Sidebar (Image 4 Style)
    function addTaskToSidebar(taskData) {
        const tasksList = document.querySelector('.pdf-tasks-content');
        if (!tasksList) return;

        // Check if task card already exists
        let existingCard = document.querySelector(`[data-task-id="${taskData.id}"]`);

        if (!existingCard) {
            const taskCard = document.createElement('div');
            taskCard.className = 'pdf-task-card';
            taskCard.dataset.taskId = taskData.id;

            taskCard.innerHTML = `
                <div class="pdf-task-card-header">
                    <div class="pdf-task-card-number">${taskData.number}</div>
                    <div class="pdf-task-card-title">${taskData.title || 'Untitled Task'}</div>
                </div>
                <div class="pdf-task-card-meta">
                    <i class="fas fa-check-circle" style="font-size: 11px; margin-right: 4px;"></i>
                    ${taskData.status || 'Priority 2'}
                </div>
            `;

            // Click task card to reopen modal
            taskCard.addEventListener('click', function() {
                reopenTaskModal(taskData.id);

                // Highlight corresponding pin
                const pin = taskPinMarkers[taskData.id];
                if (pin && pin.element) {
                    pin.element.style.animation = 'none';
                    setTimeout(() => {
                        pin.element.style.animation = 'pinPulse 1s ease-out';
                    }, 10);
                }
            });

            // Insert after "New task" button
            const newTaskBtn = tasksList.querySelector('.pdf-tasks-new-text-btn');
            if (newTaskBtn) {
                newTaskBtn.insertAdjacentElement('afterend', taskCard);
            } else {
                tasksList.appendChild(taskCard);
            }
        } else {
            // Update existing card
            existingCard.querySelector('.pdf-task-card-title').textContent = taskData.title || 'Untitled Task';
            existingCard.querySelector('.pdf-task-card-meta').innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 11px; margin-right: 4px;"></i>
                ${taskData.status || 'Priority 2'}
            `;
        }
    }

    // Add Pin Marker to Preview Canvas - COMPLETE FIX
    function addPinMarkerToPreview(pinX, pinY, taskNumber) {
        const preview = document.querySelector('.task-attachment-preview');
        const canvas = document.getElementById('taskPlanThumbnail');

        if (!preview || !canvas) {
            console.log('âŒ Preview or canvas not found');
            return;
        }

        // Remove existing pin if any
        const existingPin = preview.querySelector('.task-attachment-preview-pin');
        if (existingPin) {
            existingPin.remove();
        }

        // Get canvas display dimensions
        const canvasRect = canvas.getBoundingClientRect();

        // Get actual PDF dimensions (from the rendered canvas)
        const pdfDocumentArea = document.querySelector('.pdf-document-area');
        const pdfContent = document.getElementById('pdfDocumentContent');

        if (!pdfContent) {
            console.log('âŒ PDF content not found');
            return;
        }

        const pdfRect = pdfContent.getBoundingClientRect();

        // Calculate scale ratio
        const scaleX = canvasRect.width / pdfRect.width;
        const scaleY = canvasRect.height / pdfRect.height;

        // Calculate pin position on preview (centered on pin tip)
        const previewPinX = pinX * scaleX;
        const previewPinY = pinY * scaleY;

        console.log('ðŸ“ Pin position calculation:', {
            originalX: pinX,
            originalY: pinY,
            scaleX: scaleX.toFixed(2),
            scaleY: scaleY.toFixed(2),
            previewX: previewPinX.toFixed(0),
            previewY: previewPinY.toFixed(0)
        });

        // Create pin marker div with PROPER SVG
        const pinDiv = document.createElement('div');
        pinDiv.className = 'task-attachment-preview-pin';
        pinDiv.style.left = previewPinX + 'px';
        pinDiv.style.top = previewPinY + 'px';

        // CRITICAL: Use proper teardrop/location pin SVG path
        pinDiv.innerHTML = `
            <svg width="28" height="36" viewBox="0 0 28 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="pin-grad-${taskNumber}" x1="0%" y1="0%" x2="0%" y2="100%">
                        <stop offset="0%" style="stop-color:#ff6b35;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#f7931e;stop-opacity:1" />
                    </linearGradient>
                </defs>

                <!-- Teardrop location pin body -->
                <path d="M 14 2
                         C 8.5 2, 4 6.5, 4 12
                         C 4 19, 14 34, 14 34
                         S 24 19, 24 12
                         C 24 6.5, 19.5 2, 14 2 Z"
                      fill="url(#pin-grad-${taskNumber})"
                      stroke="white"
                      stroke-width="2"/>

                <!-- White circle background for number -->
                <circle cx="14" cy="12" r="6.5" fill="white"/>

                <!-- Task number -->
                <text x="14"
                      y="16"
                      text-anchor="middle"
                      font-family="-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif"
                      font-size="9"
                      font-weight="700"
                      fill="#ff6b35">
                    ${taskNumber}
                </text>
            </svg>
        `;

        preview.appendChild(pinDiv);
        console.log('âœ… Teardrop pin marker added to preview at', previewPinX, previewPinY);
    }

    // Reopen Task Modal (Image 1)
    function reopenTaskModal(taskId) {
        const taskData = taskDataStore[taskId];
        if (!taskData) return;

        currentTaskId = taskId;

        const modal = document.getElementById('taskCreationModal');
        if (!modal) return;

        // Get the currently selected PDF name
        const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
        let pdfName = 'Document';
        if (planIndex !== -1 && plans && plans[planIndex]) {
            pdfName = plans[planIndex].name || 'Document';
        }

        // Get user abbreviation
        const userElement = document.querySelector('.user-dropdown span');
        let userAbbr = 'USER';
        if (userElement) {
            const username = userElement.textContent.trim();
            userAbbr = username.split(' ').map(n => n.charAt(0)).join('').toUpperCase();
        }

        // Populate modal with existing data
        document.getElementById('taskModalNumber').textContent = `#${taskData.number} | @${userAbbr} | ${pdfName}`;
        document.getElementById('taskTitleInput').value = taskData.title || '';
        document.getElementById('selectedStatus').textContent = taskData.status || 'Priority 2';
        document.getElementById('taskPlanName').textContent = pdfName;

        modal.dataset.pinX = taskData.pinX;
        modal.dataset.pinY = taskData.pinY;
        modal.classList.add('show');

        // Generate thumbnail
        setTimeout(() => {
            const planIndex = currentPlanIndex !== -1 ? currentPlanIndex : currentPDFPlan;
            if (planIndex !== -1 && plans && plans[planIndex]) {
                const plan = plans[planIndex];
                if (plan.preview) {
                    const canvas = document.getElementById('taskPlanThumbnail');
                    if (canvas) {
                        const base64Data = plan.preview.split(',')[1] || plan.preview;
                        generateThumbnailWithPin(plan, taskData.pinX, taskData.pinY);

                        // Add pin marker to preview
                        addPinMarkerToPreview(taskData.pinX, taskData.pinY, taskData.number);
                    }
                }
            }
        }, 100);
    }

    // Enhanced Close Task Modal
    function closeTaskCreationModal() {
        const modal = document.getElementById('taskCreationModal');
        if (modal) {
            modal.classList.remove('show');
            currentTaskId = null;
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const statusDropdown = document.getElementById('statusDropdownMenu');
        const statusBtn = document.getElementById('statusDropdownBtn');

        if (statusDropdown && statusBtn &&
            !statusBtn.contains(e.target) &&
            !statusDropdown.contains(e.target)) {
            statusDropdown.classList.remove('show');
        }
    });

    // Initialize task list container if it doesn't exist
    document.addEventListener('DOMContentLoaded', function() {
        const tasksContent = document.querySelector('.pdf-tasks-content');
        if (tasksContent && !tasksContent.querySelector('.pdf-tasks-list')) {
            // Container already has the "New task" button, just ensure it's styled correctly
            console.log('âœ… Tasks sidebar initialized');
        }
    });

    console.log('âœ… Enhanced Task System Loaded - Professional Style');

    // ===== TASK NAVIGATION FUNCTIONS =====
    function navigatePreviousTask() {
        const taskIds = Object.keys(taskDataStore);
        if (taskIds.length === 0) return;

        const currentIndex = taskIds.indexOf(currentTaskId);

        if (currentIndex > 0) {
            const prevTaskId = taskIds[currentIndex - 1];
            reopenTaskModal(prevTaskId);
        } else {
            showNotification('This is the first task', 'info');
        }
    }

    function navigateNextTask() {
        const taskIds = Object.keys(taskDataStore);
        if (taskIds.length === 0) return;

        const currentIndex = taskIds.indexOf(currentTaskId);

        if (currentIndex < taskIds.length - 1) {
            const nextTaskId = taskIds[currentIndex + 1];
            reopenTaskModal(nextTaskId);
        } else {
            showNotification('This is the last task', 'info');
        }
    }

    // Dynamic viewport adjustment - FIXED FOR 100% ZOOM
    function adjustForViewport() {
        const vw = window.innerWidth;
        const vh = window.innerHeight;
        const zoom = window.devicePixelRatio || 1;

        // Adjust root font size based on viewport AND zoom level
        let baseFontSize = 14; // Default for 100% zoom at 1920x1080

        if (vw < 1400) {
            baseFontSize = 12; // Laptops
        } else if (vw >= 1400 && vw < 1920) {
            baseFontSize = 13; // Standard monitors
        } else if (vw >= 1920 && vw < 2560) {
            baseFontSize = 14; // Large monitors
        } else if (vw >= 2560) {
            baseFontSize = 16; // Ultra-wide/4K
        }

        // Compensate for browser zoom (if user zooms to 80%, increase font size)
        const adjustedFontSize = baseFontSize / zoom;

        document.documentElement.style.fontSize = adjustedFontSize + 'px';

        console.log('Viewport adjusted:', {
            screenWidth: vw,
            screenHeight: vh,
            browserZoom: (zoom * 100).toFixed(0) + '%',
            baseFontSize: baseFontSize + 'px',
            adjustedFontSize: adjustedFontSize.toFixed(1) + 'px'
        });
    }

    // Run on load and resize
    window.addEventListener('load', adjustForViewport);
    window.addEventListener('resize', adjustForViewport);
    adjustForViewport();
    </script>

</body>
</html>