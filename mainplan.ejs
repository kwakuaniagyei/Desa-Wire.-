<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plans | <%= projectName %></title>
    <link rel="icon" type="image/webp" href="/img/img.webp">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="/js/notifications.js?v=<%= Date.now() %>"></script>
    <script src="/js/chat-widget.js?v=<%= Date.now() %>"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Action Bar */
        .action-bar {
            background: white;
            padding: 16px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .action-bar-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .action-bar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: white;
            color: #374151;
            border: 1px solid #d1d5db;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background-color: #f9fafb;
        }

        /* Plans Content Area */
        .plans-content {
            flex: 1;
            overflow-y: auto;
            padding: 24px;
        }

        /* Empty State */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }

        .empty-state-icon {
            width: 160px;
            height: 120px;
            margin-bottom: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f3f4f6;
            border-radius: 12px;
            position: relative;
        }

        .empty-state-icon-inner {
            width: 100px;
            height: 80px;
            border: 3px solid #d1d5db;
            border-radius: 8px;
            background: white;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .empty-state-play {
            width: 50px;
            height: 50px;
            background: #9ca3af;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .empty-state-play::before {
            content: 'â–¶';
            margin-left: 3px;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .empty-state-description {
            font-size: 14px;
            color: #6b7280;
            max-width: 400px;
            line-height: 1.5;
        }

        /* Folder Section */
        .folder-section {
            margin-bottom: 32px;
        }

        .folder-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 8px 12px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            overflow: visible;
            position: relative;
        }

        .folder-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .folder-icon {
            font-size: 18px;
            color: #6b7280;
        }

        .folder-name {
            flex: 1;
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
        }

        .folder-dropdown {
            position: relative;
        }

        .folder-dropdown-btn {
            background: none;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
            color: #6b7280;
            font-size: 14px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .folder-dropdown-btn:hover {
            background: #f3f4f6;
        }

        .folder-dropdown-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-width: 160px;
            z-index: 100;
            margin-top: -2px;
        }

        .folder-dropdown-menu.show {
            display: block;
        }

        .folder-dropdown-item {
            padding: 10px 16px;
            cursor: pointer;
            font-size: 14px;
            color: #374151;
            transition: all 0.2s;
            display: block;
            text-align: left;
            border: none;
            background: none;
            width: 100%;
        }

        .folder-dropdown-item:hover {
            background: #f9fafb;
        }

        .folder-dropdown-item.danger {
            color: #dc2626;
        }

        .folder-dropdown-item.danger:hover {
            background: #fef2f2;
        }

        /* Plans Grid */
        .plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            padding: 0 12px;
        }

        .folder-plans-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
            padding: 12px 12px;
            background: #fafbfc;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            min-height: 50px;
        }

        .plan-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .plan-card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }

        .plan-thumbnail {
            width: 100%;
            height: 350px;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            border-radius: 12px 12px 0 0;
        }

        .plan-thumbnail canvas {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .plan-info {
            padding: 16px;
            background: white;
        }

        .plan-name {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            letter-spacing: 0.3px;
        }

        /* New Plan Card */
        .new-plan-card {
            background: transparent;
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 200px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .new-plan-card:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .new-plan-content {
            text-align: center;
            color: #9ca3af;
        }

        .new-plan-content i {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .new-plan-content span {
            display: block;
            font-size: 14px;
            font-weight: 500;
        }

        /* Upload Modal */
        .upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .upload-modal.show {
            display: flex;
        }

        .upload-modal-content {
            background: white;
            border-radius: 12px;
            width: 95%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .upload-modal-header {
            padding: 32px 40px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .upload-modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
        }

        .upload-modal-close {
            background: none;
            border: none;
            font-size: 28px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
            line-height: 1;
        }

        .upload-modal-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .upload-modal-body {
            padding: 32px 40px;
        }

        .upload-dropzone {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 60px 40px;
            text-align: center;
            background-color: #f9fafb;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-dropzone:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .upload-dropzone.drag-over {
            border-color: #3b82f6;
            background-color: #dbeafe;
        }

        /* Drag and drop visual feedback */
        .folder-section.drag-over {
            background-color: #dbeafe;
            border-color: #3b82f6;
            border: 2px dashed #3b82f6;
            transition: all 0.2s ease;
        }

        .folder-section.drag-over .folder-plans-grid {
            background-color: #eff6ff;
        }

        .plan-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            cursor: grabbing;
        }

        .upload-icon-wrapper {
            margin: 0 auto 20px;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-icon-box {
            width: 56px;
            height: 48px;
            border: 2px solid #9ca3af;
            border-radius: 4px;
            position: relative;
            background: white;
        }

        .upload-icon-lines {
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
        }

        .upload-icon-line {
            height: 2px;
            background-color: #d1d5db;
            margin-bottom: 6px;
        }

        .upload-icon-line:last-child {
            margin-bottom: 0;
            width: 60%;
        }

        .upload-text {
            font-size: 15px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .upload-or {
            font-size: 14px;
            color: #9ca3af;
            margin: 16px 0;
        }

        .upload-select-btn {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .upload-select-btn:hover {
            background-color: #2563eb;
        }

        .upload-file-list {
            margin-top: 24px;
            display: none;
        }

        .upload-file-list.show {
            display: block;
        }

        .upload-file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .upload-file-icon {
            width: 32px;
            height: 32px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #6b7280;
        }

        .upload-file-info {
            flex: 1;
        }

        .upload-file-name {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .upload-file-size {
            font-size: 12px;
            color: #9ca3af;
        }

        .upload-file-remove {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            padding: 4px;
            font-size: 16px;
            transition: all 0.2s;
        }

        .upload-file-remove:hover {
            color: #dc2626;
        }

        .upload-integration-section {
            margin-top: 32px;
        }

        .upload-integration-text {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            text-align: center;
        }

        .upload-integration-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .upload-integration-btn {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 16px 12px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .upload-integration-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .upload-integration-icon {
            width: 28px;
            height: 28px;
        }

        .upload-integration-name {
            font-size: 12px;
            color: #6b7280;
            text-align: center;
        }

        .upload-more-options {
            width: 100%;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 10px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            color: #6b7280;
            transition: all 0.2s;
        }

        .upload-more-options:hover {
            background: #f9fafb;
        }

        .upload-files-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 24px;
            transition: all 0.2s;
        }

        .upload-files-btn:hover {
            background-color: #2563eb;
        }

        .upload-files-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Create Folder Modal */
        .create-folder-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .create-folder-modal.show {
            display: flex;
        }

        .create-folder-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            animation: modalSlideIn 0.3s ease;
        }

        .create-folder-header {
            padding: 24px 24px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .create-folder-title {
            font-size: 20px;
            font-weight: 600;
            color: #1f2937;
        }

        .create-folder-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #9ca3af;
            cursor: pointer;
            padding: 0;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .create-folder-close:hover {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        .create-folder-body {
            padding: 0 24px 24px;
        }

        .create-folder-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            margin-bottom: 16px;
            transition: all 0.2s;
        }

        .create-folder-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .create-folder-btn {
            width: 100%;
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-folder-btn:hover {
            background-color: #2563eb;
        }

        .create-folder-btn:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            background: white;
            padding: 32px 48px;
            border-radius: 12px;
            text-align: center;
        }

        .loading-spinner i {
            font-size: 48px;
            color: #3b82f6;
            margin-bottom: 16px;
        }

        .loading-spinner p {
            font-size: 16px;
            color: #6b7280;
        }

        /* Bottom status bar */
        .status-bar {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 8px 24px;
            font-size: 13px;
            color: #6b7280;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            transition: width 0.3s ease;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .logo span {
            display: none;
        }

        .sidebar.collapsed .logo .dropdown-icon {
            display: none;
        }

        .sidebar.collapsed .section-title {
            display: none;
        }

        .sidebar.collapsed .menu-item span {
            display: none;
        }

        .sidebar.collapsed .task-item span {
            display: none;
        }

        .sidebar.collapsed .tasks-section {
            margin-top: 10px;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        .sidebar.collapsed .task-item {
            padding: 8px 12px;
            justify-content: center;
            margin-bottom: 5px;
        }

        .sidebar.collapsed .task-item .badge {
            display: none;
        }

        .sidebar.collapsed .task-item i {
            width: auto;
            font-size: 16px;
        }

        /* Hide main content panels when sidebar is collapsed in PDF viewer context */
        .sidebar.collapsed ~ .main-content .action-bar {
            display: none;
        }

        .sidebar.collapsed ~ .main-content .plans-content {
            display: none;
        }

        .sidebar.collapsed ~ .main-content .status-bar {
            display: none;
        }

        .logo {
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #34495e;
        }

        .logo-img {
            width: 44px;
            height: 44px;
            object-fit: contain;
        }

        .logo i {
            color: #3498db;
            font-size: 24px;
        }

        .logo span {
            font-weight: 700;
            font-size: 18px;
            color: #ecf0f1;
        }

        .logo .dropdown-icon {
            margin-left: auto;
            font-size: 12px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo .dropdown-icon.open {
            transform: rotate(180deg);
        }

        /* Sidebar Project Dropdown */
        .sidebar-project-dropdown {
            position: absolute;
            top: 65px;
            left: 20px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: calc(100% - 40px);
            min-width: 200px;
            max-height: 350px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .sidebar-project-dropdown.show {
            display: block;
        }

        .sidebar-project-search {
            padding: 10px 12px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-project-search input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            outline: none;
            transition: border-color 0.2s;
        }

        .sidebar-project-search input:focus {
            border-color: #3498db;
        }

        .sidebar-project-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #333;
        }

        .sidebar-project-item:hover {
            background-color: #f8f8f8;
            border-left-color: #3498db;
        }

        .sidebar-project-item.active {
            background-color: #ebf8ff;
            border-left-color: #3498db;
            color: #3498db;
            font-weight: 600;
        }

        .sidebar-project-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background-color: #3498db;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .sidebar-project-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Sidebar Dropdown Header with Home and Create buttons */
        .sidebar-project-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid #f0f0f0;
            gap: 8px;
        }

        .sidebar-home-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            padding: 8px 12px;
            background-color: transparent;
            border: 1.5px solid #FFD700;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            color: #FFD700;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 600;
        }

        .sidebar-home-btn i {
            color: #FFD700;
            font-size: 14px;
        }

        .sidebar-home-btn:hover {
            background-color: rgba(255, 215, 0, 0.15);
            border-color: #FFD700;
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .sidebar-create-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            background-color: #FF6B6B;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            color: white;
            font-size: 18px;
            transition: all 0.2s ease;
            flex-shrink: 0;
            font-weight: bold;
        }

        .sidebar-create-btn i {
            color: white;
        }

        .sidebar-create-btn:hover {
            background-color: #FF5252;
            transform: scale(1.1);
            box-shadow: 0 0 12px rgba(255, 107, 107, 0.4);
        }

        .sidebar-create-btn:active {
            transform: scale(0.95);
        }

        .section-title {
            padding: 8px 16px 15px;
            font-size: 13px;
            text-transform: uppercase;
            color: #3498db;
            letter-spacing: 1.5px;
            font-weight: 800;
            opacity: 0.95;
        }

        .menu-item {
            padding: 12px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-size: 19px;
            color: #ecf0f1;
        }

        .menu-item:hover {
            background-color: #34495e;
        }

        .menu-item.active {
            background-color: #3498db;
            color: white;
        }

        .menu-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
        }

        .tasks-section {
            margin-top: 30px;
            border-top: 2px solid rgba(52, 152, 219, 0.4);
            padding-top: 18px;
            padding-bottom: 15px;
            flex-shrink: 0;
        }

        .task-item {
            padding: 11px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            font-size: 18px;
            color: #ffffff;
            border-radius: 8px;
            margin-bottom: 7px;
            position: relative;
            overflow: hidden;
        }

        .task-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background-color: transparent;
            transition: background-color 0.3s ease;
        }

        .task-item:hover {
            background-color: rgba(52, 152, 219, 0.12);
            color: #ffffff;
            transform: translateX(3px);
            box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.2);
        }

        .task-item:hover::before {
            background-color: #3498db;
        }

        .task-item.active {
            background-color: rgba(52, 152, 219, 0.2);
            color: #ffffff;
            font-weight: 600;
            letter-spacing: 0.3px;
            box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.3);
        }

        .task-item.active::before {
            background-color: #3498db;
            width: 4px;
        }

        .task-item .left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .task-item .badge {
            background-color: #3498db;
            color: white;
            padding: 4px 9px;
            border-radius: 14px;
            font-size: 11px;
            font-weight: 800;
            min-width: 22px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
        }

        .task-item:hover .badge {
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(52, 152, 219, 0.4);
        }

        .task-item i {
            width: 20px;
            text-align: center;
            font-size: 18px;
            opacity: 0.9;
            transition: opacity 0.3s ease;
        }

        .task-item:hover i {
            opacity: 1;
        }

        .sidebar-footer {
            padding: 15px 20px;
            display: flex;
            gap: 20px;
            border-top: 2px solid rgba(52, 152, 219, 0.3);
            margin-top: auto;
            justify-content: center;
        }

        .footer-icon {
            cursor: pointer;
            color: #7f8c8d;
            transition: all 0.3s ease;
            font-size: 20px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            padding: 6px;
        }

        .footer-icon:hover {
            color: #3498db;
            background-color: rgba(52, 152, 219, 0.15);
            transform: scale(1.1);
        }

        /* Header Section */
        .header {
            background-color: white;
            padding: 12px 30px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e0e0e0;
            gap: 20px;
        }

        .search-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .sidebar-toggle-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #374151;
            transition: color 0.2s;
        }

        .sidebar-toggle-btn:hover {
            color: #1f2937;
        }

        .search-box {
            display: flex;
            align-items: center;
            background-color: #f5f5f5;
            padding: 8px 15px;
            border-radius: 4px;
            width: 300px;
        }

        .search-box input {
            border: none;
            background: none;
            outline: none;
            margin-left: 10px;
            width: 100%;
            font-size: 14px;
        }

        .search-box i {
            color: #9ca3af;
            font-size: 16px;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .notification-icon {
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .notification-icon:hover {
            transform: scale(1.1);
        }

        .notification-panel, .help-panel {
            position: absolute;
            top: 50px;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 350px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
        }

        .notification-panel.show, .help-panel.show {
            display: block;
        }

        .panel-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .panel-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .mark-all-read {
            font-size: 12px;
            color: #3498db;
            cursor: pointer;
            transition: color 0.2s;
        }

        .mark-all-read:hover {
            color: #2563eb;
        }

        .help-item {
            padding: 12px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .help-item:hover {
            background-color: #f9fafb;
        }

        .help-item-title {
            font-size: 14px;
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .help-item-desc {
            font-size: 12px;
            color: #6b7280;
        }

        .user-dropdown {
            position: relative;
            cursor: pointer;
        }

        .user-dropdown > span:first-child {
            font-size: 14px;
            color: #1f2937;
            font-weight: 500;
        }

        .user-dropdown > span:last-child {
            font-size: 12px;
            color: #9ca3af;
        }

        .user-dropdown-content {
            position: absolute;
            top: 40px;
            right: 0;
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 250px;
            display: none;
            z-index: 1000;
        }

        .user-dropdown-content.show {
            display: block;
        }

        .user-dropdown-header {
            padding: 15px 20px;
            border-bottom: 1px solid #e0e0e0;
        }

        .user-full-name {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .user-email {
            font-size: 12px;
            color: #6b7280;
        }

        .user-dropdown-menu {
            padding: 8px 0;
        }

        .user-dropdown-item {
            display: block;
            width: 100%;
            padding: 10px 20px;
            border: none;
            background: none;
            text-align: left;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            transition: background-color 0.2s;
        }

        .user-dropdown-item:hover {
            background-color: #f9fafb;
        }

        /* Notification Styles */
        .notification-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .notification-item:hover {
            background: #f7fafc;
        }

        .notification-item.unread {
            background: #ebf8ff;
        }

        .notification-header {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            margin-bottom: 5px;
        }

        .notification-icon-circle {
            width: 8px;
            height: 8px;
            background: #3182ce;
            border-radius: 50%;
            margin-top: 5px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 3px;
        }

        .notification-message {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        .notification-time {
            font-size: 11px;
            color: #a0aec0;
            margin-top: 5px;
        }

        .notification-type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 8px;
        }

        .notification-type-badge.People {
            background: #e6f7ff;
            color: #1890ff;
        }

        .notification-type-badge.Project {
            background: #f0f5ff;
            color: #6366f1;
        }

        .notification-type-badge.Account {
            background: #fff7e6;
            color: #fa8c16;
        }

        .notification-type-badge.Alerts {
            background: #fff1f0;
            color: #f5222d;
        }

        .notification-type-badge.Tasks {
            background: #f6ffed;
            color: #52c41a;
        }

        .notification-type-badge.Forms {
            background: #f9f0ff;
            color: #722ed1;
        }

        /* Help Item Styles */
        .help-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f7fafc;
            cursor: pointer;
            transition: background 0.2s;
        }

        .help-item:hover {
            background: #f7fafc;
        }

        .help-item-title {
            font-size: 14px;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 5px;
        }

        .help-item-desc {
            font-size: 13px;
            color: #718096;
            line-height: 1.4;
        }

        /* ========== PDF VIEWER MODAL STYLES ========== */

        /* PDF Viewer Modal */
        .pdf-viewer-modal {
            display: none;
            position: fixed;
            top: 60px;
            left: 280px;
            right: 0;
            bottom: 0;
            background-color: white;
            z-index: 10000;
            flex-direction: column;
        }

        .pdf-viewer-modal.show {
            display: flex;
        }

        /* When sidebar is collapsed, expand PDF viewer to full width */
        .sidebar.collapsed ~ .pdf-viewer-modal {
            left: 80px;
        }

        .sidebar.collapsed ~ .pdf-viewer-modal.show {
            left: 80px;
        }

        /* Left Sidebar with Tools */
        .pdf-tools-sidebar {
            width: 60px;
            background: #3a3f47;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            gap: 8px;
        }

        .tool-btn {
            width: 44px;
            height: 44px;
            background: #3a3f47;
            border: none;
            border-radius: 8px;
            color: #ffffff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            background: #4a5058;
        }

        .tool-btn.active {
            background: #5a6268;
        }

        .zoom-group {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-bottom: 8px;
        }

        .zoom-group .tool-btn {
            border-radius: 0;
            height: 38px;
        }

        .zoom-group .tool-btn:first-child {
            border-radius: 8px 8px 0 0;
            border-bottom: 1px solid #2a2f37;
        }

        .zoom-group .tool-btn:last-child {
            border-radius: 0 0 8px 8px;
        }

        .tool-separator {
            width: 30px;
            height: 1px;
            background: #5a6268;
            margin: 8px 0;
        }

        .tool-btn.record {
            background: #dc2626;
        }

        .tool-btn.record:hover {
            background: #b91c1c;
        }

        .pdf-nav-arrows {
            margin-top: auto;
            display: flex;
            gap: 0;
        }

        .pdf-nav-arrows .tool-btn {
            width: 28px;
            height: 44px;
            border-radius: 0;
            font-size: 14px;
        }

        .pdf-nav-arrows .tool-btn:first-child {
            border-radius: 8px 0 0 8px;
            border-right: 1px solid #2a2f37;
        }

        .pdf-nav-arrows .tool-btn:last-child {
            border-radius: 0 8px 8px 0;
        }

        .pdf-main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f5f5f5;
            overflow: hidden;
        }

        .pdf-top-bar {
            background: white;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #e5e7eb;
        }

        .pdf-search {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-icon, .view-icon {
            width: 36px;
            height: 36px;
            background: #f3f4f6;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .tasks-panel {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .tasks-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .new-task-btn {
            font-size: 13px;
            color: #6b7280;
            cursor: pointer;
        }

        .pdf-document-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            display: flex;
            justify-content: center;
        }

        .pdf-document-container {
            width: 100%;
            max-width: 900px;
            background: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 40px 60px 60px 60px;
            margin: 0 auto;
            min-height: calc(100vh - 200px);
            position: relative;
        }

        .doc-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }

        .company-logo {
            background: #FDB714;
            color: black;
            font-size: 32px;
            font-weight: 900;
            padding: 8px 16px;
            border-radius: 4px;
            letter-spacing: 2px;
        }

        .company-info {
            font-size: 11px;
            color: #374151;
            line-height: 1.4;
            margin-top: 8px;
        }

        .project-info {
            text-align: right;
            font-size: 11px;
            color: #374151;
            line-height: 1.6;
        }

        .doc-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .doc-title h2 {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .doc-title h3 {
            font-size: 13px;
            font-weight: 600;
            color: #374151;
        }

        .doc-info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px 40px;
            margin-bottom: 30px;
            font-size: 12px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .info-label {
            font-weight: 600;
            color: #374151;
        }

        .info-value {
            color: #6b7280;
            text-align: right;
        }

        .description-box {
            background: #fef2f2;
            border: 2px solid #fecaca;
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 30px;
            font-size: 11px;
            line-height: 1.6;
            color: #374151;
        }

        .workflow-section {
            margin-bottom: 30px;
        }

        .workflow-title {
            font-size: 14px;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 16px;
        }

        .workflow-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
            border: 1px solid #e5e7eb;
        }

        .workflow-table th {
            background: #f9fafb;
            color: #374151;
            font-weight: 600;
            padding: 10px 12px;
            text-align: left;
            border: 1px solid #e5e7eb;
        }

        .workflow-table td {
            padding: 10px 12px;
            border: 1px solid #e5e7eb;
            color: #6b7280;
        }

        .workflow-table td a {
            color: #3b82f6;
            text-decoration: none;
        }

        .alert-box {
            background: #fef2f2;
            border: 2px solid #dc2626;
            border-radius: 6px;
            padding: 12px 16px;
            font-size: 11px;
            font-weight: 600;
            color: #dc2626;
            text-align: center;
            margin-bottom: 30px;
        }

        .doc-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            margin-top: 30px;
            border-top: 2px solid #e5e7eb;
            font-size: 10px;
            color: #6b7280;
            font-weight: 500;
            background: white;
            position: relative;
        }

        .bottom-right-panel {
            position: fixed;
            bottom: 24px;
            right: 24px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 10001;
        }

        .date-compare-box {
            background: #3a3f47;
            color: white;
            padding: 16px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .date-display {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .compare-btn {
            background: #6b7280;
            color: white;
            border: none;
            padding: 8px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            width: 100%;
        }

        .bottom-edit-bar {
            position: fixed;
            bottom: 0;
            left: 60px;
            right: 0;
            background: #2a2f37;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
        }

        .edit-label {
            background: #3a3f47;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .close-viewer-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            color: #6b7280;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10002;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .close-viewer-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        /* ===== PDF VIEWER SECONDARY HEADER ===== */
        .pdf-viewer-secondary-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 44px;
            position: relative;
            z-index: 10003;
        }

        .pdf-secondary-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .pdf-back-btn {
            background: none;
            border: none;
            display: flex;
            align-items: center;
            gap: 6px;
            color: #6b7280;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.2s;
            padding: 4px 8px;
            border-radius: 4px;
        }

        .pdf-back-btn:hover {
            background: #e5e7eb;
            color: #1f2937;
        }

        .pdf-secondary-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pdf-action-btn, .pdf-filter-btn, .pdf-version-btn {
            background: none;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
        }

        .pdf-action-btn:hover, .pdf-filter-btn:hover, .pdf-version-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
            color: #1f2937;
        }

        /* ===== PDF VIEWER MAIN WRAPPER ===== */
        .pdf-viewer-main-wrapper {
            display: flex;
            height: calc(100vh - 44px);
            overflow: hidden;
            position: relative;
        }

        /* ===== PDF LEFT SIDEBAR TOOLS ===== */
        .pdf-left-sidebar {
            width: 60px;
            background: #3a3f47;
            border-right: 1px solid #2a2f37;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 16px 0;
            gap: 6px;
            overflow-y: visible;
            height: fit-content;
            align-self: flex-start;
        }

        .pdf-tool-btn {
            width: 36px;
            height: 36px;
            background: none;
            border: none;
            color: #d1d5db;
            font-size: 16px;
            cursor: pointer;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            padding: 4px;
            margin: 2px 0;
        }

        .pdf-tool-btn:hover {
            background: #4a5158;
            color: white;
        }

        .pdf-tool-btn.active {
            background: #2563eb;
            color: white;
        }

        /* ===== PDF CENTER CONTENT ===== */
        .pdf-center-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            overflow: hidden;
        }

        .pdf-document-area {
            flex: 1;
            overflow: hidden;
            background: #f3f4f6;
            padding: 0px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .pdf-document-area::-webkit-scrollbar {
            display: none;
        }

        #pdfDocumentContent {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 0px;
            background: transparent;
            padding: 20px;
            box-shadow: none;
            border-radius: 0px;
            height: 100%;
            align-items: center;
            justify-content: center;
            overflow: visible;
        }

        #pdfDocumentContent canvas {
            max-width: 95%;
            max-height: 95%;
            height: auto;
            width: auto;
            background: white;
            border-radius: 0px;
            box-shadow: none;
            object-fit: contain;
            image-rendering: crisp-edges;
            image-rendering: sharp;
            -ms-interpolation-mode: nearest-neighbor;
            border: 1px solid #000000;
        }

        /* ===== PDF RIGHT TASKS SIDEBAR ===== */
        .pdf-tasks-sidebar {
            width: 280px;
            background: white;
            border-left: 1px solid #e5e7eb;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.05);
        }

        .pdf-tasks-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 50px;
            flex-shrink: 0;
        }

        .pdf-tasks-title {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .pdf-tasks-header-actions {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .pdf-tasks-close-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #6b7280;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pdf-tasks-close-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .pdf-tasks-add-btn {
            background: none;
            border: none;
            font-size: 18px;
            color: #2563eb;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .pdf-tasks-add-btn:hover {
            background: #eff6ff;
        }

        .pdf-tasks-content {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #9ca3af;
        }

        .pdf-tasks-content::-webkit-scrollbar {
            width: 6px;
        }

        .pdf-tasks-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .pdf-tasks-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        /* ===== PDF BOTTOM PANELS ===== */
        .pdf-bottom-panel {
            position: fixed;
            bottom: 100px;
            right: 300px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 14px 18px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
            z-index: 10001;
            min-width: auto;
        }

        .pdf-panel-title {
            font-size: 12px;
            font-weight: 700;
            color: #9ca3af;
            text-transform: uppercase;
            letter-spacing: 0.4px;
            margin-bottom: 6px;
        }

        .pdf-date-display {
            font-size: 14px;
            color: #1f2937;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .pdf-compare-btn {
            background: white;
            border: 1px solid #d1d5db;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            color: #374151;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s;
        }

        .pdf-compare-btn:hover {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .pdf-date-selector {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 10001;
            min-width: 160px;
        }

        .pdf-date-selector input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            color: #1f2937;
        }

        .pdf-date-selector input:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .pdf-edit-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #2a2f37;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 10002;
            height: 50px;
        }

        .pdf-edit-label {
            background: #3a3f47;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pdf-edit-label:hover {
            background: #4a5158;
        }

    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar (WITH LOGO, PROJECT NAME AND DROPDOWN) -->
        <div class="sidebar">
            <!-- Logo Section with Project Name and Dropdown -->
            <div class="logo" id="sidebarLogoToggle" style="cursor: pointer; position: relative;">
                <img src="/img/img.webp" alt="Desa Logo" class="logo-img">
                <span style="font-size: 18px; color: #ecf0f1; font-weight: 600; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; flex: 1; line-height: 1.2;" id="sidebarProjectName"><%= projectName || 'Select Project' %></span>
                <i class="fas fa-chevron-down dropdown-icon" id="sidebarLogoDropdownIcon"></i>

                <!-- Project Dropdown Menu -->
                <div class="sidebar-project-dropdown" id="projectDropdown" style="display: none;">
                    <div class="sidebar-project-header">
                        <button class="sidebar-home-btn" onclick="goHome()">
                            <i class="fas fa-home"></i>
                            Home
                        </button>
                        <button class="sidebar-create-btn" onclick="openCreateProjectModal()" title="Create new project">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="sidebar-project-search">
                        <input type="text" placeholder="Search projects..." id="projectSearch">
                    </div>
                    <div id="projectList"></div>
                </div>
            </div>

            <div class="section-title">Pages</div>

            <div class="menu-item">
                <i class="fas fa-edit"></i>
                <span>Plans</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-clipboard-check"></i>
                <span>Specifications</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-clipboard-list"></i>
                <span>Tasks</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-camera"></i>
                <span>Photos</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-file-invoice"></i>
                <span>Forms</span>
            </div>

            <div class="menu-item">
                <i class="fas fa-folder"></i>
                <span>Files</span>
            </div>

            <div class="tasks-section">
                <div class="section-title">Tasks</div>

                <div class="task-item active">
                    <div class="left">
                        <i class="fas fa-star"></i>
                        <span>My tasks</span>
                    </div>
                    <span class="badge" id="myTasksBadge" style="display: none;">0</span>
                </div>

                <div class="task-item">
                    <div class="left">
                        <i class="fas fa-eye"></i>
                        <span>Watched tasks</span>
                    </div>
                    <span class="badge" id="watchedTasksBadge" style="display: none;">0</span>
                </div>

                <div class="task-item">
                    <div class="left">
                        <i class="fas fa-th"></i>
                        <span>All tasks</span>
                    </div>
                    <span class="badge" id="allTasksBadge" style="display: none;">0</span>
                </div>

                <div class="task-item">
                    <div class="left">
                        <i class="fas fa-plus"></i>
                        <span>New category</span>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer">
                <i class="fas fa-users footer-icon"></i>
                <i class="fas fa-cog footer-icon"></i>
                <i class="fas fa-trash footer-icon"></i>
            </div>
        </div>

        <!-- Main Content (UPDATED) -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="search-section">
                    <button class="sidebar-toggle-btn" id="sidebarToggleBtn" title="Toggle Sidebar">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Search">
                    </div>
                </div>

                <div class="header-right">
                    <div class="user-section">
                        <!-- Notification Bell -->
                        <span class="notification-icon" id="notificationBell" style="position: relative;">
                            ðŸ””
                            <span id="notificationBadge" style="
                                position: absolute;
                                top: -2px;
                                right: -2px;
                                background: #e53e3e;
                                color: white;
                                font-size: 10px;
                                font-weight: 600;
                                padding: 2px 5px;
                                border-radius: 10px;
                            ">0</span>
                        </span>

                        <!-- Help Icon -->
                        <span class="notification-icon" id="helpIcon">â“</span>

                        <!-- Notification Panel -->
                        <div class="notification-panel" id="notificationPanel">
                            <div class="panel-header">
                                <div class="panel-title">Notifications</div>
                                <div class="mark-all-read" id="markAllRead">Mark all as read</div>
                            </div>
                            <div id="notificationsList"></div>
                        </div>

                        <!-- Help Panel -->
                        <div class="help-panel" id="helpPanel">
                            <div class="panel-header">
                                <div class="panel-title">Help & Support</div>
                            </div>
                            <div class="help-item" onclick="window.open('https://www.desa.ca/', '_blank')">
                                <div class="help-item-title">ðŸ“š Documentation</div>
                                <div class="help-item-desc">Browse our complete documentation</div>
                            </div>
                            <div class="help-item" onclick="contactSupport()">
                                <div class="help-item-title">ðŸ’¬ Contact Support</div>
                                <div class="help-item-desc">Get help from our support team</div>
                            </div>
                        </div>

                        <!-- User Dropdown -->
                        <div class="user-dropdown" id="userDropdownToggle">
                            <span><%= user ? user.username : 'Guest' %></span>
                            <span>â–¼</span>
                            <div class="user-dropdown-content" id="userDropdown">
                                <div class="user-dropdown-header">
                                    <div class="user-full-name"><%= user ? user.username : 'Guest' %></div>
                                    <div class="user-email"><%= user ? user.email : 'guest@example.com' %></div>
                                </div>
                                <div class="user-dropdown-menu">
                                    <a href="/account" class="user-dropdown-item">View account</a>
                                    <a href="#" class="user-dropdown-item" onclick="signOut()">Sign out</a>
                                </div>
                            </div>
                        </div>

                        <span>ðŸ‡¨ðŸ‡¦</span>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="action-bar">
                <div class="action-bar-left">
                    <button class="btn-primary" onclick="openUploadModal()">
                        <i class="fas fa-plus"></i>
                        <span>New plan</span>
                    </button>
                    <button class="btn-secondary" onclick="openCreateFolderModal()">
                        <i class="fas fa-plus"></i>
                        <span>New folder</span>
                    </button>
                    <button class="btn-secondary">
                        <span>Actions</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
                <div class="action-bar-right">
                    <button class="btn-secondary">
                        <i class="fas fa-filter"></i>
                        <span>Filter plans</span>
                    </button>
                    <button class="btn-secondary">
                        <span>Version control</span>
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-th"></i>
                    </button>
                    <button class="btn-secondary">
                        <i class="fas fa-list"></i>
                    </button>
                </div>
            </div>

            <!-- Plans Content -->
            <div class="plans-content" id="plansContent">
                <!-- Empty State (shown when no files) -->
                <div class="empty-state" id="emptyState">
                    <div class="empty-state-icon">
                        <div class="empty-state-icon-inner">
                            <div class="empty-state-play"></div>
                        </div>
                    </div>
                    <h2 class="empty-state-title">Drop your plans here to get started</h2>
                    <p class="empty-state-description">Plans will sync across all of your devices to provide your team with the latest information.</p>
                </div>

                <!-- Plans View (shown when files exist) -->
                <div id="plansView" style="display: none;">
                    <!-- All plans folder -->
                    <div class="folder-section" id="allPlansSection" style="display: none;">
                        <div class="folder-header">
                            <input type="checkbox" class="folder-checkbox" id="allPlansCheckbox">
                            <i class="fas fa-folder folder-icon"></i>
                            <span class="folder-name" id="allPlansName">All plans (0 plans)</span>
                            <div class="folder-dropdown">
                                <button class="folder-dropdown-btn" onclick="toggleFolderDropdown('allPlansDropdown')">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                                <div class="folder-dropdown-menu" id="allPlansDropdown">
                                    <button class="folder-dropdown-item" onclick="createNewPlanInFolder('all')">New plan</button>
                                    <button class="folder-dropdown-item" onclick="selectFolder('all')">Select folder</button>
                                    <button class="folder-dropdown-item" onclick="deselectFolder('all')">Deselect folder</button>
                                </div>
                            </div>
                        </div>
                        <div class="plans-grid" id="allPlansGrid">
                            <!-- Plans will be added here -->
                        </div>
                    </div>

                    <!-- Custom folders -->
                    <div id="customFoldersContainer"></div>
                </div>
            </div>

            <!-- Status Bar -->
            <div class="status-bar">
                <span id="statusText">0 plans</span>
            </div>
        </div>
    </div>

    <!-- Upload Plans Modal -->
    <div id="uploadModal" class="upload-modal">
        <div class="upload-modal-content">
            <div class="upload-modal-header">
                <h2 class="upload-modal-title">Upload plans</h2>
                <button class="upload-modal-close" onclick="closeUploadModal()">Ã—</button>
            </div>
            <div class="upload-modal-body">
                <div class="upload-dropzone" id="dropzone">
                    <div class="upload-icon-wrapper">
                        <div class="upload-icon-box">
                            <div class="upload-icon-lines">
                                <div class="upload-icon-line"></div>
                                <div class="upload-icon-line"></div>
                                <div class="upload-icon-line"></div>
                            </div>
                        </div>
                    </div>
                    <p class="upload-text">Drag and drop your plans here</p>
                    <p class="upload-or">or</p>
                    <button class="upload-select-btn" onclick="document.getElementById('fileInput').click()">
                        Select files
                    </button>
                </div>

                <input type="file" id="fileInput" multiple accept=".pdf" style="display: none;">

                <div id="uploadFileList" class="upload-file-list"></div>

                <div class="upload-integration-section">
                    <p class="upload-integration-text">Or setup plan sync using one of our integrations below</p>
                    <div class="upload-integration-grid">
                        <button class="upload-integration-btn" onclick="alert('Google Drive integration coming soon')">
                            <img src="https://www.gstatic.com/images/branding/product/1x/drive_2020q4_48dp.png" alt="Google Drive" class="upload-integration-icon">
                            <span class="upload-integration-name">Google Drive</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('SharePoint integration coming soon')">
                            <svg class="upload-integration-icon" width="28" height="28" viewBox="0 0 32 32">
                                <circle cx="16" cy="16" r="14" fill="#036C70"/>
                                <circle cx="12" cy="12" r="6" fill="#03787C" opacity="0.8"/>
                                <circle cx="20" cy="12" r="6" fill="#00A4A6" opacity="0.7"/>
                                <circle cx="16" cy="20" r="6" fill="#00B7C3" opacity="0.6"/>
                            </svg>
                            <span class="upload-integration-name">SharePoint</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('Dropbox integration coming soon')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/7/78/Dropbox_Icon.svg" alt="Dropbox" class="upload-integration-icon">
                            <span class="upload-integration-name">Dropbox</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('Box integration coming soon')">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/57/Box%2C_Inc._logo.svg" alt="Box" class="upload-integration-icon">
                            <span class="upload-integration-name">Box</span>
                        </button>
                        <button class="upload-integration-btn" onclick="alert('OneDrive integration coming soon')">
                            <svg class="upload-integration-icon" width="28" height="28" viewBox="0 0 32 32">
                                <path fill="#0364B8" d="M22 12c-1.1 0-2.1.2-3.1.6-.9-2.9-3.5-5-6.6-5-3.9 0-7 3.1-7 7 0 .3 0 .6.1.9C3.1 16.1 1 18.5 1 21.5 1 25.1 3.9 28 7.5 28h14c4.1 0 7.5-3.4 7.5-7.5S26.1 12 22 12z"/>
                            </svg>
                            <span class="upload-integration-name">OneDrive</span>
                        </button>
                    </div>
                    <button class="upload-more-options" onclick="alert('More options coming soon')">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>More upload options</span>
                    </button>
                </div>

                <button class="upload-files-btn" id="uploadBtn" onclick="uploadFiles()" disabled>
                    <i class="fas fa-cloud-upload-alt"></i>
                    <span>Upload files</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Create Folder Modal -->
    <div id="createFolderModal" class="create-folder-modal">
        <div class="create-folder-content">
            <div class="create-folder-header">
                <h3 class="create-folder-title">Create folder</h3>
                <button class="create-folder-close" onclick="closeCreateFolderModal()">Ã—</button>
            </div>
            <div class="create-folder-body">
                <input type="text" class="create-folder-input" id="folderNameInput" placeholder="Add name" autocomplete="off">
                <button class="create-folder-btn" onclick="createFolder()">Create</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing files...</p>
        </div>
    </div>

    <script>
        // Global state
        let plans = [];
        let folders = [];
        let selectedFiles = [];
        let projects = <% if (projects) { %><%- JSON.stringify(projects) %><% } else { %>[]<% } %>;
        let notifications = [];
        let currentFilter = 'all';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadPlans();
            setupDragAndDrop();
            setupFileInput();
            loadProjectsInDropdown();
            loadNotifications();
            setupTaskEventListeners();
        });

        // Setup task item event listeners
        function setupTaskEventListeners() {
            const taskItems = document.querySelectorAll('.tasks-section .task-item');
            taskItems.forEach((item, index) => {
                item.addEventListener('click', function(e) {
                    // Remove active class from all task items
                    taskItems.forEach(t => t.classList.remove('active'));

                    // Add active class to clicked item
                    item.classList.add('active');

                    // Get task type
                    const taskTypeSpan = item.querySelector('span:nth-child(2)');
                    const taskType = taskTypeSpan ? taskTypeSpan.textContent.trim() : 'All tasks';

                    // Display tasks based on type
                    showTaskDetails(taskType);
                });
            });
        }

        // Show task details based on task type
        function showTaskDetails(taskType) {
            // Create a modal or side panel to show uploaded files as tasks
            console.log('Showing tasks for:', taskType);

            let tasksToShow = [];

            if (taskType === 'My tasks') {
                // Show all uploaded plans as tasks
                tasksToShow = plans;
            } else if (taskType === 'Watched tasks') {
                // Show watched tasks (currently empty for future feature)
                tasksToShow = [];
            } else if (taskType === 'All tasks') {
                // Show all plans as tasks
                tasksToShow = plans;
            }

            // You can implement a tasks panel here to display the tasks
            // For now, this just logs the task details
            console.log(`Found ${tasksToShow.length} tasks for "${taskType}":`, tasksToShow);
        }

        // Get current project ID from URL
        function getCurrentProjectId() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('projectId') || null;
        }

        // Get storage key for current project
        function getProjectStorageKey(key) {
            const projectId = getCurrentProjectId();
            return projectId ? `project_${projectId}_${key}` : key;
        }

        // Load plans from database (project-specific)
        async function loadPlans() {
            const projectId = getCurrentProjectId();

            if (!projectId) {
                plans = [];
                folders = [];
                updateView();
                return;
            }

            try {
                // Fetch plans from database for this project
                const plansResponse = await fetch(`/api/plans?projectId=${projectId}`);
                const plansResult = await plansResponse.json();

                // Fetch folders separately
                const foldersResponse = await fetch(`/api/folders?projectId=${projectId}`);
                const foldersResult = await foldersResponse.json();

                if (plansResult.success) {
                    plans = plansResult.plans || [];
                } else {
                    plans = [];
                }

                if (foldersResult.success) {
                    folders = foldersResult.folders || [];
                } else {
                    folders = [];
                }
            } catch (error) {
                console.error('Error loading plans:', error);
                plans = [];
                folders = [];
            }

            updateView();
            updateTaskCounts();
        }

        // Update task counts in sidebar
        function updateTaskCounts() {
            const myTasksBadge = document.getElementById('myTasksBadge');
            const watchedTasksBadge = document.getElementById('watchedTasksBadge');
            const allTasksBadge = document.getElementById('allTasksBadge');

            // Count all plans as tasks
            const totalTasks = plans.length;

            // For now: My tasks = all tasks (you can customize this logic later)
            // Watched tasks = 0 (placeholder for future feature)
            // All tasks = total tasks

            const myTasksCount = totalTasks;
            const watchedTasksCount = 0;
            const allTasksCount = totalTasks;

            // Update badges with counts
            if (myTasksCount > 0) {
                myTasksBadge.textContent = myTasksCount;
                myTasksBadge.style.display = 'inline-block';
            } else {
                myTasksBadge.style.display = 'none';
            }

            if (watchedTasksCount > 0) {
                watchedTasksBadge.textContent = watchedTasksCount;
                watchedTasksBadge.style.display = 'inline-block';
            } else {
                watchedTasksBadge.style.display = 'none';
            }

            if (allTasksCount > 0) {
                allTasksBadge.textContent = allTasksCount;
                allTasksBadge.style.display = 'inline-block';
            } else {
                allTasksBadge.style.display = 'none';
            }
        }

        // Update view based on plans
        function updateView() {
            const emptyState = document.getElementById('emptyState');
            const plansView = document.getElementById('plansView');
            const allPlansSection = document.getElementById('allPlansSection');
            const statusText = document.getElementById('statusText');

            if (plans.length === 0) {
                emptyState.style.display = 'flex';
                plansView.style.display = 'none';
                statusText.textContent = '0 plans';
            } else {
                emptyState.style.display = 'none';
                plansView.style.display = 'block';
                allPlansSection.style.display = 'block';

                // Setup drag and drop for All Plans section
                allPlansSection.ondragover = (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    allPlansSection.classList.add('drag-over');
                };
                allPlansSection.ondragenter = (e) => {
                    e.preventDefault();
                    allPlansSection.classList.add('drag-over');
                };
                allPlansSection.ondragleave = (e) => {
                    allPlansSection.classList.remove('drag-over');
                };
                allPlansSection.ondrop = (e) => handleAllPlansDrop(e);

                // Update All plans folder
                const allPlansName = document.getElementById('allPlansName');
                allPlansName.textContent = `All plans (${plans.length} ${plans.length === 1 ? 'plan' : 'plans'})`;

                // Render plans
                renderPlans();

                // Render folders
                renderFolders();

                statusText.textContent = `${plans.length} ${plans.length === 1 ? 'plan' : 'plans'}`;
            }
        }

        // Render plans in grid
        function renderPlans() {
            const grid = document.getElementById('allPlansGrid');
            grid.innerHTML = '';

            // Add existing plans
            plans.forEach((plan, index) => {
                const card = createPlanCard(plan, index);
                grid.appendChild(card);
            });

            // Add "New plan" card
            const newPlanCard = document.createElement('div');
            newPlanCard.className = 'new-plan-card';
            newPlanCard.onclick = openUploadModal;
            newPlanCard.innerHTML = `
                <div class="new-plan-content">
                    <i class="fas fa-plus"></i>
                    <span>New plan</span>
                </div>
            `;
            grid.appendChild(newPlanCard);
        }

        // Create plan card with PDF preview
        function createPlanCard(plan, index) {
            const card = document.createElement('div');
            card.className = 'plan-card';
            card.draggable = true;
            card.ondragstart = (e) => handlePlanDragStart(e, index);
            card.ondragend = (e) => handlePlanDragEnd(e);
            card.onclick = () => viewPlan(index);

            const thumbnail = document.createElement('div');
            thumbnail.className = 'plan-thumbnail';
            thumbnail.id = `thumbnail-${index}`;

            const info = document.createElement('div');
            info.className = 'plan-info';
            info.innerHTML = `<div class="plan-name">${plan.name}</div>`;

            card.appendChild(thumbnail);
            card.appendChild(info);

            // Generate PDF preview
            if (plan.preview) {
                // Extract base64 data from data URL
                const base64Data = plan.preview.split(',')[1] || plan.preview;
                generatePDFPreview(base64Data, `thumbnail-${index}`);
            }

            return card;
        }

        // Generate PDF preview using PDF.js
        async function generatePDFPreview(pdfData, containerId) {
            try {
                const loadingTask = pdfjsLib.getDocument({ data: atob(pdfData) });
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);

                const scale = 5.5;  // Ultra high-quality zoom for premium professional appearance
                const viewport = page.getViewport({ scale: scale });

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                // Set canvas style for better rendering
                canvas.style.maxWidth = '100%';
                canvas.style.maxHeight = '100%';
                canvas.style.objectFit = 'contain';

                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                await page.render(renderContext).promise;

                const container = document.getElementById(containerId);
                if (container) {
                    container.innerHTML = '';
                    container.appendChild(canvas);
                }
            } catch (error) {
                console.error('Error generating PDF preview:', error);
            }
        }

        // Render custom folders
        function renderFolders() {
            const container = document.getElementById('customFoldersContainer');
            container.innerHTML = '';

            folders.forEach((folder, index) => {
                // Skip "All Plans" folders - they show in the special section at top
                if (folder.name.toLowerCase() === 'all plans') {
                    return;
                }

                const folderSection = document.createElement('div');
                folderSection.className = 'folder-section';
                folderSection.draggable = false;
                folderSection.ondragover = (e) => handleFolderDragOver(e, index);
                folderSection.ondragenter = (e) => handleFolderDragEnter(e, index);
                folderSection.ondragleave = (e) => handleFolderDragLeave(e, index);
                folderSection.ondrop = (e) => handleFolderDrop(e, index);

                // Get plans in this folder
                const folderPlans = plans.filter(p => p.folderId === folder.id || p.folder === folder.name);
                const planCount = folderPlans.length;

                folderSection.innerHTML = `
                    <div class="folder-header">
                        <input type="checkbox" class="folder-checkbox">
                        <i class="fas fa-folder folder-icon"></i>
                        <span class="folder-name">${folder.name} (${planCount})</span>
                        <div class="folder-dropdown">
                            <button class="folder-dropdown-btn" onclick="toggleFolderDropdown('folder-${index}-dropdown')">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <div class="folder-dropdown-menu" id="folder-${index}-dropdown">
                                <button class="folder-dropdown-item" onclick="createNewPlanInFolder('${folder.name}')">New plan</button>
                                <button class="folder-dropdown-item" onclick="renameFolder(${index})">Rename folder</button>
                                <button class="folder-dropdown-item danger" onclick="deleteFolder(${index})">Delete folder</button>
                            </div>
                        </div>
                    </div>
                    <div class="folder-plans-grid" id="folder-${index}-plans">
                        <!-- Plans will be rendered here -->
                    </div>
                `;
                container.appendChild(folderSection);

                // Render plans inside this folder
                const plansGrid = folderSection.querySelector(`#folder-${index}-plans`);
                folderPlans.forEach((plan, planIndex) => {
                    const card = createPlanCard(plan, plans.indexOf(plan));
                    plansGrid.appendChild(card);
                });
            });
        }

        // ========== DRAG AND DROP FOR PLANS BETWEEN FOLDERS ==========

        // Handle plan drag start
        function handlePlanDragStart(e, planIndex) {
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('planIndex', planIndex);
            e.target.closest('.plan-card').classList.add('dragging');
        }

        // Handle plan drag end
        function handlePlanDragEnd(e) {
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('dragging');
            });
            document.querySelectorAll('.folder-section').forEach(folder => {
                folder.classList.remove('drag-over');
            });
        }

        // Handle folder drag over
        function handleFolderDragOver(e, folderIndex) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.closest('.folder-section').classList.add('drag-over');
        }

        // Handle folder drag enter
        function handleFolderDragEnter(e, folderIndex) {
            e.preventDefault();
            e.currentTarget.closest('.folder-section').classList.add('drag-over');
        }

        // Handle folder drag leave
        function handleFolderDragLeave(e, folderIndex) {
            e.currentTarget.closest('.folder-section').classList.remove('drag-over');
        }

        // Handle folder drop
        function handleFolderDrop(e, folderIndex) {
            e.preventDefault();
            e.currentTarget.closest('.folder-section').classList.remove('drag-over');

            const planIndex = parseInt(e.dataTransfer.getData('planIndex'));
            const targetFolder = folders[folderIndex];

            if (targetFolder) {
                movePlanToFolder(planIndex, targetFolder.name);
            }
        }

        // Handle drop on "All plans" section
        function handleAllPlansDrop(e) {
            e.preventDefault();
            const allPlansSection = document.getElementById('allPlansSection');
            if (allPlansSection) {
                allPlansSection.classList.remove('drag-over');
            }

            const planIndex = parseInt(e.dataTransfer.getData('planIndex'));
            // Move plan back to All Plans (null folderId)
            if (plans[planIndex]) {
                movePlanToFolder(planIndex, null);
            }
        }

        // Move plan to folder with optimistic updates
        async function movePlanToFolder(planIndex, targetFolderName) {
            if (!plans[planIndex]) {
                console.error('Plan not found');
                return;
            }

            const plan = plans[planIndex];
            let newFolderId = null;
            let newFolderName = targetFolderName;

            // Find the target folder's ID
            if (targetFolderName) {
                const targetFolder = folders.find(f => f.name === targetFolderName);
                if (targetFolder) {
                    newFolderId = targetFolder.id;
                } else {
                    console.error('Target folder not found');
                    return;
                }
            }

            // OPTIMISTIC UPDATE: Update UI immediately
            plan.folder = newFolderName;
            plan.folderId = newFolderId;

            // Re-render the plans to reflect changes
            await loadPlans();

            // Save changes to backend in background (fire-and-forget)
            try {
                const response = await fetch(`/api/plans/${plan.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        folderId: newFolderId,
                        folder: newFolderName
                    })
                });
                // Fire-and-forget, no waiting for response
                if (!response.ok) {
                    console.error('Failed to save plan move to backend');
                }
            } catch (error) {
                console.error('Error moving plan:', error);
            }
        }

        // ========== END DRAG AND DROP ==========

        // Modal functions
        function openUploadModal() {
            const projectId = getCurrentProjectId();
            if (!projectId) {
                alert('Please select a project first');
                return;
            }
            document.getElementById('uploadModal').classList.add('show');
            selectedFiles = [];
            updateUploadFileList();
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
            selectedFiles = [];
            updateUploadFileList();
        }

        function openCreateFolderModal() {
            const projectId = getCurrentProjectId();
            if (!projectId) {
                alert('Please select a project first');
                return;
            }
            document.getElementById('createFolderModal').classList.add('show');
            document.getElementById('folderNameInput').value = '';
            document.getElementById('folderNameInput').focus();
        }

        function closeCreateFolderModal() {
            document.getElementById('createFolderModal').classList.remove('show');
        }

        // Drag and drop setup
        function setupDragAndDrop() {
            const dropzone = document.getElementById('dropzone');
            const emptyState = document.getElementById('emptyState');

            // Dropzone handlers
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => {
                    dropzone.classList.add('drag-over');
                }, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                dropzone.addEventListener(eventName, () => {
                    dropzone.classList.remove('drag-over');
                }, false);
            });

            dropzone.addEventListener('drop', handleDrop, false);

            // Empty state drop
            emptyState.addEventListener('dragenter', preventDefaults, false);
            emptyState.addEventListener('dragover', preventDefaults, false);
            emptyState.addEventListener('drop', handleEmptyStateDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            handleFiles(files);
        }

        function handleEmptyStateDrop(e) {
            preventDefaults(e);
            const dt = e.dataTransfer;
            const files = dt.files;
            if (files.length > 0) {
                openUploadModal();
                setTimeout(() => handleFiles(files), 300);
            }
        }

        // File input setup
        function setupFileInput() {
            const fileInput = document.getElementById('fileInput');
            fileInput.addEventListener('change', function(e) {
                handleFiles(this.files);
            });
        }

        // Handle selected files
        function handleFiles(files) {
            selectedFiles = Array.from(files).filter(file => file.type === 'application/pdf');
            updateUploadFileList();
        }

        // Update upload file list
        function updateUploadFileList() {
            const listContainer = document.getElementById('uploadFileList');
            const uploadBtn = document.getElementById('uploadBtn');

            if (selectedFiles.length === 0) {
                listContainer.classList.remove('show');
                uploadBtn.disabled = true;
            } else {
                listContainer.classList.add('show');
                uploadBtn.disabled = false;

                listContainer.innerHTML = '';
                selectedFiles.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = 'upload-file-item';
                    item.innerHTML = `
                        <div class="upload-file-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <div class="upload-file-info">
                            <div class="upload-file-name">${file.name}</div>
                            <div class="upload-file-size">${formatFileSize(file.size)}</div>
                        </div>
                        <button class="upload-file-remove" onclick="removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    listContainer.appendChild(item);
                });
            }
        }

        // Remove file from selection
        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateUploadFileList();
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Upload files
        async function uploadFiles() {
            if (selectedFiles.length === 0) return;

            const loadingOverlay = document.getElementById('loadingOverlay');
            loadingOverlay.classList.add('show');

            const projectId = getCurrentProjectId();
            const maxFileSize = 10 * 1024 * 1024; // 10MB limit

            // Validate file sizes
            for (const file of selectedFiles) {
                if (file.size > maxFileSize) {
                    alert(`File "${file.name}" is too large. Maximum size is 10MB.`);
                    loadingOverlay.classList.remove('show');
                    return;
                }
            }

            // Process and upload files
            const formData = new FormData();
            formData.append('projectId', projectId);

            // Add all files to FormData
            for (const file of selectedFiles) {
                formData.append('plans', file);
            }

            try {
                // Send to database using FormData (handles large files better)
                const response = await fetch('/api/plans/upload', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert(`Error uploading files: ${response.status} ${response.statusText}`);
                    loadingOverlay.classList.remove('show');
                    return;
                }

                const result = await response.json();
                if (result.success || result.status === 'success') {
                    alert('Files uploaded successfully!');
                } else {
                    alert(`Error uploading files: ${result.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error uploading files:', error);
                alert(`Error uploading files: ${error.message}`);
            }

            // Wait for all files to be processed
            await new Promise(resolve => setTimeout(resolve, 2000));

            loadingOverlay.classList.remove('show');
            closeUploadModal();
            await loadPlans();
        }

        // Create folder
        async function createFolder() {
            const input = document.getElementById('folderNameInput');
            const folderName = input.value.trim();

            if (!folderName) {
                alert('Please enter a folder name');
                return;
            }

            const projectId = getCurrentProjectId();

            try {
                // Save to database
                const response = await fetch('/api/folders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        projectId: projectId,
                        name: folderName
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Server error:', errorText);
                    alert(`Error creating folder: ${response.status} ${response.statusText}`);
                    return;
                }

                const result = await response.json();
                if (result.success || result.folderId) {
                    alert('Folder created successfully!');
                    closeCreateFolderModal();
                    await loadPlans();
                } else {
                    alert(`Error creating folder: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error creating folder:', error);
                alert(`Error creating folder: ${error.message}`);
            }
        }

        // Folder dropdown toggle
        function toggleFolderDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            const allDropdowns = document.querySelectorAll('.folder-dropdown-menu');

            allDropdowns.forEach(d => {
                if (d.id !== dropdownId) {
                    d.classList.remove('show');
                }
            });

            if (dropdown) {
                dropdown.classList.toggle('show');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.folder-dropdown')) {
                document.querySelectorAll('.folder-dropdown-menu').forEach(d => {
                    d.classList.remove('show');
                });
            }
        });

        // Folder actions
        function createNewPlanInFolder(folderName) {
            alert(`Create new plan in ${folderName} folder`);
            toggleFolderDropdown('');
        }

        function selectFolder(folderName) {
            alert(`Select ${folderName} folder`);
            toggleFolderDropdown('');
        }

        function deselectFolder(folderName) {
            alert(`Deselect ${folderName} folder`);
            toggleFolderDropdown('');
        }

        async function renameFolder(index) {
            const newName = prompt('Enter new folder name:', folders[index].name);
            if (newName && newName.trim()) {
                const folder = folders[index];
                try {
                    // Update in database
                    const response = await fetch(`/api/folders/${folder.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: newName.trim()
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        folder.name = newName.trim();
                        updateView();
                    } else {
                        alert('Error renaming folder');
                    }
                } catch (error) {
                    console.error('Error renaming folder:', error);
                    alert('Error renaming folder');
                }
            }
            toggleFolderDropdown('');
        }

        async function deleteFolder(index) {
            if (confirm(`Are you sure you want to delete the folder "${folders[index].name}"?`)) {
                const folder = folders[index];
                try {
                    // Delete from database
                    const response = await fetch(`/api/folders/${folder.id}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    const result = await response.json();
                    if (result.success) {
                        folders.splice(index, 1);
                        updateView();
                    } else {
                        alert('Error deleting folder');
                    }
                } catch (error) {
                    console.error('Error deleting folder:', error);
                    alert('Error deleting folder');
                }
            }
            toggleFolderDropdown('');
        }

        // View plan
        function viewPlan(index) {
            // Open PDF viewer with the selected plan
            const plan = plans[index];
            if (plan) {
                // Create PDF data object with plan information
                const pdfData = {
                    plan: plan,
                    html: generatePDFViewerContent(plan)
                };
                openPDFViewer(pdfData);
            }
        }

        // Generate PDF viewer content based on uploaded plan
        function generatePDFViewerContent(plan) {
            return `
                <div class="doc-header">
                    <div class="doc-logo">
                        <div class="company-logo">DESA</div>
                        <div class="company-info">
                            <strong>DESA Wire</strong><br>
                            Project Management System<br>
                            Plans & Documents<br>
                            P: (403) 255-6521
                        </div>
                    </div>
                    <div class="project-info">
                        <strong>Document: ${plan.name || 'Untitled'}</strong><br>
                        File Size: ${plan.size || 'N/A'}<br>
                        Type: ${plan.type || 'application/pdf'}<br>
                        Uploaded: ${new Date(plan.createdAt).toLocaleDateString()}
                    </div>
                </div>

                <div class="doc-title">
                    <h2>${plan.name || 'Document Preview'}</h2>
                    <h3>Uploaded Document</h3>
                </div>

                <div class="doc-info-grid">
                    <div class="info-row">
                        <span class="info-label">File Name</span>
                        <span class="info-value">${plan.name || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">File Size</span>
                        <span class="info-value">${plan.size || 'N/A'}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Upload Date</span>
                        <span class="info-value">${new Date(plan.createdAt).toLocaleDateString()}</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">File Type</span>
                        <span class="info-value">${plan.type || 'PDF Document'}</span>
                    </div>
                </div>

                <div class="description-box">
                    <strong>Document Information</strong><br>
                    This is the uploaded document preview for <strong>${plan.name || 'your file'}</strong>.
                    You can use the tools on the left to annotate, mark up, or review this document.
                </div>

                <div class="workflow-section">
                    <div class="workflow-title">Document Details</div>
                    <table class="workflow-table">
                        <thead>
                            <tr>
                                <th>Property</th>
                                <th>Value</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>File Name</td>
                                <td>${plan.name || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td>File Size</td>
                                <td>${plan.size || 'N/A'}</td>
                            </tr>
                            <tr>
                                <td>File Type</td>
                                <td>${plan.type || 'PDF'}</td>
                            </tr>
                            <tr>
                                <td>Created</td>
                                <td>${new Date(plan.createdAt).toLocaleString()}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="doc-footer">
                    <div>DESA Wire</div>
                    <div>Document Preview</div>
                    <div>Generated: ${new Date().toLocaleString()}</div>
                </div>
            `;
        }

        // Configure PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Header functionality
        const notificationBell = document.getElementById('notificationBell');
        const helpIcon = document.getElementById('helpIcon');
        const userDropdownToggle = document.getElementById('userDropdownToggle');
        const notificationPanel = document.getElementById('notificationPanel');
        const helpPanel = document.getElementById('helpPanel');
        const userDropdown = document.getElementById('userDropdown');
        const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
        const sidebar = document.querySelector('.sidebar');

        // Sidebar logo and project dropdown
        const sidebarLogoToggle = document.getElementById('sidebarLogoToggle');
        const sidebarLogoDropdownIcon = document.getElementById('sidebarLogoDropdownIcon');
        const projectDropdown = document.getElementById('projectDropdown');

        // Notification bell toggle
        notificationBell.addEventListener('click', function() {
            notificationPanel.classList.toggle('show');
            helpPanel.classList.remove('show');
            userDropdown.classList.remove('show');
        });

        // Help icon toggle
        helpIcon.addEventListener('click', function() {
            helpPanel.classList.toggle('show');
            notificationPanel.classList.remove('show');
            userDropdown.classList.remove('show');
        });

        // User dropdown toggle
        userDropdownToggle.addEventListener('click', function() {
            userDropdown.classList.toggle('show');
            notificationPanel.classList.remove('show');
            helpPanel.classList.remove('show');
        });

        // Sidebar toggle
        sidebarToggleBtn.addEventListener('click', function() {
            sidebar.classList.toggle('collapsed');
        });

        // Sidebar logo and project dropdown toggle
        sidebarLogoToggle.addEventListener('click', function(e) {
            e.stopPropagation();
            projectDropdown.style.display = projectDropdown.style.display === 'none' ? 'block' : 'none';
            sidebarLogoDropdownIcon.style.transform = projectDropdown.style.display === 'block' ? 'rotate(180deg)' : 'rotate(0)';
        });

        // Close panels when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.notification-icon') && !e.target.closest('.notification-panel')) {
                notificationPanel.classList.remove('show');
            }
            if (!e.target.closest('#helpIcon') && !e.target.closest('.help-panel')) {
                helpPanel.classList.remove('show');
            }
            if (!e.target.closest('.user-dropdown')) {
                userDropdown.classList.remove('show');
            }
            // Don't close project dropdown if clicking anywhere inside it
            const isClickInsideProjectDropdown = e.target.closest('#projectDropdown') ||
                                                 e.target.closest('#sidebarLogoToggle') ||
                                                 e.target.closest('.sidebar-project-dropdown');

            if (!isClickInsideProjectDropdown) {
                projectDropdown.style.display = 'none';
                if (sidebarLogoDropdownIcon) {
                    sidebarLogoDropdownIcon.style.transform = 'rotate(0)';
                }
            }
        });

        // Load notifications from server
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications');
                const result = await response.json();

                if (result.status === 'success') {
                    notifications = result.data;
                    updateNotificationBadge(result.unreadCount);
                    renderNotifications();
                }
            } catch (error) {
                console.error('Error loading notifications:', error);
            }
        }

        // Update notification badge
        function updateNotificationBadge(count = 0) {
            const badge = document.getElementById('notificationBadge');
            if (count > 0) {
                badge.textContent = count;
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Render notifications
        function renderNotifications(filter = 'all') {
            const notificationsList = document.getElementById('notificationsList');
            const notificationBadge = document.getElementById('notificationBadge');

            const unreadCount = notifications.filter(n => n.unread).length;

            if (unreadCount > 0) {
                notificationBadge.textContent = unreadCount;
                notificationBadge.style.display = 'block';
            } else {
                notificationBadge.style.display = 'none';
            }

            // Filter notifications
            let filteredNotifications = notifications;
            if (filter !== 'all') {
                filteredNotifications = notifications.filter(n => n.type === filter);
            }

            if (filteredNotifications.length === 0) {
                notificationsList.innerHTML = `
                    <div style="padding: 40px 20px; text-align: center; color: #a0aec0;">
                        <div style="font-size: 48px; margin-bottom: 10px;">ðŸ””</div>
                        <div style="font-size: 14px;">No ${filter === 'all' ? '' : filter + ' '}notifications</div>
                    </div>
                `;
                return;
            }

            notificationsList.innerHTML = filteredNotifications.map(notification => `
                <div class="notification-item ${notification.unread ? 'unread' : ''}" onclick="markAsRead(${notification.id})">
                    <div class="notification-header">
                        ${notification.unread ? '<div class="notification-icon-circle"></div>' : ''}
                        <div class="notification-content">
                            <div class="notification-title">
                                ${notification.title || 'Notification'}
                                ${notification.type ? `<span class="notification-type-badge ${notification.type}">${notification.type}</span>` : ''}
                            </div>
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${notification.createdAt ? new Date(notification.createdAt).toLocaleDateString() : 'Just now'}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Mark notification as read
        async function markAsRead(notificationId) {
            try {
                const response = await fetch(`/api/notifications/${notificationId}/read`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    // Update local notification
                    const notification = notifications.find(n => n.id === notificationId);
                    if (notification) {
                        notification.unread = false;
                    }
                    renderNotifications();
                    updateNotificationBadge();
                }
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }
        }

        // Sign out function
        async function signOut() {
            try {
                // Call logout API
                const response = await fetch('/auth/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const result = await response.json();

                if (result.success) {
                    // Show success message
                    const notification = document.createElement('div');
                    notification.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #48bb78;
                        color: white;
                        padding: 16px 24px;
                        border-radius: 8px;
                        box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
                        z-index: 10000;
                        font-weight: 600;
                    `;
                    notification.textContent = 'Signed out successfully. Redirecting...';
                    document.body.appendChild(notification);

                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1500);
                } else {
                    alert('Error signing out. Please try again.');
                }
            } catch (error) {
                console.error('Error signing out:', error);
                alert('Error signing out. Please try again.');
            }
        }

        // Contact support function
        function contactSupport() {
            const supportEmail = 'support@desawire.com';
            const subject = 'Support Request';
            const body = 'Hello Desa Wire Support,\n\nI need help with:\n\n';
            window.location.href = `mailto:${supportEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
        }

        // Go home function
        function goHome() {
            window.location.href = '/';
        }

        // Open create project modal function
        function openCreateProjectModal() {
            alert('Create project modal coming soon');
        }

        // Load and display projects in sidebar dropdown
        function loadProjectsInDropdown() {
            const projectList = document.getElementById('projectList');
            const searchInput = document.getElementById('projectSearch');

            if (!projects || projects.length === 0) {
                projectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No projects available</div>';
                return;
            }

            renderProjectsList(projects);

            // Setup search functionality
            if (searchInput) {
                // Prevent dropdown from closing when clicking search input
                searchInput.addEventListener('click', function(e) {
                    e.stopPropagation();
                });

                // Prevent dropdown from closing when typing in search
                searchInput.addEventListener('keydown', function(e) {
                    e.stopPropagation();
                });

                searchInput.addEventListener('input', function(e) {
                    e.stopPropagation();
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredProjects = projects.filter(project => {
                        const projectName = (project.name || project.projectName || 'Unnamed Project').toLowerCase();
                        return projectName.includes(searchTerm);
                    });
                    renderProjectsList(filteredProjects);
                });
            }
        }

        // Render projects list
        function renderProjectsList(projectsToRender) {
            const projectList = document.getElementById('projectList');
            projectList.innerHTML = '';

            if (projectsToRender.length === 0) {
                projectList.innerHTML = '<div style="padding: 20px; text-align: center; color: #9ca3af;">No projects found</div>';
                return;
            }

            projectsToRender.forEach(project => {
                const projectItem = document.createElement('div');
                projectItem.className = 'sidebar-project-item';

                // Get first letter of project name for icon
                const firstLetter = (project.name || project.projectName || 'P').charAt(0).toUpperCase();

                projectItem.innerHTML = `
                    <div class="sidebar-project-icon">${firstLetter}</div>
                    <div style="flex: 1;">
                        <div class="sidebar-project-name">${project.name || project.projectName || 'Unnamed Project'}</div>
                    </div>
                `;
                projectItem.style.cursor = 'pointer';
                projectItem.style.padding = '12px 16px';
                projectItem.style.borderBottom = '1px solid #f0f0f0';
                projectItem.style.transition = 'background-color 0.2s';
                projectItem.style.color = '#374151';

                projectItem.onmouseover = function() {
                    projectItem.style.backgroundColor = '#f9fafb';
                };

                projectItem.onmouseout = function() {
                    projectItem.style.backgroundColor = 'transparent';
                };

                projectItem.onclick = function() {
                    // Update selected project
                    const projectName = project.name || project.projectName || 'Unnamed Project';
                    document.getElementById('sidebarProjectName').textContent = projectName;
                    projectDropdown.style.display = 'none';
                    sidebarLogoDropdownIcon.style.transform = 'rotate(0)';

                    // Clear search input
                    const searchInput = document.getElementById('projectSearch');
                    if (searchInput) {
                        searchInput.value = '';
                    }

                    // Update URL and reload content without navigating away from mainplan
                    if (project.id) {
                        window.location.href = `/mainplan?projectId=${project.id}&name=${encodeURIComponent(projectName)}`;
                    }
                };

                projectList.appendChild(projectItem);
            });
        }

        // ========== PDF VIEWER FUNCTIONS ==========
        function openPDFViewer(pdfData) {
            const modal = document.getElementById('pdfViewerModal');
            const contentContainer = document.getElementById('pdfDocumentContent');

            // Load actual PDF file using PDF.js
            if (pdfData && pdfData.plan && pdfData.plan.preview) {
                // Clear the container
                contentContainer.innerHTML = '';

                // Extract base64 from preview
                const base64Data = pdfData.plan.preview.split(',')[1] || pdfData.plan.preview;

                // Render PDF using PDF.js
                renderPDFInViewer(base64Data, contentContainer, pdfData.plan);
            } else {
                // Load default template if no PDF data
                contentContainer.innerHTML = getDefaultPDFTemplate();
            }

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function renderPDFInViewer(base64Data, container, planData) {
            try {
                const decodedData = atob(base64Data);
                const byteArray = new Uint8Array(decodedData.length);
                for (let i = 0; i < decodedData.length; i++) {
                    byteArray[i] = decodedData.charCodeAt(i);
                }

                const loadingTask = pdfjsLib.getDocument({ data: byteArray });
                loadingTask.promise.then(pdf => {
                    container.innerHTML = `<div style="width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                        <div id="pdfPagesContainer" style="flex: 1; overflow-y: hidden; background: transparent; display: flex; align-items: center; justify-content: center;"></div>
                    </div>`;

                    const pagesContainer = container.querySelector('#pdfPagesContainer');

                    // Render first 5 pages or all pages if less than 5
                    const numPages = Math.min(pdf.numPages, 5);
                    for (let pageNum = 1; pageNum <= numPages; pageNum++) {
                        pdf.getPage(pageNum).then(page => {
                            const scale = 5.5;
                            const viewport = page.getViewport({ scale: scale });
                            const canvas = document.createElement('canvas');
                            const context = canvas.getContext('2d', { alpha: false });
                            canvas.width = viewport.width;
                            canvas.height = viewport.height;
                            canvas.style.display = 'block';
                            canvas.style.margin = '0px auto';
                            canvas.style.border = '1px solid #000000';
                            canvas.style.borderRadius = '0px';
                            canvas.style.imageRendering = 'sharp';
                            canvas.style.imageRendering = 'crisp-edges';

                            const renderContext = {
                                canvasContext: context,
                                viewport: viewport
                            };

                            page.render(renderContext).promise.then(() => {
                                pagesContainer.appendChild(canvas);
                            });
                        });
                    }
                });
            } catch (error) {
                console.error('Error rendering PDF:', error);
                container.innerHTML = '<div style="padding: 20px; color: red;">Error loading PDF: ' + error.message + '</div>';
            }
        }

        function closePDFViewer() {
            const modal = document.getElementById('pdfViewerModal');
            modal.classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Toggle tasks panel visibility
        function toggleTasksPanel() {
            const tasksPanel = document.querySelector('.pdf-tasks-sidebar');
            if (tasksPanel) {
                tasksPanel.style.display = tasksPanel.style.display === 'none' ? 'block' : 'none';
            }
        }

        function getDefaultPDFTemplate() {
            return `
                <div class="doc-header">
                    <div class="doc-logo">
                        <div class="company-logo">CANA</div>
                        <div class="company-info">
                            <strong>CANA Management Ltd.</strong><br>
                            #100, 5720 - 4th Street S.E.<br>
                            Calgary, Alberta T2H1K7<br>
                            P: (403) 255-6521
                        </div>
                    </div>
                    <div class="project-info">
                        <strong>Project: 65589 AMUFL</strong><br>
                        800 Main Street S<br>
                        Airdrie, Alberta T4B 3G1
                    </div>
                </div>

                <div class="doc-title">
                    <h2>Submittal #08 44 00-7.0 - Curtain Wall Shop Drawing & PA Speaker Reinforcing Package</h2>
                    <h3>08 44 00 - Aluminum Curtain Wall</h3>
                </div>

                <div class="doc-info-grid">
                    <div class="info-row">
                        <span class="info-label">Revision</span>
                        <span class="info-value">0</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Submittal Manager</span>
                        <span class="info-value">Conor Jensen (CANA Construction Co. Ltd.)</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Status</span>
                        <span class="info-value">Open</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Date Created</span>
                        <span class="info-value">Nov 7, 2024</span>
                    </div>
                </div>

                <div class="description-box">
                    <strong>Description</strong>
                    As discussed, please see the combined Curtain Wall Drawing & PA Speaker Reinforcing Package attached for your review & comment.
                </div>

                <div class="workflow-section">
                    <div class="workflow-title">Submittal Workflow</div>
                    <table class="workflow-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Sent Date</th>
                                <th>Due Date</th>
                                <th>Response</th>
                                <th>Attachments</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Conor Jensen</td>
                                <td>Nov 7, 2024</td>
                                <td>Nov 7, 2024</td>
                                <td>Submitted</td>
                                <td><a href="#">Document.pdf</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="doc-footer">
                    <div>CANA Management Ltd.</div>
                    <div>Page 1 of 1</div>
                    <div>Printed On: Nov 8, 2024 09:54 AM MST</div>
                </div>
            `;
        }

        // Keyboard shortcut for closing
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closePDFViewer();
            }
        });
    </script>

    <!-- PDF VIEWER MODAL -->
    <div class="pdf-viewer-modal" id="pdfViewerModal">
        <!-- Secondary Header Bar (replacing top header - uses existing page header) -->
        <div class="pdf-viewer-secondary-header">
            <div class="pdf-secondary-left">
                <button class="pdf-back-btn" onclick="closePDFViewer()">
                    <i class="fas fa-arrow-left"></i>
                    <span>All plans</span>
                </button>
                <div class="pdf-secondary-center">
                    <button class="pdf-action-btn">
                        Actions
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="pdf-filter-btn">
                    <i class="fas fa-filter"></i>
                    Filter tasks
                </button>
                <button class="pdf-version-btn">Version control</button>
            </div>
        </div>

        <!-- Main Content Wrapper -->
        <div class="pdf-viewer-main-wrapper">
            <!-- Left Sidebar with Tools -->
            <div class="pdf-left-sidebar">
                <button class="pdf-tool-btn" title="Full Screen">
                    <i class="fas fa-expand"></i>
                </button>

                <div style="display: flex; flex-direction: column; gap: 4px;">
                    <button class="pdf-tool-btn" title="Zoom In">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="pdf-tool-btn" title="Zoom Out">
                        <i class="fas fa-minus"></i>
                    </button>
                </div>

                <div style="width: 30px; height: 1px; background: #4a5158; margin: 8px 0;"></div>

                <button class="pdf-tool-btn" title="Pin Location">
                    <i class="fas fa-map-marker-alt"></i>
                </button>
                <button class="pdf-tool-btn" title="Link">
                    <i class="fas fa-link"></i>
                </button>
                <button class="pdf-tool-btn" title="Draw Line">
                    <i class="fas fa-minus" style="transform: rotate(45deg);"></i>
                </button>
                <button class="pdf-tool-btn" title="Shapes">
                    <i class="far fa-square"></i>
                </button>
                <button class="pdf-tool-btn" title="Markup">
                    <i class="fas fa-toolbox"></i>
                </button>
                <button class="pdf-tool-btn" title="Text">
                    <i class="fas fa-font"></i>
                </button>
                <button class="pdf-tool-btn" title="Pen">
                    <i class="fas fa-pen"></i>
                </button>

                <div style="width: 30px; height: 1px; background: #4a5158; margin: 8px 0;"></div>

                <button class="pdf-tool-btn" title="Record">
                    <div style="width: 12px; height: 12px; background: white; border-radius: 50%;"></div>
                </button>

                <div style="width: 30px; height: 1px; background: #4a5158; margin: 8px 0;"></div>

                <button class="pdf-tool-btn" title="Select">
                    <i class="fas fa-mouse-pointer"></i>
                </button>
                <button class="pdf-tool-btn" title="Undo">
                    <i class="fas fa-undo"></i>
                </button>

                <div style="display: flex; flex-direction: column; gap: 4px; margin-top: auto;">
                    <button class="pdf-tool-btn" title="Previous">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="pdf-tool-btn" title="Next">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- Center Content Area -->
            <div class="pdf-center-content">
                <!-- Document Display Area -->
                <div class="pdf-document-area">
                    <div id="pdfDocumentContent">
                        <!-- Document content loads here -->
                    </div>
                </div>
            </div>

            <!-- Right Sidebar - Tasks Panel -->
            <div class="pdf-tasks-sidebar">
                <div class="pdf-tasks-header">
                    <h3 class="pdf-tasks-title">Tasks</h3>
                    <div class="pdf-tasks-header-actions">
                        <button class="pdf-tasks-add-btn" title="Add new task">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button class="pdf-tasks-close-btn" onclick="toggleTasksPanel()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="pdf-tasks-content">
                    <p>No tasks yet</p>
                </div>
            </div>
        </div>

        <!-- Bottom Panels -->
        <div class="pdf-bottom-panel">
            <div class="pdf-panel-title">Date Compare</div>
            <div class="pdf-date-display">2025-10-17</div>
            <button class="pdf-compare-btn">Compare</button>
        </div>

        <!-- Date Selector -->
        <div class="pdf-date-selector">
            <input type="date" value="2025-10-17">
        </div>

        <!-- Edit Bar -->
        <div class="pdf-edit-bar">
            <div class="pdf-edit-label">
                <i class="fas fa-pen"></i>
                <span>desa wire</span>
            </div>
        </div>
    </div>

</body>
</html>
